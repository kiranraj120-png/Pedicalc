<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6062360145892080"
         crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EQG7VWLLQ9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EQG7VWLLQ9');
      gtag('config', 'G-P5H9YSJRSF');
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#059669">

    <title>Pediatric Anesthesia Calculator: Drug Doses, PALS & Airway | Free Online Tool</title>
    <meta name="description" content="Free online pediatric anesthesia calculator by Dr. Kiranraj. Instant weight-based calculation for emergency drugs (PALS), airway equipment (ETT/LMA), fluid management (4-2-1), and infusions. Designed for anesthesiologists and emergency physicians.">
    <meta name="keywords" content="pediatric anesthesia calculator, weight based drug dosage, PALS algorithms 2025, airway sizing calculator, Cole's formula, emergency drug doses, pediatric fluid maintenance, anesthesia pharmacology, Dr. Kiranraj, medical calculator">
    <meta name="author" content="Dr. Kiranraj">
    <meta name="robots" content="index, follow">
    
    <link rel="canonical" href="https://pedicalc.pages.dev/" />

    <meta property="og:type" content="website">
    <meta property="og:title" content="Pediatric Anesthesia Calculator by Dr. Kiranraj">
    <meta property="og:description" content="Instant calculation of pediatric drug doses, airway equipment, and emergency algorithms.">
    <meta property="og:site_name" content="Pediatric Anesthesia Calculator">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Pediatric Anesthesia Calculator">
    <meta name="twitter:description" content="Instant calculation of pediatric drug doses, airway equipment, and emergency algorithms.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
          /* Primary Accent */
          --primary-accent: #059669;
          --primary-accent-dark: #065f46;
          --primary-accent-light: rgba(5, 150, 105, 0.1);

          /* Neutrals */
          --bg-primary: #f5f5f4;
          --bg-secondary: #ffffff;
          --bg-card: #ffffff;

          --text-primary: #292524;
          --text-secondary: #57534e;
          --text-tertiary: #78716c;

          --border-color: #e7e5e4;

          /* Standard Shadows */
          --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
          --shadow-hover: var(--shadow-lg);

          /* Glass/Sticky Backgrounds */
          --glass-bg: rgba(255, 255, 255, 0.85);
          --glass-border: rgba(231, 229, 228, 0.7);

          /* Drug Category Colors */
          --induction: #0ea5e9;
          --muscle-relaxant: #f59e0b;
          --analgesic: #059669;
          --adjunct: #8b5cf6;
          --reversal: #ef4444;
          --emergency: #f97316;
          --steroid: #14b8a6;
          --antiemetic: #4d7c0f;
          --local-anesthetic: #f43f5e;
          --infusion: #06b6d4;
          --antibiotic: #4f46e5;

          /* Semantic Alerts */
          --caution-color: #f59e0b;
          --reset-color: #ef4444;

          --radius-card: 12px;
          --radius-input: 8px;
          --radius-tab: 8px;

          --anim-bezier: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
          /* Primary Accent */
          --primary-accent: #34d399;
          --primary-accent-dark: #10b981;
          --primary-accent-light: rgba(52, 211, 153, 0.1);

          /* Neutrals */
          --bg-primary: #1c1917;
          --bg-secondary: #292524;
          --bg-card: #292524;

          --text-primary: #f5f5f4;
          --text-secondary: #a8a29e;
          --text-tertiary: #78716c;

          --border-color: #44403c;

          /* Shadows */
          --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
          --shadow-hover: var(--shadow-lg);

          /* Glass/Sticky Backgrounds */
          --glass-bg: rgba(41, 37, 36, 0.85);
          --glass-border: rgba(68, 64, 60, 0.7);
          
          /* Semantic Alerts */
          --caution-color: #fcd34d;
          --reset-color: #f87171;
          --emergency: #fbbf24;
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
            touch-action: manipulation; /* Disables double-tap to zoom */
        }

        body {
          overflow-x: hidden; /* Stops the page from swaying sideways */
          width: 100%;
          font-family: 'Manrope', sans-serif;
          background: var(--bg-primary);
          color: var(--text-primary);
          line-height: 1.7;
          font-size: 14px;
          transition: background-color 0.4s var(--anim-bezier), color 0.4s var(--anim-bezier), font-size 0.3s var(--anim-bezier);
          user-select: none;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          overflow-x: hidden;
          overscroll-behavior: contain; /* Prevents overscroll bounce */
          text-rendering: optimizeLegibility;
        }
        
        h1, h2, h3 {
          letter-spacing: -0.02em; 
        }

        /* Use Tabular Numbers for all numeric-heavy elements */
        .calculation-result,
        .volume-result,
        .equipment-value,
        .drug-dose-preview,
        .la-max-dose,
        .infusion-value,
        .antibiotic-value,
        #font-size-indicator {
          font-feature-settings: "tnum" on;
          font-variant-numeric: tabular-nums;
        }

        input[type="number"],
        .infusion-dilution-input input {
          font-feature-settings: "tnum" on;
          font-variant-numeric: tabular-nums;
        }

        input, textarea {
          user-select: text !important;
          font-family: 'Manrope', sans-serif;
        }

        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 15px 10px;
           padding-top: 40px;
          animation: containerFadeIn 0.5s ease-out;
        }

        @keyframes containerFadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        header {
          background: linear-gradient(135deg, var(--primary-accent), var(--primary-accent-dark));
          color: white;
          padding: 15px;
          border-radius: var(--radius-card);
          box-shadow: var(--shadow-md);
          margin-bottom: 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 10px;
          position: relative;
          overflow: hidden;
        }

        header::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
          transform: rotate(30deg);
          animation-name: shimmer;
          animation-duration: 4s;
          animation-iteration-count: infinite;
          animation-direction: alternate;
          animation-timing-function: ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translate(-30%, -30%) rotate(30deg); }
            100% { transform: translate(30%, 30%) rotate(30deg); }
        }
        
        .sticky-header-wrapper {
            position: sticky;
            top: 5px;
            z-index: 101;
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-card);
            padding: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .patient-safety-header {
            top: 5px;
            z-index: 101;
            background: var(--caution-color);
            color: #000;
            padding: 8px 12px;
            border-radius: var(--radius-input);
            margin-bottom: 8px;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-weight: 700;
            font-size: 0.9em;
            text-align: center;
            animation: fadeIn 0.3s var(--anim-bezier);
        }
        body.dark-mode .patient-safety-header {
            background: var(--caution-color);
            color: #000;
        }

        body.dark-mode .tab-navigation {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }
        .patient-safety-header span {
            display: inline-block;
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        h1 {
          font-size: 1.5em;
          font-weight: 700;
          z-index: 1;
          flex: 1;
          min-width: 150px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .font-size-control {
          background: rgba(255, 255, 255, 0.2);
          border-radius: 50px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, .2);
          display: flex;
          align-items: center;
          padding: 2px;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          z-index: 1;
        }

        .font-adjust-btn {
          background: transparent;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 1em;
          padding: 6px 8px;
          border-radius: 50%;
          transition: all .25s var(--anim-bezier);
          line-height: 1;
        }

        .font-adjust-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        #font-size-indicator {
          color: white;
          font-weight: 600;
          font-size: .75em;
          padding: 0 4px;
          min-width: 40px;
          text-align: center;
          user-select: none;
        }

        .dark-mode-toggle {
          background: rgba(255, 255, 255, 0.2);
          color: white;
          border: none;
          border-radius: 50px;
          padding: 8px 16px;
          cursor: pointer;
          font-size: .75em;
          font-weight: 600;
          box-shadow: 0 2px 5px rgba(0, 0, 0, .2);
          transition: all .25s var(--anim-bezier);
          outline: none;
          z-index: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          min-width: 120px;
          overflow: hidden;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, .2);
        }

        .dark-mode-toggle:active {
          transform: translateY(0px);
        }

        .dark-mode-toggle i {
            transition: transform 0.4s var(--anim-bezier);
        }

        body.dark-mode .dark-mode-toggle i {
            transform: rotate(180deg);
        }

        .tab-navigation {
          display: flex;
          overflow-x: auto;
          gap: 5px;
          padding: 4px 0;
          scrollbar-width: none;
          -ms-overflow-style: none;
          z-index: 100;
          background: transparent;
          border-radius: var(--radius-tab);
          border: none;
        }

        .tab-navigation::-webkit-scrollbar {
          display: none;
        }

        .tab-button {
          flex: 1;
          min-width: 120px;
          background: transparent;
          border: 1px solid transparent;
          padding: 12px 15px;
          border-radius: var(--radius-tab);
          cursor: pointer;
          font-size: 0.8em;
          font-weight: 600;
          text-align: center;
          transition: all 0.3s var(--anim-bezier);
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 5px;
          color: var(--text-secondary);
          box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .tab-button i {
          font-size: 1.4em;
        }

        .tab-button.active {
          background: var(--primary-accent);
          color: white;
          transform: translateY(-2px);
          box-shadow: 0 5px 15px var(--primary-accent-light);
        }

        .tab-button:not(.active):hover {
          background: var(--bg-card);
          color: var(--text-primary);
          transform: translateY(-2px);
          box-shadow: var(--shadow);
        }

        .tab-content {
          display: none;
          animation: fadeIn 0.5s var(--anim-bezier);
          background: var(--bg-primary);
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .tab-content.active {
          display: block;
        }

        .section, .patient-info, .memory-section {
          background: var(--bg-card);
          padding: 15px;
          border-radius: var(--radius-card);
          box-shadow: var(--shadow-md);
          margin-bottom: 15px;
          transition: box-shadow .3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
          border: 1px solid var(--border-color);
        }

        .section:hover, .patient-info:hover, .memory-section:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-hover);
        }

        .section h2 {
          font-size: 1.25em;
          font-weight: 600;
          margin-bottom: 12px;
          color: var(--text-primary);
          border-bottom: 2px solid var(--border-color);
          padding-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .section h2 i {
          color: var(--primary-accent);
        }

        .category-heading {
            font-size: 1em;
            font-weight: 700;
            color: var(--primary-accent);
            margin-top: 20px;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
            grid-column: 1 / -1;
        }


        .disclaimer-container {
          margin-bottom: 15px;
        }

        .disclaimer-toggle {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          padding: 10px 15px;
          border-radius: var(--radius-card);
          cursor: pointer;
          font-size: 0.85em;
          font-weight: 600;
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: all 0.3s var(--anim-bezier);
          box-shadow: var(--shadow-md);
        }


        .disclaimer-toggle i:last-child {
            transition: transform 0.3s var(--anim-bezier);
        }

        .disclaimer-toggle:hover {
          background: var(--bg-secondary);
          border-color: var(--primary-accent);
        }

        .disclaimer-content {
          display: grid;
          grid-template-rows: 0fr; /* Collapsed */
          overflow: hidden;
          transition: grid-template-rows 0.4s var(--anim-bezier), margin-top 0.4s var(--anim-bezier), border-color 0.4s var(--anim-bezier);
          background: var(--bg-secondary);
          border-radius: var(--radius-card);
          margin-top: 0;
          border: 0px solid transparent;
        }

        .disclaimer-content.expanded {
          grid-template-rows: 1fr; /* Expanded */
          margin-top: 8px;
          border-color: var(--border-color);
        }

        
        .disclaimer-wrapper {
            overflow: hidden;
            padding: 0px;
        }


        .disclaimer-content.expanded + .disclaimer-toggle i:last-child {
            transform: rotate(180deg);
        }

        #disclaimer-arrow {
            transition: transform 0.3s ease;
        }

        .warning {
          background: #fffbeb;
          border-left: 5px solid #f59e0b;
          padding: 12px;
          border-radius: 8px;
          font-size: 0.8em;
          color: #b45309;
          font-weight: 500;
        }

        body.dark-mode .warning {
          background: #451a03;
          color: #fcd34d;
          border-left: 5px solid #f59e0b;
        }

        .input-group {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 12px;
          margin-top: 10px;
        }

        .hb-input-group {
          display: flex;
          gap: 8px;
        }

        .age-input-group {
          display: flex;
          gap: 8px;
        }

        .input-field label {
          font-size: .8em;
          color: var(--text-secondary);
          margin-bottom: 5px;
          font-weight: 600;
          display: block;
        }

        .input-field input {
          width: 100%;
          padding: 8px 12px;
          border: 2px solid var(--border-color);
          border-radius: var(--radius-input);
          font-size: .9em;
          background: var(--bg-primary);
          color: var(--text-primary);
          transition: border-color .3s var(--anim-bezier), box-shadow .3s var(--anim-bezier);
        }

        .input-field input:focus {
          outline: none;
          border-color: var(--primary-accent);
          box-shadow: 0 0 0 3px var(--primary-accent-light);
        }

        .weight-input-container {
          display: grid;
          grid-template-columns: 1fr auto;
          align-items: center;
          gap: 8px;
        }

        .weight-input-container input {
          grid-area: 1 / 1;
          width: 100%;
          min-width: 80px; 
        }
        .weight-input-container .unit-toggle-btn {
          grid-area: 1 / 2;
          height: 100%;
        }

        .unit-toggle-btn {
            display: flex;
            position: relative;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-left-width: 2px;
            height: 100%;
            border-radius: 50px;
            transition: all .25s var(--anim-bezier);
            flex-shrink: 0;
            padding: 4px;
            width: 100px;
            cursor: pointer;
            user-select: none;
        }
        .weight-input-container input:focus + .unit-toggle-btn {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px var(--primary-accent-light);
            z-index: 2;
        }
        .unit-slider {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: calc(50% - 4px);
            background: var(--primary-accent);
            border-radius: 50px;
            transition: left 0.3s var(--anim-bezier);
            z-index: 1;
        }
        .unit-toggle-btn.lbs-active .unit-slider {
            left: 50%;
        }
        .unit-option {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: .85em;
            color: var(--text-secondary);
            z-index: 2;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s var(--anim-bezier);
        }
        .unit-option.active {
            color: white;
        }
        body.dark-mode .unit-option.active {
            color: var(--bg-primary);
        }

        .height-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            display: grid;
            grid-template-columns: 1fr auto;
        }
        
        .height-input-container > input,
        .height-input-container > .height-input-group {
            grid-area: 1 / 1;
            transition: opacity 0.3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
            width: 100%;
        }

        .height-input-group {
            display: flex;
            gap: 8px;
        }

        .height-input-group input {
            width: 100%;
        }

        .height-input-group {
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
        }
        #height-cm {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .height-input-container.ft-active .height-input-group {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        .height-input-container.ft-active #height-cm {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }
        
        .height-input-container .unit-toggle-btn {
            grid-area: 1 / 2;
            height: 100%;
        }
        .height-input-container .unit-toggle-btn.lbs-active .unit-slider {
            left: 50%;
        }

        .input-with-status-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            grid-area: 1 / 1;
        }
        .input-with-status-wrapper input {
            width: 100%;
            height: 100%;
            padding-right: 95px; /* Space for the badge */
        }
        .weight-bmi-status {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            font-size: 0.75em;
            font-weight: 700;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 3px 6px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            display: none;
            pointer-events: none;
            white-space: nowrap;
        }

        .info-box {
          background: var(--bg-secondary);
          border-left: 4px solid var(--primary-accent);
          padding: 12px 15px;
          margin: 15px 0;
          border-radius: 8px;
          font-size: 0.85em;
          color: var(--text-secondary);
          animation: slideIn 0.5s var(--anim-bezier);
          border: 1px solid var(--border-color);
        }

        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(-10px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .info-box strong {
          color: var(--primary-accent);
          font-weight: 600;
        }

        .info-box.ketorolac-specific {
          border-left-color: var(--analgesic);
          margin-top: 5px;
          margin-bottom: 5px;
          background: var(--bg-secondary);
          color: var(--text-primary);
          font-weight: 500;
          font-size: 0.8em;
          padding: 8px 10px;
        }

        .drug-card {
          border-radius: var(--radius-card);
          padding: 12px;
          border-left: 6px solid;
          background: var(--bg-secondary);
          transition: all .35s var(--anim-bezier);
          position: relative;
          z-index: 1;
          will-change: transform, box-shadow, background-color;
          animation: cardAppear 0.5s var(--anim-bezier);
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
        }

        @keyframes cardAppear {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .drug-card.caution-active {
          z-index: 20;
          border-left-color: var(--caution-color) !important;
          box-shadow: 0 0 15px -3px var(--caution-color);
          border-color: var(--caution-color);
        }
       .drug-card.dose-limit-exceeded {
            z-index: 20;
            border-left-color: var(--reversal) !important;
            box-shadow: 0 0 15px -3px var(--reversal);
            border-color: var(--reversal);
        }
        .drug-card:hover {
          box-shadow: var(--shadow-hover);
          transform: translateY(-3px);
          background: var(--bg-card);
        }

        .drug-card.induction { border-left-color: var(--induction) }
        .drug-card.muscle-relaxant { border-left-color: var(--muscle-relaxant) }
        .drug-card.analgesic { border-left-color: var(--analgesic) }
        .drug-card.adjunct { border-left-color: var(--adjunct) }
        .drug-card.reversal { border-left-color: var(--reversal) }
        .drug-card.emergency { border-left-color: var(--emergency) }
        .drug-card.steroid { border-left-color: var(--steroid) }
        .drug-card.antiemetic { border-left-color: var(--antiemetic) }
        .drug-card.local-anesthetic { border-left-color: var(--local-anesthetic) }
        .drug-card.infusion { border-left-color: var(--infusion) }
        .drug-card.antibiotic { border-left-color: var(--antibiotic) }

            .drug-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: pointer;
          user-select: none;
          flex-direction: row;
          flex-wrap: nowrap;
          gap: 5px;
        }


        .drug-card.expanded .drug-header {
          padding-bottom: 8px;
        }

        .drug-name {
          font-weight: 700;
          font-size: 1.05em;
          color: var(--text-primary);
          display: flex;
          align-items: center;
        }
        .toggle-icon {
          font-size: 1em;
          margin-right: 8px;
          transform: rotate(0deg);
          transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          will-change: transform;
          color: var(--primary-accent);
        }

        .drug-card.expanded .toggle-icon {
          transform: rotate(90deg);
        }

        .drug-details {
          display: grid;
          grid-template-rows: 0fr;
          max-height: none;
          overflow: hidden;
          transition: grid-template-rows 0.35s var(--anim-bezier);
          will-change: grid-template-rows;
        }

        .drug-card.expanded .drug-details {
          grid-template-rows: 1fr;
          max-height: none;
        }

        .drug-card.expanded .drug-details > .details-wrapper,
        .drug-card.expanded .infusion-details > .details-wrapper,
        .drug-card.expanded .antibiotic-details > .details-wrapper {
            opacity: 1;
            transform: translateY(0);
        }
        
        .details-wrapper {
            overflow: hidden;
        }

        .drug-details > .details-wrapper {
            padding-top: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
            will-change: opacity, transform;
        }


        .drug-category {
          font-size: 0.65em;
          padding: 4px 8px;
          border-radius: 20px;
          color: #fff;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: .5px;
          background-color: var(--border-color);
        }
        .drug-category.induction { background-color: var(--induction); }
        .drug-category.muscle-relaxant { background-color: var(--muscle-relaxant); }
        .drug-category.analgesic { background-color: var(--analgesic); }
        .drug-category.adjunct { background-color: var(--adjunct); }
        .drug-category.reversal { background-color: var(--reversal); }
        .drug-category.emergency { background-color: var(--emergency); }
        .drug-category.steroid { background-color: var(--steroid); }
        .drug-category.antiemetic { background-color: var(--antiemetic); }
        .drug-category.local-anesthetic { background-color: var(--local-anesthetic); }
        .drug-category.infusion { background-color: var(--infusion); }
        .drug-category.antibiotic { background-color: var(--antibiotic); }

        body.dark-mode .drug-category.emergency {
            color: #000;
        }

        .dose-info {
          font-size: .75em;
          color: var(--text-secondary);
          font-style: italic;
          margin-top: 4px;
        }

        .caution-icon {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 18px;
          height: 18px;
          line-height: 18px;
          text-align: center;
          border-radius: 50%;
          background-color: var(--caution-color);
          color: #000;
          font-weight: bold;
          font-size: .7em;
          cursor: pointer;
          margin-left: 8px;
          flex-shrink: 0;
          align-self: flex-start;
          transition: all 0.2s var(--anim-bezier);
        }
        .caution-icon:hover {
            transform: scale(1.2);
        }
    .dose-limit-exceeded .caution-icon {
            background-color: var(--reversal);
            color: white;
        }
        .caution-popup {
          display: none;
          position: absolute;
          z-index: 30;
          padding: 10px;
          background: var(--bg-card);
          color: var(--text-primary);
          border: 1px solid var(--caution-color);
          border-radius: 8px;
          box-shadow: var(--shadow-hover);
          width: 220px;
          font-size: .75em;
          top: 12px;
          right: 12px;
          white-space: normal;
          animation: popIn 0.3s var(--anim-bezier);
        }
        .drug-header-right-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

            .drug-dose-preview {
            font-weight: 700;
            font-size: 0.9em;
            color: var(--primary-accent);
            padding: 3px 8px;
            border-radius: 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: opacity 0.3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
            white-space: nowrap;
            opacity: 1;
            transform: scale(1);
            max-width: 150px;
            overflow: hidden;
        }


        .drug-card.expanded .drug-dose-preview {
            opacity: 0;
            transform: scale(0.8);
        }

        .drug-name {
            flex: 1;
            min-width: 0;
            margin-right: 5px;
        }

        @keyframes popIn {
          from {
            opacity: 0;
            transform: scale(0.8);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }

        .dose-limit-applied {
          font-size: .7em;
          color: var(--reversal);
          font-weight: 600;
          display: block;
          margin-top: 2px;
        }

        .calculation {
          background: var(--bg-primary);
          padding: 10px;
          border-radius: var(--radius-input);
          margin-top: 8px;
          border: 1px solid var(--border-color);
        }

        .calculation-result {
          font-weight: 800;
          font-size: 1.2em;
          color: var(--primary-accent);
        }

        body.dark-mode .calculation-result {
            color: var(--primary-accent);
        }
        
        .calculation-result .dose-limit-applied {
            color: var(--reversal);
        }

        .volume-result {
          font-size: .8em;
          color: var(--text-secondary);
          margin-top: 3px;
          font-weight: 500;
        }

        .edit-btn, .memory-btn, .saved-item-btn, .infusion-rate-btn, .expand-all-btn {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: .8em;
            font-weight: 600;
            cursor: pointer;
            transition: all .25s var(--anim-bezier);
            border: 2px solid transparent;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .edit-btn:hover, .memory-btn:hover, .saved-item-btn:hover, .infusion-rate-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .edit-btn:active, .memory-btn:active, .saved-item-btn:active, .infusion-rate-btn:active {
            transform: translateY(0px);
            box-shadow: var(--shadow);
        }
		.edit-btn, .memory-btn {
            background: transparent;
            border-color: var(--primary-accent);
            color: var(--primary-accent);
            margin-top: 8px;
        }

        .edit-btn:hover, .memory-btn:hover {
            background: var(--primary-accent);
            color: var(--bg-card);
            box-shadow: 0 4px 10px var(--primary-accent-light);
        }

        .edit-actions .edit-btn {
            margin-top: 0;
            background: var(--primary-accent);
            color: var(--bg-card);
        }
        .edit-actions .edit-btn:hover {
            background: var(--primary-accent-dark);
        }

        .edit-btn.reset-btn, .memory-btn.warning {
            color: var(--reset-color);
            border-color: var(--reset-color);
            background: transparent;
        }

        .edit-btn.reset-btn:hover, .memory-btn.warning:hover {
            background: var(--reset-color);
            color: var(--bg-card);
            box-shadow: 0 4px 10px rgba(239, 68, 68, .3);
        }

        .memory-btn.secondary {
          background: transparent;
          color: var(--text-secondary);
          border-color: var(--border-color);
        }

        .memory-btn.secondary:hover {
          background: var(--bg-secondary);
          color: var(--text-primary);
          border-color: var(--text-secondary);
        }

        /* Print Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-card);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            text-align: center;
            animation: popIn 0.3s var(--anim-bezier);
        }
        .modal-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .modal-btn {
            padding: 12px;
            border-radius: var(--radius-input);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn:hover {
            background: var(--primary-accent);
            color: white;
            border-color: var(--primary-accent);
        }
        .modal-btn.cancel {
            color: var(--text-secondary);
        }
        .modal-btn.cancel:hover {
            background: var(--bg-secondary);
            color: var(--reversal);
            border-color: var(--reversal);
        }

        .infusion-rate-btn {
            background: var(--primary-accent);
            color: var(--bg-card);
            border: none;
            font-size: 1.1em;
            font-weight: 700;
            box-shadow: var(--shadow-md);
            text-align: center;
            margin-top: 10px;
            width: 100%;
        }
        .infusion-rate-btn:hover {
            background: var(--primary-accent-dark);
        }

        .edit-inputs {
          display: grid;
          grid-template-rows: 0fr;
          overflow: hidden;
          transition: grid-template-rows 0.4s var(--anim-bezier), margin-top 0.4s var(--anim-bezier);
          margin-top: 0;
        }

        .edit-inputs.active {
          grid-template-rows: 1fr;
          margin-top: 10px;
        }
        
        .edit-inputs-wrapper {
            overflow: hidden;
        }
        
        .edit-inputs > .edit-inputs-wrapper {
            min-width: 0;
        }
        
        .edit-inputs-content {
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-input);
            border: 1px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @keyframes slideDown {
          from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
          }
          to {
            opacity: 1;
            max-height: 150px;
            transform: translateY(0);
          }
        }

        .edit-input-grid {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .edit-input-field {
            flex: 1;
        }

        .edit-input-field label {
            font-size: 0.7em;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .edit-input-field input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.8em;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
		.edit-input-field input:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px var(--primary-accent-light);
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .infusion-edit-pane {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: var(--radius-input);
            border: 1px dashed var(--border-color);
        }
        .infusion-dilution-input {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .infusion-dilution-input label {
            font-size: 0.7em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
            width: 100%;
        }

        .infusion-dilution-input .input-wrapper {
            flex: 1;
            min-width: 60px;
        }

        .infusion-dilution-input .input-wrapper input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.8em;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .infusion-dilution-input select {
            padding: 6px 4px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.8em;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            height: 30px;
            margin-top: auto;
        }

        .infusion-dilution-input .separator {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: 600;
            align-self: flex-end;
            padding-bottom: 6px;
        }

        .route-selector, .indication-selector {
          display: flex;
          gap: 8px;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px dashed var(--border-color);
          flex-wrap: wrap;
        }

        .indication-selector {
            flex-direction: column;
        }

        .route-selector label, .indication-selector label {
          display: flex;
          align-items: center;
          cursor: pointer;
          font-size: 0.75em;
          color: var(--text-secondary);
          font-weight: 600;
          padding: 6px 12px;
          border-radius: 50px;
          background: var(--bg-primary);
          border: 1px solid var(--border-color);
          transition: all 0.2s var(--anim-bezier);
        }

        .route-selector input[type="radio"], .indication-selector input[type="radio"] {
          display: none;
        }

        .route-selector input[type="radio"]:focus-visible + label,
        .indication-selector input[type="radio"]:focus-visible + label {
            outline: 2px solid var(--primary-accent);
            outline-offset: 2px;
        }

        .route-selector input[type="radio"]:checked+label {
          background: var(--primary-accent);
          color: var(--bg-card);
          border-color: var(--primary-accent);
          box-shadow: 0 2px 4px var(--primary-accent-light);
        }

        .indication-selector input[type="radio"]:checked+label {
          background: var(--antibiotic);
          color: var(--bg-card);
          border-color: var(--antibiotic);
          box-shadow: 0 2px 4px rgba(120, 113, 108, 0.3);
        }

        .drugs-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 12px;
          margin-top: 10px;
        }

        .equipment-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
          gap: 12px;
          margin-top: 10px;
        }

        .equipment-card {
          background: var(--bg-secondary);
          padding: 12px;
          border-radius: var(--radius-card);
          text-align: center;
          border-top: 4px solid var(--primary-accent);
          transition: all .3s var(--anim-bezier);
          animation: cardAppear 0.5s var(--anim-bezier);
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
        }

        .equipment-card:hover {
          transform: translateY(-3px);
          box-shadow: var(--shadow-hover);
        }

        .equipment-title {
          font-size: .85em;
          color: var(--text-secondary);
          margin-bottom: 6px;
          font-weight: 600;
        }

        .equipment-value {
          font-size: 1.4em;
          font-weight: 800;
          color: var(--primary-accent);
          line-height: 1.1;
        }

        .equipment-value.error {
          color: var(--reversal);
          font-size: .85em;
          font-weight: 600;
          line-height: 1.3;
        }

        .equipment-detail {
          font-size: .7em;
          color: var(--text-secondary);
          margin-top: 4px;
        }

        .expand-all-btn {
          margin-top: 5px;
          margin-bottom: 12px;
          display: block;
          width: 100%;
          max-width: 350px;
          text-align: center;
          margin-left: auto;
          margin-right: auto;
        }

        .la-results-container {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-top: 10px;
        }

        .la-result-row {
          display: grid;
          grid-template-columns: 2fr 1.5fr;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px dotted var(--border-color);
        }

        .la-result-row:last-child {
          border-bottom: none;
        }

        .la-name {
          font-weight: 600;
          font-size: 0.95em;
          color: var(--text-primary);
        }

        .la-max-dose {
          font-weight: 800;
          font-size: 1.1em;
          color: var(--reversal);
          text-align: right;
        }

        .la-detail {
          display: block;
          font-weight: 500;
          font-size: 0.7em;
          color: var(--text-secondary);
          line-height: 1.3;
        }

        .infusion-details, .antibiotic-details {
          display: grid;
          grid-template-rows: 0fr;
          max-height: none;
          overflow: hidden;
          transition: grid-template-rows 0.35s var(--anim-bezier);
          will-change: grid-template-rows;
        }
        
        .drug-card.expanded .infusion-details,
        .drug-card.expanded .antibiotic-details {
            grid-template-rows: 1fr;
            max-height: none;
        }
        
        .infusion-details > .details-wrapper,
        .antibiotic-details > .details-wrapper {
            overflow: hidden;
            padding-top: 12px;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
            will-change: opacity, transform;
        }


        .infusion-detail-row, .antibiotic-detail-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          padding: 8px 0;
          border-bottom: 1px dotted var(--border-color);
        }

        .infusion-detail-row:last-child, .antibiotic-detail-row:last-child {
          border-bottom: none;
        }

        .infusion-label, .antibiotic-label {
          font-weight: 600;
          font-size: 0.85em;
          color: var(--text-primary);
        }

        .infusion-value, .antibiotic-value {
          font-weight: 600;
          font-size: 0.85em;
          color: var(--primary-accent);
          text-align: right;
        }

        .antibiotic-value {
            color: var(--antibiotic);
        }

        .infusion-note, .antibiotic-note {
          font-size: 0.75em;
          color: var(--text-secondary);
          font-style: italic;
          margin-top: 3px;
          grid-column: 1 / -1;
        }

        .favorite-toggle-btn {
          color: var(--border-color);
          font-size: 1.1em;
          margin-right: 10px;
          cursor: pointer;
          transition: all 0.3s var(--anim-bezier);
          vertical-align: middle;
        }

        @media (hover: hover) and (pointer: fine) {
          .favorite-toggle-btn:hover {
            color: #f59e0b;
            transform: scale(1.2);
          }
        }

        .favorite-toggle-btn.favorited {
          color: #f59e0b;
          text-shadow: 0 0 10px var(--caution-color);
        }
        
        .favorite-toggle-btn.pulse {
          animation: starPulse 0.4s var(--anim-bezier);
        }

        @keyframes starPulse {
          0% { transform: scale(1.1); }
          50% { transform: scale(1.4); }
          100% { transform: scale(1); }
        }

        .favorites-filter-container {
          margin-bottom: 15px;
        }

        .favorites-filter-toggle {
          background: var(--bg-card);
          border: 1px solid var(--border-color);
          color: var(--text-secondary);
          padding: 8px 16px;
          border-radius: 50px;
          font-size: .8em;
          font-weight: 600;
          cursor: pointer;
          transition: all .25s var(--anim-bezier);
          display: inline-flex;
          align-items: center;
          gap: 8px;
          box-shadow: var(--shadow);
        }
        .favorites-filter-toggle:hover {
          border-color: var(--caution-color);
          color: var(--caution-color);
          box-shadow: var(--shadow-md);
        }

        .favorites-filter-toggle.active {
          background: var(--caution-color);
          border-color: var(--caution-color);
          color: #000;
          box-shadow: 0 4px 10px rgba(245, 158, 11, .3);
        }
        body.dark-mode .favorites-filter-toggle.active {
            color: #000;
        }

        footer {
          text-align: center;
          margin-top: 20px;
          font-size: 0.8em;
          color: var(--text-secondary);
          padding: 20px 10px;
          border-top: 1px solid var(--border-color);
        }

        footer a {
          color: var(--primary-accent);
          text-decoration: none;
          font-weight: 600;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .memory-controls {
          display: flex;
          gap: 10px;
          margin-top: 10px;
          flex-wrap: wrap;
        }

        .memory-input {
          flex: 1;
          min-width: 150px;
          padding: 10px 12px;
          border: 2px solid var(--border-color);
          border-radius: var(--radius-input);
          font-size: .9em;
          background: var(--bg-primary);
          color: var(--text-primary);
          transition: border-color .3s var(--anim-bezier), box-shadow .3s var(--anim-bezier);
        }

        .memory-input:focus {
          outline: none;
          border-color: var(--primary-accent);
          box-shadow: 0 0 0 3px var(--primary-accent-light);
        }

        .saved-items-container {
          margin-top: 15px;
          max-height: 200px;
          overflow-y: auto;
          border: 1px solid var(--border-color);
          border-radius: var(--radius-input);
          padding: 10px;
          background: var(--bg-primary);
        }

        .saved-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 10px;
          margin-bottom: 5px;
          background: var(--bg-secondary);
          border-radius: var(--radius-input);
          transition: background .3s var(--anim-bezier);
          border: 1px solid var(--border-color);
        }

        .saved-item:hover {
          background: var(--bg-card);
          border-color: var(--primary-accent);
        }

        .saved-item:last-child {
          margin-bottom: 0;
        }

        .saved-item-name {
          font-weight: 600;
          font-size: .85em;
          color: var(--text-primary);
        }

        .saved-item-details {
          font-size: .7em;
          color: var(--text-secondary);
        }

        .saved-item-actions {
          display: flex;
          gap: 5px;
        }

        .saved-item-btn {
          background: transparent;
          border: 1px solid var(--border-color);
          color: var(--text-secondary);
          font-size: .8em;
          padding: 4px 8px;
          border-radius: 4px;
        }

        .saved-item-btn:hover {
          background: var(--primary-accent);
          color: var(--bg-card);
          border-color: var(--primary-accent);
        }

        .saved-item-btn.delete:hover {
          background: var(--reversal);
          color: var(--bg-card);
          border-color: var(--reversal);
        }

        .custom-values-indicator {
          background: var(--primary-accent-light);
          border: 1px solid var(--primary-accent);
          color: var(--primary-accent-dark);
          padding: 12px 15px;
          border-radius: var(--radius-card);
          margin-bottom: 15px;
          font-size: .85em;
          font-weight: 600;
          display: flex;
          justify-content: space-between;
          align-items: center;
          animation: slideIn 0.5s var(--anim-bezier);
          box-shadow: var(--shadow);
        }

        body.dark-mode .custom-values-indicator {
            color: var(--primary-accent);
        }

        .no-saved-items {
          text-align: center;
          color: var(--text-secondary);
          font-style: italic;
          padding: 20px;
          font-size: .85em;
        }

        .custom-indicator {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: var(--primary-accent);
          margin-left: 6px;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% {
            transform: scale(0.95);
            opacity: 0.7;
          }
          50% {
            transform: scale(1.1);
            opacity: 1;
          }
          100% {
            transform: scale(0.95);
            opacity: 0.7;
          }
        }

        .drug-name.has-custom::after {
          content: "";
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: var(--primary-accent);
          margin-left: 8px;
          animation: pulse 2s infinite;
        }

        @media(min-width:768px) {
          .container {
            padding: 20px 15px;
          }

          .drugs-grid {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            align-items: start; /* Prevents cards from stretching/overlapping when neighbors expand */
          }
          
          .drug-card {
            min-width: 0; /* Prevents horizontal content overflow/overlapping */
            max-width: 100%;
          }

          .equipment-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            align-items: start;
          }

          h1 {
            font-size: 2em;
          }

          .section h2 {
            font-size: 1.5em;
          }

          .drug-name {
            font-size: 1.2em;
            flex: 1 1 auto; /* Allows name to shrink so it can wrap */
            white-space: normal; /* Turns on wrapping */
            overflow-wrap: anywhere; /* Breaks long words if needed */
            margin-right: 10px;
          }

          .drug-header {
            flex-wrap: wrap; /* Allows the header row to wrap on large screens */
            gap: 8px;
            row-gap: 4px;
          }


          .tab-button {
            min-width: 150px;
            flex-direction: row;
            justify-content: center;
            font-size: 0.9em;
          }

          .tab-button i {
            font-size: 1.1em;
            margin-right: 8px;
          }
        }

        /* --- New Attractive Print Button Styles --- */
        .print-featured-btn {
            background: linear-gradient(135deg, var(--primary-accent) 0%, var(--primary-accent-dark) 100%);
            color: white !important; /* Force white text for contrast */
            border: none;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px var(--primary-accent-light);
            transition: all 0.3s var(--anim-bezier);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            animation: gentlePulse 3s infinite;
            margin-top: 0; 
            margin-bottom: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .print-featured-btn i {
            font-size: 1.1em;
        }

        .print-featured-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--primary-accent-light);
            filter: brightness(1.05);
        }
        
        .print-featured-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px var(--primary-accent-light);
        }

        /* Shimmer effect on hover */
        .print-featured-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        
        .print-featured-btn:hover::after {
            left: 100%;
            transition: 0.5s;
        }

        @keyframes gentlePulse {
            0% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(5, 150, 105, 0); }
            100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0); }
        }
        
        /* Adjust for dark mode specific contrast */
        body.dark-mode .print-featured-btn {
             box-shadow: 0 4px 10px rgba(0,0,0,0.4);
             color: #000 !important; /* Dark text on the brighter neon green in dark mode */
             text-shadow: none;
        }
        body.dark-mode .print-featured-btn:hover {
            box-shadow: 0 6px 15px rgba(52, 211, 153, 0.3);
        }
        @media (max-width: 480px) {
          .print-featured-btn {
              padding: 6px 12px;
          }
          .print-featured-btn span {
              display: none; /* Hide text "Summary" on very small screens if needed, or keep it */
          }
          .tab-button {
            min-width: 90px;
            padding: 8px 6px;
            font-size: 0.7em;
            gap: 3px;
          }
          .drug-header-right-group .drug-category {
              display: none;
          }

          .drug-dose-preview {
              font-size: 0.75em;
              padding: 2px 5px;
          }

          .drug-card {
            padding: 8px;
          }
          .drug-name {
            font-size: 1.0em;
          }
          .calculation-result {
            font-size: 1.1em;
          }
          .volume-result, .dose-info {
            font-size: 0.75em;
            margin-top: 2px;
          }
          .equipment-card {
            padding: 10px;
          }
          .equipment-value {
            font-size: 1.25em;
          }
          .equipment-title {
            font-size: 0.8em;
          }
          .drugs-grid {
            gap: 8px;
          }
          .route-selector {
            gap: 5px;
            margin-bottom: 8px;
          }
          .route-selector label {
            padding: 4px 10px;
            font-size: 0.7em;
          }
          .calculation {
            padding: 8px;
            margin-top: 5px;
          }
          .infusion-edit-pane {
            padding: 8px;
            gap: 8px;
          }
          .infusion-dilution-input .input-wrapper input {
            padding: 4px;
          }

          input[type="number"], input[type="text"], textarea, input[type="search"] {
              font-size: 16px !important; /* Prevent iOS zoom */
          }

          .memory-input {
            min-width: 100%;
          }

          header::before {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0) 60%);
            animation-duration: 2.5s;
          }
        
          .header-controls {
            flex-wrap: wrap;
            justify-content: flex-end;
            flex-grow: 1;
            gap: 8px;
          }
          .font-size-control {
            padding: 2px;
          }
          .font-adjust-btn {
            padding: 4px 6px;
            font-size: 0.9em;
          }
          .dark-mode-toggle {
            padding: 6px 12px;
            font-size: 0.7em;
            min-width: 100px;
          }
          h1 {
            font-size: 1.15em;
          }

        }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "SoftwareApplication",
          "name": "Pediatric Anesthesia Calculator",
          "operatingSystem": "Web Browser, iOS, Android",
          "applicationCategory": "MedicalApplication",
          "url": "https://YOUR-WEBSITE-URL.com/",
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
          },
          "author": {
              "@id": "#kiranraj"
          },
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "124",
            "bestRating": "5",
            "worstRating": "1"
          },
          "featureList": "Pediatric Drug Dosage, PALS Emergency Algorithms, Airway Equipment Sizing, Fluid Maintenance (4-2-1), LAST Protocol",
          "audience": {
            "@type": "MedicalAudience",
            "audienceType": "Clinician"
          }
        },
        {
          "@type": "MedicalWebPage",
          "@id": "https://pedicalc.pages.dev/",
          "name": "Pediatric Anesthesia & Emergency Drug Dosage Calculator",
          "description": "Free pediatric anesthesia calculator for medical professionals. Calculate drug doses, airway equipment sizing, fluid management, and emergency medications based on weight and age.",
          "lastReviewed": "2025-11-12",
          "author": {
              "@id": "#kiranraj"
          },
          "specialty": [
            { "@type": "MedicalSpecialty", "name": "Anesthesia" },
            { "@type": "MedicalSpecialty", "name": "Pediatrics" },
            { "@type": "MedicalSpecialty", "name": "Emergency Medicine" }
          ],
          "about": {
            "@type": "MedicalEntity",
            "name": "Pediatric Drug Dosage Calculation"
          }
        },
        {
          "@type": "Person",
          "@id": "#kiranraj",
          "name": "Dr. Kiran Raj",
          "jobTitle": "Anesthesiologist",
          "url": "https://www.instagram.com/kiranrajkp?igsh=MWR0OG9ncjVvMnQ0Zw==/"
        }
      ]
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "How do you calculate pediatric ETT size?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "For uncuffed tubes, use Cole's Formula: (Age / 4) + 4. For cuffed tubes, the formula is typically (Age / 4) + 3.5. This calculator automatically determines the internal diameter and insertion depth based on patient age."
          }
        },
        {
          "@type": "Question",
          "name": "What is the 4-2-1 rule for fluid maintenance?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The Holliday-Segar rule calculates hourly fluid requirements: 4 mL/kg/hr for the first 10kg, 2 mL/kg/hr for the next 10kg, and 1 mL/kg/hr for every kg thereafter."
          }
        },
        {
          "@type": "Question",
          "name": "What is the pediatric dose for Epinephrine in cardiac arrest?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The standard PALS dose for Epinephrine in cardiac arrest is 0.01 mg/kg (10 mcg/kg), which equates to 0.1 mL/kg of the 1:10,000 concentration."
          }
        }
      ]
    }
    </script>
	
<script src="html2pdf.bundle.min.js"></script>
</head>

<body>
<div class="container">
    <header>
        <h1><i class="fas fa-calculator"></i> Pediatric Anesthesia Calculator</h1>
        <div class="header-controls">
            <div class="font-size-control">
                <button class="font-adjust-btn" onclick="adjustFontSize(-1)" aria-label="Decrease font size">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span id="font-size-indicator">100%</span>
                <button class="font-adjust-btn" onclick="adjustFontSize(1)" aria-label="Increase font size">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>

            <button id="pwa-install-btn" class="dark-mode-toggle" style="display: none;" onclick="installPWA()">
                <i class="fas fa-download"></i> <span>Install App</span>
            </button>

            <button id="dark-mode-btn" class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i> <span>Dark Mode</span>
            </button>
        </div>
    </header>

 

    <div class="disclaimer-container">
        <div class="disclaimer-toggle" onclick="toggleDisclaimer()">
            <span><i class="fas fa-exclamation-triangle" style="color: var(--caution-color);"></i> Disclaimer (Read this first)</span>
            <i class="fas fa-chevron-down" id="disclaimer-arrow"></i>
        </div>
        <div class="disclaimer-content" id="disclaimer-content">
            <div class="disclaimer-wrapper">
                <div class="warning">
                    The information provided by this calculator is strictly for estimation and reference purposes. You are required to exercise independent professional judgment and verify all calculations against approved institutional and regulatory standards. No warranties, express or implied, are made regarding the accuracy or completeness of the data. The developers and distributors disclaim all liability for damages arising from the use or inability to use this information.
                </div>
            </div>
        </div>
    </div>

    <div id="patient-safety-header" class="patient-safety-header" style="display: none;">
        <span id="safety-header-age">---</span>
        <span id="safety-header-weight">---</span>
        <span id="safety-header-bmi" style="display: none;">---</span>
        <span id="safety-header-bmi-percentile" style="display: none;">---</span>
        <span id="safety-header-bsa" style="display: none;">---</span>
    </div>
 

    <div class="tab-navigation">
        <div class="tab-button active" data-tab="patient-info">
            <i class="fas fa-user-injured"></i>
            <span>Patient Info</span>
        </div>
        <div class="tab-button" data-tab="airway-fluids">
            <i class="fas fa-lungs"></i>
            <span>Airway & Fluids</span>
        </div>
        <div class="tab-button" data-tab="normal-values">
            <i class="fas fa-heartbeat"></i>
            <span>Normal Values</span>
        </div>
        <div class="tab-button" data-tab="local-anesthetics">
            <i class="fas fa-syringe"></i>
            <span>Local Anesthetics</span>
        </div>
        <div class="tab-button" data-tab="drug-calculations">
            <i class="fas fa-pills"></i>
            <span>Drugs</span>
        </div>
        <div class="tab-button" data-tab="infusions">
            <i class="fas fa-tint"></i>
            <span>Infusions</span>
        </div>
        <div class="tab-button" data-tab="antibiotics">
            <i class="fas fa-bacteria"></i>
            <span>Antibiotics</span>
        </div>
        <div class="tab-button" data-tab="info">
            <i class="fas fa-info-circle"></i>
            <span>Info</span>
        </div>
        </div>

    <div class="tab-content active" id="patient-info">
        <section class="patient-info">
            <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <span><i class="fas fa-user-circle"></i> Patient Information</span>
                <div style="display:flex; gap:10px; align-items: center;">
                    <button class="print-featured-btn" onclick="openPrintModal()">
                        <i class="fas fa-print"></i> Print Summary
                    </button>
                    <button class="memory-btn secondary" id="clear-patient-info-btn" style="padding: 6px 12px; font-size: 0.7em; margin-top: 0; margin-bottom: 0; height: 100%;" onclick="clearPatientInfo()">
                        <i class="fas fa-times"></i> Reset
                    </button>
                </div>
            </h2>
            <div class="input-group">
                <div class="input-field">
                    <label for="age-years">Age</label>
                    <div class="age-input-group">
                        <input type="number" id="age-years" placeholder="Years" step="1" min="0" max="18" oninput="debouncedClampAndCalculate()">
                        <label for="age-months"></label>
                        <input type="number" id="age-months" placeholder="Months" step="1" min="0" max="11" oninput="debouncedClampAndCalculate()">
                    </div>
                </div>

                <div class="input-field">
                    <label for="weight" id="weight-label">Weight (kg)</label>
                    <div class="weight-input-container">
                        <div class="input-with-status-wrapper">
                            <input type="number" id="weight" placeholder="Enter weight in kg" step="0.1" min="0" oninput="debouncedCalculateAll()">
                            <span id="weight-bmi-status" class="weight-bmi-status"></span>
                        </div>
                        <div class="unit-toggle-btn" id="unit-toggle" aria-label="Toggle weight unit">
                            <div class="unit-slider"></div>
                            <div class="unit-option" data-unit="kg">kg</div>
                            <div class="unit-option" data-unit="lbs">lbs</div>
                        </div>
                        </div>
                </div>

                <div class="input-field">
                    <label for="height-cm" id="height-label">Height (cm)</label>
                    <div class="height-input-container" id="height-input-container">
                        <input type="number" id="height-cm" placeholder="cm" step="0.1" min="0" oninput="debouncedCalculateAll()">
                        
                        <div class="height-input-group">
                            <input type="number" id="height-ft" placeholder="ft" step="1" min="0" oninput="debouncedCalculateAll()">
                            <input type="number" id="height-in" placeholder="in" step="0.1" min="0" max="11.9" oninput="debouncedCalculateAll()">
                        </div>

                        <div class="unit-toggle-btn" id="height-unit-toggle" aria-label="Toggle height unit">
                            <div class="unit-slider"></div>
                            <div class="unit-option" data-unit="cm">cm</div>
                            <div class="unit-option" data-unit="ft">ft</div>
                        </div>
                    </div>
                </div>

                <div class="input-field">
                    <label>Hb (g/dL)</label>
                    <div class="hb-input-group">
                        <input type="number" id="currentHb" placeholder="Current" step="0.1" min="0" oninput="debouncedCalculateAll()">
                        <input type="number" id="targetHb" placeholder="Target" step="0.1" min="0" oninput="debouncedCalculateAll()">
                    </div>
                </div>
                <div class="input-field">
                    <label>Biological Sex</label>
                    <div class="route-selector" style="margin-bottom: 0; padding-bottom: 0; border: none;">
                        <input type="radio" id="sex-male" name="sex" value="male" checked onclick="debouncedCalculateAll()">
                        <label for="sex-male"><i class="fas fa-mars"></i> Male</label>
                        <input type="radio" id="sex-female" name="sex" value="female" onclick="debouncedCalculateAll()">
                        <label for="sex-female"><i class="fas fa-venus"></i> Female</label>
                    </div>
                </div>
                </div>
        </section>

        <section class="memory-section">
            <h2><i class="fas fa-save"></i> Patient Memory</h2>
            <div class="info-box">
                <strong>Save Patient Profiles:</strong> Store patient details for quick recall. Data is saved locally in your device.
            </div>

            <div class="input-field">
                <label for="patient-profile-name">Profile Name</label>
                <input type="text" id="patient-profile-name" placeholder="e.g., Jack Sparrow" class="memory-input">
            </div>

            <div class="memory-controls">
                <button class="memory-btn" onclick="savePatientProfile()">
                    <i class="fas fa-save"></i> Save Current Patient
                </button>
                <button class="memory-btn warning" onclick="clearAllPatientProfiles()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>

            <div id="patient-profiles-list" class="saved-items-container">
            </div>
        </section>

        <div style="margin-top: 10px; padding: 10px; border: 1px dashed var(--border-color); border-radius: var(--radius-card); font-size: 0.8em; color: var(--text-tertiary); text-align: center; background: var(--bg-secondary);">
            <strong>About PediCalc:</strong> A rapid <strong>pediatric anesthesia calculator</strong> for PALS algorithms, airway sizing, and fluid management. Enter <strong>Age & Weight</strong> above to instantly generate all parameters. Some parameters may require optional additional inputs. <br><em>*BMI estimates are based on simplified CDC growth charts. For accurate values refer official website.</em>
        </div>
    </div>

    <div class="tab-content" id="airway-fluids">
        <section class="section">
            <h2><i class="fas fa-wind"></i> Airway Equipment Sizing</h2>
            <div id="equipment-results" class="equipment-grid"></div>
        </section>

        <section class="section">
            <h2><i class="fas fa-tint"></i> Fluid & Blood Loss Requirements</h2>
            <div id="fluid-results" class="equipment-grid"></div>
        </section>
    </div>

    <div class="tab-content" id="normal-values">
        <section class="section">
            <h2><i class="fas fa-heartbeat"></i> Normal Physiological Values</h2>
            <div class="info-box">
                <strong>Age-Specific Data:</strong> These values are estimates for the patient's age group. Clinical judgment is required.
            </div>
            <div id="normal-values-results" class="equipment-grid"></div>
            <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 15px; text-align: center;">
                Data compiled from standard pediatric and PALS reference guidelines.
                <a href="https://www.ahajournals.org/doi/10.1161/CIR.0000000000000901" target="_blank" rel="noopener" style="color: var(--primary-accent);">[Source: 2020 AHA PALS Guidelines]</a>
            </div>
        </section>
    </div>

    <div class="tab-content" id="local-anesthetics">
        <section class="section">
            <h2><i class="fas fa-syringe"></i> Local Anesthetics - Maximum Doses</h2>
            <div class="info-box">
                <strong>Note:</strong> These are maximum recommended doses. Always use the lowest effective dose and consider patient factors.
            </div>
            <div id="local-anesthetics-results" classs="drugs-grid"></div>
        </section>
        
        <section class="section">
            <h2><i class="fas fa-life-ring"></i> L.A.S.T. Rescue (20% Intralipid)</h2>
            <div class="info-box" style="border-left-color: var(--reversal);">
                <strong>High Alert:</strong> For suspected Local Anesthetic Systemic Toxicity (LAST). This protocol is based on <a href="https://www.lipidrescue.org" target="_blank" style="color: var(--primary-accent);">LipidRescue.org</a> guidelines.
            </div>
            <div id="intralipid-results">
                </div>
        </section>
        <section class="section">
            <h2><i class="fas fa-calculator"></i> Caudal & MLAD Calculator</h2>
            <div class="info-box">
                <strong>Advanced Calculations:</strong> For Modified Armitage formula-based caudal calculation and Minimum Local Anesthetic Dose (MLAD).
            </div>
            <a href="mlad.html" class="infusion-rate-btn" target="_self">
                <i class="fas fa-external-link-alt"></i> Open Caudal & MLAD Calculator
            </a>
        </section>
        </div>

    <div class="tab-content" id="drug-calculations">
        <div id="custom-drugs-indicator" class="custom-values-indicator" style="display: none;">
            <span><i class="fas fa-info-circle"></i> Using Custom Drug Values: <span id="current-drug-set-name">Unknown</span> (<span id="modified-drugs-count">0</span> drugs modified)</span>
            <button class="memory-btn secondary" onclick="resetAllDrugsToDefault()" style="padding: 4px 8px; font-size: 0.7em;">
                <i class="fas fa-undo"></i> Reset to Default
            </button>
        </div>

        <section class="section">
            <h2><i class="fas fa-pills"></i> Drug Calculations</h2>
            
            <div class="warning" id="obesity-warning-box" style="display: none; margin-bottom: 15px;">
                <strong>Caution:</strong> Your patient may be overweight/obese. You may need to consider Ideal Body Weight (IBW) for dosing some medications.
            </div>
            <div class="info-box">
                    <strong>Route Selection:</strong> Some drugs can be administered via different routes. Select the appropriate route for your clinical scenario.
                </div>
                
                <div class="favorites-filter-container">
                    <button class="favorites-filter-toggle" id="favorites-filter-toggle" onclick="toggleFavoritesFilter()">
                        <i class="fas fa-star"></i> Show Favorites Only
                    </button>
                </div>

                <div class="input-field" style="margin-bottom: 15px;">
                <label for="drug-search" style="font-size: .8em; color: var(--text-secondary); margin-bottom: 5px; font-weight: 600; display: block;">
                    <i class="fas fa-search"></i> Search Drugs
                </label>
                <input type="search" id="drug-search"
                       placeholder="e.g., Propofol, Fentanyl..."
                       oninput="filterDrugs()">
            </div>
            <button class="expand-all-btn edit-btn" id="toggleAllBtn" onclick="toggleAllDrugs()">Expand All / Collapse All</button>
            <div id="drug-results" class="drugs-grid"></div>
        </section>

        <section class="memory-section">
            <h2><i class="fas fa-cogs"></i> Drug Settings Memory</h2>
            <div class="info-box">
                <strong>Save Custom Drug Settings:</strong> Store your modified drug doses and concentrations as named sets for quick recall.
            </div>

            <div class="input-field">
                <label for="drug-set-name">Settings Name</label>
                <input type="text" id="drug-set-name" placeholder="e.g., My Custom Doses" class="memory-input">
            </div>

            <div class="memory-controls">
                <button class="memory-btn" onclick="saveDrugSet()">
                    <i class="fas fa-save"></i> Save Current Settings
                </button>
                <button class="memory-btn warning" onclick="clearAllDrugSets()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>

            <div id="drug-sets-list" class="saved-items-container">
            </div>
        </section>
    </div>
	<div class="tab-content" id="infusions">
        <section class="section">
            <h2><i class="fas fa-tint"></i> Infusion Calculations</h2>
            <div class="info-box">
                <strong>Important:</strong> These are high-alert medications. <b>Always</b> verify calculations by self and with a second clinician. Use central lines when possible for vasoactive drugs.
            </div>
            <button class="expand-all-btn edit-btn" id="toggleAllInfusionsBtn" onclick="toggleAllInfusions()">Expand All / Collapse All</button>
            <div id="infusion-results" class="drugs-grid"></div>
        </section>

        <section class="section">
            <h2><i class="fas fa-calculator"></i> Infusion Rate Calculator</h2>
            <div class="info-box">
                <strong>Advanced Infusion Calculations:</strong> For more complex infusion scenarios including custom concentrations, multiple drugs, and detailed rate calculations.
            </div>
            <a href="calc.html" class="infusion-rate-btn" target="_self">
                <i class="fas fa-external-link-alt"></i> Open Infusion Rate Calculator
            </a>
        </section>
    </div>

    <div class="tab-content" id="antibiotics">
        <section class="section">
            <h2><i class="fas fa-bacteria"></i> Antibiotics</h2>
            <div class="info-box">
                <strong>Note:</strong> Antibiotic dosing varies by indication, severity, and patient factors. Always verify with local guidelines and consider renal function.
            </div>
            <button class="expand-all-btn edit-btn" id="toggleAllAntibioticsBtn" onclick="toggleAllAntibiotics()">Expand All / Collapse All</button>
            <div id="antibiotics-results" class="drugs-grid"></div>
        </section>
    </div>

    <div class="tab-content" id="info">
        <section class="section">
            <h2><i class="fas fa-info-circle"></i> A Deeper Dive into Pediatric Calculations</h2>
            <div class="info-box" style="border-left-color: var(--caution-color);">
                <strong>Important Disclaimer:</strong> This information is for educational and reference purposes only. It is <strong>not</strong> a substitute for professional clinical judgment. All calculations, doses, and clinical decisions must be verified by a qualified medical professional according to institutional policies and patient-specific factors.
            </div>
            <p style="margin-top: 10px; line-height: 1.6;">
                The axiom "children are not small adults" is the guiding principle of pediatric anesthesia. A child's physiology is in a constant state of change. Factors like a higher metabolic rate, larger body surface area-to-weight ratio, immature organ function, and different body compositions (e.g., higher total body water) drastically alter pharmacokinetics (what the body does to a drug) and pharmacodynamics (what the drug does to the body).
            </p>
            <p style="margin-top: 10px; line-height: 1.6;">
                For this reason, precise, weight-based calculations are the foundation of safety. This guide provides context for some of the most common formulas used in daily practice.
            </p>
        </section>
    
        <section class="section">
            <h2><i class="fas fa-tint"></i> Fluid and Blood Management</h2>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 10px; margin-bottom: 5px;">Maintenance Fluid Rate (The "4-2-1" Rule)</h3>
            <p>The Holliday-Segar ("4-2-1") rule estimates the hourly fluid required to replace basal losses for a 24-hour period. It is the foundation for calculating both maintenance infusions and fasting deficits.</p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>First 0-10 kg of body weight:</strong> 4 mL/kg/hr</li>
                <li><strong>Next 10-20 kg of body weight:</strong> 2 mL/kg/hr</li>
                <li><strong>For weight > 20 kg:</strong> 1 mL/kg/hr</li>
            </ul>
            <div class="info-box" style="margin-top: 10px;">
                <strong>Example for a 25 kg child:</strong><br>
                1. (10 kg  4 mL) = 40 mL/hr<br>
                2. (10 kg  2 mL) = 20 mL/hr<br>
                3. (5 kg  1 mL) = 5 mL/hr<br>
                <strong>Total Rate:</strong> 40 + 20 + 5 = <strong>65 mL/hr</strong>
            </div>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">NPO Fasting Guidelines (The '2-4-6' Rule)</h3>
            <p>This safety standard is designed to minimize the risk of pulmonary aspiration of stomach contents while also preventing dehydration. The "2-4-6" rule is a common mnemonic:</p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>2 Hours:</strong> Clear liquids (water, pulp-free juice)</li>
                <li><strong>4 Hours:</strong> Breast milk</li>
                <li><strong>6 Hours:</strong> Formula, non-human milk, light meal (e.g., toast, cereal)</li>
                <li><strong>8 Hours:</strong> Heavy, fatty, or fried meal</li>
            </ul>
            <div class="info-box" style="margin-top: 10px;">
                <strong>Example:</strong> A 2-year-old drinks 100 mL of formula at 6:00 AM. Their "6-hour" NPO time expires at 12:00 PM (noon). They are safe for an anesthetic to begin any time after 12:00 PM.
            </div>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Fasting Fluid Deficit</h3>
            <p>Patients are NPO (nil per os) before surgery, creating a fluid deficit. This is calculated as:</p>
            <div class="calculation" style="margin-top: 5px; text-align: center; padding: 15px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); background: var(--bg-primary);">
                Deficit (mL) = Maintenance Rate (mL/hr)  Hours NPO
            </div>
            <div class="info-box" style="margin-top: 10px;">
                <strong>Example for a 25 kg child (65 mL/hr rate) fasting for 6 hours:</strong><br>
                Deficit = 65 mL/hr  6 hrs = <strong>390 mL</strong><br>
                This 390 mL is replaced *in addition* to their ongoing 65 mL/hr maintenance.
            </div>
            <p style="margin-top: 10px;">This deficit is often replaced intraoperatively, typically by giving 50% in the first hour, 25% in the second hour, and 25% in the third hour, in addition to ongoing maintenance fluids.</p>


            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Estimated Blood Volume (EBV)</h3>
            <p>A child's blood volume (in mL/kg) is higher than an adult's (65-70 mL/kg) and varies significantly with age. This is critical for estimating MABL.</p>
            <div class="la-results-container" style="margin-top: 5px;">
                <div class="la-result-row"><div class="la-name">Premature Neonate</div><div class="la-max-dose" style="color: var(--text-primary);">90-100 <span class="la-detail">mL/kg</span></div></div>
                <div class="la-result-row"><div class="la-name">Full-Term Neonate (&lt;1m)</div><div class="la-max-dose" style="color: var(--text-primary);">80-90 <span class="la-detail">mL/kg</span></div></div>
                <div class="la-result-row"><div class="la-name">Infant (1m - 1y)</div><div class="la-max-dose" style="color: var(--text-primary);">75-80 <span class="la-detail">mL/kg</span></div></div>
                <div class="la-result-row"><div class="la-name">Child (&gt;1y)</div><div class="la-max-dose" style="color: var(--text-primary);">70-75 <span class="la-detail">mL/kg</span></div></div>
                <div class="la-result-row"><div class="la-name">Adult</div><div class="la-max-dose" style="color: var(--text-primary);">65-70 <span class="la-detail">mL/kg</span></div></div>
            </div>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Maximum Allowable Blood Loss (MABL)</h3>
            <p>This formula estimates the volume of blood loss (in mL) that can be tolerated before the patient's hemoglobin (Hb) reaches a pre-determined "target" level, often 8-10 g/dL. This calculator uses the initial Hb (Current Hb) for this formula.</p>
            <div class="calculation" style="margin-top: 5px; text-align: center; padding: 15px; font-size: 1.1em; font-weight: 600; color: var(--text-primary); background: var(--bg-primary);">
                MABL (mL) = EBV  (Initial Hb - Target Hb)  Initial Hb
            </div>
            <div class="info-box" style="margin-top: 10px;">
                <strong>Example for a 25 kg child (EBV 1875 mL, Initial Hb=14, Target Hb=10):</strong><br>
                MABL = 1875  (14 - 10)  14<br>
                MABL = 1875  4  14 = <strong>535 mL</strong>
            </div>
        </section>

        <section class="section">
            <h2><i class="fas fa-wind"></i> Airway Management Formulas</h2>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 10px; margin-bottom: 5px;">Endotracheal Tube (ETT) Sizing (Age &gt; 1 Year)</h3>
            <p>ETT size is based on the internal diameter (ID) in millimeters. Formulas provide an estimate; the correct size must be confirmed by assessing for an audible air leak around the tube.</p>
            <p style="margin-top: 5px;">
                Historically, uncuffed tubes were preferred due to the belief that the cricoid cartilage provided a natural "cuff." However, modern, high-volume, low-pressure cuffed tubes are now widely used as they offer a more reliable seal, reduce anesthetic gas pollution, and may lower aspiration risk.
            </p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Uncuffed ETT Size (Cole's Formula):</strong> (Age in years  4) + 4</li>
                <li><strong>Cuffed ETT Size:</strong> (Age in years  4) + 3.5 (or 0.5 mm smaller than uncuffed)</li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">ETT Insertion Depth (Oral)</h3>
            <p>These are estimates. Tube placement <strong>must</strong> always be confirmed clinically (bilateral breath sounds, chest rise) and with end-tidal capnography.</p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>For Neonates:</strong> Weight (kg) + 6 = Depth (cm at lip)</li>
                <li><strong>For Children (&gt;1 year):</strong> ETT Internal Diameter (mm)  3 = Depth (cm at lip)</li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Supraglottic Airway (LMA/i-gel) Sizing</h3>
            <p>Unlike ETTs, supraglottic airways are sized based on weight categories, which vary slightly by brand. A common approximation is:</p>
            <div class="la-results-container" style="margin-top: 5px;">
                <div class="la-result-row"><div class="la-name">&lt; 5 kg</div><div class="la-max-dose" style="color: var(--text-primary);">Size 1</div></div>
                <div class="la-result-row"><div class="la-name">5 - 10 kg</div><div class="la-max-dose" style="color: var(--text-primary);">Size 1.5</div></div>
                <div class="la-result-row"><div class="la-name">10 - 20 kg</div><div class="la-max-dose" style="color: var(--text-primary);">Size 2</div></div>
                <div class="la-result-row"><div class="la-name">20 - 30 kg</div><div class="la-max-dose" style="color: var(--text-primary);">Size 2.5</div></div>
                <div class="la-result-row"><div class="la-name">30 - 50 kg</div><div class="la-max-dose" style="color: var(--text-primary);">Size 3</div></div>
            </div>
        </section>

        <section class="section">
            <h2><i class="fas fa-syringe"></i> Drug Dosing & Emergency</h2>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 10px; margin-bottom: 5px;">The Weight-Based Dosing Principle</h3>
            <p>All dosing is in <strong>mg/kg</strong> or <strong>mcg/kg</strong>. A simple "decimal point error" (e.g., 10 mcg/kg vs 1.0 mcg/kg) can be catastrophic, especially with potent drugs. For neonates and small infants, doses are often drawn up in a 1 mL syringe to improve accuracy. Understanding drug <strong>concentration</strong> (e.g., mg/mL) is as important as the dose itself.</p>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Key PALS Emergency Medications</h3>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Epinephrine (Cardiac Arrest):</strong> <strong>0.01 mg/kg</strong> (or 10 mcg/kg). This is 0.1 mL/kg of the 1:10,000 (0.1 mg/mL) concentration.</li>
                <li><strong>Atropine (Symptomatic Bradycardia):</strong> <strong>0.02 mg/kg</strong> (or 20 mcg/kg).
                    <ul style="margin-left: 25px; list-style-type: circle;">
                        <li><strong>Minimum dose:</strong> 0.1 mg (to prevent paradoxical bradycardia).</li>
                        <li><strong>Maximum single dose:</strong> 0.5 mg in children, 1 mg in adolescents.</li>
                    </ul>
                </li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Maximum Local Anesthetic Doses</h3>
            <p>Adhering to these limits is essential to prevent <strong>LAST (Local Anesthetic Systemic Toxicity)</strong>, a life-threatening emergency. All areas using local anesthetics should have a LAST rescue kit, including 20% Intralipid emulsion.</p>
            <div class="la-results-container" style="margin-top: 5px;">
                <div class="la-result-row">
                    <div class="la-name">Lidocaine (Plain)</div>
                    <div class="la-max-dose" style="color: var(--text-primary);">3 - 4.5 <span class="la-detail">mg/kg</span></div>
                </div>
                <div class="la-result-row">
                    <div class="la-name">Lidocaine (with Epinephrine)</div>
                    <div class="la-max-dose" style="color: var(--text-primary);">7 <span class="la-detail">mg/kg</span></div>
                </div>
                <div class="la-result-row">
                    <div class="la-name">Bupivacaine (Plain)</div>
                    <div class="la-max-dose" style="color: var(--text-primary);">2 - 2.5 <span class="la-detail">mg/kg</span></div>
                </div>
                <div class="la-result-row">
                    <div class="la-name">Bupivacaine (with Epinephrine)</div>
                    <div class="la-max-dose" style="color: var(--text-primary);">3 <span class="la-detail">mg/kg</span></div>
                </div>
            </div>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Emergency Defibrillation Energy</h3>
            <p>In a pediatric cardiac arrest (VF/pVT), the energy dose is weight-based.</p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Initial Shock:</strong> 2 Joules/kg</li>
                <li><strong>Subsequent Shocks:</strong> Escalate to 4 Joules/kg</li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Malignant Hyperthermia (MH) Crisis</h3>
            <p>MH is a hypermetabolic crisis triggered by volatile anesthetics (e.g., Sevoflurane) or Succinylcholine. Immediate recognition is key.</p>
            <div class="info-box" style="border-left-color: var(--reversal);">
                <strong>Dantrolene Dose:</strong> 2.5 mg/kg rapid IV bolus. Repeat prn until signs abate. Max 10 mg/kg.
            </div>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Triggers:</strong> Hypercarbia (early sign), Tachycardia, Muscle Rigidity, Hyperthermia (late sign).</li>
                <li><strong>Action:</strong> Stop volatile agents, hyperventilate with 100% O2, administer Dantrolene, cool patient.</li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Laryngospasm Management</h3>
            <p>A common pediatric airway emergency, often occurring during light planes of anesthesia (induction/emergence).</p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Step 1:</strong> 100% Oxygen, CPAP, Jaw Thrust (Larson's maneuver).</li>
                <li><strong>Step 2 (If Hypoxia):</strong> Propofol (0.5-1 mg/kg) IV.</li>
                <li><strong>Step 3 (Refractory):</strong> Succinylcholine (0.5-1 mg/kg IV or 4 mg/kg IM) + Atropine.</li>
            </ul>
        </section>

        <section class="section">
            <h2><i class="fas fa-question-circle"></i> Frequently Asked Questions (FAQs)</h2>
            <div class="info-box">
                Tap a question below to reveal clinical pearls and calculation logic.
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                
                <details style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-input); padding: 10px; cursor: pointer;">
                    <summary style="font-weight: 600; color: var(--primary-accent); outline: none;">Why use Cuffed vs. Uncuffed ETT in pediatrics?</summary>
                    <div style="padding-top: 10px; font-size: 0.9em; color: var(--text-secondary); border-top: 1px dashed var(--border-color); margin-top: 10px;">
                        Historically, uncuffed tubes were used to minimize subglottic stenosis. However, modern <strong>Microcuff</strong> tubes allow for better seal, accurate End-Tidal CO2 (EtCO2) monitoring, and reduced aspiration risk without increasing mucosal pressure, provided cuff pressure is monitored (< 20 cmH2O).
                    </div>
                </details>

                <details style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-input); padding: 10px; cursor: pointer;">
                    <summary style="font-weight: 600; color: var(--primary-accent); outline: none;">How is the "4-2-1" fluid rule calculated?</summary>
                    <div style="padding-top: 10px; font-size: 0.9em; color: var(--text-secondary); border-top: 1px dashed var(--border-color); margin-top: 10px;">
                        The Holliday-Segar method estimates maintenance fluid requirements:
                        <ul>
                            <li><strong>1st 10 kg:</strong> 4 mL/kg/hr</li>
                            <li><strong>2nd 10 kg:</strong> 2 mL/kg/hr</li>
                            <li><strong>Remaining weight:</strong> 1 mL/kg/hr</li>
                        </ul>
                        Example: A 25kg child gets (10x4) + (10x2) + (5x1) = 65 mL/hr.
                    </div>
                </details>

                <details style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-input); padding: 10px; cursor: pointer;">
                    <summary style="font-weight: 600; color: var(--primary-accent); outline: none;">What is the correct Atropine dose for bradycardia?</summary>
                    <div style="padding-top: 10px; font-size: 0.9em; color: var(--text-secondary); border-top: 1px dashed var(--border-color); margin-top: 10px;">
                        The PALS recommended dose is <strong>0.02 mg/kg</strong>. Critically, there is a minimum dose of <strong>0.1 mg</strong> to prevent paradoxical bradycardia (a central vagal effect seen with low doses). The max single dose is 0.5 mg for a child and 1 mg for an adolescent.
                    </div>
                </details>

                <details style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-input); padding: 10px; cursor: pointer;">
                    <summary style="font-weight: 600; color: var(--primary-accent); outline: none;">How to manage Local Anesthetic Systemic Toxicity (LAST)?</summary>
                    <div style="padding-top: 10px; font-size: 0.9em; color: var(--text-secondary); border-top: 1px dashed var(--border-color); margin-top: 10px;">
                        <strong>1. Airway:</strong> 100% O2, suppress seizures (Benzodiazepines).<br>
                        <strong>2. Lipid Rescue:</strong> 20% Intralipid Emulsion.<br>
                        <strong>3. Bolus:</strong> 1.5 mL/kg over 1 min.<br>
                        <strong>4. Infusion:</strong> 0.25 mL/kg/min.<br>
                        Avoid Vasopressin, Calcium channel blockers, and Lidocaine. Use small doses of Epinephrine (< 1 mcg/kg) if needed.
                    </div>
                </details>

            </div>
        </section>

        <section class="section">
            <h2><i class="fas fa-book"></i> Sources for Further Reading</h2>
            <ul style="margin-left: 20px; list-style-type: disc; padding-left: 15px; line-height: 1.7;">
                <li>Holliday-Segar Method: <a href="https://www.ncbi.nlm.nih.gov/books/NBK532305/" target="_blank">ncbi.nlm.nih.gov/books/NBK532305/</a></li>
                <li>Pediatric Airway Formulas: <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC9663958/" target="_blank">pmc.ncbi.nlm.nih.gov/articles/PMC9663958/</a></li>
                <li>MABL and Fluid Management: <a href="https://www.mdcalc.com/calc/3905/maximum-allowable-blood-loss-abl-without-transfusion" target="_blank">mdcalc.com/calc/3905/maximum-allowable-blood-loss</a></li>
                <li>PALS Guidelines (AHA): <a href="https://www.ahajournals.org/doi/10.1161/CIR.0000000000000901" target="_blank">AHA Circulation Guidelines (2020)</a></li>
                <li>Local Anesthetic Systemic Toxicity (LAST): <a href="https://www.lipidrescue.org/" target="_blank">lipidrescue.org</a></li>
            </ul>
        </section>

        <section class="section">
            <h2><i class="fas fa-book-medical"></i> Clinical Reference Guide & Pharmacology Notes</h2>
            
            <div class="info-box">
                <strong>Note:</strong> This section outlines the pharmacological principles used in this calculator to ensure accuracy and safety in pediatric anesthesia practice.
            </div>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Pediatric Pharmacokinetics</h3>
            <p>
                Dosing in neonates and infants requires adjustment not just for weight, but for physiological maturity. This calculator accounts for standard weight-based dosing (mg/kg). Clinicians must be aware that:
            </p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Total Body Water:</strong> Neonates have 70-80% water content compared to 60% in adults, requiring higher loading doses for water-soluble drugs (e.g., Succinylcholine).</li>
                <li><strong>Protein Binding:</strong> Lower albumin levels in infants lead to higher fractions of free (active) drug for highly protein-bound agents (e.g., Bupivacaine, Propofol).</li>
                <li><strong>Clearance:</strong> Hepatic and renal function are immature at birth. Maintenance intervals for drugs like antibiotics or muscle relaxants may need extension in neonates.</li>
            </ul>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Safety in Emergency Algorithms (PALS)</h3>
            <p>
                During critical events like Cardiac Arrest, SVT, or Anaphylaxis, cognitive load is high. This tool digitizes the <strong>2020-2025 AHA PALS algorithms</strong>.
            </p>
            <p style="margin-top: 5px;">
                <strong>Key Considerations:</strong>
                <br>
                1. <strong>Epinephrine:</strong> The calculator distinguishes between Cardiac Arrest (10 mcg/kg) and Anaphylaxis/Hypotension doses to prevent 10-fold dosing errors.
                <br>
                2. <strong>Defibrillation:</strong> Energy selection (2 J/kg initial, 4 J/kg subsequent) is critical for shockable rhythms (VF/pVT).
                <br>
                3. <strong>Adenosine:</strong> Rapid administration via a proximal vein is required due to its half-life of <10 seconds.
            </p>

            <h3 style="font-weight: 600; font-size: 1.1em; margin-top: 15px; margin-bottom: 5px;">Airway Equipment Selection</h3>
            <p>
                Proper sizing of the Endotracheal Tube (ETT) and Supraglottic Airway (LMA/i-gel) reduces the risk of subglottic stenosis and aspiration.
            </p>
            <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
                <li><strong>Cuffed vs. Uncuffed:</strong> Modern pediatric practice favors cuffed tubes (Microcuff) even in infants, provided cuff pressure is monitored (< 20 cmH2O).</li>
                <li><strong>Blade Selection:</strong> A straight (Miller) blade is often preferred in infants < 2 years to lift the floppy, U-shaped epiglottis.</li>
            </ul>
        </section>
    </div>
    
     

    <div id="print-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-print"></i> Print Summary Sheet</div>
            <p style="margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary);">Select content to include in the generated report:</p>
            <div class="modal-actions">
                <button class="modal-btn" onclick="generatePrintSheet(false)">
                    <i class="fas fa-list"></i> Include All Drugs
                </button>
                <button class="modal-btn" onclick="generatePrintSheet(true)">
                    <i class="fas fa-star"></i> Favorites Only
                </button>
                <button class="modal-btn cancel" onclick="closePrintModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <footer style="background: var(--bg-primary); padding: 20px; text-align: center; border-top: 1px solid var(--border-color);">
        <div style="margin-bottom: 10px;">
            <a href="https://www.t.me/utopiccc" target="_blank" rel="noopener" style="text-decoration: none; color: var(--primary-accent); font-weight: 600;">&copy; 2025 Dr. Kiranraj</a>
            <span style="margin: 0 10px; color: var(--border-color);">|</span>
            <a href="privacy.html" target="_blank" rel="noopener" style="font-size: 0.9em; color: var(--primary-accent); text-decoration: none;">Privacy Policy</a>
            <span style="margin: 0 10px; color: var(--border-color);">|</span>
            <a href="mailto:kiranraj120@gmail.com" style="font-size: 0.9em; color: var(--primary-accent); text-decoration: none;">Contact</a>
        </div>
        <div style="font-size: 0.75em; color: var(--text-tertiary); margin-top: 8px;">
            Last Updated: Nov 2025 | <a href="https://schema.org/" target="_blank" rel="nofollow" style="color: inherit; text-decoration: none;">v2.4</a>
        </div>
    </footer>
</div>

<script>
    // Global state variables
    let allExpanded = false;
    let allInfusionsExpanded = false;
    let allAntibioticsExpanded = false;
    let activeEditIndex = null;
    let antibioticExpanded = [];
    let currentBaseDeficit = 0;
    let showFavoritesOnly = false;
    
    let currentWeightUnit = 'kg'; // 'kg' or 'lbs'
    const KG_TO_LBS = 2.20462;

    let currentHeightUnit = 'cm'; // 'cm' or 'ft'
    const CM_TO_IN = 0.393701;
    const IN_TO_CM = 2.54;
    const FT_TO_CM = 30.48;

    const FONT_SIZE_STEPS_PX = [12, 13, 14, 15, 16];
    let currentFontSizeIndex = 2; // Default index for 14px
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    const debouncedCalculateAll = debounce(calculateAll, 250);
    const debouncedClampAndCalculate = debounce(clampAgeAndCalculate, 250);


    function filterDrugs() {
      const searchTerm = document.getElementById('drug-search').value.toLowerCase().trim();
      const drugCards = document.querySelectorAll('#drug-results .drug-card');
      const categoryHeadings = document.querySelectorAll('#drug-results .category-heading');
      let visibleCategories = new Set();
      
      drugCards.forEach((card, index) => {
        const originalIndex = parseInt(card.id.split('-')[2], 10);
        const drug = drugs[originalIndex]; 
        if (!drug) return;

        if (showFavoritesOnly && !drug.isFavorite) {
            card.style.display = 'none';
            return;
        }

        const drugName = drug.name.toLowerCase();
        const drugCategory = drug.categoryLabel.toLowerCase();
        const isMatch = drugName.includes(searchTerm) || drugCategory.includes(searchTerm);

        if (isMatch) {
          card.style.display = 'block';
          visibleCategories.add(drug.categoryLabel);
        } else {
          card.style.display = 'none';
        }
      });

      categoryHeadings.forEach(heading => {
        const categoryName = heading.textContent;
        if (visibleCategories.has(categoryName)) {
          heading.style.display = 'block';
        } else {
          heading.style.display = 'none';
        }
      });
    }

    const drugs = [
      { name:'Propofol', category:'induction', categoryLabel:'Induction Agent', defaultDose:2.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'2-3 mg/kg', defaultRoute:'IV' },
      { name:'Thiopentone', category:'induction', categoryLabel:'Induction Agent', defaultDose:5, unit:'mg/kg', concentration:25, concentrationUnit:'mg/mL', useParam:'weight', range:'4-6 mg/kg', defaultRoute:'IV' },
      { name:'Ketamine', category:'induction', categoryLabel:'Induction Agent', defaultDose:2, imDose:4, oralDose:6, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 4-6 mg/kg IM, 6-10 mg/kg Oral', defaultRoute:'IV' },
      { name:'Etomidate', category:'induction', categoryLabel:'Induction Agent', defaultDose:0.3, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2-0.3 mg/kg', caution:'Avoid in sepsis or adrenal suppression risk.', defaultRoute:'IV' },
      { name:'Vecuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.08-0.1 mg/kg', defaultRoute:'IV' },
      { name:'Rocuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.6, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.6-1.2 mg/kg', defaultRoute:'IV' },
      { name:'Atracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.4-0.5 mg/kg', defaultRoute:'IV' },
      { name:'Cisatracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg', defaultRoute:'IV' },
      { name:'Succinylcholine', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:1.5, imDose:3, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 3-4 mg/kg IM', caution:'FDA Black Box Warning: Reserved for emergent use in children (<50kg) due to risk of hyperkalemia/cardiac arrest in undiagnosed myopathies.', defaultRoute:'IV' },
      { name:'Fentanyl', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:2, unit:'mcg/kg', concentration:50, concentrationUnit:'mcg/mL', useParam:'weight', range:'1-3 mcg/kg', defaultRoute:'IV' },
      { name:'Morphine', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg', defaultRoute:'IV' },
      { name:'Tramadol', category:'analgesic', categoryLabel:'Analgesic', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
      { name:'Paracetamol', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, caution:'Dose must be reduced to 7.5 mg/kg for patients <10 kg. Risk of hepatotoxicity in small infants/neonates.', defaultRoute:'IV' },
      { name:'Ketorolac', category:'analgesic', categoryLabel:'NSAID Analgesic', defaultDose:0.5, oralDose:1.0, unit:'mg/kg', concentration:30, concentrationUnit:'mg/mL', useParam:'weight', range:'Dose varies significantly by Age/Weight/Route (See Info)', defaultRoute:'IV' },
      { name:'Midazolam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.5, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg IV, 0.5-1 mg/kg Oral', caution:'Reduced dose or slow titration recommended for infants <10 kg due to prolonged effect/lower clearance.', defaultRoute:'IV' },
      { name:'Diazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.2, oralDose:0.3, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.3 mg/kg IV, 0.2-0.5 mg/kg Oral', caution:'Max 10mg. Slow IV. Not recommended for neonates.', defaultRoute:'IV' },
      { name:'Lorazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.05, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.1 mg/kg IV, 0.05 mg/kg Oral', caution:'Max 4mg/dose. Slow IV.', defaultRoute:'IV' },
      { name:'Lidocaine (Xylocard)', category:'adjunct', categoryLabel:'Local Anesthetic', defaultDose:1.5, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-1.5 mg/kg IV', caution:'Strict total dose of 5 mg/kg. Higher risk of systemic toxicity in neonates/infants <10 kg.', defaultRoute:'IV' },
      { name:'Neostigmine', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:0.05, unit:'mg/kg', concentration:0.5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.04-0.08 mg/kg (max 5mg)', maxDose:5, defaultRoute:'IV', description: 'Cholinesterase Inhibitor (Muscle Relaxant Reversal)' },
      { name:'Glycopyrrolate', category:'adjunct', categoryLabel:'Anticholinergic', defaultDose:0.01, unit:'mg/kg', concentration:0.2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.008-0.01 mg/kg', defaultRoute:'IV', description: 'Muscarinic Antagonist (used with Neostigmine)' },
      { name:'Sugammadex', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:2, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'2-4 mg/kg (routine reversal)', defaultRoute:'IV', description: 'Selective Relaxant Binding Agent (Rocuronium/Vecuronium Reversal)' },
      { name:'Naloxone', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:0.1, unit:'mg/kg', concentration:0.4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1mg/kg (titrate)',maxDose:2, defaultRoute:'IV', description: 'Opioid Antagonist (Opioid Reversal)' },
      { name:'Flumazenil', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:0.01, unit:'mg/kg', concentration:0.1, concentrationUnit:'mg/mL', useParam:'weight', range:'10 mcg/kg (titrate, max 200mcg)', maxDose:0.2, defaultRoute:'IV', description: 'Benzodiazepine Antagonist (Benzodiazepine Reversal)' },
      { name:'Adrenaline (Epinephrine) Arrest', category:'emergency', categoryLabel:'Cardiac Arrest', defaultDose:10, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'10 mcg/kg IV (1:10,000)', defaultRoute:'IV' },
      { name:'Adrenaline (Epinephrine) Anaphylaxis', category:'emergency', categoryLabel:'Anaphylaxis (IV)', defaultDose:1, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'1 mcg/kg (1:10,000)', defaultRoute:'IV' },
      { name:'Defibrillation (First Shock)', category:'emergency', categoryLabel:'Resuscitation Energy', defaultDose:2, unit:'Joules', concentration:1, concentrationUnit:'N/A', useParam:'weight', range:'2 J/kg', defaultRoute:'External' },
      { name:'Defibrillation (Subsequent)', category:'emergency', categoryLabel:'Resuscitation Energy', defaultDose:4, unit:'Joules', concentration:1, concentrationUnit:'N/A', useParam:'weight', range:'4-10 J/kg', defaultRoute:'External' },
      { name:'Cardioversion (Sync)', category:'emergency', categoryLabel:'Resuscitation Energy', defaultDose:1, unit:'Joules', concentration:1, concentrationUnit:'N/A', useParam:'weight', range:'0.5-1 J/kg', defaultRoute:'External' },
      { name:'Atropine', category:'emergency', categoryLabel:'Bradycardia', defaultDose:0.02, unit:'mg/kg', concentration:0.6, concentrationUnit:'mg/mL', useParam:'weight', range:'20 mcg/kg (min 100mcg, max 600mcg)', minDose:0.1, maxDose:0.6, defaultRoute:'IV' },
      { name:'Lignocaine (Anti-Arrhythmic)', category:'emergency', categoryLabel:'Anti-Arrhythmic', defaultDose:1, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.5-1 mg/kg', defaultRoute:'IV' },
      { name:'Magnesium Sulphate', category:'emergency', categoryLabel:'Asthma/Torsades', defaultDose:50, unit:'mg/kg', concentration:500, concentrationUnit:'mg/mL', useParam:'weight', range:'25-50 mg/kg', caution:'Infuse over 10-20 minutes.', defaultRoute:'IV' },
      { name:'Adenosine 1st Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.1, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1 mg/kg (max 6mg)', maxDose:6, defaultRoute:'IV' },
      { name:'Adenosine 2nd Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.2, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2 mg/kg (max 12mg)', maxDose:12, defaultRoute:'IV' },
      { name:'Phenylephrine', category:'emergency', categoryLabel:'Vasopressor', defaultDose:5, unit:'mcg/kg', concentration:50, concentrationUnit:'mcg/mL', useParam:'weight', range:'5-20 mcg/kg', caution:'Bolus doses of 50-100 mcg can be given. Use for acute hypotension. Titrate dose according to response. Can cause BRADYCARDIA', maxDose:500, defaultRoute:'IV' },
      { name:'Dexamethasone', category:'steroid', categoryLabel:'Steroid', defaultDose:0.15, unit:'mg/kg', concentration:4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
      { name:'Hydrocortisone', category:'steroid', categoryLabel:'Steroid', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
      { name:'Ondansetron', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.15 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
      { name:'Metoclopramide', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.15, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 10mg)', maxDose:10, defaultRoute:'IV' },
    {
      name: 'Ibuprofen',
      category: 'analgesic',
      categoryLabel: 'NSAID Analgesic',
      defaultDose: 10,
      unit: 'mg/kg',
      concentration: 20,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '5-10 mg/kg/dose Q6-8H',
      caution: 'Contraindicated < 3 months. Risk of renal impairment in dehydrated children. Give with food/milk.',
      routes: ['Oral'],
      defaultRoute: 'Oral',
      ageMinMonths: 3,
      notes: 'Common preparation: 100mg/5mL (20mg/mL). A 10 mg/kg dose is 0.5 mL/kg.'
    },
    {
      name: 'Diclofenac',
      category: 'analgesic',
      categoryLabel: 'NSAID Analgesic',
      defaultDose: 1,
      unit: 'mg/kg',
      concentration: 1,
      concentrationUnit: 'N/A',
      useParam: 'weight',
      range: '1-3 mg/kg/day in 2-3 divided doses (max 75mg)',
	  maxDose:75,
      caution: 'Contraindicated in NSAID hypersensitivity, active GI bleed, or severe renal impairment.',
      routes: ['Rectal'],
      defaultRoute: 'Rectal',
      notes: 'For rectal (suppository) use. Dose is per administration (e.g., 1 mg/kg). Common suppository strengths: 12.5mg, 25mg.'
    },
    {
      name: 'Triclofos',
      category: 'adjunct',
      categoryLabel: 'Sedative',
      defaultDose: 30,
      unit: 'mg/kg',
      concentration: 100,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '25-75 mg/kg single dose for sedation',
      caution: 'Use with caution in obstructive sleep apnea or severe hepatic/renal impairment. Monitor cardiorespiratory status.',
      routes: ['Oral'],
      defaultRoute: 'Oral',
      notes: 'Common preparation: Syrup 500mg/5mL (100mg/mL). A 30 mg/kg dose is 0.3 mL/kg. Onset 30-60 min.'
    },
    {
      name: 'Granisetron',
      category: 'antiemetic',
      categoryLabel: 'Antiemetic',
      defaultDose: 20,
      unit: 'mcg/kg',
      concentration: 1000,
      concentrationUnit: 'mcg/mL',
      useParam: 'weight',
      range: '10-40 mcg/kg (IV) for CINV/PONV',
      caution: 'Risk of QT prolongation. Use with caution in patients with pre-existing arrhythmias or electrolyte imbalance.',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'Common preparation: 1mg/1mL ampoule.'
    },
    {
      name: 'Domperidone',
      category: 'antiemetic',
      categoryLabel: 'Prokinetic',
      defaultDose: 0.3,
      unit: 'mg/kg',
      concentration: 1,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '0.2-0.4 mg/kg/dose Q8H',
      caution: 'BLACK BOX WARNING: Risk of serious cardiac arrhythmias (QT prolongation). Use is heavily discouraged in children (especially < 12 years). Contraindicated in cardiac disease.',
      routes: ['Oral'],
      defaultRoute: 'Oral',
      ageMin: 12,
      notes: 'Dosing for >12 years: 10mg (10mL) Q8H. Common prep: 1mg/mL.'
    },
    {
      name: 'Calcium Gluconate (10%)',
      category: 'emergency',
      categoryLabel: 'Electrolyte',
      defaultDose: 100,
      unit: 'mg/kg',
      concentration: 100,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '60-100 mg/kg/dose (0.6-1 mL/kg) (max 2000mg)',
	  maxDose:2000,
      caution: 'Vesicant - risk of tissue necrosis. Administer slowly (5-10 min) via large vein or central line. **CONTRAINDICATION: Do NOT co-administer with Ceftriaxone in neonates (<28 days).**',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'For hyperkalemia (with ECG changes) or symptomatic hypocalcemia.'
    },
 {
      name: 'Sodium Bicarbonate (8.4%)',
      category: 'emergency',
      categoryLabel: 'Alkalinizer',
      defaultDose: 1,
      unit: 'mEq/kg',
      concentration: 1,
      concentrationUnit: 'mEq/mL',
      useParam: 'weight',
      range: '1-2 mEq/kg/dose (Emergency Bolus)',
      caution: 'Ensure adequate ventilation to blow off CO2. Can cause hypernatremia/hyperosmolality. Incompatible with catecholamines & calcium.',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'Emergency Bolus (no deficit): 1-2 mEq/kg. Calculated Dose (with deficit): 0.3 x Wt(kg) x Base Deficit.',
      specialHandling: 'bicarbonate'
    },
    {
      name: 'Furosemide',
      category: 'adjunct',
      categoryLabel: 'Diuretic',
      defaultDose: 1,
      imDose: 1,
      oralDose: 2,
      unit: 'mg/kg',
      concentration: 10,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '0.5-2 mg/kg/dose (IV/IM), 1-3 mg/kg/dose (Oral)',
      caution: 'Monitor electrolytes (esp. K+) and volume status. Risk of ototoxicity with rapid infusion.',
      routes: ['IV', 'IM', 'Oral'],
      defaultRoute: 'IV'
    },
    {
      name: 'Mannitol (20%)',
      category: 'adjunct',
      categoryLabel: 'Osmotic Diuretic',
      defaultDose: 500,
      unit: 'mg/kg',
      concentration: 200,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '250-1000 mg/kg/dose (1.25-5 mL/kg)',
      caution: 'Must use an IV line filter. Monitor serum osmolality (<320) & electrolytes. Contraindicated in active intracranial bleed.',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'For raised intracranial pressure. Give over 15-30 min.'
    },
    {
      name: 'Pantoprazole',
      category: 'adjunct',
      categoryLabel: 'Proton Pump Inhibitor',
      defaultDose: 1,
      unit: 'mg/kg',
      concentration: 4,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '0.5-2 mg/kg/dose (Max 40mg)',
	maxDose:40,
      caution: 'Not approved for children < 5 years. Dosing in younger children is off-label and not well-established.',
      routes: ['IV'],
      defaultRoute: 'IV',
      ageMin: 5,
      notes: 'For GERD or stress ulcer prophylaxis. Reconstitute 40mg vial with 10mL NS to get 4mg/mL.'
    },
    {
      name: 'Phenytoin (Loading Dose)',
      category: 'emergency',
      categoryLabel: 'Anticonvulsant',
      defaultDose: 20,
      unit: 'mg/kg',
      concentration: 50,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '15-20 mg/kg (Loading Dose)',
      caution: 'Vesicant. **Dilute in NORMAL SALINE only.** Infuse slowly (1-3 mg/kg/min, max 50/min) with continuous ECG/BP monitoring.',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'For Status Epilepticus (second-line). Do not administer via IM route for loading.'
    },
   {
      name: 'Dantrolene (Ryanodex)',
      category: 'emergency',
      categoryLabel: 'MH Antidote',
      defaultDose: 2.5,
      unit: 'mg/kg',
      concentration: 50,
      concentrationUnit: 'mg/mL',
      useParam: 'weight',
      range: '2.5 mg/kg IV bolus, repeat as needed (Max 10 mg/kg)',
      caution: 'For Malignant Hyperthermia (Ryanodex). Reconstitute 250mg vial with 5mL sterile water (without bacteriostatic agent). Repeat bolus as needed up to 10 mg/kg total dose. VESICANT.',
      routes: ['IV'],
      defaultRoute: 'IV',
      notes: 'Ryanodex Reconstitution: 250mg vial + 5mL sterile water = 50 mg/mL.'
    }

    ];

    drugs.forEach(drug => {
              drug.customDoseIV = null;
              drug.customDoseIM = null;
              drug.customDoseOral = null;
              drug.customConcentration = null;
              drug.isExpanded = false;
              drug.isFavorite = false;
            });
    const antibiotics = [
      { 
        name: 'Ampicillin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 50, 
        unit: 'mg/kg', 
        concentration: 100, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '50-100 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Mild/Moderate Infection', dose: 50, frequency: 'Q6H', maxPerDose: 2000, note: 'Max daily dose: 12g/day.' }, 
          { name: 'Severe Infection/Meningitis', dose: 100, frequency: 'Q6H', maxPerDose: 2000, note: 'Max daily dose: 12g/day.' }, 
          { name: 'Surgical Prophylaxis', dose: 50, frequency: 'Single dose', maxPerDose: 2000 } 
        ], 
        caution: 'High rate of rash. Not effective against beta-lactamase producing bacteria.', 
        info: 'Common indications: Meningitis, severe sepsis, UTIs, intra-abdominal infections. Often used for Listeria in neonates.' 
      },
      { 
        name: 'Amoxicillin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 25, 
        unit: 'mg/kg', 
        concentration: 50, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '25-90 mg/kg/day', 
        defaultRoute: 'Oral', 
        routes: ['Oral'], 
        indications: [ 
          { name: 'Mild/Moderate Infection', dose: 25, frequency: 'Q8H', maxPerDose: 1000 }, 
          { name: 'Otitis Media/Sinusitis', dose: 45, frequency: 'Q12H', maxPerDose: 1000 }, 
          { name: 'Severe Infection', dose: 90, frequency: 'Q12H', maxPerDose: 1000, note: 'Max dose 1g/dose. Max daily 4g.' }
        ], 
        caution: 'High incidence of rash, especially with concurrent viral infections.', 
        info: 'Common indications: Otitis media, sinusitis, community-acquired pneumonia, streptococcal pharyngitis.' 
      },
      { 
        name: 'Amoxicillin/Clavulanate', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 25, 
        unit: 'mg/kg', 
        concentration: 50, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '25-90 mg/kg/day (amox component)', 
        defaultRoute: 'Oral', 
        routes: ['Oral'], 
        indications: [ 
          { name: 'Standard Dose', dose: 25, frequency: 'Q8H', maxPerDose: 875 }, 
          { name: 'Higher Dose (Recurrent Otitis)', dose: 45, frequency: 'Q12H', maxPerDose: 875 } 
        ], 
        caution: 'Diarrhea and GI upset are more common due to clavulanate.', 
        info: 'Dosing based on amoxicillin component.' 
      },
      { 
        name: 'Cefazolin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 25, 
        unit: 'mg/kg', 
        concentration: 100, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '25-50 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Surgical Prophylaxis', dose: 25, frequency: 'Single dose', maxPerDose: 2000 }, 
          { name: 'Treatment', dose: 50, frequency: 'Q8H', maxPerDose: 2000, note: 'Max daily dose 6g/day.' } 
        ], 
        caution: 'Cross-hypersensitivity with penicillins (approx. 5-10% risk).', 
        info: 'Common indications: Surgical prophylaxis, skin and soft tissue infections caused by MSSA.' 
      },
      { 
        name: 'Cefotaxime', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 50, 
        unit: 'mg/kg', 
        concentration: 100, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '50-75 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Mild/Moderate Infection', dose: 50, frequency: 'Q8H', maxPerDose: 2000 }, 
          { name: 'Severe Infection/Meningitis', dose: 75, frequency: 'Q6H', maxPerDose: 2000, note: 'Max daily dose 12g/day.' }, 
          { name: 'Surgical Prophylaxis', dose: 50, frequency: 'Single dose', maxPerDose: 2000 } 
        ], 
        caution: 'Excellent CNS penetration.', 
        info: 'Common indications: Meningitis, serious Gram-negative infections, gonorrhea, sepsis in neonates.' 
      },
      { 
        name: 'Cefoxitin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 40, 
        unit: 'mg/kg', 
        concentration: 100, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '40-80 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Mild/Moderate Infection', dose: 40, frequency: 'Q6H', maxPerDose: 2000 }, 
          { name: 'Severe Infection', dose: 80, frequency: 'Q4H', maxPerDose: 2000, note: 'Max daily dose 12g/day.' }, 
          { name: 'Surgical Prophylaxis', dose: 40, frequency: 'Single dose', maxPerDose: 2000 } 
        ], 
        caution: 'Good anaerobic coverage. Considered a "cephamycin".', 
        info: 'Common indications: Intra-abdominal infections, pelvic inflammatory disease (PID), surgical prophylaxis for colorectal procedures.' 
      },
      { 
        name: 'Clindamycin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 10, 
        unit: 'mg/kg', 
        concentration: 150, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '10-40 mg/kg/day', 
        defaultRoute: 'IV', 
        routes: ['IV', 'Oral'], 
        indications: [ 
          { name: 'Mild/Moderate Infection', dose: 10, frequency: 'Q8H', maxPerDose: 900 }, 
          { name: 'Severe Infection/MRSA', dose: 10, frequency: 'Q6H', maxPerDose: 900, note: 'Dose is 10mg/kg Q6H (40mg/kg/day). Max 2.7g/day.' }, 
          { name: 'Surgical Prophylaxis', dose: 10, frequency: 'Single dose', maxPerDose: 900 } 
        ], 
        caution: 'High risk of causing C. difficile colitis. Not reliable for CNS infections.', 
        info: 'Common indications: Anaerobic infections, MRSA skin/soft tissue infections, bone/joint infections.' 
      },
      { 
        name: 'Gentamicin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 7.5, 
        unit: 'mg/kg', 
        concentration: 10, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '5-7.5 mg/kg/day', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Standard Dose (Once Daily)', dose: 7.5, frequency: 'Q24H' },
          { name: 'Divided Dosing (Meningitis)', dose: 2.5, frequency: 'Q8H' }
        ], 
        caution: 'NEPHROTOXIC and OTOTOXIC. Therapeutic drug monitoring (troughs) required, especially with divided dosing or impaired renal function.', 
        info: 'Common indications: Severe Gram-negative infections, sepsis, synergistic therapy for endocarditis.' 
      },
      { 
        name: 'Metronidazole', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 7.5, 
        unit: 'mg/kg', 
        concentration: 5, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '7.5-10 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV', 'Oral'], 
        indications: [ 
          { name: 'Anaerobic Infections', dose: 7.5, frequency: 'Q8H', maxPerDose: 500 }, 
          { name: 'C. difficile Colitis', dose: 10, frequency: 'Q8H (Oral)', maxPerDose: 500 }, 
          { name: 'Surgical Prophylaxis', dose: 7.5, frequency: 'Single dose', maxPerDose: 500, note: 'Max daily 4g.' } 
        ], 
        caution: 'Causes disulfiram-like reaction with alcohol. Metallic taste common.', 
        info: 'Common indications: Anaerobic infections (intra-abdominal, brain abscess), C. difficile colitis.' 
      },
      { 
        name: 'Vancomycin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 15, 
        unit: 'mg/kg', 
        concentration: 5, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '15-20 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Standard Dose', dose: 15, frequency: 'Q6-8H', maxPerDose: 1000 }, 
          { name: 'Severe Infection/Meningitis', dose: 20, frequency: 'Q6-8H', maxPerDose: 1000, note: 'Dosing should be guided by serum troughs or AUC/MIC.' } 
        ], 
        caution: 'NEPHROTOXIC and OTOTOXIC. Requires therapeutic drug monitoring.', 
        info: 'Common indications: MRSA infections, serious infections in penicillin-allergic patients.' 
      },
      { 
        name: 'Piperacillin/Tazobactam (Zosyn)', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 100, 
        unit: 'mg/kg', 
        concentration: 40, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '80-100 mg/kg/dose', 
        defaultRoute: 'IV', 
        routes: ['IV'], 
        indications: [ 
          { name: 'Standard Dose', dose: 80, frequency: 'Q8H', maxPerDose: 4000 }, 
          { name: 'Severe Infection', dose: 100, frequency: 'Q6H', maxPerDose: 4000, note: 'Max 4g (pip) per dose. Max daily 16g (pip).' }, 
          { name: 'Surgical Prophylaxis', dose: 80, frequency: 'Single dose', maxPerDose: 4000 } 
        ], 
        caution: 'Broad-spectrum use can lead to C. diff and fungal superinfections. Contains significant sodium load.', 
        info: 'Common indications: Broad-spectrum coverage for hospital-acquired pneumonia, intra-abdominal infections, febrile neutropenia.' 
      },
      { 
        name: 'Ceftriaxone', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 75, 
        unit: 'mg/kg', 
        concentration: 100, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '50-100 mg/kg/day', 
        defaultRoute: 'IV', 
        routes: ['IV', 'IM'], 
        indications: [
          { name: 'Sepsis/Severe Infection', dose: 75, frequency: 'Q24H', maxPerDose: 4000, note: 'Max daily dose: 4000mg/day.' },
          { name: 'Meningitis', dose: 100, frequency: 'Q12H or Q24H', maxPerDose: 2000, note: 'Q12H dosing max 2g/dose. Max daily dose: 4000mg/day.' }
        ], 
        caution: '**CONTRAINDICATION: Do NOT co-administer with IV calcium in neonates (<28 days) due to risk of fatal precipitate.** Avoid in hyperbilirubinemic neonates.', 
        info: 'Commonly reconstituted 1g vial with 9.6mL sterile water to get 100mg/mL.' 
      }, 
      { 
        name: 'Amikacin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 15, 
        unit: 'mg/kg', 
        concentration: 50, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '15-22.5 mg/kg/day', 
        defaultRoute: 'IV', 
        routes: ['IV', 'IM'], 
        indications: [
          { name: 'Standard Dose (Once Daily)', dose: 15, frequency: 'Q24H' },
          { name: 'Neonatal Sepsis (Term)', dose: 15, frequency: 'Q24H' }
        ], 
        caution: '**NEPHROTOXIC and OTOTOXIC.** Requires therapeutic drug monitoring (TDM). Adjust dose in renal impairment.', 
        info: 'Aminoglycoside. Common preps: 100mg/2mL (50mg/mL) or 500mg/2mL (250mg/mL). Neonatal dosing varies significantly by gestational/postnatal age.' 
      }, 
      { 
        name: 'Azithromycin', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 10, 
        unit: 'mg/kg', 
        concentration: 40, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '10-12 mg/kg/day', 
        defaultRoute: 'Oral', 
        routes: ['Oral'], 
        indications: [
          { name: 'Pneumonia / Otitis Media', dose: 10, frequency: 'Q24H (for 3-5 days)', maxPerDose: 500, note: 'Max daily dose: 500mg/day.' }, 
          { name: 'Pharyngitis', dose: 12, frequency: 'Q24H (for 5 days)', maxPerDose: 500, note: 'Max daily dose: 500mg/day.' }
        ], 
        caution: 'Risk of QT prolongation. Use with caution in patients with cardiac arrhythmias.', 
        info: 'Macrolide. Common preps: 100mg/5mL or 200mg/5mL (40mg/mL). A 10mg/kg dose from 200mg/5mL prep is 0.25 mL/kg.' 
      }, 
      { 
        name: 'Cefixime', 
        category: 'antibiotic', 
        categoryLabel: 'Antibiotic', 
        defaultDose: 8, 
        unit: 'mg/kg', 
        concentration: 20, 
        concentrationUnit: 'mg/mL', 
        useParam: 'weight', 
        range: '8-20 mg/kg/day', 
        defaultRoute: 'Oral', 
        routes: ['Oral'], 
        indications: [
          { name: 'Standard Dose (UTI/Otitis)', dose: 8, frequency: 'Q24H', maxPerDose: 400, note: 'Max daily dose: 400mg/day.' },
          { name: 'Typhoid Fever', dose: 10, frequency: 'Q12H', maxPerDose: 200, note: 'Max daily dose: 400mg/day.' }
        ], 
        caution: 'Hypersensitivity risk in penicillin-allergic patients. Not recommended for children < 6 months.', 
        ageMin: 0.5, 
        info: 'Oral 3rd-gen cephalosporin. Common preps: 50mg/5mL or 100mg/5mL (20mg/mL). An 8mg/kg dose from 100mg/5mL prep is 0.4 mL/kg.' 
      }
    ];

    const infusionDrugs = [
      {
        name: 'Adrenaline (Epinephrine) Infusion', category: 'infusion', categoryLabel: 'Vasopressor Infusion', isExpanded: false,
        loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Not typically used as a loading dose for infusions' },
        infusionDoseRange: { min: 0.1, max: 1, unit: 'mcg/kg/min' },
        defaultDose: 0.1, currentDose: 0.1,
        defaultDilutionAmount: 4, defaultDilutionUnit: 'mg', defaultDilutionVol: 50,
        currentDilutionAmount: 4, currentDilutionUnit: 'mg', currentDilutionVol: 50,
        caution: 'VESICANT - High risk of tissue necrosis if extravasation occurs. Use central line if possible. Have phentolamine ready for infiltration management.',
        notes: 'Standard prep: 4 mg in 50 mL (80 mcg/mL). 1 mL/h = 1.33 mcg/kg/min for 1 kg pt.'
      },
      {
        name: 'Noradrenaline (Norepinephrine) Infusion', category: 'infusion', categoryLabel: 'Vasopressor Infusion', isExpanded: false,
        loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Not typically used as a loading dose' },
        infusionDoseRange: { min: 0.05, max: 2, unit: 'mcg/kg/min' },
        defaultDose: 0.05, currentDose: 0.05,
        defaultDilutionAmount: 4, defaultDilutionUnit: 'mg', defaultDilutionVol: 50,
        currentDilutionAmount: 4, currentDilutionUnit: 'mg', currentDilutionVol: 50,
        caution: 'POTENT VESICANT - Must be administered through a central line if possible. If peripheral, use large proximal vein with frequent monitoring.',
        notes: 'Standard prep: 4 mg in 50 mL (80 mcg/mL). 1 mL/h = 1.33 mcg/kg/min for 1 kg pt.'
      },
      {
        name: 'Dexmedetomidine (Precedex) Infusion', category: 'infusion', categoryLabel: 'Sedative Infusion', isExpanded: false,
        loadingDose: { dose: 0.5, unit: 'mcg/kg', note: 'Optional: 0.5-1 mcg/kg over 10-20 minutes' },
        infusionDoseRange: { min: 0.2, max: 1, unit: 'mcg/kg/hr' },
        defaultDose: 0.2, currentDose: 0.2,
        defaultDilutionAmount: 200, defaultDilutionUnit: 'mcg', defaultDilutionVol: 50,
        currentDilutionAmount: 200, currentDilutionUnit: 'mcg', currentDilutionVol: 50,
        caution: 'Causes bradycardia. Monitor hemodynamics closely. Withdrawal symptoms possible after prolonged use (>24 hours).',
        notes: 'Standard prep: 200 mcg in 50 mL (4 mcg/mL). Does not cause significant respiratory depression.'
      },
      {
        name: 'Fentanyl Infusion', category: 'infusion', categoryLabel: 'Opioid Analgesic Infusion', isExpanded: false,
        loadingDose: { dose: 1, unit: 'mcg/kg', note: '1-2 mcg/kg bolus before starting infusion' },
        infusionDoseRange: { min: 1, max: 5, unit: 'mcg/kg/hr' },
        defaultDose: 1, currentDose: 1,
        defaultDilutionAmount: 500, defaultDilutionUnit: 'mcg', defaultDilutionVol: 50,
        currentDilutionAmount: 500, currentDilutionUnit: 'mcg', currentDilutionVol: 50,
        caution: 'Respiratory depression risk. Monitor respiratory status continuously. Have naloxone available. Chest wall rigidity possible with rapid bolus.',
        notes: 'Standard prep: 500 mcg in 50 mL (10 mcg/mL). For non-intubated patients, use lowest effective dose and monitor closely.'
      },
	  {
        name: 'Dopamine Infusion', category: 'infusion', categoryLabel: 'Inotrope/Vasopressor', isExpanded: false,
        loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Loading dose not typically used.' },
        infusionDoseRange: { min: 2, max: 20, unit: 'mcg/kg/min' },
        defaultDose: 5, currentDose: 5,
        defaultDilutionAmount: 200, defaultDilutionUnit: 'mg', defaultDilutionVol: 50,
        currentDilutionAmount: 200, currentDilutionUnit: 'mg', currentDilutionVol: 50,
        caution: 'POTENT VESICANT - Must be administered through a central line. Can cause tachycardia and arrhythmias.',
        notes: 'Standard prep: 200 mg in 50 mL (4000 mcg/mL). Dose-dependent effects: 2-5 (renal), 5-10 (inotropic), >10 (vasopressor).'
      },
      {
        name: 'Dobutamine Infusion', category: 'infusion', categoryLabel: 'Inotrope Infusion', isExpanded: false,
        loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Loading dose not typically used.' },
        infusionDoseRange: { min: 2, max: 20, unit: 'mcg/kg/min' },
        defaultDose: 5, currentDose: 5,
        defaultDilutionAmount: 250, defaultDilutionUnit: 'mg', defaultDilutionVol: 50,
        currentDilutionAmount: 250, currentDilutionUnit: 'mg', currentDilutionVol: 50,
        caution: 'Can cause tachycardia, arrhythmias, and hypotension. Monitor HR and BP closely.',
        notes: 'Standard prep: 250 mg in 50 mL (5000 mcg/mL). Primarily a beta-1 agonist.'
      },
      {
        name: 'Vasopressin Infusion', category: 'infusion', categoryLabel: 'Vasopressor Infusion', isExpanded: false,
        loadingDose: { dose: 0, unit: 'units/kg', note: 'Loading dose not typically used for shock.' },
        infusionDoseRange: { min: 0.01, max: 0.48, unit: 'units/kg/hr' }, // This is 0.2 - 8 mU/kg/min
        defaultDose: 0.01, currentDose: 0.01,
        defaultDilutionAmount: 5, defaultDilutionUnit: 'units', defaultDilutionVol: 50,
        currentDilutionAmount: 5, currentDilutionUnit: 'units', currentDilutionVol: 50,
        caution: 'POTENT VESICANT - Must use central line. Risk of peripheral and splanchnic ischemia. Monitor for limb perfusion and urine output.',
        notes: 'Standard prep: 5 units in 50 mL (0.1 units/mL). Dose range corresponds to 0.2 - 8 milliunits/kg/min. Not standard to use "mg" or "mcg" for dilution unit.'
      },
    {
      name: 'Salbutamol Infusion',
      category: 'infusion',
      categoryLabel: 'Bronchodilator Infusion',
      isExpanded: false,
      loadingDose: {
        dose: 15,
        unit: 'mcg/kg',
        note: 'Optional: 15 mcg/kg over 10 minutes'
      },
      infusionDoseRange: {
        min: 0.1,
        max: 1,
        unit: 'mcg/kg/min'
      },
      defaultDose: 0.1,
      currentDose: 0.1,
      defaultDilutionAmount: 5,
      defaultDilutionUnit: 'mg',
      defaultDilutionVol: 50,
      currentDilutionAmount: 5,
      currentDilutionUnit: 'mg',
      currentDilutionVol: 50,
      caution: 'Requires continuous cardiac monitoring. Causes significant tachycardia and hypokalemia. Use with caution in cardiac disease.',
      notes: 'Standard prep: 5 mg in 50 mL (100 mcg/mL). For severe status asthmaticus unresponsive to nebulizers or for hyperkalemia.'
    }

  ];
  const localAnesthetics = [
      { name: 'Lignocaine (Plain)', maxDose: 4.5, unit: 'mg/kg', caution: 'Without epinephrine' },
      { name: 'Lignocaine (With Epinephrine)', maxDose: 7, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
      { name: 'Bupivacaine (Plain)', maxDose: 2, unit: 'mg/kg', caution: 'Without epinephrine' },
      { name: 'Bupivacaine (With Epinephrine)', maxDose: 3, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
      { name: 'Ropivacaine', maxDose: 3, unit: 'mg/kg', caution: 'Maximum recommended dose' }
	  
    ];

    function toggleFavorite(index) {
        const drug = drugs[index];
        if (!drug) return;

        drug.isFavorite = !drug.isFavorite;
        saveFavorites();

        const btn = document.getElementById(`fav-btn-${index}`);
        if (btn) {
            
            if (drug.isFavorite) {
                btn.classList.add('favorited');
            } else {
                btn.classList.remove('favorited');
            }

            void btn.offsetWidth; 

            btn.classList.add('pulse');
            
            setTimeout(() => {
                btn.classList.remove('pulse');
            }, 400);
        }
        
        if (showFavoritesOnly && !drug.isFavorite) {
            filterDrugs();
        }
    }

    function saveFavorites() {
        const favorites = drugs.filter(d => d.isFavorite).map(d => d.name);
        localStorage.setItem('pediatricAnesthesiaFavorites', JSON.stringify(favorites));
    }

    function loadFavorites() {
        const favorites = JSON.parse(localStorage.getItem('pediatricAnesthesiaFavorites') || '[]');
        favorites.forEach(name => {
            const drug = drugs.find(d => d.name === name);
            if (drug) {
                drug.isFavorite = true;
            }
        });
    }
    function toggleFavoritesFilter() {
        showFavoritesOnly = !showFavoritesOnly;
        
        const btn = document.getElementById('favorites-filter-toggle');
        btn.classList.toggle('active', showFavoritesOnly);
        btn.innerHTML = showFavoritesOnly 
            ? '<i class="fas fa-star"></i> Showing Favorites' 
            : '<i class="fas fa-star"></i> Show Favorites Only';

        filterDrugs(); // Re-run filter
    }

    const dilutionTiers = {
      'Fentanyl': [50,10,5], 'Atropine': [0.6,0.1], 'Glycopyrrolate': [0.2,0.04],
      'Ondansetron': [2,1], 'Vecuronium': [1,0.5], 'Atracurium': [10,5,2.5],
      'Cisatracurium': [2,1,0.5], 'Adrenaline (Epinephrine) Anaphylaxis': [10,5]
    };

    drugs.forEach(drug => {
      if (drug.name === 'Ketorolac') { drug.routes = ['IV', 'IM', 'Oral']; drug.defaultRoute = 'IV'; }
      else { drug.routes = drug.defaultRoute ? [drug.defaultRoute] : ['IV']; if (drug.imDose !== undefined) drug.routes.push('IM'); if (drug.oralDose !== undefined) drug.routes.push('Oral'); }
      drug.currentRoute = drug.defaultRoute;
    });

    antibiotics.forEach(antibiotic => {
      antibiotic.routes = antibiotic.routes.filter(route => route !== 'IM');
      if (antibiotic.defaultRoute === 'IM') { antibiotic.defaultRoute = antibiotic.routes.includes('IV') ? 'IV' : antibiotic.routes[0]; }
      antibiotic.currentRoute = antibiotic.defaultRoute;
      antibiotic.currentIndication = antibiotic.indications ? antibiotic.indications[0].name : 'Standard';
    });

    const initialDrugs = JSON.parse(JSON.stringify(drugs.map(d => ({
        name: d.name,
        defaultDose: d.defaultDose,
        imDose: d.imDose,
        oralDose: d.oralDose,
        concentration: d.concentration
    }))));

    function getPatientData(){
      const years = parseFloat(document.getElementById('age-years').value) || 0;
      const months = parseFloat(document.getElementById('age-months').value) || 0;
      const totalAge = years + (months/12);
      
      let weightInKg = parseFloat(document.getElementById('weight').value) || 0;
      
      if (currentWeightUnit === 'lbs' && weightInKg > 0) {
        weightInKg = weightInKg / KG_TO_LBS;
      }
      
      let heightInCm = 0;
      if (currentHeightUnit === 'cm') {
        heightInCm = parseFloat(document.getElementById('height-cm').value) || 0;
      } else {
        const ft = parseFloat(document.getElementById('height-ft').value) || 0;
        const inches = parseFloat(document.getElementById('height-in').value) || 0;
        heightInCm = (ft * FT_TO_CM) + (inches * IN_TO_CM);
      }
      
      const sex = document.getElementById('sex-male').checked ? 'male' : 'female';
      const totalAgeInMonths = (years * 12) + months;

      return {
        age: totalAge, ageYears: years, ageMonths: months,
        totalAgeInMonths: totalAgeInMonths,
        sex: sex,
        weight: weightInKg,
        height: heightInCm,
        currentHb: parseFloat(document.getElementById('currentHb').value) || 0,
        targetHb: parseFloat(document.getElementById('targetHb').value) || 0
      };
    }
    function clampAgeAndCalculate(){
      const ageYearsInput = document.getElementById('age-years');
      const ageMonthsInput = document.getElementById('age-months');
      let years = parseFloat(ageYearsInput.value);
      let months = parseFloat(ageMonthsInput.value);

      if (!isNaN(years)){
        years = Math.min(18, Math.max(0, years));
        ageYearsInput.value = years;
      } else if (ageYearsInput.value) { ageYearsInput.value = ''; }

      if (!isNaN(months)){
        months = Math.min(11, Math.max(0, months));
        if (years === 18) months = 0;
        ageMonthsInput.value = months;
      } else if (ageMonthsInput.value) { ageMonthsInput.value = ''; }

      calculateAll();
    }
	/**
     * Gets the current effective dose for a given route, prioritizing custom values.
     */
    function getDoseByRoute(drug, route) {
      const initialDrug = initialDrugs.find(d => d.name === drug.name);
      if (!initialDrug) return 0;

      switch (route) {
          case 'IV':
              return drug.customDoseIV !== null ? drug.customDoseIV : initialDrug.defaultDose;
          case 'IM':
              const defaultIM = initialDrug.imDose !== undefined ? initialDrug.imDose : initialDrug.defaultDose;
              return drug.customDoseIM !== null ? drug.customDoseIM : defaultIM;
          case 'Oral':
              const defaultOral = initialDrug.oralDose !== undefined ? initialDrug.oralDose : initialDrug.defaultDose;
              return drug.customDoseOral !== null ? drug.customDoseOral : defaultOral;
          default:
              return drug.customDoseIV !== null ? drug.customDoseIV : initialDrug.defaultDose;
      }
    }

    /**
     * Gets the current effective concentration, prioritizing custom values.
     */
    function getConcentration(drug) {
        const initialDrug = initialDrugs.find(d => d.name === drug.name);
        if (!initialDrug) return 0;
        return drug.customConcentration !== null ? drug.customConcentration : initialDrug.concentration;
    }

    /**
     * Checks if a drug has any custom values set that differ from the default.
     */
    function hasCustomValues(drug) {
      const initialDrug = initialDrugs.find(d => d.name === drug.name);
      if (!initialDrug) return false;

      const isIvDoseMod = drug.customDoseIV !== null;
      const isImDoseMod = drug.customDoseIM !== null;
      const isOralDoseMod = drug.customDoseOral !== null;
      const isConcMod = drug.customConcentration !== null;

      return isIvDoseMod || isImDoseMod || isOralDoseMod || isConcMod;
    }


    function countModifiedDrugs() {
      return drugs.filter(hasCustomValues).length;
    }
    /**
     * Selects a route for a drug and recalculates.
     */
    function selectRoute(index, route) {
      const drug = drugs[index];
      if (drug) {
        drug.currentRoute = route;
        activeEditIndex = index;
        calculateDrugs();
      }
    }


    function selectAntibioticRoute(index, route) {
      const antibiotic = antibiotics[index];
      if (antibiotic) {
        antibiotic.currentRoute = route;
        if (antibiotic.indications && antibiotic.indications.length > 0) { antibiotic.currentIndication = antibiotic.indications[0].name; }
        calculateAntibiotics();
      }
    }

    function selectAntibioticIndication(index, indication) {
      const antibiotic = antibiotics[index];
      if (antibiotic) { antibiotic.currentIndication = indication; calculateAntibiotics(); }
    }
    function calculateKetorolacDoseAndInfo(patient, drug) {
      const age = patient.age;
      const weight = patient.weight;
      const route = drug.currentRoute;
      let dosePerKg = 0.5; let totalDose = 0; let maxDosePerDose = 0; let maxDailyDose = 0;
      let duration = ''; let doseInfo = ''; let specialNote = ''; let displayDoseString = 'N/A';

      if (age < 2.0) {
        if (route === 'IV' || route === 'IM') {
          dosePerKg = 0.5; totalDose = weight * dosePerKg; maxDosePerDose = 15;
          totalDose = Math.min(totalDose, maxDosePerDose);
          displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;
          doseInfo = `Recommended: 0.5 mg/kg/dose Q6-8H (Range: 0.25-0.5 mg/kg/dose). Max ${maxDosePerDose} mg/dose.`;
          duration = 'Limited to 48-72 hours.';
          if (route === 'IM' && age < 0.5) { doseInfo = `IM use described in patients 6 months of age. Recommended IV: 0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose.`; }
        } else {
          doseInfo = 'Oral use is not recommended in this age group (<2 years).'; displayDoseString = 'Not Recommended'; totalDose = 'Not Recommended';
        }
      } else if (age >= 2.0 && age < 17.0) {
        if (route === 'IM' || route === 'IV') {
          dosePerKg = 0.5; totalDose = weight * dosePerKg; maxDosePerDose = 30;
          totalDose = Math.min(totalDose, maxDosePerDose);
          displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;
          doseInfo = `0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose. Max duration: 5 days.`; duration = 'Max duration: 5 days.';
        } else if (route === 'Oral') {
          dosePerKg = 1.0; totalDose = weight * dosePerKg; maxDosePerDose = 10; maxDailyDose = 40;
          totalDose = Math.min(totalDose, maxDosePerDose);
          displayDoseString = `${maxDosePerDose} mg Q4-6H (Max ${maxDailyDose} mg/day)`;
          doseInfo = `1 mg/kg/dose Q4-6H. Max ${maxDosePerDose} mg/dose. Max daily: ${maxDailyDose} mg/day.`;
          specialNote = 'Oral must **only** be used as a continuation of IV or IM therapy; do not use as initial therapy.';
          duration = 'Max combined duration: 5 days.';
        }
      } else if (age >= 17.0) {
        const isUnder50kg = weight < 50;
        if (route === 'IM') {
          totalDose = isUnder50kg ? 15 : 30; maxDosePerDose = isUnder50kg ? 30 : 60; maxDailyDose = isUnder50kg ? 60 : 120;
          dosePerKg = totalDose / weight;
          displayDoseString = isUnder50kg ? '15 mg Q6H (Max 30 mg single dose; Max daily: 60 mg)' : '30 mg Q6H (Max 60 mg single dose; Max daily: 120 mg)';
          doseInfo = `${totalDose} mg every 6 hours (OR ${maxDosePerDose} mg as a single dose). Max daily: ${maxDailyDose} mg/day.`;
          duration = 'Max combined duration (parenteral + oral): 5 days.';
        } else if (route === 'IV') {
          totalDose = isUnder50kg ? 15 : 30; maxDosePerDose = isUnder50kg ? 15 : 30; maxDailyDose = isUnder50kg ? 60 : 120;
          dosePerKg = totalDose / weight;
          displayDoseString = isUnder50kg ? '15 mg Q6H (Max 15 mg single dose; Max daily: 60 mg)' : '30 mg Q6H (Max 30 mg single dose; Max daily: 120 mg)';
          doseInfo = `${totalDose} mg every 6 hours (OR ${maxDosePerDose} mg as a single dose). Max daily: ${maxDailyDose} mg/day.`;
          duration = 'Max combined duration (parenteral + oral): 5 days.';
        } else if (route === 'Oral') {
          totalDose = 10; maxDosePerDose = 10; maxDailyDose = 40; dosePerKg = 10 / weight;
          displayDoseString = isUnder50kg ? 'Initial 10 mg, then 10 mg Q4-6H (Max 40 mg/day)' : 'Initial 20 mg, then 10 mg Q4-6H (Max 40 mg/day)';
          doseInfo = `Initial: ${isUnder50kg ? 10 : 20} mg, then 10 mg every 4 to 6 hours. Max daily: 40 mg/day.`;
          specialNote = 'The maximum combined duration of treatment (parenteral and oral) is 5 days. Oral is generally continuation therapy.';
          duration = 'Max combined duration: 5 days.';
        }
      } else { doseInfo = 'Enter Age and Weight for Ketorolac Dose.'; }

      let editableDosePerKg = (dosePerKg > 0) ? dosePerKg : 0;

      return { dosePerKg: editableDosePerKg, totalDose, displayDoseString, doseUnit: 'mg', doseInfo, specialNote, maxDosePerDose, maxDailyDose, duration };
    }

    function calculateAntibiotics() {
      const patient = getPatientData();
      const antibioticsDiv = document.getElementById('antibiotics-results');

      if (!patient.weight) {
        antibioticsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate antibiotic doses</p>';
        document.getElementById('toggleAllAntibioticsBtn').style.display = 'none';
        return;
      }
      document.getElementById('toggleAllAntibioticsBtn').style.display = 'block';

      let html = '';

      antibiotics.forEach((antibiotic, index) => {
        const weight = patient.weight;
        const currentIndication = antibiotic.indications.find(ind => ind.name === antibiotic.currentIndication) || { dose: antibiotic.defaultDose, frequency: 'Q6H' };
        
        const dosePerKg = currentIndication.dose;
        const frequency = currentIndication.frequency;
        let totalDose = weight * dosePerKg;
        let limitApplied = false;

        if (currentIndication.maxPerDose && totalDose > currentIndication.maxPerDose) { 
          totalDose = currentIndication.maxPerDose; 
          limitApplied = true; 
        }

        let volumeDisplay = 'N/A';
        let concentrationDisplay = '';
        if (antibiotic.currentRoute === 'IV') {
          const volume = totalDose / antibiotic.concentration;
          volumeDisplay = volume.toFixed(2);
          concentrationDisplay = `${antibiotic.concentration} ${antibiotic.concentrationUnit}`;
        }

        let isCautionNeeded = antibiotic.caution ? true : false;
        let cautionIconHtml = isCautionNeeded ? `<span class="caution-icon" id="antibiotic-caution-icon-${index}" onclick="event.stopPropagation(); toggleAntibioticCautionPopup(${index})">i</span>` : '';
        let cautionPopupHtml = isCautionNeeded ? `<div id="antibiotic-caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${antibiotic.caution}</div>` : '';
        
        let infoText = currentIndication.note ? currentIndication.note : (antibiotic.info ? antibiotic.info : '');
        let infoBoxHtml = infoText ? `<div class="info-box ketorolac-specific" style="border-left-color: var(--antibiotic);">${infoText}</div>` : '';


        let routeSelectorHTML = antibiotic.routes.length > 1 ? '<div class="route-selector">' + antibiotic.routes.map(route => `<input type="radio" id="antibiotic-route-${index}-${route}" name="antibiotic-route-${index}" value="${route}" ${antibiotic.currentRoute === route ? 'checked' : ''} onclick="event.stopPropagation(); selectAntibioticRoute(${index}, '${route}')"><label for="antibiotic-route-${index}-${route}">${route === 'Oral' ? 'Oral' : 'Intravenous (IV)'}</label>`).join('') + '</div>' : '';

        let indicationSelectorHTML = antibiotic.indications.length > 1 ? '<div class="indication-selector">' + antibiotic.indications.map(indication => `<input type="radio" id="antibiotic-indication-${index}-${indication.name.replace(/\s+/g, '-')}" name="antibiotic-indication-${index}" value="${indication.name}" ${antibiotic.currentIndication === indication.name ? 'checked' : ''} onclick="event.stopPropagation(); selectAntibioticIndication(${index}, '${indication.name}')"><label for="antibiotic-indication-${index}-${indication.name.replace(/\s+/g, '-')}">${indication.name}</label>`).join('') + '</div>' : '';

        let limitInfoHtml = limitApplied ? `<span class="dose-limit-applied">(MAX Limit Applied)</span>` : '';

        const volumeDetail = (antibiotic.currentRoute === 'IV') ?
          `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` :
          `<div class="volume-result" style="font-style:normal;">Concentration/Volume Not Applicable for Oral Dose</div>`;

        const isExpandedClass = (allAntibioticsExpanded || antibioticExpanded[index]) ? 'expanded' : '';

        html += `<div class="drug-card antibiotic ${isExpandedClass}" id="antibiotic-card-${index}">
            ${cautionPopupHtml}
            <div class="drug-header" onclick="toggleAntibioticCard(${index})">
              <div class="drug-name"><span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>${antibiotic.name}</div>
              <div class="drug-category antibiotic">${antibiotic.categoryLabel}</div>
              ${cautionIconHtml}
            </div>
            <div class="antibiotic-details" id="antibiotic-details-${index}">
              <div class="details-wrapper">
                ${routeSelectorHTML}${indicationSelectorHTML}${infoBoxHtml}
                
                <div class="antibiotic-detail-row"><div class="antibiotic-label">Frequency:</div><div class="antibiotic-value">${frequency}</div></div>
                <div class="calculation">
                  <div class="dose-info" style="margin-top: 0; padding-bottom: 4px; border-bottom: 1px dotted var(--border-color); margin-bottom: 5px;">Recommended: ${antibiotic.range}</div>
                  <div class="calculation-result" style="color: var(--antibiotic);">${totalDose.toFixed(2)} mg ${limitInfoHtml}</div>
                  ${volumeDetail}
                  <div class="dose-info">Calculated: ${dosePerKg} ${antibiotic.unit}</div>
                </div>
              </div>
            </div>
          </div>`;
      });

      antibioticsDiv.innerHTML = html;
      document.getElementById('toggleAllAntibioticsBtn').textContent = allAntibioticsExpanded ? 'Collapse All' : 'Expand All / Collapse All';
    }

    function calculateETTSize(age, weight){
      if (age === 0) return 'Enter Age (Years/Months)';
      if (age < 1){ if (weight === 0) return 'Enter Weight (kg)'; if (weight < 1.0) return '2.5'; if (weight <= 2.0) return '3.0'; return '3.5'; }
      if (age <= 18){ const calculatedSize = (age/4)+4; return (Math.round(calculatedSize * 2) / 2).toFixed(1); }
      return '7.5';
    }

    function calculateETTDepth(age, weight){
      const sizeStr = calculateETTSize(age, weight);
      if (sizeStr.includes('Enter') || sizeStr === 'N/A') return 'N/A';
      const size = parseFloat(sizeStr);
      if (age < 0.1 && weight > 0){ return (weight + 6).toFixed(1); }
      return (size * 3).toFixed(1);
    }

    function calculateCuffedETTSize(age, weight){
      const uncuffedSize = calculateETTSize(age, weight);
      if (uncuffedSize.includes('Enter') || uncuffedSize === 'N/A') return 'N/A';
      return (parseFloat(uncuffedSize) - 0.5).toFixed(1);
    }

    function calculateLaryngoscopeBlade(age){
      if (age < 1) return '0-1 (Miller)';
      if (age <= 2) return '1 (Miller)';
      if (age <= 6) return '2 (Mac)';
      return '3 (Mac)';
    }

    function calculateProSealLMASize(weight){
      if (weight === 0) return { size: 'N/A', cuffVolume: 'N/A' };
      if (weight < 5) return { size: '1', cuffVolume: 'Up to 4 mL' };
      if (weight < 10) return { size: '1.5', cuffVolume: 'Up to 7 mL' };
      if (weight < 20) return { size: '2', cuffVolume: 'Up to 10 mL' };
      if (weight < 30) return { size: '2.5', cuffVolume: 'Up to 14 mL' };
      if (weight < 50) return { size: '3', cuffVolume: 'Up to 20 mL' };
      if (weight < 70) return { size: '4', cuffVolume: 'Up to 30 mL' };
      return { size: '5', cuffVolume: 'Up to 40 mL' };
    }

    function calculateIGelSize(weight){
      if (weight < 5) return '1';
      if (weight < 10) return '1.5';
      if (weight < 25) return '2';
      if (weight < 35) return '2.5';
      if (weight < 60) return '3';
      if (weight < 90) return '4';
      return '5';
    }
	function calculateCentralLineSize(weight){
      if (weight === 0) return 'N/A';
      if (weight <= 5) return '3.0 Fr';
      if (weight <= 10) return '4.0 Fr';
      if (weight <= 40) return '5.0 Fr';
      return '7.0 Fr';
    }

    function calculateGuedelAirway(weight, age) {
        if (age > 0) {
            if (age < 0.1) return { size: '00', length: '50 mm', color: 'var(--induction)' };
            if (age < 1) return { size: '0', length: '60 mm', color: '#222222' };
            if (age < 5) return { size: '1', length: '70 mm', color: '#F0F0F0' };
            if (age < 12) return { size: '2', length: '80 mm', color: 'var(--primary-accent)' };
            if (age < 16) return { size: '3', length: '90 mm', color: 'var(--muscle-relaxant)' };
            return { size: '4', length: '100 mm', color: 'var(--reversal)' };
        }
        if (weight > 0) {
            if (weight < 3) return { size: '000', length: '40 mm', color: 'var(--local-anesthetic)' };
            if (weight < 5) return { size: '00', length: '50 mm', color: 'var(--induction)' };
            if (weight < 10) return { size: '0', length: '60 mm', color: '#222222' };
            if (weight < 20) return { size: '1', length: '70 mm', color: '#F0F0F0' };
            if (weight < 40) return { size: '2', length: '80 mm', color: 'var(--primary-accent)' };
            if (weight < 60) return { size: '3', length: '90 mm', color: 'var(--muscle-relaxant)' };
            if (weight < 90) return { size: '4', length: '100 mm', color: 'var(--reversal)' };
            return { size: '5', length: '110 mm', color: 'var(--emergency)' };
        }
        return { size: 'N/A', length: 'N/A', color: 'var(--border-color)' };
    }

    function calculateFaceMask(weight, age) {
        if (age > 0) {
            if (age < 0.1) return { size: '0', color: 'var(--local-anesthetic)' };
            if (age < 1) return { size: '1', color: 'var(--emergency)' };
            if (age < 5) return { size: '2', color: '#F0F0F0' };
            if (age < 12) return { size: '3', color: 'var(--muscle-relaxant)' };
            if (age < 16) return { size: '4', color: 'var(--reversal)' };
            return { size: '5', color: 'var(--primary-accent)' };
        }
        if (weight > 0) {
            if (weight < 3) return { size: '0', color: 'var(--local-anesthetic)' };
            if (weight < 10) return { size: '1', color: 'var(--emergency)' };
            if (weight < 20) return { size: '2', color: '#F0F0F0' };
            if (weight < 40) return { size: '3', color: 'var(--muscle-relaxant)' };
            if (weight < 70) return { size: '4', color: 'var(--reversal)' };
            return { size: '5', color: 'var(--primary-accent)' };
        }
        return { size: 'N/A', color: 'var(--border-color)' };
    }

    function calculateRylesTube(weight, age) {
        if (age > 0) {
            if (age < 0.1) return { size: '6 Fr', color: 'var(--antiemetic)' };
            if (age < 3) return { size: '8 Fr', color: 'var(--induction)' };
            if (age < 8) return { size: '10 Fr', color: '#222222' };
            return { size: '12 Fr', color: '#F0F0F0' };
        }
        if (weight > 0) {
            if (weight < 2.5) return { size: '5 Fr', color: 'var(--antibiotic)' };
            if (weight < 5) return { size: '6 Fr', color: 'var(--antiemetic)' };
            if (weight < 15) return { size: '8 Fr', color: 'var(--induction)' };
            if (weight < 30) return { size: '10 Fr', color: '#222222' };
            return { size: '12 Fr', color: '#F0F0F0' };
        }
        return { size: 'N/A', color: 'var(--border-color)' };
    }

    function calculateEquipment(){
      const patient = getPatientData();
      const uncuffedSize = calculateETTSize(patient.age, patient.weight);
      const cuffedSize = calculateCuffedETTSize(patient.age, patient.weight);
      const depth = calculateETTDepth(patient.age, patient.weight);
      const blade = calculateLaryngoscopeBlade(patient.age);
      const proSealLMA = calculateProSealLMASize(patient.weight);
      const igelSize = patient.weight === 0 ? 'N/A' : calculateIGelSize(patient.weight);
      const centralLineSize = calculateCentralLineSize(patient.weight);
      
      const guedel = calculateGuedelAirway(patient.weight, patient.age);
      const mask = calculateFaceMask(patient.weight, patient.age);
      const ryles = calculateRylesTube(patient.weight, patient.age);

      let uncuffedValueClass = 'equipment-value';
      if (uncuffedSize.includes('Enter')){ uncuffedValueClass += ' error'; }

      const equipmentHTML = `
        <div class="equipment-card">
          <div class="equipment-title">ETT Size (Uncuffed)</div>
          <div class="${uncuffedValueClass}">${uncuffedSize}</div>
          <div class="equipment-detail">Depth: ${depth} cm at lips</div>
        </div>
        <div class="equipment-card">
          <div class="equipment-title">ETT Size (Cuffed)</div>
          <div class="equipment-value">${cuffedSize}</div>
          <div class="equipment-detail">Depth: ${depth} cm at lips</div>
        </div>
        
        <div class="equipment-card" style="background-color: #f0f9ff; border-color: #0ea5e9;">
          <div class="equipment-title" style="color: #0369a1;">Nasal ETT Depth</div>
          <div class="equipment-value" style="color: #0369a1;">${
             (patient.age < 1 && patient.weight > 0) ? (patient.weight + 7).toFixed(1) : 
             (patient.age >= 1) ? (15 + (patient.age / 2)).toFixed(1) : 'N/A'
          }</div>
          <div class="equipment-detail">cm at nares</div>
        </div>
        <div class="equipment-card">
          <div class="equipment-title">Laryngoscope Blade</div>
          <div class="equipment-value">${blade}</div>
          <div class="equipment-detail">Based on age</div>
        </div>
        <div class="equipment-card">
          <div class="equipment-title">ProSeal LMA Size</div>
          <div class="equipment-value">${proSealLMA.size}</div>
          <div class="equipment-detail">Cuff: ${proSealLMA.cuffVolume}</div>
        </div>
        <div class="equipment-card">
          <div class="equipment-title">i-gel Size</div>
          <div class="equipment-value">${igelSize}</div>
          <div class="equipment-detail">Based on weight</div>
        </div>
        <div class="equipment-card">
          <div class="equipment-title">Central Line Catheter</div>
          <div class="equipment-value">${centralLineSize}</div>
          <div class="equipment-detail">French size based on weight</div>
        </div>
        
        <div class="equipment-card" style="border: 3px solid ${mask.color};">
          <div class="equipment-title">Anesthesia Face Mask</div>
          <div class="equipment-value">${mask.size}</div>
          <div class="equipment-detail">Size (0-5)</div>
        </div>
        <div class="equipment-card" style="border: 3px solid ${guedel.color};">
          <div class="equipment-title">Guedel's Airway (OPA)</div>
          <div class="equipment-value">${guedel.size}</div>
          <div class="equipment-detail">${guedel.length}</div>
        </div>
        <div class="equipment-card" style="border: 3px solid ${ryles.color};">
          <div class="equipment-title">Ryle's Tube (NG)</div>
          <div class="equipment-value">${ryles.size}</div>
          <div class="equipment-detail">Diameter (for feeding)</div>
        </div>
        `;
      
      const infoBoxHTML = `
        <div class="info-box" style="grid-column: 1/-1; margin-top: 10px;">
          <strong><i class="fas fa-ruler-combined"></i> Sizing Confirmation:</strong>
          <ul style="margin-left: 20px; margin-top: 5px; list-style-type: disc; padding-left: 15px;">
            <li><strong>Face Mask:</strong> Visually fit from <strong>bridge of nose</strong> to <strong>groove of chin</strong>.</li>
            <li><strong>Guedel's Airway (OPA):</strong> Measure from <strong>corner of mouth</strong> to <strong>angle of the mandible</strong>.</li>
            <li><strong>Ryle's Tube (NG) Length:</strong> Measure using the **NEX method** (Tip of **N**ose &rarr; **E**arlobe &rarr; **X**iphoid process).</li>
          </ul>
        </div>
      `;

      document.getElementById('equipment-results').innerHTML = equipmentHTML + infoBoxHTML;
    }

    function calculateMaintenanceFluid(weight){
      if (weight <= 10) return weight * 4;
      if (weight <= 20) return 40 + (weight - 10) * 2;
      return 60 + (weight - 20) * 1;
    }

    function calculateEBV(weight, age){
      if (weight === 0) return 0;
      if (age < 0.1) return weight * 90;
      if (age < 1) return weight * 85;
      if (age < 3) return weight * 80;
      if (age < 6) return weight * 75;
      if (age < 12) return weight * 70;
      return weight * 65;
    }

    function calculateMABL(EBV, initialHb, targetHb){
      if (initialHb <= targetHb || initialHb === 0 || EBV === 0) return 0;
      const MABL = EBV * (initialHb - targetHb) / initialHb;
      return Math.max(0, MABL);
    }

    function calculatePerioperativeBolus(weight) {
      if (weight === 0) return 'N/A';
      const lowRange = weight * 20;
      const highRange = weight * 40;
      return `${lowRange.toFixed(0)}-${highRange.toFixed(0)} mL`;
    }

    function calculatePostopMaintenance(weight) {
      if (weight === 0) return 'N/A';
      let maintenance = 0;
      if (weight <= 10) { maintenance = weight * 2; }
      else if (weight <= 20) { maintenance = 20 + (weight - 10) * 1; }
      else { maintenance = 30 + (weight - 20) * 0.5; }
      return `${maintenance.toFixed(0)} mL/hr`;
    }

    function calculateFluids(){
      const patient = getPatientData();
      const fluidResultsEl = document.getElementById('fluid-results');

      if (!patient.weight){
        fluidResultsEl.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate fluids and drug doses</p>';
        return;
      }

      const maintenance = calculateMaintenanceFluid(patient.weight);
      const bolus = patient.weight * 10;
      const EBV = calculateEBV(patient.weight, patient.age);
      const perioperativeBolus = calculatePerioperativeBolus(patient.weight);
      const postopMaintenance = calculatePostopMaintenance(patient.weight);

      let MABL_Result = "N/A";
      let MABL_Detail = "Requires Current & Target Hb";

      if (patient.currentHb > 0 && patient.targetHb > 0){
        const calculatedMABL = calculateMABL(EBV, patient.currentHb, patient.targetHb);
        MABL_Result = `${calculatedMABL.toFixed(0)} mL`;
        MABL_Detail = `Hb Drop: ${patient.currentHb.toFixed(1)}  ${patient.targetHb.toFixed(1)} g/dL`;
      } else {
        MABL_Result = `${(EBV * 0.15).toFixed(0)} - ${(EBV * 0.3).toFixed(0)} mL`;
        MABL_Detail = `Estimated Max (15-30% of EBV)`;
      }

      const fluidHTML = `
        <div class="equipment-card"><div class="equipment-title">Maintenance Fluid</div><div class="equipment-value">${maintenance.toFixed(0)} mL/hr</div><div class="equipment-detail">4-2-1 rule</div></div>
        <div class="equipment-card"><div class="equipment-title">Fluid Bolus</div><div class="equipment-value">${bolus.toFixed(0)} mL</div><div class="equipment-detail">10 mL/kg</div></div>
        <div class="equipment-card"><div class="equipment-title">Est. Blood Volume (EBV)</div><div class="equipment-value">${EBV.toFixed(0)} mL</div><div class="equipment-detail">Age-based mL/kg used</div></div>
        <div class="equipment-card"><div class="equipment-title">Max Allowable Blood Loss (MABL)</div><div class="equipment-value">${MABL_Result}</div><div class="equipment-detail">${MABL_Detail}</div></div>
        <div class="equipment-card"><div class="equipment-title">Perioperative Bolus</div><div class="equipment-value">${perioperativeBolus}</div><div class="equipment-detail">20-40 mL/kg (Alternative)</div></div>
        <div class="equipment-card"><div class="equipment-title">Postop Maintenance</div><div class="equipment-value">${postopMaintenance}</div><div class="equipment-detail">2-1-0.5 rule (12 hrs)</div></div>
      `;

      fluidResultsEl.innerHTML = `${fluidHTML}<div class="info-box" style="grid-column: 1/-1; margin-top: 10px;">
          <strong>Perioperative Fluid Note:</strong> For children with marginal to moderate hypovolemia (e.g., fasting for surgery), administer 20-40 mL/kg of isotonic fluids during surgery and in PACU. Postoperatively, use the 2-1-0.5 rule for the first 12 hours or until patient starts drinking.
          <a href="https://www.openanesthesia.org/keywords/perioperative-fluid-administration-in-children/" target="_blank" style="color: var(--primary-accent);">Source</a>
        </div>`;
    }

    function calculateIntralipid() {
      const patient = getPatientData();
      const intralipidDiv = document.getElementById('intralipid-results');

      if (!patient.weight) {
        intralipidDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Enter patient weight to calculate LAST rescue doses</p>';
        return;
      }
      
      const weight = patient.weight;
      const concentrationMgPerMl = 200;
      const bolusDoseMlPerKg = 1.5;
      const infusionRateMlPerKgPerMin = 0.25;
      const maxDoseMlPerKg = 10;

      const bolusMl = bolusDoseMlPerKg * weight;
      const bolusMg = bolusMl * concentrationMgPerMl;
      const infusionMlPerMin = infusionRateMlPerKgPerMin * weight;
      const maxCumulativeMl = maxDoseMlPerKg * weight;

      const bolusMlDisplay = bolusMl.toFixed(1);
      const bolusMgDisplay = bolusMg.toFixed(0);
      const infusionMlPerMinDisplay = infusionMlPerMin.toFixed(1);
      const maxCumulativeMlDisplay = maxCumulativeMl.toFixed(0);

      const intralipidHtml = `
        <div class="drug-card reversal expanded" style="border-color: var(--reversal);">
          <div class="drug-header" style="cursor: default; padding-bottom: 0;">
            <div class="drug-name">20% Intralipid Dosing Protocol</div>
            <div class="drug-category reversal">LAST Rescue</div>
          </div>
          <div class="la-results-container" style="gap: 12px; margin-top: 15px;">
            <div class="la-result-row" style="grid-template-columns: 1fr; border-bottom: 2px solid var(--border-color); padding-bottom: 12px;">
              <div style="font-size: 1.1em; line-height: 1.6; color: var(--text-primary);">
                Give bolus of <strong>${bolusMgDisplay} mg</strong> (<strong>${bolusMlDisplay} mL</strong>) over 1-2 mins.
              </div>
            </div>
            <div class="la-result-row" style="grid-template-columns: 1fr; border: none;">
              <div style="font-size: 1em; line-height: 1.6; color: var(--text-primary);">
                Start infusion immediately after bolus at <strong>${infusionMlPerMinDisplay} mL/min</strong>.
                <br>Bolus can be repeated 1-2 times at 5 min interval if HD instability present.
                <br>If HD stability not restored after 5-10 min, double infusion rate to <strong>${(infusionMlPerMinDisplay * 2).toFixed(1)} mL/min</strong>.
                <br>Max cumulative dose is <strong>${maxCumulativeMlDisplay} mL</strong>.
              </div>
            </div>
          </div>
          <div class="dose-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); font-style:normal;">
              Doses are for <strong>20% Intralipid (200 mg/mL)</strong> based on patient weight of ${weight.toFixed(1)} kg.
          </div>
        </div>
      `;

      intralipidDiv.innerHTML = intralipidHtml;
    }

    function calculateLocalAnesthetics() {
      const patient = getPatientData();
      const localAnestheticsDiv = document.getElementById('local-anesthetics-results');

      if (!patient.weight) {
        localAnestheticsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate maximum doses</p>';
        return;
      }

      let resultsListHtml = '';

      localAnesthetics.forEach((la) => {
        const maxDose = patient.weight * la.maxDose;
        const maxDoseDisplay = maxDose.toFixed(1);
        resultsListHtml += `<div class="la-result-row">
            <div class="la-name">${la.name}</div>
            <div class="la-max-dose">
              ${maxDoseDisplay} ${la.unit.split('/')[0]}
              <span class="la-detail">${la.maxDose} ${la.unit} | ${la.caution}</span>
            </div>
          </div>`;
      });

      const singleCardHtml = `
        <div class="drug-card local-anesthetic expanded" style="border-color: var(--local-anesthetic);">
          <div class="drug-header" style="cursor: default; padding-bottom: 0;">
            <div class="drug-name">Maximum Safe Doses</div>
            <div class="drug-category local-anesthetic">Local Anesthetics</div>
          </div>
          <div class="la-results-container">${resultsListHtml}</div>
          <div class="dose-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); font-style:normal;">
              Doses are based on patient weight of ${patient.weight.toFixed(1)} kg.
          </div>
        </div>
      `;

      localAnestheticsDiv.innerHTML = singleCardHtml;

      calculateIntralipid();
    }

    function parseMaxDoseFromRange(rangeString){
      if (!rangeString) return null;
      const numbers = rangeString.match(/(\d+\.?\d*)/g);
      if (!numbers || numbers.length === 0) return null;
      const maxDose = numbers.reduce((max, cur) => {
        const num = parseFloat(cur);
        return (!isNaN(num) && num > max) ? num : max;
      }, 0);
      return maxDose > 0 ? maxDose : null;
    }

      function calculateBicarbDeficit() {
          const baseDeficitInput = document.getElementById('base-deficit-input');
          const baseDeficit = baseDeficitInput ? (parseFloat(baseDeficitInput.value) || 0) : 0;
          
          currentBaseDeficit = baseDeficit;
          
          calculateDrugs();
      }

      function calculateDrugs(){
      const patient = getPatientData();
      const drugResultsDiv = document.getElementById('drug-results');
      
      const baseDeficit = currentBaseDeficit;

      if (!patient.weight){
        drugResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate drug doses</p>';
        document.getElementById('toggleAllBtn').style.display = 'none';
        return;
      }
      document.getElementById('toggleAllBtn').style.display = 'block';

      let html = '';
      let currentCategoryLabel = null;

      const sortedDrugs = [...drugs].sort((a, b) => a.categoryLabel.localeCompare(b.categoryLabel));

      sortedDrugs.forEach((drug) => {

        const originalIndex = drugs.findIndex(d => d.name === drug.name);

        const currentSortedIndex = sortedDrugs.findIndex(d => d.name === drug.name);
        const prevSortedDrug = (currentSortedIndex > 0) ? sortedDrugs[currentSortedIndex - 1] : null;

        if (!prevSortedDrug || drug.categoryLabel !== prevSortedDrug.categoryLabel) {
            currentCategoryLabel = drug.categoryLabel;
            html += `<h3 class="category-heading">${currentCategoryLabel}</h3>`;
        }

        const paramValue = patient[drug.useParam];

        let dosePerKg;
        let concentration;
        let totalDose = 0;
        let limitApplied = false;
        let doseAdjusted = false;
        let concentrationDisplay = '';
        let volumeDisplay = 'N/A';
        let totalDoseUnit = drug.unit.includes('mcg') ? 'mcg' : 'mg';
		if (drug.unit.toLowerCase().includes('joules')) totalDoseUnit = 'Joules';
        let isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
        
        let ketorolacInfoBox = '';
        let descriptionBox = '';
        let notesBox = '';
        let bicarbInputHtml = '';
        let bicarbInfoBox = '';
        
        let calculationHtml = '';
        let doseDisplay = 'N/A';
        let limitInfoHtml = '';
        let adjustedInfoHtml = '';

        if(drug.notes) {
          notesBox = `<div class="info-box ketorolac-specific" style="border-left-color: var(--${drug.category}); margin-top: 8px;">${drug.notes}</div>`;
        }
        if(drug.description) {
          descriptionBox = `<div class="info-box ketorolac-specific" style="border-left-color: var(--${drug.category});">${drug.description}</div>`;
        }
        
        let resultColorStyle = '';
        if(drug.category) {
            resultColorStyle = `style="color: var(--${drug.category});"`;
            if(drug.category === 'induction' || drug.category === 'antiemetic' || (drug.category === 'emergency' && document.body.classList.contains('dark-mode'))) {
                resultColorStyle = `style="color: var(--${drug.category}); text-shadow: 0 0 5px rgba(0,0,0,0.2);"`;
            }
        } else {
            resultColorStyle = `style="color: var(--primary-accent);"`;
        }

        if (drug.specialHandling === 'bicarbonate') {
          isInjectable = true;
          totalDoseUnit = 'mEq';
          concentration = getConcentration(drug);
          concentrationDisplay = `${concentration} ${drug.concentrationUnit}`;

          bicarbInputHtml = `
            <div class="edit-input-field" style="margin-bottom: 10px; padding: 10px; background: var(--bg-primary); border-radius: var(--radius-input); border: 1px dashed var(--border-color);">
              <label for="base-deficit-input" style="font-weight: 600;">Base Deficit (mEq/L)</label>
              <div style="display: flex; gap: 10px;">
                <input type="number" id="base-deficit-input" value="${baseDeficit > 0 ? baseDeficit : ''}" placeholder="Enter base deficit (if known)" style="flex: 1;">
                <button class="edit-btn" onclick="calculateBicarbDeficit()" style="margin-top: 0; padding: 6px 12px; font-size: 0.8em;">Calculate</button>
              </div>
            </div>
          `;

          if (baseDeficit > 0) {
            totalDose = 0.3 * paramValue * baseDeficit;
            const halfDose = totalDose / 2;
            doseDisplay = `${totalDose.toFixed(2)} mEq`;
            dosePerKg = 'N/A (Deficit)';
            volumeDisplay = (halfDose / concentration).toFixed(2); 

            bicarbInfoBox = `<div class="info-box ketorolac-specific" style="border-left-color: var(--${drug.category});">
                              <strong>Calculated Total Deficit:</strong> ${totalDose.toFixed(2)} mEq<br>
                              <strong>Recommended Initial Dose:</strong> Give <strong>${halfDose.toFixed(2)} mEq</strong> (${volumeDisplay} mL) slowly, then reassess.
                            </div>`;
            
            calculationHtml = `
              <div class="calculation-result" ${resultColorStyle}>${doseDisplay} (Total Deficit)</div>
              <div class="volume-result">Initial Dose Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>
              <div class="dose-info">Calculated: 0.3 x ${paramValue} kg x ${baseDeficit} BE</div>
            `;

          } else {
            dosePerKg = getDoseByRoute(drug, drug.currentRoute); 
            totalDose = paramValue * dosePerKg;
            if (drug.maxDose && totalDose > drug.maxDose){ totalDose = drug.maxDose; limitApplied = true; }
            if (drug.minDose && totalDose < drug.minDose){ totalDose = drug.minDose; limitApplied = true; }
            
            doseDisplay = `${totalDose.toFixed(2)} ${totalDoseUnit}`;
            volumeDisplay = (totalDose / concentration).toFixed(2);
            
            if(limitApplied) limitInfoHtml = `<span class="dose-limit-applied">(MAX Limit Applied)</span>`;

            bicarbInfoBox = `<div class="info-box ketorolac-specific" style="border-left-color: var(--${drug.category});">
                              <strong>Emergency Bolus:</strong> No base deficit entered. Using standard bolus dose.
                            </div>`;

            calculationHtml = `
              <div class="calculation-result" ${resultColorStyle}>${doseDisplay} ${limitInfoHtml}</div>
              <div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>
              <div class="dose-info">Calculated: ${dosePerKg} ${drug.unit}</div>
            `;
          }

        } else if (drug.name === 'Ketorolac') {
          const ketorolacCalc = calculateKetorolacDoseAndInfo(patient, drug);
          let customDose = null;
          if(drug.currentRoute === 'IV') customDose = drug.customDoseIV;
          else if(drug.currentRoute === 'IM') customDose = drug.customDoseIM;
          else if(drug.currentRoute === 'Oral') customDose = drug.customDoseOral;

          dosePerKg = (customDose !== null) ? customDose : ketorolacCalc.dosePerKg;
          totalDose = (customDose !== null) ? (paramValue * customDose) : ketorolacCalc.totalDose;
          totalDoseUnit = ketorolacCalc.doseUnit;
          doseDisplay = (customDose !== null) ? `${totalDose.toFixed(2)} ${totalDoseUnit}` : ketorolacCalc.displayDoseString;

          ketorolacInfoBox = `<div class="info-box ketorolac-specific"><strong>Ketorolac Dosing for ${patient.weight.toFixed(1)} kg (${patient.ageYears} Y, ${patient.ageMonths} M):</strong><div>${ketorolacCalc.doseInfo}</div><div>${ketorolacCalc.duration}</div>${ketorolacCalc.specialNote ? `<div>**Note:** ${ketorolacCalc.specialNote}</div>` : ''}</div>`;
          
          concentration = getConcentration(drug);
          if (isInjectable && typeof totalDose === 'number' && totalDose > 0){
            volumeDisplay = (totalDose / concentration).toFixed(2);
            concentrationDisplay = `${concentration} ${drug.concentrationUnit}`;
          }

          calculationHtml = `
            <div class="calculation-result" ${resultColorStyle}>${doseDisplay}</div>
            ${isInjectable ? `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` : ''}
            ${drug.name !== 'Ketorolac' ? `<div class="dose-info">Calculated: ${dosePerKg} ${drug.unit}</div>` : ''}
          `;

        } else {
          dosePerKg = getDoseByRoute(drug, drug.currentRoute);

          if (drug.name.includes('Paracetamol') && patient.weight > 0 && patient.weight < 10){
            const initialDrug = initialDrugs.find(d => d.name === drug.name);
            if (initialDrug && dosePerKg === initialDrug.defaultDose && initialDrug.defaultDose === 15){
              dosePerKg = 7.5;
              doseAdjusted = true;
            }
          }

          totalDose = paramValue * dosePerKg;

          if (drug.maxDose && totalDose > drug.maxDose){ totalDose = drug.maxDose; limitApplied = true; }
          if (drug.minDose && totalDose < drug.minDose){ totalDose = drug.minDose; limitApplied = true; }

          if (drug.unit.includes('mcg') && totalDose < 1) { doseDisplay = `${(totalDose * 1000).toFixed(0)} mcg`; }
          else { doseDisplay = `${totalDose.toFixed(2)} ${totalDoseUnit}`; }

          concentration = getConcentration(drug);

          if (isInjectable && typeof totalDose === 'number' && totalDose > 0){
            let volume = totalDose / concentration;
            let currentConc = concentration;

            if (volume < 1 && dilutionTiers[drug.name]){
              const newConc = dilutionTiers[drug.name].find(conc => (totalDose / conc) >= 1);
              if (newConc){ volume = totalDose / newConc; currentConc = newConc; }
            }
            volumeDisplay = volume.toFixed(2);
            concentrationDisplay = `${currentConc} ${drug.concentrationUnit}${currentConc !== concentration ? ' (Diluted)' : ''}`;
          }
          
          if(limitApplied) limitInfoHtml = `<span class="dose-limit-applied">(MAX Limit Applied)</span>`;
          if(doseAdjusted) adjustedInfoHtml = `<span class="dose-limit-applied">(Adjusted for weight < 10 kg)</span>`;

          calculationHtml = `
            <div class="calculation-result" ${resultColorStyle}>${doseDisplay} ${limitInfoHtml} ${adjustedInfoHtml}</div>
            ${isInjectable ? `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` : ''}
            <div class="dose-info">Calculated: ${dosePerKg} ${drug.unit}</div>
          `;
        }
        
        let isCustomDoseHigh = drug.isCustomDoseHigh || false;
        const currentDoseForRangeCheck = getDoseByRoute(drug, drug.currentRoute);
        const rangeMax = parseMaxDoseFromRange(drug.range);
        if (rangeMax && currentDoseForRangeCheck > rangeMax) { 
            isCustomDoseHigh = true; 
        }

        let isContraindicated = false;
        let contraindicationText = '';

        if (drug.ageMin && patient.age < drug.ageMin) {
            isContraindicated = true;
            contraindicationText = `Contraindicated for age < ${drug.ageMin} years.`;
        }
        if (drug.ageMinMonths && (patient.age * 12) < drug.ageMinMonths) { 
            isContraindicated = true;
            contraindicationText = `Contraindicated for age < ${drug.ageMinMonths} months.`;
        }
        if (drug.name.includes('Calcium Gluconate') && patient.age < 0.077) { 
            isContraindicated = true;
            contraindicationText = drug.caution;
        }
        
        let cautionActive = drug.caution || isCustomDoseHigh || isContraindicated;
        let cautionIconHtml = '';
        let cautionPopupHtml = '';
        
        if (cautionActive) {
            cautionIconHtml = `<span class="caution-icon" id="caution-icon-${originalIndex}" onclick="event.stopPropagation(); toggleCautionPopup(${originalIndex})">i</span>`;
            
            let popupMessage = '';
            if (isContraindicated) {
                popupMessage = `<strong>CONTRAINDICATION:</strong> ${contraindicationText} ${drug.caution ? ` <br><br><strong>Also:</strong> ${drug.caution.replace('**CONTRAINDICATION:**', '')}` : ''}`;
            } else if (isCustomDoseHigh) {
                popupMessage = `<strong>CAUTION:</strong> Custom dose (${currentDoseForRangeCheck} ${drug.unit}) exceeds recommended range (${drug.range}). ${drug.caution ? ` <br><br><strong>Also:</strong> ${drug.caution}` : ''}`;
            } else {
                popupMessage = `<strong>CAUTION:</strong> ${drug.caution}`;
            }
            cautionPopupHtml = `<div id="caution-popup-${originalIndex}" class="caution-popup">${popupMessage}</div>`;
        }
        
        const haloClass = (isContraindicated || isCustomDoseHigh) ? 'dose-limit-exceeded' : '';
        const hasCustom = hasCustomValues(drug);
        const customIndicator = hasCustom ? ' has-custom' : '';

        let routeSelectorHTML = '';
        if (drug.routes && drug.routes.length > 1) {
          routeSelectorHTML = '<div class="route-selector">' + drug.routes.map(route => {
            const checked = drug.currentRoute === route ? 'checked' : '';
            const routeName = (route === 'IV' ? 'Intravenous (IV)' : (route === 'IM' ? 'Intramuscular (IM)' : 'Oral'));
            return `<input type="radio" id="route-${originalIndex}-${route}" name="route-${originalIndex}" value="${route}" ${checked} onclick="event.stopPropagation(); selectRoute(${originalIndex}, '${route}')"><label for="route-${originalIndex}-${route}">${routeName}</label>`;
          }).join('') + '</div>';
        }

        const isEditing = activeEditIndex === originalIndex;
        const isModified = hasCustomValues(drug); 

        const editInputsHtml = `
          <div class="edit-inputs ${isEditing ? 'active' : ''}" id="edit-inputs-${originalIndex}">
            <div class="edit-inputs-wrapper">
                <div class="edit-inputs-content">
                    <div class="edit-input-grid">
                      <div class="edit-input-field">
                        <label for="dose-${originalIndex}">Dose (${drug.unit})</label>
                        <input type="number" id="dose-${originalIndex}" value="${dosePerKg}" step="0.01" min="0">
                      </div>
                      ${isInjectable ? `<div class="edit-input-field">
                                          <label for="conc-${originalIndex}">Concentration (${drug.concentrationUnit})</label>
                                          <input type="number" id="conc-${originalIndex}" value="${concentration}" step="0.01" min="0">
                                       </div>` : ''}
                    </div>
                    <div class="edit-actions">
                      <button class="edit-btn" onclick="updateDrug(${originalIndex})">Update</button>
                      ${isModified ? `<button class="edit-btn reset-btn" onclick="resetDrugToDefault(${originalIndex})">Reset</button>` : ''}
                    </div>
                </div>
            </div>
          </div>`;

        const isExpandedClass = (allExpanded || drug.isExpanded) ? 'expanded' : '';
        
        html += `<div class="drug-card ${drug.category} ${isExpandedClass} ${haloClass}" id="drug-card-${originalIndex}">

            ${cautionPopupHtml}
            <div class="drug-header" onclick="toggleDrugCard(${originalIndex})">
              <div class="drug-name${customIndicator}">
                <span class="favorite-toggle-btn ${drug.isFavorite ? 'favorited' : ''}" id="fav-btn-${originalIndex}" onclick="event.stopPropagation(); toggleFavorite(${originalIndex})">
                    <i class="fas fa-star"></i>
                </span>
                <span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>${drug.name}
              </div>

              <div class="drug-header-right-group">
                <div class="drug-dose-preview" ${resultColorStyle}>
                    ${doseDisplay}
                </div>
                <div class="drug-category ${drug.category}">${drug.categoryLabel}</div>
                ${cautionIconHtml}
              </div>
            </div>
            <div class="drug-details" id="drug-details-${originalIndex}">
              <div class="details-wrapper">
                  ${bicarbInputHtml}
                  ${bicarbInfoBox}
                  ${ketorolacInfoBox}${descriptionBox}${notesBox}${routeSelectorHTML}
                  
                  <div class="calculation">
                    <div class="dose-info" style="margin-top: 0; padding-bottom: 4px; border-bottom: 1px dotted var(--border-color); margin-bottom: 5px;">Recommended: ${drug.range}</div>
                    ${calculationHtml} 
                  </div>
                  
                  ${ (drug.specialHandling === 'bicarbonate' && baseDeficit > 0) ? '' : `
                    <button class="edit-btn" onclick="toggleEdit(${originalIndex})">${isEditing ? 'Close Edit' : 'Edit Dose/Concentration'}</button>
                    ${editInputsHtml}
                  `}
              </div>
            </div>
          </div>`;
          
      });

      drugResultsDiv.innerHTML = html;
      filterDrugs();

      document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
    }

    /**
     * Checks if a custom infusion differs from its default.
     */
    function isInfusionModified(infusion) {
      return infusion.currentDose !== infusion.defaultDose ||
             infusion.currentDilutionAmount !== infusion.defaultDilutionAmount ||
             infusion.currentDilutionUnit !== infusion.defaultDilutionUnit ||
             infusion.currentDilutionVol !== infusion.defaultDilutionVol;
    }
    /**
     * Resets a single infusion's custom values to default.
     */
    function resetInfusion(index) {
      const infusion = infusionDrugs[index];
      if (!infusion) return;

      infusion.currentDose = infusion.defaultDose;
      infusion.currentDilutionAmount = infusion.defaultDilutionAmount;
      infusion.currentDilutionUnit = infusion.defaultDilutionUnit;
      infusion.currentDilutionVol = infusion.defaultDilutionVol;

      calculateInfusions();
    }
    /**
     * Updates an infusion's custom values based on input fields.
     */
    function updateInfusion(index) {
      const infusion = infusionDrugs[index];
      if (!infusion) return;

      requestAnimationFrame(() => {
          const doseInput = document.getElementById(`infusion-dose-${index}`);
          const amountInput = document.getElementById(`infusion-dilution-amount-${index}`);
          const unitInput = document.getElementById(`infusion-dilution-unit-${index}`);
          const volInput = document.getElementById(`infusion-dilution-vol-${index}`);

          if (doseInput) {
              const dose = parseFloat(doseInput.value);
              if (!isNaN(dose)) infusion.currentDose = dose;
          }
          if (amountInput) {
              const amount = parseFloat(amountInput.value);
              if (!isNaN(amount)) infusion.currentDilutionAmount = amount;
          }
          if (unitInput) {
              infusion.currentDilutionUnit = unitInput.value;
          }
          if (volInput) {
              const vol = parseFloat(volInput.value);
              if (!isNaN(vol)) infusion.currentDilutionVol = vol;
          }

          calculateInfusions();
      });
    }

    function calculateInfusions() {
      const patient = getPatientData();
      const infusionResultsDiv = document.getElementById('infusion-results');

      if (!patient.weight) {
        infusionResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate infusion rates</p>';
        document.getElementById('toggleAllInfusionsBtn').style.display = 'none';
        return;
      }
      document.getElementById('toggleAllInfusionsBtn').style.display = 'block';

      let html = '';

      infusionDrugs.forEach((infusion, index) => {
        const weight = patient.weight;

        let concentrationInMcgOrUnits;
        if (infusion.currentDilutionUnit === 'mg') {
          concentrationInMcgOrUnits = (infusion.currentDilutionAmount * 1000) / infusion.currentDilutionVol;
        } else {
          concentrationInMcgOrUnits = infusion.currentDilutionAmount / infusion.currentDilutionVol;
        }

        let totalDosePerHr;
        if (infusion.infusionDoseRange.unit.includes('/min')) {
          totalDosePerHr = infusion.currentDose * weight * 60;
        } else {
          totalDosePerHr = infusion.currentDose * weight;
        }

        let rate = totalDosePerHr / concentrationInMcgOrUnits;
        if (isNaN(rate) || !isFinite(rate) || rate < 0) {
          rate = 0;
        }

        const concUnit = (infusion.currentDilutionUnit === 'units') ? 'units/mL' : 'mcg/mL';
        const concDisplay = `${concentrationInMcgOrUnits.toFixed(2)} ${concUnit}`;

        const isModified = isInfusionModified(infusion);
        let isCautionNeeded = infusion.caution ? true : false;
        let cautionIconHtml = isCautionNeeded ? `<span class="caution-icon" id="infusion-caution-icon-${index}" onclick="event.stopPropagation(); toggleInfusionCautionPopup(${index})">i</span>` : '';
        let cautionPopupHtml = isCautionNeeded ? `<div id="infusion-caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${infusion.caution}</div>` : '';

        let loadingDoseHtml = '';
        if (infusion.loadingDose && infusion.loadingDose.dose > 0) {
          loadingDoseHtml = `<div class="infusion-detail-row"><div class="infusion-label">Loading Dose:</div><div class="infusion-value">${infusion.loadingDose.dose} ${infusion.loadingDose.unit}</div></div><div class="infusion-note">${infusion.loadingDose.note}</div>`;
        }

        const isExpandedClass = (allInfusionsExpanded || infusion.isExpanded) ? 'expanded' : '';

        let unitOptions = `
          <option value="mcg" ${infusion.currentDilutionUnit === 'mcg' ? 'selected' : ''}>mcg</option>
          <option value="mg" ${infusion.currentDilutionUnit === 'mg' ? 'selected' : ''}>mg</option>
        `;
        if (infusion.defaultDilutionUnit === 'units') {
          unitOptions = `<option value="units" ${infusion.currentDilutionUnit === 'units' ? 'selected' : ''}>units</option>`;
        }

        html += `<div class="drug-card infusion ${isExpandedClass}" id="infusion-card-${index}">
            ${cautionPopupHtml}
            <div class="drug-header" onclick="toggleInfusionCard(${index})">
              <div class="drug-name"><span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>${infusion.name}</div>
              <div class="drug-header-right-group">
                  <div class="drug-dose-preview" style="color: var(--infusion);">${rate.toFixed(2)} mL/hr</div>
                  <div class="drug-category infusion">${infusion.categoryLabel}</div>
                  ${cautionIconHtml}
              </div>
            </div>
            <div class="infusion-details" id="infusion-details-${index}">
              <div class="details-wrapper">
                <div class="infusion-detail-row">
                  <div class="infusion-label">Dose Range:</div>
                  <div class="infusion-value">${infusion.infusionDoseRange.min}-${infusion.infusionDoseRange.max} ${infusion.infusionDoseRange.unit}</div>
                </div>
                ${loadingDoseHtml}

                <div class="infusion-edit-pane">
                  <div class="edit-input-field">
                    <label for="infusion-dose-${index}">Dose (${infusion.infusionDoseRange.unit})</label>
                    <input type="number" id="infusion-dose-${index}" value="${infusion.currentDose}" step="0.01" min="0">
                  </div>
                  <div class="infusion-dilution-input">
                    <label>Dilution</label>
                    <div class="input-wrapper">
                      <input type="number" id="infusion-dilution-amount-${index}" value="${infusion.currentDilutionAmount}">
                    </div>
                    <select id="infusion-dilution-unit-${index}">
                      ${unitOptions}
                    </select>
                    <span class="separator">in</span>
                    <div class="input-wrapper">
                      <input type="number" id="infusion-dilution-vol-${index}" value="${infusion.currentDilutionVol}">
                    </div>
                    <span class="separator">mL</span>
                  </div>
                  <div class="edit-actions">
                    <button class="edit-btn" onclick="updateInfusion(${index})">Update</button>
                    ${isModified ? `<button class="edit-btn reset-btn" onclick="resetInfusion(${index})">Reset</button>` : ''}
                  </div>
                </div>

                <div class="calculation">
                  <div class="calculation-result" style="color: var(--infusion);">${rate.toFixed(2)} mL/hr</div>
                  <div class="volume-result">For ${weight.toFixed(1)} kg @ ${infusion.currentDose.toFixed(2)} ${infusion.infusionDoseRange.unit}</div>
                  <div class="dose-info">Dilution: ${infusion.currentDilutionAmount} ${infusion.currentDilutionUnit} in ${infusion.currentDilutionVol} mL (${concDisplay})</div>
                </div>
                ${infusion.notes ? `<div class="infusion-note" style="font-style: normal; border-top: 1px dashed var(--border-color); padding-top: 8px;">${infusion.notes}</div>` : ''}
              </div>
            </div>
          </div>`;
      });

      infusionResultsDiv.innerHTML = html;
      document.getElementById('toggleAllInfusionsBtn').textContent = allInfusionsExpanded ? 'Collapse All' : 'Expand All / Collapse All';
    }

    function toggleDrugCard(index) {
      const drug = drugs[index];
      if (!drug) return;

      drug.isExpanded = !drug.isExpanded;

      if (!drug.isExpanded && activeEditIndex === index) {
          activeEditIndex = null;
          calculateDrugs();
      } else {
          requestAnimationFrame(() => {
              document.getElementById(`drug-card-${index}`).classList.toggle('expanded', drug.isExpanded);
          });
      }
    }
    function toggleInfusionCard(index) {
      requestAnimationFrame(() => {
          const card = document.getElementById(`infusion-card-${index}`);
          if(card) {
              card.classList.toggle('expanded');
              infusionDrugs[index].isExpanded = card.classList.contains('expanded');
          }
      });
    }

    function toggleAntibioticCard(index) {
      const card = document.getElementById(`antibiotic-card-${index}`);
      if (!card) return;
      requestAnimationFrame(() => { card.classList.toggle('expanded'); antibioticExpanded[index] = card.classList.contains('expanded'); });
    }

    function toggleAllDrugs() {
      allExpanded = !allExpanded;
      drugs.forEach(drug => { drug.isExpanded = allExpanded; });

      requestAnimationFrame(() => {
        drugs.forEach((_, index) => {
          const card = document.getElementById(`drug-card-${index}`);
          if (card) { card.classList.toggle('expanded', allExpanded); }
        });
        setTimeout(() => { document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
      });
    }

    function toggleAllInfusions() {
      allInfusionsExpanded = !allInfusionsExpanded;
      requestAnimationFrame(() => {
        infusionDrugs.forEach((infusion, index) => {
          infusion.isExpanded = allInfusionsExpanded;
          const card = document.getElementById(`infusion-card-${index}`);
          if (card) { card.classList.toggle('expanded', allInfusionsExpanded); }
        });
        calculateInfusions();
        setTimeout(() => { document.getElementById('toggleAllInfusionsBtn').textContent = allInfusionsExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
      });
    }

    function toggleAllAntibiotics() {
      allAntibioticsExpanded = !allAntibioticsExpanded;
      requestAnimationFrame(() => {
        antibioticExpanded.fill(allAntibioticsExpanded);
        calculateAntibiotics();
        setTimeout(() => { document.getElementById('toggleAllAntibioticsBtn').textContent = allAntibioticsExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
      });
    }

    function toggleEdit(index) {
      const drug = drugs[index];
      if (!drug) return;

      if (activeEditIndex === index) {
        activeEditIndex = null;
      } else {
        activeEditIndex = index;
        drug.isExpanded = true;
      }

      calculateDrugs();
    }

    /**
     * Resets a single drug's custom values to default (null).
     */
    function resetDrugToDefault(index) {
        const drug = drugs[index];
        if (drug) {
            drug.customDoseIV = null;
            drug.customDoseIM = null;
            drug.customDoseOral = null;
            drug.customConcentration = null;
            drug.isCustomDoseHigh = false;

            saveLastUsedDrugValues();
            calculateDrugs();
            checkForCustomDrugValues();
        }
    }

    /**
     * Updates a drug's custom values based on input fields.
     */
    function updateDrug(index) {
      const drug = drugs[index];
      const initialDrug = initialDrugs.find(d => d.name === drug.name);
      if (!initialDrug) return;

      const newDoseInput = document.getElementById(`dose-${index}`);
      const newDose = parseFloat(newDoseInput.value);

      const isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
      let newConc = null;
      let newConcInput = null;

      if (isInjectable) {
          newConcInput = document.getElementById(`conc-${index}`);
          if (newConcInput) {
              newConc = parseFloat(newConcInput.value);
          }
      }

      if (!isNaN(newDose) && newDose > 0) {
          switch (drug.currentRoute) {
              case 'IV':
                  const defaultIVDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : initialDrug.defaultDose;
                  drug.customDoseIV = (newDose !== defaultIVDose) ? newDose : null;
                  break;
              case 'IM':
                  const defaultIMDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : (initialDrug.imDose !== undefined ? initialDrug.imDose : initialDrug.defaultDose);
                  drug.customDoseIM = (newDose !== defaultIMDose) ? newDose : null;
                  break;
              case 'Oral':
                  const defaultOralDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : (initialDrug.oralDose !== undefined ? initialDrug.oralDose : initialDrug.defaultDose);
                  drug.customDoseOral = (newDose !== defaultOralDose) ? newDose : null;
                  break;
          }
      }

      if (newConc !== null && !isNaN(newConc) && newConc > 0) {
          const defaultConc = initialDrug.concentration;
          drug.customConcentration = (newConc !== defaultConc) ? newConc : null;
      } else if (newConcInput && newConcInput.value === '') {
          drug.customConcentration = null;
      }

      drug.isCustomDoseHigh = false;
      const currentDose = getDoseByRoute(drug, drug.currentRoute);
      const rangeMax = parseMaxDoseFromRange(drug.range);
      if (rangeMax && currentDose > rangeMax) {
          drug.isCustomDoseHigh = true;
      }

      saveLastUsedDrugValues();
      calculateDrugs();
      checkForCustomDrugValues();
    }


    function toggleCautionPopup(index) {
      const popup = document.getElementById(`caution-popup-${index}`);
      if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
    }

    function toggleInfusionCautionPopup(index) {
      const popup = document.getElementById(`infusion-caution-popup-${index}`);
      if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
    }
    function toggleAntibioticCautionPopup(index) {
      const popup = document.getElementById(`antibiotic-caution-popup-${index}`);
      if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
    }

    document.addEventListener('click', function(e) {
      if (!e.target.classList.contains('caution-icon')) {
        document.querySelectorAll('.caution-popup').forEach(popup => { popup.style.display = 'none'; });
      }
    });
    
    const bmi_percentiles_boys = [
      { minAge: 24,  label: "2 Yrs", p5: 14.8, p85: 18.0, p95: 18.9 }, // 24-35 mos
      { minAge: 36,  label: "3 Yrs", p5: 14.5, p85: 17.8, p95: 18.6 }, // 36-47 mos
      { minAge: 48,  label: "4-5 Yrs", p5: 14.1, p85: 17.8, p95: 19.1 }, // 48-71 mos
      { minAge: 72,  label: "6-7 Yrs", p5: 14.0, p85: 18.4, p95: 20.2 }, // 72-95 mos
      { minAge: 96,  label: "8-9 Yrs", p5: 14.4, p85: 19.6, p95: 21.9 }, // 96-119 mos
      { minAge: 120, label: "10-11 Yrs", p5: 15.0, p85: 21.1, p95: 23.9 }, // 120-143 mos
      { minAge: 144, label: "12-13 Yrs", p5: 15.8, p85: 22.8, p95: 25.9 }, // 144-167 mos
      { minAge: 168, label: "14-15 Yrs", p5: 16.8, p85: 24.5, p95: 27.6 }, // 168-191 mos
      { minAge: 192, label: "16-20 Yrs", p5: 17.8, p85: 25.9, p95: 30.6 }  // 192-240 mos
    ];

    const bmi_percentiles_girls = [
      { minAge: 24,  label: "2 Yrs", p5: 14.4, p85: 17.8, p95: 18.7 }, // 24-35 mos
      { minAge: 36,  label: "3 Yrs", p5: 14.0, p85: 17.5, p95: 18.4 }, // 36-47 mos
      { minAge: 48,  label: "4-5 Yrs", p5: 13.8, p85: 17.6, p95: 19.0 }, // 48-71 mos
      { minAge: 72,  label: "6-7 Yrs", p5: 13.8, p85: 18.3, p95: 20.2 }, // 72-95 mos
      { minAge: 96,  label: "8-9 Yrs", p5: 14.2, p85: 19.6, p95: 22.1 }, // 96-119 mos
      { minAge: 120, label: "10-11 Yrs", p5: 14.8, p85: 21.2, p95: 24.3 }, // 120-143 mos
      { minAge: 144, label: "12-13 Yrs", p5: 15.7, p85: 23.1, p95: 26.5 }, // 144-167 mos
      { minAge: 168, label: "14-15 Yrs", p5: 16.5, p85: 24.6, p95: 28.3 }, // 168-191 mos
      { minAge: 192, label: "16-20 Yrs", p5: 17.3, p85: 25.7, p95: 30.8 }  // 192-240 mos
    ];
    
    function calculateBMIForAge(patient, bmi) {
        if (patient.totalAgeInMonths < 24 || patient.totalAgeInMonths > 240) {
            return { percentile: 'N/A', status: 'Age out of range (2-20y)' };
        }

        const dataSet = patient.sex === 'male' ? bmi_percentiles_boys : bmi_percentiles_girls;

        const ageGroupData = dataSet.slice().reverse().find(d => patient.totalAgeInMonths >= d.minAge);

        if (!ageGroupData) {
            return { percentile: 'N/A', status: 'Data not found' };
        }

        if (bmi < ageGroupData.p5) {
            return { percentile: '< 5th', status: 'Underweight' };
        } else if (bmi >= ageGroupData.p95) {
            return { percentile: ' 95th', status: 'Obese' };
        } else if (bmi >= ageGroupData.p85) {
            return { percentile: '85th-94th', status: 'Overweight' };
        } else {
            return { percentile: '5th-84th', status: 'Healthy Weight' };
        }
    }
    
    function calculateAll() {
      const patient = getPatientData();

      const weightInput = document.getElementById('weight');
      const weightBmiStatus = document.getElementById('weight-bmi-status');
      const obesityWarning = document.getElementById('obesity-warning-box');
      const defaultPlaceholderKg = 'Enter weight in kg';
      const defaultPlaceholderLbs = 'Enter weight in lbs';

      const safetyHeader = document.getElementById('patient-safety-header');
      const safetyAge = document.getElementById('safety-header-age');
      const safetyWeight = document.getElementById('safety-header-weight');
      const safetyBmi = document.getElementById('safety-header-bmi');
      const safetyBmiPercentile = document.getElementById('safety-header-bmi-percentile');
      const safetyBsa = document.getElementById('safety-header-bsa');

      if (patient.weight > 0 || (patient.ageYears > 0 || patient.ageMonths > 0) || patient.height > 0) {
          safetyHeader.style.display = 'flex';
          safetyAge.textContent = `AGE: ${patient.ageYears} Y, ${patient.ageMonths} M`;
          
          let displayWeight = patient.weight;
          let displayUnit = 'kg';
          if (currentWeightUnit === 'lbs') {
              displayWeight = patient.weight * KG_TO_LBS;
              displayUnit = 'lbs';
          }
          safetyWeight.textContent = `WEIGHT: ${displayWeight.toFixed(1)} ${displayUnit}`;

          let bmi = 0;
          if (patient.weight > 0 && patient.height > 0) {
            const heightInM = patient.height / 100;
            bmi = patient.weight / (heightInM * heightInM);
          }
          
          if (bmi > 0) {
            safetyBmi.textContent = `BMI: ${bmi.toFixed(1)}`;
            safetyBmi.style.display = 'inline-block';
          } else {
            safetyBmi.style.display = 'none';
          }
          
          if (bmi > 0 && patient.totalAgeInMonths >= 24) {
              const bmiData = calculateBMIForAge(patient, bmi);
              safetyBmiPercentile.style.display = 'none';
              
              if (bmiData.status === 'Underweight') {
                  safetyBmiPercentile.style.background = 'var(--induction)';
                  safetyBmiPercentile.style.color = '#fff';
              } else if (bmiData.status === 'Overweight' || bmiData.status === 'Obese') {
                  safetyBmiPercentile.style.background = 'var(--reversal)';
                  safetyBmiPercentile.style.color = '#fff';
              } else {
                  safetyBmiPercentile.style.background = 'var(--primary-accent-light)';
                  safetyBmiPercentile.style.color = 'var(--primary-accent-dark)';
              }

              weightBmiStatus.textContent = `${bmiData.status} *`;
              weightBmiStatus.style.display = 'inline-block';

              if (bmiData.status === 'Overweight' || bmiData.status === 'Obese') {
                  weightBmiStatus.style.color = 'var(--reversal)';
                  if (obesityWarning) obesityWarning.style.display = 'block';
              } else if (bmiData.status === 'Underweight') {
                  weightBmiStatus.style.color = 'var(--induction)';
                  if (obesityWarning) obesityWarning.style.display = 'none';
              } else {
                  weightBmiStatus.style.color = 'var(--primary-accent-dark)';
                  if (obesityWarning) obesityWarning.style.display = 'none';
              }
              
              weightInput.placeholder = (currentWeightUnit === 'lbs') ? defaultPlaceholderLbs : defaultPlaceholderKg;

          } else {
              safetyBmiPercentile.style.display = 'none';
              weightInput.placeholder = (currentWeightUnit === 'lbs') ? defaultPlaceholderLbs : defaultPlaceholderKg;
              if (weightBmiStatus) weightBmiStatus.style.display = 'none';
              if (obesityWarning) obesityWarning.style.display = 'none';
          }
          
          let bsa = 0;
          if (patient.weight > 0 && patient.height > 0) {
            bsa = Math.sqrt((patient.height * patient.weight) / 3600);
          }
          
          if (bsa > 0) {
            safetyBsa.textContent = `BSA: ${bsa.toFixed(2)} m`;
            safetyBsa.style.display = 'inline-block';
          } else {
            safetyBsa.style.display = 'none';
          }

      } else {
          safetyHeader.style.display = 'none';
          if (weightBmiStatus) weightBmiStatus.style.display = 'none';
      }

      calculateEquipment();
      calculateFluids();
      calculateDrugs();
      calculateLocalAnesthetics();
      calculateInfusions();
      calculateAntibiotics();
      calculateNormalValues();
    }



    function resetAllDrugsToDefault() {
      drugs.forEach(drug => {
        drug.customDoseIV = null;
        drug.customDoseIM = null;
        drug.customDoseOral = null;
        drug.customConcentration = null;
        drug.isCustomDoseHigh = false;
        drug.currentRoute = drug.defaultRoute;
      });
      localStorage.removeItem('pediatricAnesthesiaLastUsedDrugValues');
      calculateDrugs();
      document.getElementById('custom-drugs-indicator').style.display = 'none';
    }

    function savePatientProfile() {
      const profileName = document.getElementById('patient-profile-name').value.trim();
      if (!profileName) { console.error('Please enter a profile name'); return; }
      
      let weightToSave = parseFloat(document.getElementById('weight').value) || 0;
      if (currentWeightUnit === 'lbs' && weightToSave > 0) {
        weightToSave = (weightToSave / KG_TO_LBS).toFixed(2);
      }

      const currentPatientData = getPatientData();
      const heightToSave = currentPatientData.height > 0 ? currentPatientData.height.toFixed(1) : '';

      const patientData = { name: profileName, ageYears: document.getElementById('age-years').value, ageMonths: document.getElementById('age-months').value, weight: weightToSave, height: heightToSave, currentHb: document.getElementById('currentHb').value, targetHb: document.getElementById('targetHb').value, timestamp: new Date().toISOString() };
      let savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
      const existingIndex = savedProfiles.findIndex(p => p.name === profileName);

      if (existingIndex !== -1) {
        console.log(`Profile "${profileName}" already exists. Overwriting.`);
        savedProfiles[existingIndex] = patientData;
      } else { savedProfiles.push(patientData); }

      localStorage.setItem('pediatricAnesthesiaPatientProfiles', JSON.stringify(savedProfiles));
      document.getElementById('patient-profile-name').value = '';
      loadPatientProfiles();
    }

    function loadPatientProfiles() {
      const savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
      const container = document.getElementById('patient-profiles-list');

      if (savedProfiles.length === 0) { container.innerHTML = '<div class="no-saved-items">No saved patient profiles</div>'; return; }

      savedProfiles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      container.innerHTML = savedProfiles.map(profile => {
        let heightDetail = profile.height ? ` | ${profile.height} cm` : '';
        return `
        <div class="saved-item">
          <div>
            <div class="saved-item-name">${profile.name}</div>
            <div class="saved-item-details">
              ${profile.ageYears || 0}Y ${profile.ageMonths || 0}M | ${profile.weight || 0} kg${heightDetail} |
              Hb: ${profile.currentHb || 'N/A'}  ${profile.targetHb || 'N/A'}
            </div>
          </div>
          <div class="saved-item-actions">
            <button class="saved-item-btn" onclick="applyPatientProfile('${profile.name}')" title="Apply"><i class="fas fa-play"></i></button>
            <button class="saved-item-btn delete" onclick="deletePatientProfile('${profile.name}')" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        `;
      }).join('');
    }

    function applyPatientProfile(profileName) {
      const profile = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]').find(p => p.name === profileName);
      if (profile) {
        document.getElementById('age-years').value = profile.ageYears || '';
        document.getElementById('age-months').value = profile.ageMonths || '';
        
        let weightToDisplay = parseFloat(profile.weight) || 0;
        if (currentWeightUnit === 'lbs' && weightToDisplay > 0) {
          weightToDisplay = (weightToDisplay * KG_TO_LBS).toFixed(1);
        }
        document.getElementById('weight').value = weightToDisplay || '';
        
        document.getElementById('currentHb').value = profile.currentHb || '';
        document.getElementById('targetHb').value = profile.targetHb || '';
        
        const heightInCm = parseFloat(profile.height) || 0;
        if (heightInCm > 0) {
            if (currentHeightUnit === 'cm') {
                document.getElementById('height-cm').value = heightInCm.toFixed(1);
                document.getElementById('height-ft').value = '';
                document.getElementById('height-in').value = '';
            } else {
                const totalInches = heightInCm * CM_TO_IN;
                const feet = Math.floor(totalInches / 12);
                const inches = (totalInches % 12).toFixed(1);
                document.getElementById('height-cm').value = '';
                document.getElementById('height-ft').value = feet;
                document.getElementById('height-in').value = inches;
            }
        } else {
             document.getElementById('height-cm').value = '';
             document.getElementById('height-ft').value = '';
             document.getElementById('height-in').value = '';
        }

        calculateAll();
      }
    }

    function deletePatientProfile(profileName) {
      console.log(`Deleting profile "${profileName}".`);
      let savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
      savedProfiles = savedProfiles.filter(p => p.name !== profileName);
      localStorage.setItem('pediatricAnesthesiaPatientProfiles', JSON.stringify(savedProfiles));
      loadPatientProfiles();
    }

    function clearAllPatientProfiles() {
      console.log('Deleting ALL saved patient profiles.');
      localStorage.removeItem('pediatricAnesthesiaPatientProfiles');
      loadPatientProfiles();
    }

    function saveDrugSet() {
      const setName = document.getElementById('drug-set-name').value.trim();
      if (!setName) { console.error('Please enter a drug set name'); return; }
      const modifiedCount = countModifiedDrugs();

      const drugSet = {
          name: setName,
          drugs: drugs.map(drug => ({
              name: drug.name,
              customDoseIV: drug.customDoseIV,
              customDoseIM: drug.customDoseIM,
              customDoseOral: drug.customDoseOral,
              customConcentration: drug.customConcentration,
              currentRoute: drug.currentRoute,
              isCustomDoseHigh: drug.isCustomDoseHigh
          })),
          modifiedCount,
          timestamp: new Date().toISOString()
      };

      let savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
      const existingIndex = savedSets.findIndex(s => s.name === setName);

      if (existingIndex !== -1) {
        console.log(`Drug set "${setName}" already exists. Overwriting.`);
        savedSets[existingIndex] = drugSet;
      } else { savedSets.push(drugSet); }

      localStorage.setItem('pediatricAnesthesiaDrugSets', JSON.stringify(savedSets));
      document.getElementById('drug-set-name').value = '';
      loadDrugSets();
    }

    function loadDrugSets() {
      const savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
      const container = document.getElementById('drug-sets-list');

      if (savedSets.length === 0) { container.innerHTML = '<div class="no-saved-items">No saved drug sets</div>'; return; }

      savedSets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      container.innerHTML = savedSets.map(set => `
        <div class="saved-item">
          <div>
            <div class="saved-item-name">${set.name}</div>
            <div class="saved-item-details">
              ${set.modifiedCount || 0} drugs modified | ${new Date(set.timestamp).toLocaleDateString()}
            </div>
          </div>
          <div class="saved-item-actions">
            <button class="saved-item-btn" onclick="applyDrugSet('${set.name}')" title="Apply"><i class="fas fa-play"></i></button>
            <button class="saved-item-btn delete" onclick="deleteDrugSet('${set.name}')" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `).join('');
    }

    function applyDrugSet(setName) {
      const set = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]').find(s => s.name === setName);
      if (set) {
        set.drugs.forEach(savedDrug => {
          const drug = drugs.find(d => d.name === savedDrug.name);
          if (!drug) return;

          if (savedDrug.customDoseIV !== undefined) {
              drug.customDoseIV = savedDrug.customDoseIV;
              drug.customDoseIM = savedDrug.customDoseIM;
              drug.customDoseOral = savedDrug.customDoseOral;
              drug.customConcentration = savedDrug.customConcentration;
          } else {
              const initialDrug = initialDrugs.find(d => d.name === savedDrug.name);
              if (initialDrug) {
                  drug.customDoseIV = (savedDrug.defaultDose !== initialDrug.defaultDose) ? savedDrug.defaultDose : null;
                  drug.customConcentration = (savedDrug.concentration !== initialDrug.concentration) ? savedDrug.concentration : null;
                  drug.customDoseIM = null;
                  drug.customDoseOral = null;
              }
          }
          drug.currentRoute = savedDrug.currentRoute || drug.defaultRoute;
          drug.isCustomDoseHigh = savedDrug.isCustomDoseHigh;
        });

        saveLastUsedDrugValues();
        calculateDrugs();
        document.getElementById('custom-drugs-indicator').style.display = 'flex';
        document.getElementById('current-drug-set-name').textContent = setName;
        document.getElementById('modified-drugs-count').textContent = countModifiedDrugs();
      }
    }

    function deleteDrugSet(setName) {
      console.log(`Deleting drug set "${setName}".`);
      let savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
      savedSets = savedSets.filter(s => s.name !== setName);
      localStorage.setItem('pediatricAnesthesiaDrugSets', JSON.stringify(savedSets));
      loadDrugSets();
    }

function clearAllDrugSets() {
      console.log('Deleting ALL saved drug sets.');
      localStorage.removeItem('pediatricAnesthesiaDrugSets');
      loadDrugSets();
    }

    function saveLastUsedDrugValues() {
      const drugValues = drugs.map(drug => ({
          name: drug.name,
          customDoseIV: drug.customDoseIV,
          customDoseIM: drug.customDoseIM,
          customDoseOral: drug.customDoseOral,
          customConcentration: drug.customConcentration,
          currentRoute: drug.currentRoute,
          isCustomDoseHigh: drug.isCustomDoseHigh
      }));
      localStorage.setItem('pediatricAnesthesiaLastUsedDrugValues', JSON.stringify({ drugs: drugValues, timestamp: new Date().toISOString() }));
    }

    function loadLastUsedDrugValues() {
      const savedData = localStorage.getItem('pediatricAnesthesiaLastUsedDrugValues');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          if (data.drugs && Array.isArray(data.drugs)) {
            data.drugs.forEach(savedDrug => {
              const drug = drugs.find(d => d.name === savedDrug.name);
              if (drug) {
                  drug.customDoseIV = savedDrug.customDoseIV;
                  drug.customDoseIM = savedDrug.customDoseIM;
                  drug.customDoseOral = savedDrug.customDoseOral;
                  drug.customConcentration = savedDrug.customConcentration;
                  drug.currentRoute = savedDrug.currentRoute || drug.defaultRoute;
                  drug.isCustomDoseHigh = savedDrug.isCustomDoseHigh;
              }
            });
            checkForCustomDrugValues();
          }
        } catch (e) {
          console.error('Error loading last used drug values:', e);
        }
      }
    }


    function checkForCustomDrugValues() {
      const modifiedCount = countModifiedDrugs();
      const indicator = document.getElementById('custom-drugs-indicator');

      if (modifiedCount > 0) {
        indicator.style.display = 'flex';
        document.getElementById('modified-drugs-count').textContent = modifiedCount;
        const savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
        let currentSetName = 'Custom';
        const currentValues = JSON.stringify(drugs.map(d => d.customDoseIV + d.customDoseIM + d.customDoseOral + d.customConcentration));

        for(const set of savedSets) {
            const setValues = JSON.stringify(set.drugs.map(d => d.customDoseIV + d.customDoseIM + d.customDoseOral + d.customConcentration));
            if(currentValues === setValues) {
                currentSetName = set.name;
                break;
            }
        }
        document.getElementById('current-drug-set-name').textContent = currentSetName;

      } else {
        indicator.style.display = 'none';
      }
    }

    function toggleDisclaimer() {
      const content = document.getElementById('disclaimer-content');
      const arrow = document.getElementById('disclaimer-arrow');
      content.classList.toggle('expanded');
      arrow.classList.toggle('fa-chevron-down');
      arrow.classList.toggle('fa-chevron-up');
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      updateDarkModeButton();
    }

    function updateDarkModeButton() {
      const isDark = document.body.classList.contains('dark-mode');
      // Target the specific ID so we don't overwrite the Install button
      const btn = document.getElementById('dark-mode-btn');
      
      // Safety check in case button isn't found
      if (!btn) return;

      const icon = btn.querySelector('i');
      const text = btn.querySelector('span');
      
      if (isDark) {
          icon.className = 'fas fa-sun';
          text.textContent = 'Light Mode';
      } else {
          icon.className = 'fas fa-moon';
          text.textContent = 'Dark Mode';
      }
    }

    function updateWeightUnitUI() {
        const weightInput = document.getElementById('weight');
        const weightLabel = document.getElementById('weight-label');
        const unitToggleBtn = document.getElementById('unit-toggle');
        const unitOptionKg = unitToggleBtn.querySelector('.unit-option[data-unit="kg"]');
        const unitOptionLbs = unitToggleBtn.querySelector('.unit-option[data-unit="lbs"]');

        unitToggleBtn.classList.remove('lbs-active');
        unitOptionKg.classList.remove('active');
        unitOptionLbs.classList.remove('active');

        if (currentWeightUnit === 'lbs') {
            weightLabel.textContent = 'Weight (lbs)';
            weightInput.placeholder = 'Enter weight in lbs';
            unitToggleBtn.classList.add('lbs-active');
            unitOptionLbs.classList.add('active');
        } else {
            weightLabel.textContent = 'Weight (kg)';
            weightInput.placeholder = 'Enter weight in kg';
            unitOptionKg.classList.add('active');
        }
    }

    function toggleWeightUnit() {
        const weightInput = document.getElementById('weight');
        let currentWeight = parseFloat(weightInput.value) || 0;

        if (currentWeightUnit === 'kg') {
            currentWeightUnit = 'lbs';
            if (currentWeight > 0) {
                weightInput.value = (currentWeight * KG_TO_LBS).toFixed(1);
            }
        } else {
            currentWeightUnit = 'kg';
            if (currentWeight > 0) {
                weightInput.value = (currentWeight / KG_TO_LBS).toFixed(1);
            }
        }
        
        localStorage.setItem('weightUnit', currentWeightUnit);
        updateWeightUnitUI();
        
        calculateAll();
    }

    function updateHeightUnitUI() {
        const heightInputContainer = document.getElementById('height-input-container');
        const heightLabel = document.getElementById('height-label');
        const unitToggleBtn = document.getElementById('height-unit-toggle');
        const unitOptionCm = unitToggleBtn.querySelector('.unit-option[data-unit="cm"]');
        const unitOptionFt = unitToggleBtn.querySelector('.unit-option[data-unit="ft"]');

        unitToggleBtn.classList.remove('lbs-active');
        unitOptionCm.classList.remove('active');
        unitOptionFt.classList.remove('active');
        heightInputContainer.classList.remove('ft-active');

        if (currentHeightUnit === 'ft') {
            heightLabel.textContent = 'Height (ft/in)';
            unitToggleBtn.classList.add('lbs-active');
            unitOptionFt.classList.add('active');
            heightInputContainer.classList.add('ft-active');
        } else {
            heightLabel.textContent = 'Height (cm)';
            unitOptionCm.classList.add('active');
        }
    }

    function toggleHeightUnit() {
        const cmInput = document.getElementById('height-cm');
        const ftInput = document.getElementById('height-ft');
        const inInput = document.getElementById('height-in');
        
        const heightCm = parseFloat(cmInput.value) || 0;
        const heightFt = parseFloat(ftInput.value) || 0;
        const heightIn = parseFloat(inInput.value) || 0;

        if (currentHeightUnit === 'cm') {
            currentHeightUnit = 'ft';
            if (heightCm > 0) {
                const totalInches = heightCm * CM_TO_IN;
                const feet = Math.floor(totalInches / 12);
                const inches = (totalInches % 12);
                ftInput.value = feet;
                inInput.value = inches > 0 ? inches.toFixed(1) : '';
                cmInput.value = '';
            }
        } else {
            currentHeightUnit = 'cm';
            const totalCm = (heightFt * FT_TO_CM) + (heightIn * IN_TO_CM);
            if (totalCm > 0) {
                cmInput.value = totalCm.toFixed(1);
                ftInput.value = '';
                inInput.value = '';
            }
        }
        
        localStorage.setItem('heightUnit', currentHeightUnit);
        updateHeightUnitUI();
        
        calculateAll();
    }
    
    function adjustFontSize(direction) {
      const newIndex = currentFontSizeIndex + direction;
      if (newIndex >= 0 && newIndex < FONT_SIZE_STEPS_PX.length) {
        currentFontSizeIndex = newIndex;
        applyFontSize();
      }
    }

    function applyFontSize() {
      const newSize = FONT_SIZE_STEPS_PX[currentFontSizeIndex];
      document.body.style.fontSize = `${newSize}px`;

      const defaultSize = FONT_SIZE_STEPS_PX[2];
      const percentage = Math.round((newSize / defaultSize) * 100);
      document.getElementById('font-size-indicator').textContent = `${percentage}%`;

      localStorage.setItem('fontSizeIndex', currentFontSizeIndex);
    }

    function clearPatientInfo() {
        document.getElementById('age-years').value = '';
        document.getElementById('age-months').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('height-cm').value = '';
        document.getElementById('height-ft').value = '';
        document.getElementById('height-in').value = '';
        document.getElementById('currentHb').value = '';
        document.getElementById('targetHb').value = '';
        document.getElementById('sex-male').checked = true;
        
        document.getElementById('patient-profile-name').value = '';

        calculateAll(); 
    }

    document.addEventListener('DOMContentLoaded', function() {
      
      try {
        const container = document.querySelector('.container');
        const header = document.querySelector('header');
        const disclaimer = document.querySelector('.disclaimer-container');
        const safetyBar = document.getElementById('patient-safety-header');
        const tabNav = document.querySelector('.tab-navigation');
        
        if (container && header && disclaimer && safetyBar && tabNav) { 
          const stickyWrapper = document.createElement('div');
          stickyWrapper.className = 'sticky-header-wrapper';
          
          stickyWrapper.appendChild(safetyBar);
          stickyWrapper.appendChild(tabNav);
          
          disclaimer.parentNode.insertBefore(stickyWrapper, disclaimer.nextSibling);
        }
      } catch (e) {
        console.error("Failed to create sticky wrapper:", e);
      }

      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          button.classList.add('active');
          const targetTab = document.getElementById(button.getAttribute('data-tab'));
          if (targetTab) {
              targetTab.classList.add('active');
          }

          button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        });
      });

      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      if (savedDarkMode) {
        document.body.classList.add('dark-mode');
      }
      updateDarkModeButton();
      
      const savedWeightUnit = localStorage.getItem('weightUnit');
      if (savedWeightUnit === 'lbs') {
        currentWeightUnit = 'lbs';
      }
      updateWeightUnitUI();

      document.getElementById('unit-toggle').addEventListener('click', toggleWeightUnit);
      
      const savedHeightUnit = localStorage.getItem('heightUnit');
      if (savedHeightUnit === 'ft') {
        currentHeightUnit = 'ft';
      }
      updateHeightUnitUI();
      document.getElementById('height-unit-toggle').addEventListener('click', toggleHeightUnit);

      const savedFontSizeIndex = localStorage.getItem('fontSizeIndex');
      if (savedFontSizeIndex !== null) {
        currentFontSizeIndex = parseInt(savedFontSizeIndex, 10);
        if (isNaN(currentFontSizeIndex) || currentFontSizeIndex < 0 || currentFontSizeIndex >= FONT_SIZE_STEPS_PX.length) {
          currentFontSizeIndex = 2;
        }
      }
      applyFontSize();

      loadFavorites();
      loadLastUsedDrugValues();
      calculateAll();
      loadPatientProfiles();
      loadDrugSets();
      checkForCustomDrugValues();
      antibioticExpanded = new Array(antibiotics.length).fill(false);
    });
const normalValuesData = [
      { key: 'preterm', name: 'Preterm Neonate', ageMinMonths: 0, ageMaxMonths: 0, hr: '120-180', rr: '40-70', sbp: '55-75', dbp: '35-45', map: '45-55', hgb: '13.5-20.5', plt: '150-450', glucose: '> 45', uo: '1-2' },
      { key: 'term', name: 'Term Neonate (<28d)', ageMinMonths: 0, ageMaxMonths: 0.9, hr: '100-180', rr: '30-60', sbp: '65-85', dbp: '45-55', map: '50-60', hgb: '14.0-22.0', plt: '150-450', glucose: '> 60', uo: '1-2' },
      { key: 'infant', name: 'Infant (1-12m)', ageMinMonths: 1, ageMaxMonths: 12, hr: '100-160', rr: '30-50', sbp: '70-100', dbp: '50-65', map: '60-75', hgb: '10.5-13.5', plt: '200-475', glucose: '> 60', uo: '1-2' },
      { key: 'toddler', name: 'Toddler (1-2y)', ageMinMonths: 12, ageMaxMonths: 24, hr: '90-150', rr: '24-40', sbp: '80-100', dbp: '55-65', map: '65-75', hgb: '11.0-13.0', plt: '180-450', glucose: '> 60', uo: '1.0' },
      { key: 'preschool', name: 'Preschool (3-5y)', ageMinMonths: 24, ageMaxMonths: 60, hr: '80-140', rr: '22-34', sbp: '80-110', dbp: '55-75', map: '70-80', hgb: '11.5-14.5', plt: '180-450', glucose: '> 60', uo: '1.0' },
      { key: 'school', name: 'School-age (6-12y)', ageMinMonths: 60, ageMaxMonths: 144, hr: '70-120', rr: '18-30', sbp: '90-120', dbp: '60-80', map: '75-90', hgb: '11.5-15.5', plt: '150-400', glucose: '> 60', uo: '0.5-1' },
      { key: 'adolescent', name: 'Adolescent (13+y)', ageMinMonths: 144, ageMaxMonths: 240, hr: '60-100', rr: '12-16', sbp: '110-130', dbp: '65-85', map: '85-100', hgb: '12.0-16.0', plt: '150-400', glucose: '> 70', uo: '0.5' }
    ];

    function getAgeBracket(ageInMonths, ageInYears) {
        if (ageInMonths === 0 && ageInYears === 0) return null; // No age entered
        
        // Prioritize term neonate for 0-1 month
        if (ageInMonths < 1 && ageInYears === 0) return normalValuesData.find(v => v.key === 'term');
        
        const bracket = normalValuesData.find(v => ageInMonths >= v.ageMinMonths && ageInMonths < v.ageMaxMonths);
        return bracket || normalValuesData[normalValuesData.length - 1]; // Default to last bracket if > 18y
    }

    function calculateNormalValues() {
        const patient = getPatientData();
        const resultsDiv = document.getElementById('normal-values-results');

        // 1. Get Age Bracket
        const ageBracket = getAgeBracket(patient.totalAgeInMonths, patient.age);

        if (!ageBracket) {
            resultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient age to display normal values</p>';
            return;
        }

        // 2. Calculate PALS Hypotension Limit (Lower Limit SBP)
        let lowerLimitSBP = 0;
        let lowerLimitNote = "";
        if (patient.totalAgeInMonths < 1) {
            lowerLimitSBP = 60;
            lowerLimitNote = "< 1 month";
        } else if (patient.totalAgeInMonths < 12) {
            lowerLimitSBP = 70;
            lowerLimitNote = "1m - 1y";
        } else if (patient.ageYears <= 10) {
            lowerLimitSBP = 70 + (2 * patient.ageYears);
            lowerLimitNote = `70 + (2  ${patient.ageYears})`;
        } else {
            lowerLimitSBP = 90;
            lowerLimitNote = "> 10 years";
        }

        // 3. Calculate Tidal Volume (6-8 mL/kg)
        let tvDisplay = "N/A";
        if (patient.weight > 0) {
            const tvMin = (patient.weight * 6).toFixed(0);
            const tvMax = (patient.weight * 8).toFixed(0);
            tvDisplay = `${tvMin} - ${tvMax}`;
        }

        // 4. Calculate Absolute Urine Output (mL/hr)
        let uoDisplay = "Enter Weight";
        let uoDetail = `${ageBracket.uo} mL/kg/hr`;

        if (patient.weight > 0) {
            if (ageBracket.uo.includes('-')) {
                const parts = ageBracket.uo.split('-');
                const min = parseFloat(parts[0]);
                const max = parseFloat(parts[1]);
                // ParseFloat(toFixed) removes unnecessary trailing zeros (e.g., "10.0" becomes "10")
                const minAbs = parseFloat((min * patient.weight).toFixed(1));
                const maxAbs = parseFloat((max * patient.weight).toFixed(1));
                uoDisplay = `${minAbs} - ${maxAbs}`;
            } else {
                const val = parseFloat(ageBracket.uo);
                const abs = parseFloat((val * patient.weight).toFixed(1));
                uoDisplay = `> ${abs}`;
            }
            uoDetail = `mL/hr (Ref: ${ageBracket.uo} mL/kg/hr)`;
        }

        // 5. Generate HTML with Grouping
        const html = `
        <div class="category-heading" style="margin-top:0;"><i class="fas fa-heartbeat"></i> Hemodynamics</div>
        
        <div class="equipment-card" style="border-color: var(--emergency); background-color: #fff1f2;">
          <div class="equipment-title" style="color: var(--reversal);"> Hypotension Limit (SBP)</div>
          <div class="equipment-value" style="color: var(--reversal);">< ${lowerLimitSBP}</div>
          <div class="equipment-detail">PALS Definition (${lowerLimitNote})</div>
        </div>

        <div class="equipment-card">
          <div class="equipment-title">Heart Rate</div>
          <div class="equipment-value">${ageBracket.hr}</div>
          <div class="equipment-detail">beats/min</div>
        </div>
        
        <div class="equipment-card">
          <div class="equipment-title">Systolic BP</div>
          <div class="equipment-value">${ageBracket.sbp}</div>
          <div class="equipment-detail">mmHg</div>
        </div>

        <div class="equipment-card">
          <div class="equipment-title">Mean Arterial (MAP)</div>
          <div class="equipment-value">${ageBracket.map}</div>
          <div class="equipment-detail">mmHg (Target)</div>
        </div>

        <div class="category-heading"><i class="fas fa-lungs"></i> Respiratory</div>

        <div class="equipment-card">
          <div class="equipment-title">Respiratory Rate</div>
          <div class="equipment-value">${ageBracket.rr}</div>
          <div class="equipment-detail">breaths/min</div>
        </div>

        <div class="equipment-card">
          <div class="equipment-title">Tidal Volume</div>
          <div class="equipment-value">${tvDisplay}</div>
          <div class="equipment-detail">mL (Target 6-8 mL/kg)</div>
        </div>

        <div class="category-heading"><i class="fas fa-flask"></i> Metabolic & Labs</div>

        <div class="equipment-card">
          <div class="equipment-title">Urine Output Goal</div>
          <div class="equipment-value">${uoDisplay}</div>
          <div class="equipment-detail">${uoDetail}</div>
        </div>

        <div class="equipment-card">
          <div class="equipment-title">Hypoglycemia Limit</div>
          <div class="equipment-value" style="color: var(--caution-color);">${ageBracket.glucose}</div>
          <div class="equipment-detail">mg/dL (Target)</div>
        </div>

        <div class="equipment-card">
          <div class="equipment-title">Hemoglobin</div>
          <div class="equipment-value">${ageBracket.hgb}</div>
          <div class="equipment-detail">g/dL</div>
        </div>
    `;

        resultsDiv.innerHTML = html;
    }
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('Service Worker registered');
                    // Check for updates immediately
                    reg.update();
                })
                .catch(err => console.log('SW Fail:', err));
        });
    }
	// --- Android PWA Install Logic ---

let deferredPrompt; // To store the event
const installBtn = document.getElementById('pwa-install-btn');

// 1. Listen for the 'beforeinstallprompt' event
window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent the mini-infobar from appearing on mobile
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Update UI notify the user they can install the PWA
  if(installBtn) {
      installBtn.style.display = 'flex';
      // Optional: Add a pulse animation to draw attention
      installBtn.classList.add('pulse'); 
  }
  console.log('PWA Install event captured');
});

// 2. The function triggered by the button click
async function installPWA() {
  if (!deferredPrompt) {
      return;
  }
  // Show the install prompt
  deferredPrompt.prompt();
  // Wait for the user to respond to the prompt
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`User response to the install prompt: ${outcome}`);
  
  // We've used the prompt, and can't use it again, discard it
  deferredPrompt = null;
  
  // Hide the button
  if(installBtn) {
      installBtn.style.display = 'none';
  }
}

// 3. Check if app was installed successfully
window.addEventListener('appinstalled', () => {
  // Hide the app-provided install promotion
  if(installBtn) {
      installBtn.style.display = 'none';
  }
  // Clear the deferredPrompt so it can be garbage collected
  deferredPrompt = null;
  console.log('PWA was installed');
});
</script>
<div id="ios-install-prompt" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.98); padding: 20px; border-top: 1px solid #e5e5e5; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); z-index: 9999; text-align: center; font-family: -apple-system, system-ui, sans-serif; padding-bottom: 25px;">
   <div style="max-width: 400px; margin: 0 auto; position: relative;">
       <button onclick="dismissIOSPrompt()" style="position: absolute; top: -10px; right: 0px; background: none; border: none; font-size: 1.5em; color: #888; padding: 10px; cursor: pointer; line-height: 1;"></button>
       
       <p style="margin: 0 0 10px 0; font-weight: 700; font-size: 1.1em; color: #333;">Install PediCalc App</p>
       
       <p style="margin: 0 0 15px 0; font-size: 0.95em; color: #555;">
           To install this app on your iPhone:
       </p>
       
       <div style="display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 0.9em; color: #333; margin-bottom: 20px;">
           <span>1. Tap</span>
           <img src="https://img.icons8.com/ios-glyphs/30/007AFF/share-rounded.png" alt="Share" style="width: 24px; height: 24px; vertical-align: middle;">
           <span>2. Select <strong>"Add to Home Screen"</strong></span>
           <img src="https://img.icons8.com/ios-glyphs/30/000000/plus-math.png" alt="Add" style="width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 4px; padding: 2px; vertical-align: middle;">
       </div>

       <div style="border-top: 1px solid #eee; padding-top: 15px;">
           <label style="font-size: 0.9em; color: #666; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;">
               <input type="checkbox" id="ios-dont-show" style="width: 16px; height: 16px; accent-color: #059669;">
               Don't show this again
           </label>
       </div>
   </div>
</div>

<script>
   function isIOS() {
       return /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
   }

   function isInStandaloneMode() {
       return ('standalone' in window.navigator) && (window.navigator.standalone);
   }

   function dismissIOSPrompt() {
       const checkbox = document.getElementById('ios-dont-show');
       const prompt = document.getElementById('ios-install-prompt');
       
       // Save preference if checked
       if (checkbox && checkbox.checked) {
           localStorage.setItem('iosInstallPromptDismissed', 'true');
       }
       
       prompt.style.display = 'none';
   }

   // Check if previously dismissed
   const alreadyDismissed = localStorage.getItem('iosInstallPromptDismissed') === 'true';

   // Show logic
   if (isIOS() && !isInStandaloneMode() && !alreadyDismissed) {
       setTimeout(function() {
           document.getElementById('ios-install-prompt').style.display = 'block';
       }, 2500);
   }

   // --- Print Logic ---
   function openPrintModal() {
       const patient = getPatientData();
       if (!patient.weight) {
           alert("Please enter patient weight before printing.");
           return;
       }
       document.getElementById('print-modal').style.display = 'flex';
   }

   function closePrintModal() {
       document.getElementById('print-modal').style.display = 'none';
   }

function generatePrintSheet(onlyFavorites) {
       // 1. Close existing modal
       closePrintModal();
       
       const patient = getPatientData();
       const date = new Date().toLocaleDateString();
       const time = new Date().toLocaleTimeString();

       // --- UNIT DISPLAY LOGIC ---
       // If user selected Lbs, show Lbs (with kg in small text for safety)
       let weightDisplay = `${patient.weight} kg`;
       if (currentWeightUnit === 'lbs') {
           const weightLbs = (patient.weight * 2.20462).toFixed(1);
           weightDisplay = `${weightLbs} lbs <span style="font-size:0.5em; opacity:0.7; vertical-align: middle;">(${patient.weight.toFixed(1)} kg)</span>`;
       }

       // If user selected Feet, show Ft/In
       let heightDisplay = `${patient.height} cm`;
       if (currentHeightUnit === 'ft' && patient.height > 0) {
           const totalInches = patient.height * 0.393701;
           const feet = Math.floor(totalInches / 12);
           const inches = (totalInches % 12).toFixed(1);
           heightDisplay = `${feet}' ${inches}"`;
       }
       
       // --- CALCULATIONS ---
       const ettUncuffed = calculateETTSize(patient.age, patient.weight);
       const ettCuffed = calculateCuffedETTSize(patient.age, patient.weight);
       const depth = calculateETTDepth(patient.age, patient.weight);
       const lma = calculateProSealLMASize(patient.weight);
       const igel = (patient.weight > 0) ? calculateIGelSize(patient.weight) : 'N/A';
       const fluidMaint = calculateMaintenanceFluid(patient.weight);
       const fluidBolus = patient.weight * 10;
       const ebv = calculateEBV(patient.weight, patient.age);
       
       let mablDisplay = '-';
       if (patient.currentHb > 0 && patient.targetHb > 0) {
           const mabl = calculateMABL(ebv, patient.currentHb, patient.targetHb);
           mablDisplay = `<strong>${mabl.toFixed(0)} mL</strong> (Hb ${patient.currentHb}&rarr;${patient.targetHb})`;
       } else {
           mablDisplay = `${(ebv * 0.2).toFixed(0)} mL (Est 20%)`;
       }

       // --- ANTHROPOMETRY ---
       let anthroHtml = '';
       let warningHtml = '';
       if (patient.height > 0 && patient.weight > 0) {
           const heightM = patient.height / 100;
           const bmi = patient.weight / (heightM * heightM);
           const bsa = Math.sqrt((patient.height * patient.weight) / 3600);
           
           let bmiStatus = 'N/A';
           let bmiClass = '';
           
           if (patient.totalAgeInMonths >= 24 && patient.totalAgeInMonths <= 240) {
               const bmiData = calculateBMIForAge(patient, bmi);
               bmiStatus = bmiData.status;
               if (bmiData.status === 'Obese' || bmiData.status === 'Overweight') {
                   bmiClass = 'text-danger';
                   warningHtml = `<div class="print-warning"><strong><i class="fas fa-exclamation-triangle"></i> Obesity Caution:</strong> Patient is ${bmiData.status}. Consider dosing hydrophilic drugs on Ideal Body Weight (IBW).</div>`;
               } else if (bmiData.status === 'Underweight') {
                   bmiClass = 'text-blue';
               }
           }
           anthroHtml = `
               <div class="stats-grid">
                   <div class="stat-box"><div class="stat-label">Height</div><div class="stat-val">${heightDisplay}</div></div>
                   <div class="stat-box"><div class="stat-label">BSA</div><div class="stat-val">${bsa.toFixed(2)} m</div></div>
                   <div class="stat-box"><div class="stat-label">BMI</div><div class="stat-val ${bmiClass}">${bmi.toFixed(1)}</div><div class="stat-sub ${bmiClass}">${bmiStatus}</div></div>
               </div>`;
       }

       // --- DRUG ROWS ---
       let drugRows = '';
       drugs.forEach(drug => {
           if (onlyFavorites && !drug.isFavorite) return;
           
           // 1. Check for Custom Values (Asterisk)
           const isCustom = hasCustomValues(drug);
           const customMark = isCustom ? '<span style="color:#059669; font-weight:900; margin-left:3px; vertical-align: super; font-size: 0.8em;">*</span>' : '';

           const dosePerKg = getDoseByRoute(drug, drug.currentRoute);
           
           // 2. Check for High Dose / Exceeds Range (Exclamation)
           const rangeMax = parseMaxDoseFromRange(drug.range);
           let highDoseMark = '';
           if (rangeMax && dosePerKg > rangeMax) {
               highDoseMark = '<span style="color:#dc2626; font-weight:900; margin-left:4px; font-size:1.1em;" title="Exceeds recommended range">!</span>';
           }

           let totalDose = patient.weight * dosePerKg;
           let limitMsg = '';
           if (drug.maxDose && totalDose > drug.maxDose) { totalDose = drug.maxDose; limitMsg = '<small style="color:#dc2626;">(Max Limit)</small>'; }
           if (drug.minDose && totalDose < drug.minDose) { totalDose = drug.minDose; limitMsg = '<small>(Min)</small>'; }

           const concentration = getConcentration(drug);
           let volStr = '-';
           let concStr = '-';
           if ((drug.currentRoute === 'IV' || drug.currentRoute === 'IM') && concentration) {
               let volume = totalDose / concentration;
               volStr = `<strong>${volume.toFixed(2)} mL</strong>`;
               concStr = `${concentration} ${drug.concentrationUnit}`;
           }

           let doseDisplay = drug.unit.toLowerCase().includes('joules') ? `<strong>${totalDose.toFixed(0)} J</strong>` : 
               (drug.unit.includes('mcg') && totalDose < 1 ? `<strong>${(totalDose * 1000).toFixed(0)} mcg</strong>` : `<strong>${totalDose.toFixed(2)}</strong> ${drug.unit.includes('mcg')?'mcg':'mg'}`);
           if(drug.unit.toLowerCase().includes('joules')) { volStr = 'Shock'; concStr = '-'; }

           drugRows += `<tr><td><div class="drug-name">${drug.name}${customMark}${highDoseMark}</div><div class="drug-cat">${drug.categoryLabel}</div></td><td>${doseDisplay} ${limitMsg}</td><td>${volStr}</td><td>${concStr}</td><td style="color:#666;">${dosePerKg} ${drug.unit}</td></tr>`;
       });

       // --- SHARED CSS (Used for both Preview and Final Print) ---
       const sharedCSS = `
           :root { --primary: #059669; --bg-light: #f3f4f6; --border: #d1d5db; --text: #111827; }
           body { font-family: 'Segoe UI', sans-serif; font-size: 11px; color: #111827; margin: 0; padding: 0; background: white; }
           .paper { background: white; padding: 20px; max-width: 800px; margin: 0 auto; }
           .header-banner { border-bottom: 3px solid #059669; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
           h1 { margin: 0; font-size: 22px; color: #059669; font-weight: 900; text-transform: uppercase; }
           .meta { font-size: 11px; color: #555; margin-top: 4px; }
           .patient-box { text-align: right; }
           .pt-weight { font-size: 26px; font-weight: 800; line-height: 1; }
           .pt-details { font-size: 13px; font-weight: 600; color: #333; }
           .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
           .stat-box { background: #f3f4f6; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #e5e7eb; }
           .stat-label { font-size: 9px; color: #666; text-transform: uppercase; font-weight: 600; }
           .stat-val { font-size: 14px; font-weight: 800; color: #111; margin: 2px 0; }
           .stat-sub { font-size: 8px; color: #666; }
           .text-danger { color: #dc2626 !important; }
           .text-blue { color: #0284c7 !important; }
           .print-warning { background: #fff1f2; border-left: 4px solid #dc2626; color: #991b1b; padding: 10px; margin-bottom: 15px; font-size: 11px; border-radius: 4px; }
           .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
           .card { border: 1px solid #d1d5db; border-radius: 6px; overflow: hidden; page-break-inside: avoid; }
           .card-head { background: #f3f4f6; padding: 6px 10px; font-weight: 700; font-size: 12px; border-bottom: 1px solid #d1d5db; text-transform: uppercase; }
           .card-body { padding: 8px 10px; }
           .row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #eee; padding-bottom: 2px; }
           .row:last-child { border-bottom: none; }
           .lbl { color: #555; } .val { font-weight: 700; }
           table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
           thead { background-color: #059669; color: white; }
           th { text-align: left; padding: 8px; font-weight: 600; text-transform: uppercase; font-size: 10px; }
           td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
           tr:nth-child(even) { background-color: #f9fafb; }
           .drug-name { font-weight: 700; font-size: 12px; display: block; }
           .drug-cat { font-size: 9px; color: #666; text-transform: uppercase; }
           .footer { margin-top: 30px; padding-top: 10px; border-top: 1px solid #d1d5db; text-align: center; color: #666; font-size: 10px; }
           /* Force Print Colors */
           @media print {
                body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .card, table, th, td, .header-banner { border-color: #000 !important; }
                h1, .val, .drug-name { color: #000 !important; }
           }
       `;

       const reportBody = `
           <div class="header-banner">
               <div><h1>Anesthesia Plan</h1><div class="meta">Generated: ${date} ${time}</div></div>
               <div class="patient-box"><div class="pt-weight">${weightDisplay}</div><div class="pt-details">${patient.ageYears}y ${patient.ageMonths}m | ${patient.sex.toUpperCase()}</div></div>
           </div>
           ${anthroHtml} ${warningHtml}
           <div class="grid-2">
               <div class="card"><div class="card-head">Airway Equipment</div><div class="card-body">
                   <div class="row"><span class="lbl">ETT Uncuffed</span> <span class="val">${ettUncuffed}</span></div>
                   <div class="row"><span class="lbl">ETT Cuffed</span> <span class="val">${ettCuffed}</span></div>
                   <div class="row"><span class="lbl">Depth (at lip)</span> <span class="val">${depth} cm</span></div>
                   <div class="row"><span class="lbl">Blade</span> <span class="val">${calculateLaryngoscopeBlade(patient.age)}</span></div>
                   <div class="row"><span class="lbl">LMA / i-gel</span> <span class="val">#${lma.size} / #${igel}</span></div>
               </div></div>
               <div class="card"><div class="card-head">Fluids & Blood</div><div class="card-body">
                   <div class="row"><span class="lbl">Maint. (4-2-1)</span> <span class="val">${fluidMaint.toFixed(0)} mL/hr</span></div>
                   <div class="row"><span class="lbl">Bolus (10ml/kg)</span> <span class="val">${fluidBolus.toFixed(0)} mL</span></div>
                   <div class="row"><span class="lbl">EBV</span> <span class="val">${ebv.toFixed(0)} mL</span></div>
                   <div class="row"><span class="lbl">MABL</span> <span class="val">${mablDisplay}</span></div>
                   <div class="row"><span class="lbl">NPO Deficit (~6h)</span> <span class="val">${(fluidMaint * 6).toFixed(0)} mL</span></div>
               </div></div>
           </div>
           <table><thead><tr><th width="35%">Drug</th><th width="20%">Dose</th><th width="15%">Vol</th><th width="15%">Conc</th><th width="15%">Ref</th></tr></thead><tbody>${drugRows}</tbody></table>
           <div class="footer">
               <div style="margin-bottom:5px; font-size:9px; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">
                   <span style="margin-right:15px;"><strong style="color:#059669;">*</strong> Custom Value</span> 
                   <span><strong style="color:#dc2626;">!</strong> Exceeds Range</span>
               </div>
               <strong>Disclaimer:</strong> Advisory Aid Only: This tool is intended to supplement, not replace, professional clinical judgment. All calculations must be independently verified against standard medical literature and hospital protocols before administration. The user assumes full responsibility for patient care.
           </div>
       `;

       // --- LOGIC: PDF GENERATION & OPEN (Direct View) ---
       // Uses local html2pdf library to generate Base64 and send to Android
       window.executeMobilePrint = function() {
           // 1. Create a temporary container to hold the clean HTML
           const element = document.createElement('div');
           
           // Force white background and proper padding for the PDF
           // We override specific styles to ensure it looks like a document, not a web page
           const pdfCSS = sharedCSS + " .paper { padding: 20px !important; width: 100% !important; max-width: none !important; box-shadow: none !important; } body { background: #fff; }";
           
           element.innerHTML = `<style>${pdfCSS}</style><div class="paper">${reportBody}</div>`;

           // 2. Feedback for the user (change button text)
           const btn = document.querySelector('.btn-print');
           let originalText = '';
           if(btn) { 
               originalText = btn.innerHTML;
               btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating PDF...';
           }

           // 3. Configure PDF options
           const opt = {
               margin:       0.3,
               filename:     'patient_report.pdf',
               image:        { type: 'jpeg', quality: 0.98 },
               html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
               jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
           };

           // 4. Generate and Send to Android
           // We output as 'datauristring' (Base64) so we can pass it to Java
           html2pdf().set(opt).from(element).outputPdf('datauristring').then(function(pdfAsString) {
               // The string comes as "data:application/pdf;base64,JVBERi0..."
               // We need to strip the prefix to get raw Base64 data
               var base64 = pdfAsString.split(',')[1];

               if (typeof AndroidApp !== 'undefined' && AndroidApp.saveAndOpenPdf) {
                   try {
                       AndroidApp.saveAndOpenPdf(base64); // Call the Android Java Code
                       
                       if(btn) {
                           btn.innerHTML = '<i class="fas fa-check"></i> Opening...';
                           setTimeout(() => { closePrintModal(); }, 1500);
                       }
                   } catch(e) {
                       alert("Android Bridge Error: " + e.message);
                       if(btn) btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
                   }
               } else {
                   // Fallback for Browser/PC testing (Downloads the file)
                   html2pdf().set(opt).from(element).save();
                   if(btn) {
                       btn.innerHTML = '<i class="fas fa-download"></i> Downloaded';
                       setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                   }
               }
           }).catch(function(err) {
               console.error("PDF Generation Error:", err);
               alert("Error generating PDF. Please restart the app.");
               if(btn) btn.innerHTML = originalText;
           });
       };

       // --- PREVIEW OVERLAY ---
       // Shows the user what they are about to print
       
       // Clean up existing
       if(document.getElementById('print-preview-overlay')) { 
           document.body.removeChild(document.getElementById('print-preview-overlay')); 
       }

       const overlayHTML = `
           <div class="print-toolbar">
               <button class="btn-back" onclick="closePrintPreview()"><i class="fas fa-arrow-left"></i> Back</button>
               <button class="btn-print" onclick="executeMobilePrint()"><i class="fas fa-print"></i> PRINT REPORT</button>
           </div>
           <div class="paper">
               ${reportBody}
           </div>
       `;

       const overlay = document.createElement('div');
       overlay.id = 'print-preview-overlay';
       overlay.innerHTML = overlayHTML;
       
       // Inline Styles for Overlay
       overlay.style.position = 'fixed';
       overlay.style.top = '0';
       overlay.style.left = '0';
       overlay.style.width = '100%';
       overlay.style.height = '100%';
       overlay.style.background = '#eef2ff';
       overlay.style.zIndex = '99999';
       overlay.style.overflowY = 'auto';
       overlay.style.fontFamily = "'Segoe UI', sans-serif";

       // Inject specific styles for the preview elements
       const styleTag = document.createElement('style');
       styleTag.innerHTML = `
           ${sharedCSS}
           /* Toolbar specific to preview */
           .print-toolbar { position: sticky; top: 0; left: 0; right: 0; background: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 100; margin-bottom: 20px; }
           .btn-back { flex: 1; padding: 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 700; cursor: pointer; }
           .btn-print { flex: 1; padding: 12px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2); }
           /* Hide main app scrollbar */
           body { overflow: hidden; }
       `;
       overlay.appendChild(styleTag);
       document.body.appendChild(overlay);

       // --- GLOBAL CLOSE FUNCTION ---
       window.closePrintPreview = function() {
           document.body.removeChild(overlay);
           document.body.style.overflow = ''; // Restore scroll
           delete window.closePrintPreview;
           delete window.executeMobilePrint;
       };
   }
</script>

</body>
</html>
