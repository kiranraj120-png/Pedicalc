<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pediatric Anesthesia Calculator</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
  	/* Category pill styles with colored background */
.drug-category {
  font-size: 0.7em;
  padding: 4px 10px;
  border-radius: 20px;
  color: #000;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background-color: var(--border-color);
}

/* Each category color background */
.drug-category.induction { background-color: var(--induction); }
.drug-category.muscle-relaxant { background-color: var(--muscle-relaxant); color: #fff; }
.drug-category.analgesic { background-color: var(--analgesic); color: #fff; }
.drug-category.adjunct { background-color: var(--adjunct); color: #fff; }
.drug-category.reversal { background-color: var(--reversal); color: #fff; }
.drug-category.emergency { background-color: var(--emergency); color: #000; }
.drug-category.steroid { background-color: var(--steroid); color: #fff; }
.drug-category.antiemetic { background-color: var(--antiemetic); color: #000; }
    :root{
      --bg-primary:#ffffff;
      --bg-secondary:#fff8e1;
      --bg-card:#ffffff;
      --text-primary:#121212;
      --text-secondary:#546e7a;
      --text-tertiary:#b0bec5;
      --border-color:#e1f5fe;
      --shadow:0 8px 20px rgba(0,0,0,0.1);
      --shadow-hover:0 10px 25px rgba(0,0,0,0.15);

      --induction:#34ebb4;
      --muscle-relaxant:#ff6d00;
      --analgesic:#00c853;
      --adjunct:#d500f9;
      --reversal:#ff1744;
      --emergency:#ffc400;
      --steroid:#3f51b5;
      --antiemetic:#8bc34a;
      --primary-accent:#0089f0;

      --radius-card:16px;
      --radius-input:10px;
    }

    body.dark-mode{
      --bg-primary:#000000;
      --bg-secondary:#111111;
      --bg-card:#222222;
      --text-primary:#f5f5f5;
      --text-secondary:#bbbbbb;
      --border-color:#4a4a4a;
      --shadow:0 8px 20px rgba(0,0,0,0.6);
      --shadow-hover:0 10px 25px rgba(0,0,0,0.8);
      --emergency:#ffeb3b;
    }

    /* Reset & base */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      font-family:'Montserrat',sans-serif;
      background:var(--bg-secondary);
      color:var(--text-primary);
      line-height:1.5;
      font-size:0.95rem;
      transition:background-color .4s,color .4s;
      user-select:none; /* make app text unselectable except inputs */
      -webkit-font-smoothing:antialiased;
    }
    input,textarea{user-select:text!important}

    .container{max-width:1200px;margin:0 auto;padding:20px 10px}

    /* Header */
    header{
      background:var(--primary-accent);
      color:var(--bg-primary);
      padding:20px;
      border-radius:var(--radius-card);
      box-shadow:var(--shadow);
      margin-bottom:20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    h1{font-size:1.8em;font-weight:700}
    .dark-mode-toggle{
      background:var(--bg-primary);
      color:var(--primary-accent);
      border:none;border-radius:50px;padding:8px 16px;
      cursor:pointer;font-size:.8em;font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);transition:all .18s ease;
      -webkit-tap-highlight-color:transparent;
      outline:none;
    }
    .dark-mode-toggle:active{transform:translateY(1px)}
    .dark-mode-toggle::-moz-focus-inner{border:0}

    /* Sections */
    .section,.patient-info{
      background:var(--bg-card);
      padding:20px;border-radius:var(--radius-card);
      box-shadow:var(--shadow);margin-bottom:20px;transition:box-shadow .3s ease;
    }
    .section h2{
      font-size:1.4em;font-weight:600;margin-bottom:15px;color:var(--text-primary);
      border-bottom:2px solid var(--border-color);padding-bottom:8px;
    }

    /* Inputs */
    .input-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-top:10px}
    .age-input-group{display:flex;gap:10px}
    .input-field label{font-size:.85em;color:var(--text-secondary);margin-bottom:5px;font-weight:600;display:block}
    .input-field input{
      width:100%;padding:10px 12px;border:1px solid var(--border-color);
      border-radius:var(--radius-input);font-size:.95em;background:var(--bg-primary);
      color:var(--text-primary);transition:border-color .3s,box-shadow .3s;
    }
    .input-field input:focus{outline:none;border-color:var(--primary-accent);box-shadow:0 0 0 3px rgba(0,137,240,.2)}

    /* Grid containers */
    .drugs-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:10px}
    .equipment-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-top:10px}

    /* Drug card */
    .drug-card{
      border-radius:var(--radius-card);padding:15px;border-left:6px solid;background:var(--bg-secondary);
      transition:all .35s cubic-bezier(.25,.8,.25,1);position:relative;z-index:1;
      will-change:transform,box-shadow,background-color;
    }
    .drug-card.caution-active{z-index:20}
    .drug-card:hover{box-shadow:var(--shadow-hover);transform:translateY(-1px);background:var(--bg-card)}

    /* left border category colors */
    .drug-card.induction{border-left-color:var(--induction)}
    .drug-card.muscle-relaxant{border-left-color:var(--muscle-relaxant)}
    .drug-card.analgesic{border-left-color:var(--analgesic)}
    .drug-card.adjunct{border-left-color:var(--adjunct)}
    .drug-card.reversal{border-left-color:var(--reversal)}
    .drug-card.emergency{border-left-color:var(--emergency)}
    .drug-card.steroid{border-left-color:var(--steroid)}
    .drug-card.antiemetic{border-left-color:var(--antiemetic)}

    .drug-header{
      display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer;
      -webkit-tap-highlight-color:transparent;user-select:none;flex-direction:column;gap:5px;
    }
    .drug-card.expanded .drug-header{padding-bottom:10px}
    .drug-name{font-weight:700;font-size:1.2em;color:var(--text-primary);display:flex;align-items:center}
    .toggle-icon{font-size:1.1em;margin-right:8px;transform:rotate(0deg);
      transition:transform 350ms cubic-bezier(.175,.885,.32,1.275);will-change:transform}
    .drug-card.expanded .toggle-icon{transform:rotate(90deg)}

    .drug-details{
      max-height:0;overflow:hidden;opacity:0;padding-top:0;transform:translateY(-6px);
      transition:max-height 420ms cubic-bezier(.22,1,.36,1),opacity 260ms ease-in-out,transform 420ms cubic-bezier(.22,1,.36,1),padding-top 420ms cubic-bezier(.22,1,.36,1);
      will-change:max-height,opacity,transform,padding-top;
    }
    .drug-card.expanded .drug-details{max-height:520px;opacity:1;padding-top:15px;transform:translateY(0)}

    .drug-category{font-size:.7em;padding:4px 10px;border-radius:20px;color:var(--bg-primary);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .drug-category.induction,.drug-category.emergency{color:#000}

    .dose-info{font-size:.8em;color:var(--text-secondary);font-style:italic;margin-top:4px}

    /* Caution icon & popup */
    .caution-icon{
      display:inline-block;width:18px;height:18px;line-height:18px;text-align:center;border-radius:50%;
      background-color:var(--emergency);color:#000;font-weight:bold;font-size:.7em;cursor:pointer;margin-left:10px;flex-shrink:0;align-self:flex-start;
      -webkit-tap-highlight-color:transparent;
    }
    .caution-popup{
      display:none;position:absolute;z-index:30;padding:10px;background:var(--bg-primary);color:var(--text-primary);
      border:1px solid var(--emergency);border-radius:5px;box-shadow:var(--shadow-hover);width:250px;font-size:.75em;top:15px;right:15px;white-space:normal;
    }
    .dose-limit-applied{font-size:.75em;color:var(--reversal);font-weight:600;display:block;margin-top:2px}

    /* Calculations & edit UI */
    .calculation{background:var(--bg-card);padding:12px;border-radius:var(--radius-input);margin-top:10px;border:1px solid var(--border-color)}
    .calculation-result{font-weight:800;font-size:1.3em;color:var(--reversal)}
    .volume-result{font-size:.85em;color:var(--text-secondary);margin-top:3px;font-weight:500}

    .edit-btn{
      background:transparent;border:1px solid var(--primary-accent);padding:6px 14px;border-radius:50px;font-size:.8em;cursor:pointer;color:var(--primary-accent);
      margin-top:10px;transition:all .3s ease;font-weight:600;max-width:fit-content;
    }
    .edit-btn:hover{background:var(--primary-accent);color:var(--bg-primary);box-shadow:0 4px 10px rgba(0,137,240,.3)}

    .edit-inputs{display:none;margin-top:10px;padding:10px;background:var(--bg-secondary);border-radius:var(--radius-input);border:1px dashed var(--text-tertiary);flex-direction:column;gap:10px}
    .edit-inputs.active{display:flex}

    /* New Route Selector styles */
    .route-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px dashed var(--border-color);
      flex-wrap: wrap;
    }
    .route-selector label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.85em;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 50px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    .route-selector input[type="radio"] {
      /* Hide the actual radio button */
      display: none;
    }
    .route-selector input[type="radio"]:checked + label {
      background: var(--primary-accent);
      color: var(--bg-primary);
      border-color: var(--primary-accent);
    }

    /* Equipment cards */
    .equipment-card{background:var(--bg-secondary);padding:15px;border-radius:var(--radius-card);text-align:center;border-top:4px solid var(--primary-accent);transition:all .3s ease}
    .equipment-title{font-size:.9em;color:var(--text-secondary);margin-bottom:8px;font-weight:600}
    .equipment-value{font-size:1.6em;font-weight:800;color:var(--primary-accent);line-height:1.1}
    .equipment-value.error{color:var(--reversal);font-size:.9em;font-weight:600;line-height:1.3}
    .equipment-detail{font-size:.75em;color:var(--text-secondary);margin-top:6px}

    /* Warning box */
    .warning{background:#fff3cd;border-left:5px solid #ffc107;padding:15px;margin:20px 0;border-radius:8px;font-size:.9em;color:#856404;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    body.dark-mode .warning{background:#4a3f00;color:#ffeb3b;border-left:5px solid #ff9800}

    .expand-all-btn{margin-top:5px;margin-bottom:15px;display:block;width:100%;max-width:400px;text-align:center}

    /* Responsive */
    @media(min-width:768px){
      .container{padding:30px 20px}
      .drugs-grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
      .equipment-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
      h1{font-size:2.2em}
      .section h2{font-size:1.6em}
      .drug-name{font-size:1.3em}
      .drug-header{flex-direction:row;align-items:center}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Pediatric Anesthesia Calculator</h1>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">🌙 Dark Mode</button>
    </header>

    <div class="warning">
      ⚠️ This calculator is for reference only. Always verify calculations and use clinical judgment. Dosages may need adjustment based on patient condition and local protocols.
    </div>

    <section class="patient-info">
      <h2>Patient Information</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="age-years">Age</label>
          <div class="age-input-group">
            <input type="number" id="age-years" placeholder="Years (max 18)" step="1" min="0" max="18" oninput="clampAgeAndCalculate()">
            <input type="number" id="age-months" placeholder="Months (0-11)" step="1" min="0" max="11" oninput="clampAgeAndCalculate()">
          </div>
        </div>

        <div class="input-field">
          <label for="weight">Weight (kg)</label>
          <input type="number" id="weight" placeholder="Enter weight" step="0.1" min="0" oninput="calculateAll()">
        </div>

        <div class="input-field">
          <label for="currentHb">Current Hb (g/dL)</label>
          <input type="number" id="currentHb" placeholder="e.g., 12.0" step="0.1" min="0" oninput="calculateAll()">
        </div>

        <div class="input-field">
          <label for="targetHb">Target Hb (g/dL)</label>
          <input type="number" id="targetHb" placeholder="e.g., 8.0" step="0.1" min="0" oninput="calculateAll()">
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Airway Equipment Sizing</h2>
      <div id="equipment-results" class="equipment-grid"></div>
    </section>

    <section class="section">
      <h2>Fluid & Blood Loss Requirements</h2>
      <div id="fluid-results" class="equipment-grid"></div>
    </section>

    <section class="section">
      <h2>Drug Calculations</h2>
      <button class="expand-all-btn edit-btn" id="toggleAllBtn" onclick="toggleAllDrugs()">Expand All / Collapse All</button>
      <div id="drug-results" class="drugs-grid"></div>
    </section>
  </div>

  <p style="text-align:center;margin-top:20px;font-size:0.85em;color:grey;">
    <a href="https://t.me/utopiccc">Ⓡ︎2025 Dr. Kiranraj</a>
  </p>

  <script>
  /* -------------------------
     Data definitions (MODIFIED)
     - Added oralDose, imDose, defaultRoute, and currentRoute
     ------------------------- */
  const drugs = [
    { name:'Propofol', category:'induction', categoryLabel:'Induction Agent', defaultDose:2.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'2-3 mg/kg', defaultRoute:'IV' },
    { name:'Thiopentone', category:'induction', categoryLabel:'Induction Agent', defaultDose:5, unit:'mg/kg', concentration:25, concentrationUnit:'mg/mL', useParam:'weight', range:'4-6 mg/kg', defaultRoute:'IV' },
    { name:'Ketamine', category:'induction', categoryLabel:'Induction Agent', defaultDose:2, imDose:4, oralDose:6, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 4-6 mg/kg IM, 6-10 mg/kg Oral', defaultRoute:'IV' }, // MODIFIED
    { name:'Vecuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.08-0.1 mg/kg', defaultRoute:'IV' },
    { name:'Rocuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.6, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.6-1.2 mg/kg', defaultRoute:'IV' },
    { name:'Atracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.4-0.5 mg/kg', defaultRoute:'IV' },
    { name:'Succinylcholine', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:1.5, imDose:3, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 3-4 mg/kg IM', caution:'FDA Black Box Warning: Reserved for emergent use in children (<50kg) due to risk of hyperkalemia/cardiac arrest in undiagnosed myopathies.', defaultRoute:'IV' }, // MODIFIED
    { name:'Fentanyl', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:2, unit:'mcg/kg', concentration:50, concentrationUnit:'mcg/mL', useParam:'weight', range:'1-3 mcg/kg', defaultRoute:'IV' },
    { name:'Morphine', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg', defaultRoute:'IV' },
    { name:'Tramadol', category:'analgesic', categoryLabel:'Analgesic', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Paracetamol (IV)', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, caution:'Dose must be reduced to 7.5 mg/kg for patients <10 kg. Risk of hepatotoxicity in small infants/neonates.', defaultRoute:'IV' },
    { name:'Midazolam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.5, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg IV, 0.5-1 mg/kg Oral', caution:'Reduced dose or slow titration recommended for infants <10 kg due to prolonged effect/lower clearance.', defaultRoute:'IV' }, // MODIFIED
    { name:'Lidocaine (Xylocard)', category:'adjunct', categoryLabel:'Local Anesthetic', defaultDose:1.5, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-1.5 mg/kg IV', caution:'Strict total dose of 5 mg/kg. Higher risk of systemic toxicity in neonates/infants <10 kg.', defaultRoute:'IV' },
    { name:'Dexamethasone', category:'steroid', categoryLabel:'Steroid', defaultDose:0.15, unit:'mg/kg', concentration:4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Hydrocortisone', category:'steroid', categoryLabel:'Steroid', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Ondansetron', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.15 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Metoclopramide', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.15, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 10mg)', maxDose:10, defaultRoute:'IV' },
    { name:'Atropine', category:'emergency', categoryLabel:'Anticholinergic', defaultDose:0.01, unit:'mg/kg', concentration:0.6, concentrationUnit:'mg/mL', useParam:'weight', range:'0.01-0.02 mg/kg (min 0.1mg)', minDose:0.1, defaultRoute:'IV' },
    { name:'Neostigmine', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:0.05, unit:'mg/kg', concentration:0.5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.04-0.08 mg/kg (max 5mg)', maxDose:5, defaultRoute:'IV' },
    { name:'Glycopyrrolate', category:'reversal', categoryLabel:'Anticholinergic', defaultDose:0.01, unit:'mg/kg', concentration:0.2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.008-0.01 mg/kg', defaultRoute:'IV' },
    { name:'Sugammadex', category:'reversal', categoryLabel:'Reversal Agent', defaultDose:2, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'2-4 mg/kg (routine reversal)', defaultRoute:'IV' },
    { name:'Adrenaline (Epinephrine)', category:'emergency', categoryLabel:'Emergency', defaultDose:10, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'10 mcg/kg IV (1:100,000)', defaultRoute:'IV' }
  ];
  
  // Initialize currentRoute for each drug on load (since it's a dynamic property)
  drugs.forEach(drug => {
    drug.currentRoute = drug.defaultRoute;
  });

  /* dynamic dilution tiers used when calculated volume < 1 mL */
  const dilutionTiers = {
    'Fentanyl': [50,10,5],      // mcg/mL
    'Atropine': [0.6,0.1],      // mg/mL
    'Glycopyrrolate': [0.2,0.04],
    'Ondansetron': [2,1],
    'Vecuronium': [1,0.5],
    'Atracurium': [10,5,2.5]
  };

  /* -------------------------
     UI state variables
     ------------------------- */
  let allExpanded = false;
  let activeEditIndex = null; // keep an edited card open after recalculation

  /* -------------------------
     Helper: read & cache patient data
     ------------------------- */
  function getPatientData(){
    // Read clamped inputs (clamping happens elsewhere)
    const years = parseFloat(document.getElementById('age-years').value) || 0;
    const months = parseFloat(document.getElementById('age-months').value) || 0;
    const totalAge = years + (months/12);
    return {
      age: totalAge,
      weight: parseFloat(document.getElementById('weight').value) || 0,
      currentHb: parseFloat(document.getElementById('currentHb').value) || 0,
      targetHb: parseFloat(document.getElementById('targetHb').value) || 0
    };
  }

  /* -------------------------
     Age clamping (Years: 0-18, Months: 0-11)
     and trigger recalculation
     ------------------------- */
  function clampAgeAndCalculate(){
    const ageYearsInput = document.getElementById('age-years');
    const ageMonthsInput = document.getElementById('age-months');

    let years = parseFloat(ageYearsInput.value);
    let months = parseFloat(ageMonthsInput.value);

    if (!isNaN(years)){
      if (years < 0) years = 0;
      if (years > 18) years = 18;
      ageYearsInput.value = years;
    } else if (ageYearsInput.value) {
      ageYearsInput.value = '';
    }

    if (!isNaN(months)){
      if (months < 0) months = 0;
      if (months > 11) months = 11;
      if (years === 18) months = 0; // if 18 years then months must be zero
      ageMonthsInput.value = months;
    } else if (ageMonthsInput.value) {
      ageMonthsInput.value = '';
    }

    calculateAll();
  }

  /* -------------------------
     Airway sizing helpers
     - calculateETTSize() returns string (to preserve original 'Enter Weight (kg)' message)
     - calculateETTDepth() uses ETT size and special neonate formula
     ------------------------- */
  function calculateETTSize(age, weight){
    if (age < 1){
      if (weight === 0) return 'Enter Weight (kg)';
      if (weight < 1.0) return '2.5';
      if (weight >= 1.0 && weight <= 2.0) return '3.0';
      return '3.5';
    }
    if (age >= 1 && age <= 18){
      const calculatedSize = (age/4)+4;
      // Round to nearest multiple of 0.5 as requested
      return (Math.round(calculatedSize * 2) / 2).toFixed(1);
    }
    return '7.5'; // fallback (unreachable due to clamp)
  }

  function calculateETTDepth(age, weight){
    const sizeStr = calculateETTSize(age, weight);
    if (sizeStr.includes('Enter') || sizeStr === 'N/A') return 'N/A';
    const size = parseFloat(sizeStr);
    if (age < 0.1 && weight > 0){ // neonate (<1 month)
      // depth formula for neonates: weight + 6
      return (weight + 6).toFixed(1);
    }
    // general formula: ID x 3
    return (size * 3).toFixed(1);
  }

  /* -------------------------
     LMA / i-gel sizing helpers
     (kept separate for clarity and identical results)
     ------------------------- */
  function calculateLMASize(weight){
    if (weight < 5) return '1';
    if (weight < 10) return '1.5';
    if (weight < 20) return '2';
    if (weight < 30) return '2.5';
    if (weight < 50) return '3';
    return '4';
  }

  function calculateIGelSize(weight){
    if (weight < 5) return '1';
    if (weight < 10) return '1.5';
    if (weight < 25) return '2';
    if (weight < 35) return '2.5';
    if (weight < 60) return '3';
    if (weight < 90) return '4';
    return '5';
  }

  /* -------------------------
     Fluid calculations
     ------------------------- */
  function calculateMaintenanceFluid(weight){
    if (weight <= 10) return weight * 4;
    if (weight <= 20) return 40 + (weight - 10) * 2;
    return 60 + (weight - 20) * 1;
  }

  function calculateEBV(weight, age){
    if (weight === 0) return 0;
    if (age < 0.1) return weight * 90; // neonate <1 month
    if (age < 1) return weight * 85;   // 1 month - 1 year
    if (age < 3) return weight * 80;   // toddler
    if (age < 6) return weight * 75;   // preschooler
    if (age < 12) return weight * 70;  // school age
    return weight * 65;                // adolescent
  }

  function calculateMABL(EBV, initialHb, targetHb){
    if (initialHb <= targetHb || initialHb === 0 || EBV === 0) return 0;
    const MABL = EBV * (initialHb - targetHb) / initialHb;
    return Math.max(0, MABL);
  }

  /* -------------------------
     Equipment rendering
     - builds the same HTML content (identical UX)
     ------------------------- */
  function calculateEquipment(){
    const patient = getPatientData();
    const uncuffedSize = calculateETTSize(patient.age, patient.weight);
    const depth = calculateETTDepth(patient.age, patient.weight);

    let cuffedSize = 'N/A';
    let uncuffedValueClass = 'equipment-value';
    if (uncuffedSize.includes('Enter')){
      uncuffedValueClass += ' error';
    } else {
      const id = parseFloat(uncuffedSize);
      cuffedSize = (id - 0.5).toFixed(1);
    }

    const lmaSize = patient.weight === 0 ? 'N/A' : calculateLMASize(patient.weight);
    const igelSize = patient.weight === 0 ? 'N/A' : calculateIGelSize(patient.weight);

    const equipmentHTML = `
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Uncuffed)</div>
        <div class="${uncuffedValueClass}">${uncuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Cuffed)</div>
        <div class="equipment-value">${cuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">LMA Size</div>
        <div class="equipment-value">${lmaSize}</div>
        <div class="equipment-detail">Based on weight</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">i-gel Size</div>
        <div class="equipment-value">${igelSize}</div>
        <div class="equipment-detail">Based on weight</div>
      </div>
    `;
    document.getElementById('equipment-results').innerHTML = equipmentHTML;
  }

  /* -------------------------
     Fluids rendering
     ------------------------- */
  function calculateFluids(){
    const patient = getPatientData();
    const fluidResultsEl = document.getElementById('fluid-results');

    if (!patient.weight){
      fluidResultsEl.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate fluids and drug doses</p>';
      return;
    }

    const maintenance = calculateMaintenanceFluid(patient.weight);
    const bolus = patient.weight * 10;
    const EBV = calculateEBV(patient.weight, patient.age);

    let MABL_Result = "N/A";
    let MABL_Detail = "Requires Current & Target Hb";

    if (patient.currentHb > 0 && patient.targetHb > 0){
      const calculatedMABL = calculateMABL(EBV, patient.currentHb, patient.targetHb);
      MABL_Result = `${calculatedMABL.toFixed(0)} mL`;
      MABL_Detail = `Hb Drop: ${patient.currentHb.toFixed(1)} → ${patient.targetHb.toFixed(1)} g/dL`;
    } else {
      MABL_Result = `${(EBV * 0.15).toFixed(0)} - ${(EBV * 0.3).toFixed(0)} mL`;
      MABL_Detail = `Estimated Max (15-30% of EBV)`;
    }

    const fluidHTML = `
      <div class="equipment-card">
        <div class="equipment-title">Maintenance Fluid</div>
        <div class="equipment-value">${maintenance.toFixed(0)} mL/hr</div>
        <div class="equipment-detail">4-2-1 rule</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Fluid Bolus</div>
        <div class="equipment-value">${bolus.toFixed(0)} mL</div>
        <div class="equipment-detail">10 mL/kg</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Est. Blood Volume (EBV)</div>
        <div class="equipment-value">${EBV.toFixed(0)} mL</div>
        <div class="equipment-detail">Age-based mL/kg used</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Max Allowable Blood Loss (MABL)</div>
        <div class="equipment-value">${MABL_Result}</div>
        <div class="equipment-detail">${MABL_Detail}</div>
      </div>
    `;
    fluidResultsEl.innerHTML = fluidHTML;
  }

  /* -------------------------
     Utility: parse upper numeric value from dose range strings
     ------------------------- */
  function parseMaxDoseFromRange(rangeString){
    if (!rangeString) return null;
    // Regex to find all numbers, including decimals
    const numbers = rangeString.match(/(\d+\.?\d*)/g);
    if (!numbers || numbers.length === 0) return null;
    const maxDose = numbers.reduce((max, cur) => {
      const num = parseFloat(cur);
      return (!isNaN(num) && num > max) ? num : max;
    }, 0);
    return maxDose > 0 ? maxDose : null;
  }

  /* -------------------------
     MODIFIED: Helper to get the correct dose based on route
     ------------------------- */
  function getDoseByRoute(drug){
    let dose;
    switch (drug.currentRoute) {
      case 'IM':
        dose = drug.imDose !== undefined ? drug.imDose : drug.defaultDose;
        break;
      case 'Oral':
        dose = drug.oralDose !== undefined ? drug.oralDose : drug.defaultDose;
        break;
      case 'IV':
      default:
        dose = drug.defaultDose;
        break;
    }
    return dose;
  }
  
  /* -------------------------
     MODIFIED: Route selector logic
     - updates drug.currentRoute and forces recalculation
     ------------------------- */
  function selectRoute(index, route) {
    const drug = drugs[index];
    if (drug) {
      drug.currentRoute = route;
      // When route is changed, reset dosePerKg to the default for that route
      // This is necessary because the edit functionality only updates drug.defaultDose,
      // which is mapped to the IV dose in the new logic.
      if (route === 'IM' && drug.imDose !== undefined) {
          // Temporarily set the displayed defaultDose to IM for calculation clarity
          drug.defaultDose = drug.imDose; 
          drug.isCustomDoseHigh = false; // Clear any custom dose warning
      } else if (route === 'Oral' && drug.oralDose !== undefined) {
          drug.defaultDose = drug.oralDose;
          drug.isCustomDoseHigh = false;
      } else { // IV
          // Restore the IV defaultDose from the initial data structure if possible
          // For simplicity and since we don't have a separate storage for IV default, 
          // we re-read the original IV default from a persistent, non-customized source if we had one.
          // Since we don't, we will assume drug.defaultDose is what the user is editing, but
          // will use the hardcoded initial dose for the current route's first calculation.
          // Due to the complexity of the existing `updateDrug` which only modifies `defaultDose`,
          // we will keep `defaultDose` mapped to the *current* per-kg dose shown.
          // To ensure this works, we must ensure `defaultDose` is correctly set for the new route.
          const initialDrugData = initialDrugs.find(d => d.name === drug.name);
          if (initialDrugData) {
              drug.defaultDose = initialDrugData.defaultDose; // Restore original IV dose
              drug.isCustomDoseHigh = false;
          }
      }
      activeEditIndex = index; // Keep the card open
      calculateDrugs();
    }
  }
  
  // Store a copy of initial drug data to reset doses when switching back to IV
  const initialDrugs = JSON.parse(JSON.stringify(drugs.map(d => ({
      name: d.name, 
      defaultDose: d.defaultDose,
      imDose: d.imDose,
      oralDose: d.oralDose
  }))));


  /* -------------------------
     Drug calculations & rendering (MODIFIED)
     ------------------------- */
  function calculateDrugs(){
    const patient = getPatientData();
    const drugResultsDiv = document.getElementById('drug-results');

    if (!patient.weight){
      drugResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate drug doses</p>';
      document.getElementById('toggleAllBtn').style.display = 'none';
      return;
    }
    document.getElementById('toggleAllBtn').style.display = 'block';

    let html = '';

    drugs.forEach((drug, index) => {
      const paramValue = patient[drug.useParam]; // usually weight

      // Determine the correct default dose based on the current route
      // We read the true route-specific default dose for this calculation
      const initialDosePerKgForRoute = getDoseByRoute(drug);
      
      // Use the potentially custom/edited dose (stored in defaultDose) as the calculation base.
      // This is a workaround for the existing single-property edit logic (`updateDrug` modifies `defaultDose`).
      let dosePerKg = drug.defaultDose;
      let doseAdjusted = false;
      let limitApplied = false;
      
      // Check if `defaultDose` property still holds the dose for the `currentRoute` (after a route switch)
      // If it doesn't, update the calculation to the new route's default.
      if (dosePerKg !== initialDosePerKgForRoute && drug.currentRoute !== 'IV') {
          // If the dose stored in drug.defaultDose is not the one for the new route, use the new route's dose.
          // This handles the transition from IV to IM/Oral/etc.
          dosePerKg = initialDosePerKgForRoute;
          drug.defaultDose = dosePerKg; // Update the stored default dose to the new route's default
      }
      
      // Paracetamol special-case for <10 kg (MODIFIED to use current dosePerKg)
      if (drug.name === 'Paracetamol (IV)' && patient.weight > 0 && patient.weight < 10){
        // Only apply special rule if the current dose is the high IV default (15)
        if (initialDosePerKgForRoute === 15){ 
          dosePerKg = 7.5;
          doseAdjusted = true;
        }
      }

      // total dose (mg or mcg)
      let dose = paramValue * dosePerKg;

      // enforce max/min total dose limits if present
      if (drug.maxDose && dose > drug.maxDose){
        dose = drug.maxDose; limitApplied = true;
      }
      if (drug.minDose && dose < drug.minDose){
        dose = drug.minDose; limitApplied = true;
      }

      // Concentration logic: only apply if IV/IM (Oral does not use concentration/volume logic)
      const isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
      let finalConcentration = drug.concentration;
      let dilutionApplied = false;
      
      if (isInjectable) {
          const initialConcentration = drug.concentration;
          const tiers = dilutionTiers[drug.name];

          if (tiers){
            for (const conc of tiers){
              const calculatedVolume = dose / conc;
              if (calculatedVolume >= 1.0){
                finalConcentration = conc;
                dilutionApplied = conc !== initialConcentration;
                break;
              }
              finalConcentration = conc;
              dilutionApplied = true;
            }
          }
      } else {
        // For Oral, volume and concentration are not calculated/displayed
        finalConcentration = drug.concentration;
      }

      // final metrics
      const volume = isInjectable ? dose / finalConcentration : 0;
      const doseDisplay = drug.unit.includes('mcg') ? dose.toFixed(0) : dose.toFixed(2);
      const volumeDisplay = isInjectable ? volume.toFixed(2) : 'N/A';
      const totalDoseUnit = drug.unit.includes('mcg') ? 'mcg' : 'mg';
      let concentrationDisplay = isInjectable ? `${finalConcentration} ${drug.concentrationUnit}` : 'N/A';

      // caution logic
      let isCautionNeeded = false;
      if (drug.caution){
        if (drug.name === 'Succinylcholine' && patient.weight > 0 && patient.weight < 50) isCautionNeeded = true;
        else if ((drug.name === 'Paracetamol (IV)' || drug.name === 'Midazolam' || drug.name === 'Lidocaine (Xylocard)') && patient.weight > 0 && patient.weight < 10) isCautionNeeded = true;
      }

      let cautionIconHtml = '';
      let cautionPopupHtml = '';
      if (isCautionNeeded){
        cautionIconHtml = `<span class="caution-icon" id="caution-icon-${index}" onclick="event.stopPropagation(); toggleCautionPopup(${index})">i</span>`;
        cautionPopupHtml = `<div id="caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${drug.caution}</div>`;
      }

      // dose info & limit warning
      let doseInfoHtml = `<div class="dose-info">Dose Range: ${drug.range}</div>`;
      if (doseAdjusted){
        doseInfoHtml = `<div class="dose-info dose-limit-applied">Dose reduced to ${dosePerKg} ${drug.unit} for <10 kg weight.</div>`;
      }
      let limitInfoHtml = '';
      if (limitApplied) {
        limitInfoHtml = `<span class="dose-limit-applied">${dose === drug.maxDose ? '(MAX Limit Applied)' : '(MIN Limit Applied)'}</span>`;
      }

      // custom dose warning
      let customDoseWarning = '';
      if (drug.isCustomDoseHigh){
        customDoseWarning = `
          <div class="dose-limit-applied" style="color: var(--reversal); font-weight:700; border:1px solid var(--reversal); display:block; padding:5px; border-radius:5px; margin-bottom:10px; background-color:var(--bg-card);">
            ⚠️ Custom Dose (${drug.defaultDose} ${drug.unit}) is **ABOVE** recommended range for the **current route**.
          </div>
        `;
      }

      // expanded / active classes
      const isExpandedClass = (allExpanded || index === activeEditIndex) ? 'expanded' : '';
      const isActiveEditClass = (index === activeEditIndex) ? 'active' : '';

      // MODIFIED: Route Selector HTML
      let routeSelectorHTML = '';
      const routes = [];
      if (drug.defaultDose !== undefined) routes.push('IV');
      if (drug.imDose !== undefined) routes.push('IM');
      if (drug.oralDose !== undefined) routes.push('Oral');

      if (routes.length > 1) {
        routeSelectorHTML = '<div class="route-selector">';
        routes.forEach(route => {
          const checked = drug.currentRoute === route ? 'checked' : '';
          const routeName = route === 'IM' ? 'Intramuscular (IM)' : route === 'Oral' ? 'Oral' : 'Intravenous (IV)';
          routeSelectorHTML += `
            <input type="radio" id="route-${index}-${route}" name="route-${index}" value="${route}" ${checked} 
                   onclick="event.stopPropagation(); selectRoute(${index}, '${route}')">
            <label for="route-${index}-${route}">${routeName}</label>
          `;
        });
        routeSelectorHTML += '</div>';
      }

      // Calculation/Volume Display (adjusted for Oral route)
      const volumeDetail = isInjectable ? 
          `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` :
          `<div class="volume-result" style="font-style:normal;">Concentration/Volume Not Applicable for Oral Dose</div>`;
          
      // Edit Inputs (adjusted for Oral route)
      const concentrationEdit = isInjectable ?
        `<input type="number" step="0.1" placeholder="Concentration (${drug.concentrationUnit})" id="conc-${index}" value="${drug.concentration}" onchange="updateDrug(${index})">` :
        `<input type="number" step="0.1" placeholder="Concentration (${drug.concentrationUnit})" id="conc-${index}" value="${drug.concentration}" onchange="updateDrug(${index})" disabled title="Concentration edit is disabled for the selected route.">`;

      // assemble card HTML
      html += `
        <div class="drug-card ${drug.category} ${isExpandedClass}" id="drug-card-${index}">
          ${cautionPopupHtml}
          <div class="drug-header" onclick="toggleDrugCard(${index})">
            <div class="drug-name">
              <span class="toggle-icon">▶</span>
              ${drug.name}
              <span style="font-size:0.7em; margin-left:10px; color:var(--text-secondary); font-weight:400;">(${drug.currentRoute} Dose)</span>
            </div>
            <div class="drug-category ${drug.category}">${drug.categoryLabel}</div>
            ${cautionIconHtml}
          </div>

          <div class="drug-details" id="drug-details-${index}">
            <div class="drug-info">
              ${routeSelectorHTML}
              ${customDoseWarning}
              ${doseInfoHtml}
              <div class="calculation">
                <div class="calculation-result">${doseDisplay} ${totalDoseUnit} ${limitInfoHtml}</div>
                ${volumeDetail}
                <div class="dose-info">Calculated: ${dosePerKg.toFixed(2)} ${drug.unit}</div>
              </div>

              <button class="edit-btn" onclick="event.stopPropagation(); toggleEdit(${index})">Edit Dose/Dilution</button>
              <div class="edit-inputs ${isActiveEditClass}" id="edit-${index}">
                <input type="number" step="0.01" placeholder="Dose per kg (${drug.unit} - ${drug.currentRoute})" id="dose-${index}" value="${dosePerKg}" onchange="updateDrug(${index})">
                ${concentrationEdit}
              </div>

            </div>
          </div>
        </div>
      `;
    });

    drugResultsDiv.innerHTML = html;
    activeEditIndex = null;
    document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  /* -------------------------
     Toggle handlers for cards, all-expand, edit panel
     ------------------------- */
  function toggleDrugCard(index){
    const card = document.getElementById(`drug-card-${index}`);
    if (!card) return;
    card.classList.toggle('expanded');
  }

  function toggleAllDrugs(){
    allExpanded = !allExpanded;
    const cards = document.querySelectorAll('.drug-card');
    const button = document.getElementById('toggleAllBtn');
    cards.forEach(card=>{
      if (allExpanded) {
        card.classList.add('expanded');
        const editInputs = card.querySelector('.edit-inputs');
        if (editInputs && editInputs.classList.contains('active')) editInputs.classList.add('active');
      } else {
        card.classList.remove('expanded');
        const editInputs = card.querySelector('.edit-inputs');
        if (editInputs) editInputs.classList.remove('active');
      }
    });
    button.textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  function toggleEdit(index){
    const editDiv = document.getElementById(`edit-${index}`);
    if (!editDiv) return;
    editDiv.classList.toggle('active');
    if (editDiv.classList.contains('active')){
      document.getElementById(`drug-card-${index}`).classList.add('expanded');
    }
  }

  /* -------------------------
     Update drug from edit inputs (MODIFIED)
     - The logic remains mostly the same, but it's important to note
       that `drug.defaultDose` is now used to store the **current route's**
       per-kg dose for calculation.
     ------------------------- */
  function updateDrug(index){
    const drug = drugs[index];
    const doseInput = document.getElementById(`dose-${index}`);
    const concInput = document.getElementById(`conc-${index}`);
    const newDose = parseFloat(doseInput.value);
    const newConc = parseFloat(concInput.value);

    // Parse max dose for the current route from the drug's range string
    const maxDose = parseMaxDoseFromRange(drug.range.split(drug.currentRoute)[0]); // Simple heuristic, better to have route-specific range properties.
    
    drug.isCustomDoseHigh = false;

    if (!isNaN(newDose) && newDose > 0){
      // IMPORTANT: defaultDose now holds the *current* per-kg dose, regardless of route.
      drug.defaultDose = newDose; 
      // Simplified check for custom dose high warning based on the general max in range
      if (maxDose !== null && newDose > maxDose) drug.isCustomDoseHigh = true;
    }
    
    // Only update concentration if injectable
    if (drug.currentRoute !== 'Oral' && !isNaN(newConc) && newConc > 0) drug.concentration = newConc;

    // keep this card open/active after rerender
    activeEditIndex = index;
    calculateDrugs();

    // Restore focus with a slight delay
    setTimeout(()=>{
      const updatedDoseInput = document.getElementById(`dose-${index}`);
      if (updatedDoseInput) updatedDoseInput.focus();
    },50);
  }

  /* -------------------------
     Caution popup logic
     ------------------------- */
  function toggleCautionPopup(index){
    const card = document.getElementById(`drug-card-${index}`);
    const popup = document.getElementById(`caution-popup-${index}`);

    // close other popups and remove their caution-active class
    document.querySelectorAll('.caution-popup').forEach(p=>{
      if (p.id !== (popup && popup.id)){
        p.style.display = 'none';
        const parentCard = p.closest('.drug-card');
        if (parentCard) parentCard.classList.remove('caution-active');
      }
    });

    if (!popup) return;
    if (popup.style.display === 'block'){
      popup.style.display = 'none';
      if (card) card.classList.remove('caution-active');
    } else {
      popup.style.display = 'block';
      if (card) card.classList.add('caution-active');
    }
  }

  // hide popups when clicking outside
  document.addEventListener('click', (e)=>{
    let clickedInsidePopup = false;
    let current = e.target;
    while(current){
      if (current.classList && (current.classList.contains('caution-popup') || current.classList.contains('caution-icon'))){
        clickedInsidePopup = true; break;
      }
      current = current.parentElement;
    }

    if (!clickedInsidePopup){
      document.querySelectorAll('.caution-popup').forEach(p=>p.style.display='none');
      document.querySelectorAll('.drug-card.caution-active').forEach(card=>card.classList.remove('caution-active'));
    }
  });

  /* -------------------------
     Top-level recalculation entrypoint
     ------------------------- */
  function calculateAll(){
    calculateEquipment();
    calculateFluids();
    calculateDrugs();
  }

  /* -------------------------
     Dark mode toggle (persists in localStorage)
     ------------------------- */
  function toggleDarkMode(){
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.dark-mode-toggle').textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
  }

  /* -------------------------
     Initial load: restore dark mode and render
     ------------------------- */
  window.onload = function(){
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode){
      document.body.classList.add('dark-mode');
      document.querySelector('.dark-mode-toggle').textContent = '☀️ Light Mode';
    }
    calculateAll();
  };
  </script>
</body>
</html>
