<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pediatric Anesthesia Calculator</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Category pill styles with colored background */
    .drug-category {
      font-size: 0.7em;
      padding: 4px 10px;
      border-radius: 20px;
      color: #000;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background-color: var(--border-color);
    }

    /* Each category color background */
    .drug-category.induction { background-color: var(--induction); }
    .drug-category.muscle-relaxant { background-color: var(--muscle-relaxant); color: #fff; }
    .drug-category.analgesic { background-color: var(--analgesic); color: #fff; }
    .drug-category.adjunct { background-color: var(--adjunct); color: #fff; }
    .drug-category.reversal { background-color: var(--reversal); color: #fff; }
    .drug-category.emergency { background-color: var(--emergency); color: #000; }
    .drug-category.steroid { background-color: var(--steroid); color: #fff; }
    .drug-category.antiemetic { background-color: var(--antiemetic); color: #000; }
    .drug-category.local-anesthetic { background-color: var(--local-anesthetic); color: #fff; }
    
    :root{
      --bg-primary:#ffffff;
      --bg-secondary:#fff8e1;
      --bg-card:#ffffff;
      --text-primary:#121212;
      --text-secondary:#546e7a;
      --text-tertiary:#b0bec5;
      --border-color:#e1f5fe;
      --shadow:0 8px 20px rgba(0,0,0,0.1);
      --shadow-hover:0 10px 25px rgba(0,0,0,0.15);

      --induction:#34ebb4;
      --muscle-relaxant:#ff6d00;
      --analgesic:#00c853;
      --adjunct:#d500f9;
      --reversal:#ff1744;
      --emergency:#ffc400;
      --steroid:#3f51b5;
      --antiemetic:#8bc34a;
      --local-anesthetic:#9c27b0;
      --primary-accent:#0089f0;
      --caution-color:#ffeb3b;

      --radius-card:16px;
      --radius-input:10px;
    }

    body.dark-mode{
      --bg-primary:#000000;
      --bg-secondary:#111111;
      --bg-card:#222222;
      --text-primary:#f5f5f5;
      --text-secondary:#bbbbbb;
      --border-color:#4a4a4a;
      --shadow:0 8px 20px rgba(0,0,0,0.6);
      --shadow-hover:0 10px 25px rgba(0,0,0,0.8);
      --emergency:#ffeb3b;
      --caution-color:#fbc02d;
    }

    /* Reset & base */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      font-family:'Montserrat',sans-serif;
      background:var(--bg-secondary);
      color:var(--text-primary);
      line-height:1.5;
      font-size:0.9rem; /* Slightly reduced for mobile */
      transition:background-color .4s,color .4s;
      user-select:none; /* make app text unselectable except inputs */
      -webkit-font-smoothing:antialiased;
    }
    input,textarea{user-select:text!important}

    .container{max-width:1200px;margin:0 auto;padding:15px 10px}

    /* Header */
    header{
      background:var(--primary-accent);
      color:var(--bg-primary);
      padding:15px;
      border-radius:var(--radius-card);
      box-shadow:var(--shadow);
      margin-bottom:15px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap: wrap;
      gap: 10px;
    }
    h1{font-size:1.6em;font-weight:700}
    .dark-mode-toggle{
      background:var(--bg-primary);
      color:var(--primary-accent);
      border:none;border-radius:50px;padding:8px 16px;
      cursor:pointer;font-size:.75em;font-weight:600;
      box-shadow:0 2px 5px rgba(0,0,0,.2);transition:all .18s ease;
      -webkit-tap-highlight-color:transparent;
      outline:none;
    }
    .dark-mode-toggle:active{transform:translateY(1px)}
    .dark-mode-toggle::-moz-focus-inner{border:0}

    /* Sections */
    .section,.patient-info{
      background:var(--bg-card);
      padding:15px;border-radius:var(--radius-card);
      box-shadow:var(--shadow);margin-bottom:15px;transition:box-shadow .3s ease;
    }
    .section h2{
      font-size:1.3em;font-weight:600;margin-bottom:12px;color:var(--text-primary);
      border-bottom:2px solid var(--border-color);padding-bottom:6px;
    }

    /* Info boxes */
    .info-box {
      background: var(--bg-secondary);
      border-left: 4px solid var(--primary-accent);
      padding: 12px 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-size: 0.85em;
      color: var(--text-secondary);
    }
    .info-box strong {
      color: var(--primary-accent);
    }
    /* Specific styling for the generated Ketorolac info box */
    .info-box.ketorolac-specific {
      border-left-color: var(--analgesic);
      margin-top: 5px;
      margin-bottom: 5px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.8em;
      padding: 8px 10px;
    }


    /* Inputs */
    .input-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:10px}
    .age-input-group{display:flex;gap:8px}
    .input-field label{font-size:.8em;color:var(--text-secondary);margin-bottom:5px;font-weight:600;display:block}
    .input-field input{
      width:100%;padding:8px 10px;border:1px solid var(--border-color);
      border-radius:var(--radius-input);font-size:.9em;background:var(--bg-primary);
      color:var(--text-primary);transition:border-color .3s,box-shadow .3s;
    }
    .input-field input:focus{outline:none;border-color:var(--primary-accent);box-shadow:0 0 0 3px rgba(0,137,240,.2)}

    /* Grid containers */
    .drugs-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
    .equipment-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-top:10px}

    /* Drug card */
    .drug-card{
      border-radius:var(--radius-card);padding:12px;border-left:6px solid;background:var(--bg-secondary);
      transition:all .35s cubic-bezier(.25,.8,.25,1);position:relative;z-index:1;
      will-change:transform,box-shadow,background-color;
    }
    .drug-card.caution-active{z-index:20;border-left-color:var(--caution-color)!important;box-shadow:0 0 10px var(--caution-color);}
    .drug-card:hover{box-shadow:var(--shadow-hover);transform:translateY(-1px);background:var(--bg-card)}

    /* left border category colors */
    .drug-card.induction{border-left-color:var(--induction)}
    .drug-card.muscle-relaxant{border-left-color:var(--muscle-relaxant)}
    .drug-card.analgesic{border-left-color:var(--analgesic)}
    .drug-card.adjunct{border-left-color:var(--adjunct)}
    .drug-card.reversal{border-left-color:var(--reversal)}
    .drug-card.emergency{border-left-color:var(--emergency)}
    .drug-card.steroid{border-left-color:var(--steroid)}
    .drug-card.antiemetic{border-left-color:var(--antiemetic)}
    .drug-card.local-anesthetic{border-left-color:var(--local-anesthetic)}

    .drug-header{
      display:flex;justify-content:space-between;align-items:flex-start;cursor:pointer;
      -webkit-tap-highlight-color:transparent;user-select:none;flex-direction:column;gap:5px;
    }
    .drug-card.expanded .drug-header{padding-bottom:8px}
    .drug-name{font-weight:700;font-size:1.1em;color:var(--text-primary);display:flex;align-items:center}
    .toggle-icon{font-size:1em;margin-right:6px;transform:rotate(0deg);
      transition:transform 350ms cubic-bezier(.175,.885,.32,1.275);will-change:transform}
    .drug-card.expanded .toggle-icon{transform:rotate(90deg)}

    .drug-details{
      max-height:0;overflow:hidden;opacity:0;padding-top:0;transform:translateY(-6px);
      transition:max-height 420ms cubic-bezier(.22,1,.36,1),opacity 260ms ease-in-out,transform 420ms cubic-bezier(.22,1,.36,1),padding-top 420ms cubic-bezier(.22,1,.36,1);
      will-change:max-height,opacity,transform,padding-top;
    }
    .drug-card.expanded .drug-details{max-height:520px;opacity:1;padding-top:12px;transform:translateY(0)}

    .drug-category{font-size:.65em;padding:4px 8px;border-radius:20px;color:var(--bg-primary);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .drug-category.induction,.drug-category.emergency{color:#000}

    .dose-info{font-size:.75em;color:var(--text-secondary);font-style:italic;margin-top:4px}

    /* Caution icon & popup */
    .caution-icon{
      display:inline-block;width:16px;height:16px;line-height:16px;text-align:center;border-radius:50%;
      background-color:var(--caution-color);color:#000;font-weight:bold;font-size:.65em;cursor:pointer;margin-left:8px;flex-shrink:0;align-self:flex-start;
      -webkit-tap-highlight-color:transparent;
    }
    .caution-popup{
      display:none;position:absolute;z-index:30;padding:8px;background:var(--bg-primary);color:var(--text-primary);
      border:1px solid var(--caution-color);border-radius:5px;box-shadow:var(--shadow-hover);width:220px;font-size:.7em;top:12px;right:12px;white-space:normal;
    }
    .dose-limit-applied{font-size:.7em;color:var(--reversal);font-weight:600;display:block;margin-top:2px}

    /* Calculations & edit UI */
    .calculation{background:var(--bg-card);padding:10px;border-radius:var(--radius-input);margin-top:8px;border:1px solid var(--border-color)}
    .calculation-result{font-weight:800;font-size:1.2em;color:var(--reversal)}
    .volume-result{font-size:.8em;color:var(--text-secondary);margin-top:3px;font-weight:500}

    .edit-btn{
      background:transparent;border:1px solid var(--primary-accent);padding:5px 12px;border-radius:50px;font-size:.75em;cursor:pointer;color:var(--primary-accent);
      margin-top:8px;transition:all .3s ease;font-weight:600;max-width:fit-content;
    }
    .edit-btn:hover{background:var(--primary-accent);color:var(--bg-primary);box-shadow:0 4px 10px rgba(0,137,240,.3)}

    .edit-inputs{display:none;margin-top:8px;padding:8px;background:var(--bg-secondary);border-radius:var(--radius-input);border:1px dashed var(--text-tertiary);flex-direction:column;gap:8px}
    .edit-inputs.active{display:flex}

    /* Route Selector styles */
    .route-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--border-color);
      flex-wrap: wrap;
    }
    .route-selector label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.75em;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 50px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }
    .route-selector input[type="radio"] {
      /* Hide the actual radio button */
      display: none;
    }
    .route-selector input[type="radio"]:checked + label {
      background: var(--primary-accent);
      color: var(--bg-primary);
      border-color: var(--primary-accent);
    }

    /* Equipment cards */
    .equipment-card{background:var(--bg-secondary);padding:12px;border-radius:var(--radius-card);text-align:center;border-top:4px solid var(--primary-accent);transition:all .3s ease}
    .equipment-title{font-size:.85em;color:var(--text-secondary);margin-bottom:6px;font-weight:600}
    .equipment-value{font-size:1.4em;font-weight:800;color:var(--primary-accent);line-height:1.1}
    .equipment-value.error{color:var(--reversal);font-size:.85em;font-weight:600;line-height:1.3}
    .equipment-detail{font-size:.7em;color:var(--text-secondary);margin-top:4px}

    /* Warning box */
    .warning{background:#fff3cd;border-left:5px solid #ffc107;padding:12px;margin:15px 0;border-radius:8px;font-size:.85em;color:#856404;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    body.dark-mode .warning{background:#4a3f00;color:#ffeb3b;border-left:5px solid #ff9800}

    .expand-all-btn{margin-top:5px;margin-bottom:12px;display:block;width:100%;max-width:350px;text-align:center}

    /* Local Anesthetic Result Row styles - New for conciseness */
    .la-results-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .la-result-row {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dotted var(--border-color);
    }
    .la-result-row:last-child {
      border-bottom: none;
    }
    .la-name {
      font-weight: 600;
      font-size: 0.95em;
      color: var(--text-primary);
    }
    .la-max-dose {
      font-weight: 800;
      font-size: 1.1em;
      color: var(--reversal);
      text-align: right;
    }
    .la-detail {
      display: block;
      font-weight: 500;
      font-size: 0.7em;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    /* Responsive */
    @media(min-width:768px){
      .container{padding:20px 15px}
      .drugs-grid{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}
      .equipment-grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
      h1{font-size:2em}
      .section h2{font-size:1.5em}
      .drug-name{font-size:1.2em}
      .drug-header{flex-direction:row;align-items:center}
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Pediatric Anesthesia Calculator</h1>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">🌙 Dark Mode</button>
    </header>

    <div class="warning">
      ⚠️ This calculator is for reference only. Always verify calculations and use clinical judgment. Dosages may need adjustment based on patient condition and local protocols.
    </div>

    <section class="patient-info">
      <h2>Patient Information</h2>
      <div class="input-group">
        <div class="input-field">
          <label for="age-years">Age</label>
          <div class="age-input-group">
            <input type="number" id="age-years" placeholder="Years (max 18)" step="1" min="0" max="18" oninput="clampAgeAndCalculate()">
            <input type="number" id="age-months" placeholder="Months (0-11)" step="1" min="0" max="11" oninput="clampAgeAndCalculate()">
          </div>
        </div>

        <div class="input-field">
          <label for="weight">Weight (kg)</label>
          <input type="number" id="weight" placeholder="Enter weight" step="0.1" min="0" oninput="calculateAll()">
        </div>

        <div class="input-field">
          <label for="currentHb">Current Hb (g/dL)</label>
          <input type="number" id="currentHb" placeholder="e.g., 12.0" step="0.1" min="0" oninput="calculateAll()">
        </div>

        <div class="input-field">
          <label for="targetHb">Target Hb (g/dL)</label>
          <input type="number" id="targetHb" placeholder="e.g., 8.0" step="0.1" min="0" oninput="calculateAll()">
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Airway Equipment Sizing</h2>
      <div id="equipment-results" class="equipment-grid"></div>
    </section>

    <section class="section">
      <h2>Fluid & Blood Loss Requirements</h2>
      <div id="fluid-results" class="equipment-grid"></div>
    </section>

    <section class="section">
      <h2>Local Anesthetics - Maximum Doses</h2>
      <div class="info-box">
        <strong>Note:</strong> These are maximum recommended doses. Always use the lowest effective dose and consider patient factors.
      </div>
      <div id="local-anesthetics-results" class="drugs-grid"></div>
    </section>

    <section class="section">
      <h2>Drug Calculations</h2>
      <div class="info-box">
        <strong>Route Selection:</strong> Some drugs can be administered via different routes. Select the appropriate route for your clinical scenario.
      </div>
      <button class="expand-all-btn edit-btn" id="toggleAllBtn" onclick="toggleAllDrugs()">Expand All / Collapse All</button>
      <div id="drug-results" class="drugs-grid"></div>
    </section>
  </div>

  <p style="text-align:center;margin-top:20px;font-size:0.8em;color:grey;">
    <a href="https://t.me/utopiccc">Ⓡ︎2025 Dr. Kiranraj</a>
  </p>

  <script>
  /* -------------------------
     Enhanced Drug Data Array with route options
     ------------------------- */
  const drugs = [
    // Induction Agents
    { name:'Propofol', category:'induction', categoryLabel:'Induction Agent', defaultDose:2.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'2-3 mg/kg', defaultRoute:'IV' },
    { name:'Thiopentone', category:'induction', categoryLabel:'Induction Agent', defaultDose:5, unit:'mg/kg', concentration:25, concentrationUnit:'mg/mL', useParam:'weight', range:'4-6 mg/kg', defaultRoute:'IV' },
    { name:'Ketamine', category:'induction', categoryLabel:'Induction Agent', defaultDose:2, imDose:4, oralDose:6, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 4-6 mg/kg IM, 6-10 mg/kg Oral', defaultRoute:'IV' },
    { name:'Etomidate', category:'induction', categoryLabel:'Induction Agent', defaultDose:0.3, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2-0.3 mg/kg', caution:'Avoid in sepsis or adrenal suppression risk.', defaultRoute:'IV' },

    // Muscle Relaxants
    { name:'Vecuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.08-0.1 mg/kg', defaultRoute:'IV' },
    { name:'Rocuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.6, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.6-1.2 mg/kg', defaultRoute:'IV' },
    { name:'Atracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.4-0.5 mg/kg', defaultRoute:'IV' },
    { name:'Cisatracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg', defaultRoute:'IV' },
    { name:'Succinylcholine', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:1.5, imDose:3, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 3-4 mg/kg IM', caution:'FDA Black Box Warning: Reserved for emergent use in children (<50kg) due to risk of hyperkalemia/cardiac arrest in undiagnosed myopathies.', defaultRoute:'IV' },

    // Analgesics
    { name:'Fentanyl', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:2, unit:'mcg/kg', concentration:50, concentrationUnit:'mcg/mL', useParam:'weight', range:'1-3 mcg/kg', defaultRoute:'IV' },
    { name:'Morphine', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg', defaultRoute:'IV' },
    { name:'Tramadol', category:'analgesic', categoryLabel:'Analgesic', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Paracetamol (IV)', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, caution:'Dose must be reduced to 7.5 mg/kg for patients <10 kg. Risk of hepatotoxicity in small infants/neonates.', defaultRoute:'IV' },
    { name:'Paracetamol (Oral)', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:24, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, defaultRoute:'Oral' },

    // *** KETOROLAC ENTRY ***
    { 
        name:'Ketorolac', 
        category:'analgesic', 
        categoryLabel:'NSAID Analgesic', 
        defaultDose:0.5, // Placeholder for IV/IM up to 16 yo
        oralDose:1.0,  // Placeholder for Oral up to 16 yo
        unit:'mg/kg', 
        concentration:30, // 30 mg/mL commonly
        concentrationUnit:'mg/mL', 
        useParam:'weight', 
        range:'Dose varies significantly by Age/Weight/Route (See Info)', 
        defaultRoute:'IV' 
    },
    // *** END KETOROLAC ENTRY ***

    // Adjuncts/Sedatives
    { name:'Midazolam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.5, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg IV, 0.5-1 mg/kg Oral', caution:'Reduced dose or slow titration recommended for infants <10 kg due to prolonged effect/lower clearance.', defaultRoute:'IV' },
    { name:'Diazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.2, oralDose:0.3, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.3 mg/kg IV, 0.2-0.5 mg/kg Oral', caution:'Max 10mg. Slow IV. Not recommended for neonates.', defaultRoute:'IV' },
    { name:'Lorazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.05, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.1 mg/kg IV, 0.05 mg/kg Oral', caution:'Max 4mg/dose. Slow IV.', defaultRoute:'IV' },
    { name:'Lidocaine (Xylocard)', category:'adjunct', categoryLabel:'Local Anesthetic', defaultDose:1.5, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-1.5 mg/kg IV', caution:'Strict total dose of 5 mg/kg. Higher risk of systemic toxicity in neonates/infants <10 kg.', defaultRoute:'IV' },

    // Reversal Agents
    { name:'Neostigmine', category:'reversal', categoryLabel:'Muscle Relaxant Reversal', defaultDose:0.05, unit:'mg/kg', concentration:0.5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.04-0.08 mg/kg (max 5mg)', maxDose:5, defaultRoute:'IV' },
    { name:'Glycopyrrolate', category:'reversal', categoryLabel:'Anticholinergic', defaultDose:0.01, unit:'mg/kg', concentration:0.2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.008-0.01 mg/kg', defaultRoute:'IV' },
    { name:'Sugammadex', category:'reversal', categoryLabel:'Rocuronium Reversal', defaultDose:2, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'2-4 mg/kg (routine reversal)', defaultRoute:'IV' },
    { name:'Naloxone', category:'reversal', categoryLabel:'Opioid Reversal', defaultDose:0.004, unit:'mg/kg', concentration:0.4, concentrationUnit:'mg/mL', useParam:'weight', range:'4 mcg/kg (titrate)', defaultRoute:'IV' },
    { name:'Flumazenil', category:'reversal', categoryLabel:'Benzodiazepine Reversal', defaultDose:0.01, unit:'mg/kg', concentration:0.1, concentrationUnit:'mg/mL', useParam:'weight', range:'10 mcg/kg (titrate, max 200mcg)', maxDose:0.2, defaultRoute:'IV' },

    // Emergency Drugs
    { name:'Adrenaline (Epinephrine) Arrest', category:'emergency', categoryLabel:'Cardiac Arrest', defaultDose:10, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'10 mcg/kg IV (1:10,000)', defaultRoute:'IV' },
    { name:'Adrenaline (Epinephrine) Anaphylaxis', category:'emergency', categoryLabel:'Anaphylaxis (IV)', defaultDose:1, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'1 mcg/kg (1:10,000)', defaultRoute:'IV' },
    { name:'Atropine', category:'emergency', categoryLabel:'Bradycardia', defaultDose:0.02, unit:'mg/kg', concentration:0.6, concentrationUnit:'mg/mL', useParam:'weight', range:'20 mcg/kg (min 100mcg, max 600mcg)', minDose:0.1, maxDose:0.6, defaultRoute:'IV' },
    { name:'Lignocaine (Anti-Arrhythmic)', category:'emergency', categoryLabel:'Anti-Arrhythmic', defaultDose:1, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.5-1 mg/kg', defaultRoute:'IV' },
    { name:'Magnesium Sulphate', category:'emergency', categoryLabel:'Asthma/Torsades', defaultDose:50, unit:'mg/kg', concentration:500, concentrationUnit:'mg/mL', useParam:'weight', range:'25-50 mg/kg', caution:'Infuse over 10-20 minutes.', defaultRoute:'IV' },
    { name:'Adenosine 1st Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.1, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1 mg/kg (max 6mg)', maxDose:6, defaultRoute:'IV' },
    { name:'Adenosine 2nd Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.2, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2 mg/kg (max 12mg)', maxDose:12, defaultRoute:'IV' },
    { name:'Phenylephrine', category:'emergency', categoryLabel:'Vasopressor', defaultDose:10, unit:'mcg/kg', concentration:100, concentrationUnit:'mcg/mL', useParam:'weight', range:'5-20 mcg/kg', caution:'Total dose: 50-100 mcg. Use for acute hypotension.', defaultRoute:'IV' },

    // Steroids & Antiemetics
    { name:'Dexamethasone', category:'steroid', categoryLabel:'Steroid', defaultDose:0.15, unit:'mg/kg', concentration:4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Hydrocortisone', category:'steroid', categoryLabel:'Steroid', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Ondansetron', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.15 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Metoclopramide', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.15, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 10mg)', maxDose:10, defaultRoute:'IV' }
  ];

  // Local anesthetics data
  const localAnesthetics = [
    { name: 'Lignocaine (Plain)', maxDose: 3, unit: 'mg/kg', caution: 'Without epinephrine' },
    { name: 'Lignocaine (With Epinephrine)', maxDose: 7, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
    { name: 'Bupivacaine (Plain)', maxDose: 2, unit: 'mg/kg', caution: 'Without epinephrine' },
    { name: 'Bupivacaine (With Epinephrine)', maxDose: 3, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
    { name: 'Ropivacaine', maxDose: 3, unit: 'mg/kg', caution: 'Maximum recommended dose' }
  ];

  // Initialize currentRoute for each drug on load
  drugs.forEach(drug => {
    // For Ketorolac, we define its possible routes here
    if (drug.name === 'Ketorolac') {
        drug.routes = ['IV', 'IM', 'Oral'];
        drug.defaultRoute = 'IV';
    } else {
        drug.routes = drug.defaultRoute ? [drug.defaultRoute] : ['IV']; // Keep original logic for others
        if (drug.imDose !== undefined) drug.routes.push('IM');
        if (drug.oralDose !== undefined) drug.routes.push('Oral');
    }
    drug.currentRoute = drug.defaultRoute;
  });

  /* dynamic dilution tiers used when calculated volume < 1 mL */
  const dilutionTiers = {
    'Fentanyl': [50,10,5],      // mcg/mL
    'Atropine': [0.6,0.1],      // mg/mL
    'Glycopyrrolate': [0.2,0.04],
    'Ondansetron': [2,1],
    'Vecuronium': [1,0.5],
    'Atracurium': [10,5,2.5],
    'Cisatracurium': [2,1,0.5],
    'Adrenaline (Epinephrine) Anaphylaxis': [10,5]
  };

  /* -------------------------
     UI state variables
     ------------------------- */
  let allExpanded = false;
  let activeEditIndex = null; // keep an edited card open after recalculation

  /* -------------------------
     Helper: read & cache patient data
     ------------------------- */
  function getPatientData(){
    // Read clamped inputs (clamping happens elsewhere)
    const years = parseFloat(document.getElementById('age-years').value) || 0;
    const months = parseFloat(document.getElementById('age-months').value) || 0;
    const totalAge = years + (months/12);
    return {
      age: totalAge,
      ageYears: years,
      ageMonths: months,
      weight: parseFloat(document.getElementById('weight').value) || 0,
      currentHb: parseFloat(document.getElementById('currentHb').value) || 0,
      targetHb: parseFloat(document.getElementById('targetHb').value) || 0
    };
  }

  /* -------------------------
     Age clamping (Years: 0-18, Months: 0-11)
     and trigger recalculation
     ------------------------- */
  function clampAgeAndCalculate(){
    const ageYearsInput = document.getElementById('age-years');
    const ageMonthsInput = document.getElementById('age-months');

    let years = parseFloat(ageYearsInput.value);
    let months = parseFloat(ageMonthsInput.value);

    if (!isNaN(years)){
      if (years < 0) years = 0;
      if (years > 18) years = 18;
      ageYearsInput.value = years;
    } else if (ageYearsInput.value) {
      ageYearsInput.value = '';
    }

    if (!isNaN(months)){
      if (months < 0) months = 0;
      if (months > 11) months = 11;
      if (years === 18) months = 0; // if 18 years then months must be zero
      ageMonthsInput.value = months;
    } else if (ageMonthsInput.value) {
      ageMonthsInput.value = '';
    }

    calculateAll();
  }

  /* -------------------------
     Helper to get the correct dose based on route (Only used for non-ketorolac drugs now)
     ------------------------- */
  function getDoseByRoute(drug){
    let dose;
    switch (drug.currentRoute) {
      case 'IM':
        dose = drug.imDose !== undefined ? drug.imDose : drug.defaultDose;
        break;
      case 'Oral':
        dose = drug.oralDose !== undefined ? drug.oralDose : drug.defaultDose;
        break;
      case 'IV':
      default:
        dose = drug.defaultDose;
        break;
    }
    return dose;
  }

  // Store a copy of initial drug data to reset doses when switching back to IV
  const initialDrugs = JSON.parse(JSON.stringify(drugs.map(d => ({
      name: d.name, 
      defaultDose: d.defaultDose,
      imDose: d.imDose,
      oralDose: d.oralDose
  }))));


  /* -------------------------
     Route selector logic
     - updates drug.currentRoute and forces recalculation
     ------------------------- */
  function selectRoute(index, route) {
    const drug = drugs[index];
    if (drug) {
      drug.currentRoute = route;
      
      // Reset custom dose for non-Ketorolac when route changes
      if (drug.name !== 'Ketorolac') {
          if (route === 'IM' && drug.imDose !== undefined) {
              drug.defaultDose = drug.imDose;
              drug.isCustomDoseHigh = false;
          } else if (route === 'Oral' && drug.oralDose !== undefined) {
              drug.defaultDose = drug.oralDose;
              drug.isCustomDoseHigh = false;
          } else { // IV
              const initialDrugData = initialDrugs.find(d => d.name === drug.name);
              if (initialDrugData) {
                  drug.defaultDose = initialDrugData.defaultDose;
                  drug.isCustomDoseHigh = false;
              }
          }
      } else {
        // For Ketorolac, we always use the calculated dose (0.5/1.0 mg/kg etc.) 
        // to pre-populate the edit box, but the main calculation logic is in calculateKetorolacDoseAndInfo
        const patient = getPatientData();
        const { dosePerKg } = calculateKetorolacDoseAndInfo(patient, drug);
        if (dosePerKg) {
            drug.defaultDose = dosePerKg;
        }
      }

      activeEditIndex = index; // Keep the card open
      calculateDrugs();
    }
  }

  /* -------------------------
     Ketorolac Specific Calculation Logic
     - Handles all age/weight/route tiers
     ------------------------- */
  function calculateKetorolacDoseAndInfo(patient, drug) {
    const age = patient.age;
    const weight = patient.weight;
    const route = drug.currentRoute;
    let dosePerKg = 0;
    let totalDose = 0; // Single dose in mg, used for volume calculation for injectables
    let maxDosePerDose = 0;
    let maxDailyDose = 0;
    let duration = '';
    let doseInfo = '';
    let specialNote = '';
    let doseUnit = 'mg';
    let displayDoseString = ''; // The final string for the red box

    if (route === 'IV' || route === 'IM') {
      doseUnit = 'mg/dose';
    } else if (route === 'Oral') {
      doseUnit = 'mg/dose';
    }


    if (age < 2.0) { // Infants and Children <2 years
      // IV/IM (IM has been described >=6 months)
      if (route === 'IV' || route === 'IM') {
        dosePerKg = 0.5; // Use 0.5 mg/kg for calculation as default
        totalDose = weight * dosePerKg;
        maxDosePerDose = 15;
        totalDose = Math.min(totalDose, maxDosePerDose);
        
        displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;

        doseInfo = `Recommended: 0.5 mg/kg/dose Q6-8H (Range: 0.25-0.5 mg/kg/dose). Max ${maxDosePerDose} mg/dose.`;
        duration = 'Limited to 48-72 hours.';
        if (route === 'IM' && age < 0.5) { // <6 months
            doseInfo = `IM use described in patients ≥6 months of age. Recommended IV: 0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose.`;
        }

      } else if (route === 'Oral') {
        doseInfo = 'Oral use is not recommended in this age group (<2 years).';
        totalDose = 'Not Recommended';
        displayDoseString = 'Not Recommended';
      }

    } else if (age >= 2.0 && age < 17.0) { // Children >=2 years and Adolescents <=16 years
      // IM, IV
      if (route === 'IM' || route === 'IV') {
        dosePerKg = 0.5;
        totalDose = weight * dosePerKg;
        maxDosePerDose = 30;
        totalDose = Math.min(totalDose, maxDosePerDose);
        
        displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;
        
        doseInfo = `0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose. Max duration: 5 days.`;
        duration = 'Max duration: 5 days.';
      } 
      // Oral
      else if (route === 'Oral') {
        dosePerKg = 1.0;
        totalDose = weight * dosePerKg;
        maxDosePerDose = 10;
        maxDailyDose = 40;
        totalDose = Math.min(totalDose, maxDosePerDose); // Total dose is 10mg (single dose)
        
        // **FIX:** Display regimen/Max Daily Dose as requested by user
        const minDosesPerDay = Math.ceil(maxDailyDose / maxDosePerDose); // 40/10 = 4 doses
        displayDoseString = `${maxDosePerDose} mg Q4-6H (Max ${maxDailyDose} mg/day)`;

        doseInfo = `1 mg/kg/dose Q4-6H. Max ${maxDosePerDose} mg/dose. Max daily: ${maxDailyDose} mg/day.`;
        specialNote = 'Oral must **only** be used as a continuation of IV or IM therapy; do not use as initial therapy.';
        duration = 'Max combined duration: 5 days.';
      }
      
    } else if (age >= 17.0) { // Adolescents >=17 years
      const isUnder50kg = weight < 50;
      
      if (route === 'IM') {
        if (isUnder50kg) {
          dosePerKg = 15 / weight; // Use 15mg Q6h dose to calculate equivalent mg/kg
          totalDose = 15; // Use 15mg Q6H dose
          maxDosePerDose = 30; // Maximum single dose is 30mg
          maxDailyDose = 60;
          displayDoseString = '15 mg Q6H (Max 30 mg single dose; Max daily: 60 mg)';
          doseInfo = '15 mg every 6 hours (OR 30 mg as a single dose). Max daily: 60 mg/day.';
        } else { // >=50 kg
          dosePerKg = 30 / weight; // Use 30mg Q6h dose
          totalDose = 30; // Use 30mg Q6H dose
          maxDosePerDose = 60; // Maximum single dose is 60mg
          maxDailyDose = 120;
          displayDoseString = '30 mg Q6H (Max 60 mg single dose; Max daily: 120 mg)';
          doseInfo = '30 mg every 6 hours (OR 60 mg as a single dose). Max daily: 120 mg/day.';
        }
        duration = 'Max combined duration (parenteral + oral): 5 days.';

      } else if (route === 'IV') {
        if (isUnder50kg) {
          dosePerKg = 15 / weight; // Use 15mg Q6h dose
          totalDose = 15; // Use 15mg Q6H dose
          maxDosePerDose = 15; // Maximum single dose is 15mg
          maxDailyDose = 60;
          displayDoseString = '15 mg Q6H (Max 15 mg single dose; Max daily: 60 mg)';
          doseInfo = '15 mg every 6 hours (OR 15 mg as a single dose). Max daily: 60 mg/day.';
        } else { // >=50 kg
          dosePerKg = 30 / weight; // Use 30mg Q6h dose
          totalDose = 30; // Use 30mg Q6H dose
          maxDosePerDose = 30; // Maximum single dose is 30mg
          maxDailyDose = 120;
          displayDoseString = '30 mg Q6H (Max 30 mg single dose; Max daily: 120 mg)';
          doseInfo = '30 mg every 6 hours (OR 30 mg as a single dose). Max daily: 120 mg/day.';
        }
        duration = 'Max combined duration (parenteral + oral): 5 days.';

      } else if (route === 'Oral') {
        totalDose = 10; // Maintenance dose used for volume calc, irrelevant for oral but for consistency
        maxDosePerDose = 10;
        maxDailyDose = 40;
        
        // **FIX:** Display regimen/Max Daily Dose
        if (isUnder50kg) {
            dosePerKg = 10 / weight;
            displayDoseString = 'Initial 10 mg, then 10 mg Q4-6H (Max 40 mg/day)';
            doseInfo = 'Initial: 10 mg, then 10 mg every 4 to 6 hours. Max daily: 40 mg/day.';
        } else { // >=50 kg
            dosePerKg = 10 / weight;
            displayDoseString = 'Initial 20 mg, then 10 mg Q4-6H (Max 40 mg/day)';
            doseInfo = 'Initial: 20 mg, then 10 mg every 4 to 6 hours. Max daily: 40 mg/day.';
        }

        specialNote = 'The maximum combined duration of treatment (parenteral and oral) is 5 days. Oral is generally continuation therapy.';
        duration = 'Max combined duration: 5 days.';
      }
      
    } else {
      // Fallback for missing age/weight
      doseInfo = 'Enter Age and Weight for Ketorolac Dose.';
      displayDoseString = 'N/A';
    }

    // Default editable dose for the edit box
    let editableDosePerKg = drug.defaultDose; 
    if (dosePerKg > 0) editableDosePerKg = dosePerKg;

    return {
      dosePerKg: editableDosePerKg,
      totalDose: totalDose, // Single dose number (for volume calc) or 'Not Recommended'
      displayDoseString: displayDoseString, // The formatted regimen string for the red box
      doseUnit: 'mg',
      doseInfo: doseInfo,
      specialNote: specialNote,
      maxDosePerDose: maxDosePerDose,
      maxDailyDose: maxDailyDose,
      duration: duration
    };
  }


  /* -------------------------
     Enhanced Equipment calculations
     ------------------------- */
  function calculateETTSize(age, weight){
    if (age === 0) return 'Enter Age (Years/Months)';
    
    if (age < 1){ // Age < 1 year
      if (weight === 0) return 'Enter Weight (kg)';
      // Weight-based logic for age < 1
      if (weight < 1.0) return '2.5';
      if (weight >= 1.0 && weight <= 2.0) return '3.0';
      return '3.5'; // weight > 2.0
    }
    
    // Age-based logic for age >= 1 year
    if (age >= 1 && age <= 18){
      const calculatedSize = (age/4)+4;
      // Round to nearest multiple of 0.5
      return (Math.round(calculatedSize * 2) / 2).toFixed(1);
    }
    return '7.5'; // fallback
  }

  function calculateETTDepth(age, weight){
    const sizeStr = calculateETTSize(age, weight);
    if (sizeStr.includes('Enter') || sizeStr === 'N/A') return 'N/A';
    const size = parseFloat(sizeStr);
    if (age < 0.1 && weight > 0){ // neonate (<1 month)
      // depth formula for neonates: weight + 6
      return (weight + 6).toFixed(1);
    }
    // general formula: ID x 3
    return (size * 3).toFixed(1);
  }

  function calculateCuffedETTSize(age, weight){
    const uncuffedSize = calculateETTSize(age, weight);
    if (uncuffedSize.includes('Enter') || uncuffedSize === 'N/A') return 'N/A';
    const id = parseFloat(uncuffedSize);
    return (id - 0.5).toFixed(1);
  }

  function calculateLaryngoscopeBlade(age){
    if (age < 1) return '0-1 (Miller)';
    if (age <= 2) return '1 (Miller)';
    if (age <= 6) return '2 (Mac)';
    return '3 (Mac)';
  }

  function calculateLMASize(weight){
    if (weight < 5) return '1';
    if (weight < 10) return '1.5';
    if (weight < 20) return '2';
    if (weight < 30) return '2.5';
    if (weight < 50) return '3';
    return '4';
  }

  function calculateIGelSize(weight){
    if (weight < 5) return '1';
    if (weight < 10) return '1.5';
    if (weight < 25) return '2';
    if (weight < 35) return '2.5';
    if (weight < 60) return '3';
    if (weight < 90) return '4';
    return '5';
  }

  /* -------------------------
     Central Line Catheter Size calculation (Algorithm derived from uploaded table)
     ------------------------- */
  function calculateCentralLineSize(weight){
    if (weight === 0) return 'N/A';
    // Neonates (2.5 to 5 kg) -> 3.0 Fr
    if (weight <= 5) return '3.0 Fr'; 
    // Infants (5 to 10 kg) -> 4.0 Fr
    if (weight <= 10) return '4.0 Fr'; 
    // >1 to 12 years (10 to 40 kg) -> 5.0 Fr
    if (weight <= 40) return '5.0 Fr'; 
    // ≥13 years (≥50 kg) -> 7.0 Fr (This covers all weights > 40kg)
    return '7.0 Fr'; 
  }

  /* -------------------------
     Enhanced Equipment rendering with additional parameters
     ------------------------- */
  function calculateEquipment(){
    const patient = getPatientData();
    const uncuffedSize = calculateETTSize(patient.age, patient.weight);
    const cuffedSize = calculateCuffedETTSize(patient.age, patient.weight);
    const depth = calculateETTDepth(patient.age, patient.weight);
    const blade = calculateLaryngoscopeBlade(patient.age);
    const lmaSize = patient.weight === 0 ? 'N/A' : calculateLMASize(patient.weight);
    const igelSize = patient.weight === 0 ? 'N/A' : calculateIGelSize(patient.weight);
    const centralLineSize = calculateCentralLineSize(patient.weight);

    let uncuffedValueClass = 'equipment-value';
    if (uncuffedSize.includes('Enter')){
      uncuffedValueClass += ' error';
    }

    const equipmentHTML = `
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Uncuffed)</div>
        <div class="${uncuffedValueClass}">${uncuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Cuffed)</div>
        <div class="equipment-value">${cuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Laryngoscope Blade</div>
        <div class="equipment-value">${blade}</div>
        <div class="equipment-detail">Based on age</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">LMA Size</div>
        <div class="equipment-value">${lmaSize}</div>
        <div class="equipment-detail">Based on weight</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">i-gel Size</div>
        <div class="equipment-value">${igelSize}</div>
        <div class="equipment-detail">Based on weight</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Central Line Catheter</div>
        <div class="equipment-value">${centralLineSize}</div>
        <div class="equipment-detail">French size based on weight</div>
      </div>
    `;
    document.getElementById('equipment-results').innerHTML = equipmentHTML;
  }

  /* -------------------------
     Fluid calculations
     ------------------------- */
  function calculateMaintenanceFluid(weight){
    if (weight <= 10) return weight * 4;
    if (weight <= 20) return 40 + (weight - 10) * 2;
    return 60 + (weight - 20) * 1;
  }

  function calculateEBV(weight, age){
    if (weight === 0) return 0;
    if (age < 0.1) return weight * 90; // neonate <1 month
    if (age < 1) return weight * 85;   // 1 month - 1 year
    if (age < 3) return weight * 80;   // toddler
    if (age < 6) return weight * 75;   // preschooler
    if (age < 12) return weight * 70;  // school age
    return weight * 65;                // adolescent
  }

  function calculateMABL(EBV, initialHb, targetHb){
    if (initialHb <= targetHb || initialHb === 0 || EBV === 0) return 0;
    const MABL = EBV * (initialHb - targetHb) / initialHb;
    return Math.max(0, MABL);
  }

  /* -------------------------
     Perioperative fluid calculations (new)
     ------------------------- */
  function calculatePerioperativeBolus(weight) {
    if (weight === 0) return 'N/A';
    const lowRange = weight * 20;
    const highRange = weight * 40;
    return `${lowRange.toFixed(0)}-${highRange.toFixed(0)} mL`;
  }

  function calculatePostopMaintenance(weight) {
    if (weight === 0) return 'N/A';
    let maintenance = 0;
    if (weight <= 10) {
      maintenance = weight * 2; // 2 mL/kg/hr for first 10 kg
    } else if (weight <= 20) {
      maintenance = 20 + (weight - 10) * 1; // 2 mL/kg/hr for first 10 kg, then 1 mL/kg/hr for next 10 kg
    } else {
      maintenance = 30 + (weight - 20) * 0.5; // 2 mL/kg/hr for first 10 kg, 1 mL/kg/hr for next 10 kg, then 0.5 mL/kg/hr for remaining
    }
    return `${maintenance.toFixed(0)} mL/hr`;
  }

  function calculateFluids(){
    const patient = getPatientData();
    const fluidResultsEl = document.getElementById('fluid-results');

    if (!patient.weight){
      fluidResultsEl.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate fluids and drug doses</p>';
      return;
    }

    const maintenance = calculateMaintenanceFluid(patient.weight);
    const bolus = patient.weight * 10;
    const EBV = calculateEBV(patient.weight, patient.age);
    const perioperativeBolus = calculatePerioperativeBolus(patient.weight);
    const postopMaintenance = calculatePostopMaintenance(patient.weight);

    let MABL_Result = "N/A";
    let MABL_Detail = "Requires Current & Target Hb";

    if (patient.currentHb > 0 && patient.targetHb > 0){
      const calculatedMABL = calculateMABL(EBV, patient.currentHb, patient.targetHb);
      MABL_Result = `${calculatedMABL.toFixed(0)} mL`;
      MABL_Detail = `Hb Drop: ${patient.currentHb.toFixed(1)} → ${patient.targetHb.toFixed(1)} g/dL`;
    } else {
      MABL_Result = `${(EBV * 0.15).toFixed(0)} - ${(EBV * 0.3).toFixed(0)} mL`;
      MABL_Detail = `Estimated Max (15-30% of EBV)`;
    }

    const fluidHTML = `
      <div class="equipment-card">
        <div class="equipment-title">Maintenance Fluid</div>
        <div class="equipment-value">${maintenance.toFixed(0)} mL/hr</div>
        <div class="equipment-detail">4-2-1 rule</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Fluid Bolus</div>
        <div class="equipment-value">${bolus.toFixed(0)} mL</div>
        <div class="equipment-detail">10 mL/kg</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Est. Blood Volume (EBV)</div>
        <div class="equipment-value">${EBV.toFixed(0)} mL</div>
        <div class="equipment-detail">Age-based mL/kg used</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Max Allowable Blood Loss (MABL)</div>
        <div class="equipment-value">${MABL_Result}</div>
        <div class="equipment-detail">${MABL_Detail}</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Perioperative Bolus</div>
        <div class="equipment-value">${perioperativeBolus}</div>
        <div class="equipment-detail">20-40 mL/kg (Alternative)</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Postop Maintenance</div>
        <div class="equipment-value">${postopMaintenance}</div>
        <div class="equipment-detail">2-1-0.5 rule (12 hrs)</div>
      </div>
    `;
    
    // Add info box for perioperative fluid source
    fluidResultsEl.innerHTML = `
      ${fluidHTML}
      <div class="info-box" style="grid-column: 1/-1; margin-top: 10px;">
        <strong>Perioperative Fluid Note:</strong> For children with marginal to moderate hypovolemia (e.g., fasting for surgery), administer 20-40 mL/kg of isotonic fluids during surgery and in PACU. Postoperatively, use the 2-1-0.5 rule for the first 12 hours or until patient starts drinking. 
        <a href="https://www.openanesthesia.org/keywords/perioperative-fluid-administration-in-children/" target="_blank" style="color: var(--primary-accent);">Source</a>
      </div>
    `;
  }

  /* -------------------------
     Local Anesthetics calculations (Updated for single concise card)
     ------------------------- */
  function calculateLocalAnesthetics() {
    const patient = getPatientData();
    const localAnestheticsDiv = document.getElementById('local-anesthetics-results');
    
    if (!patient.weight) {
      localAnestheticsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate maximum doses</p>';
      return;
    }
    
    let resultsListHtml = '';
    
    localAnesthetics.forEach((la) => {
      // la.useParam is implicitly 'weight' from the original data structure, but for this simpler list we only use weight
      const maxDose = patient.weight * la.maxDose;
      const maxDoseDisplay = maxDose.toFixed(1);
      
      // Create a row for the concise list
      resultsListHtml += `
        <div class="la-result-row">
          <div class="la-name">${la.name}</div>
          <div class="la-max-dose">
            ${maxDoseDisplay} ${la.unit.split('/')[0]}
            <span class="la-detail">${la.maxDose} ${la.unit} | ${la.caution}</span>
          </div>
        </div>
      `;
    });

    const singleCardHtml = `
      <div class="drug-card local-anesthetic expanded">
        <div class="drug-header" style="cursor: default; padding-bottom: 0;">
          <div class="drug-name">Maximum Safe Doses</div>
          <div class="drug-category local-anesthetic">Local Anesthetics</div>
        </div>
        <div class="la-results-container">
          ${resultsListHtml}
        </div>
        <div class="dose-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); font-style:normal;">
            Doses are based on patient weight of ${patient.weight.toFixed(1)} kg.
        </div>
      </div>
    `;
    
    localAnestheticsDiv.innerHTML = singleCardHtml;
  }

  /* -------------------------
     Utility: parse upper numeric value from dose range strings
     ------------------------- */
  function parseMaxDoseFromRange(rangeString){
    if (!rangeString) return null;
    const numbers = rangeString.match(/(\d+\.?\d*)/g);
    if (!numbers || numbers.length === 0) return null;
    const maxDose = numbers.reduce((max, cur) => {
      const num = parseFloat(cur);
      return (!isNaN(num) && num > max) ? num : max;
    }, 0);
    return maxDose > 0 ? maxDose : null;
  }

  /* -------------------------
     Enhanced Drug calculations & rendering with route selection
     ------------------------- */
  function calculateDrugs(){
    const patient = getPatientData();
    const drugResultsDiv = document.getElementById('drug-results');

    if (!patient.weight){
      drugResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate drug doses</p>';
      document.getElementById('toggleAllBtn').style.display = 'none';
      return;
    }
    document.getElementById('toggleAllBtn').style.display = 'block';

    let html = '';

    drugs.forEach((drug, index) => {
      const paramValue = patient[drug.useParam]; // usually weight

      let dosePerKg = drug.defaultDose; // Default dose per kg to use for calculation/display
      let totalDose = 0; // The single dose (number) used for volume calculation
      let limitApplied = false;
      let doseAdjusted = false;
      let concentrationDisplay = '';
      let volumeDisplay = 'N/A';
      let totalDoseUnit = drug.unit.includes('mcg') ? 'mcg' : 'mg';
      let isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
      let ketorolacInfoBox = ''; // Specific info box for Ketorolac
      let doseDisplay; // The final value for the red box

      if (drug.name === 'Ketorolac') {
        // --- KETOROLAC SPECIAL LOGIC ---
        const ketorolacCalc = calculateKetorolacDoseAndInfo(patient, drug);
        totalDose = ketorolacCalc.totalDose; // This is a number (single dose) or 'Not Recommended'
        dosePerKg = ketorolacCalc.dosePerKg;
        totalDoseUnit = ketorolacCalc.doseUnit;
        
        // Use the new displayDoseString for the final result
        doseDisplay = ketorolacCalc.displayDoseString;

        // Recalculate volume and concentration for injectable
        if (isInjectable && typeof totalDose === 'number' && totalDose > 0) {
            const finalConcentration = drug.concentration; // Use default 30 mg/mL
            const volume = totalDose / finalConcentration;
            volumeDisplay = volume.toFixed(2);
            concentrationDisplay = `${finalConcentration} ${drug.concentrationUnit}`;
        }
        
        // Create the special info box
        ketorolacInfoBox = `
            <div class="info-box ketorolac-specific">
                <strong>Ketorolac Dosing for ${patient.weight.toFixed(1)} kg (${patient.ageYears} Y, ${patient.ageMonths} M):</strong>
                <div>${ketorolacCalc.doseInfo}</div>
                <div>${ketorolacCalc.duration}</div>
                ${ketorolacCalc.specialNote ? `<div>**Note:** ${ketorolacCalc.specialNote}</div>` : ''}
            </div>
        `;
        // --- END KETOROLAC SPECIAL LOGIC ---

      } else {
        // --- STANDARD DRUG LOGIC ---
        const initialDosePerKgForRoute = getDoseByRoute(drug);
        dosePerKg = drug.defaultDose;
        
        // Check if `defaultDose` property still holds the dose for the `currentRoute`
        if (dosePerKg !== initialDosePerKgForRoute && drug.currentRoute !== 'IV') {
            dosePerKg = initialDosePerKgForRoute;
            drug.defaultDose = dosePerKg;
        }
        
        // Paracetamol special-case for <10 kg
        if (drug.name.includes('Paracetamol') && patient.weight > 0 && patient.weight < 10){
          if (initialDosePerKgForRoute === 15){ 
            dosePerKg = 7.5;
            doseAdjusted = true;
          }
        }

        // total dose (mg or mcg)
        totalDose = paramValue * dosePerKg;

        // enforce max/min total dose limits if present
        if (drug.maxDose && totalDose > drug.maxDose){
          totalDose = drug.maxDose; limitApplied = true;
        }
        if (drug.minDose && totalDose < drug.minDose){
          totalDose = drug.minDose; limitApplied = true;
        }

        // Concentration logic: only apply if IV/IM (Oral does not use concentration/volume logic)
        let finalConcentration = drug.concentration;
        let dilutionApplied = false;
        
        if (isInjectable) {
            const initialConcentration = drug.concentration;
            const tiers = dilutionTiers[drug.name];

            if (tiers){
              for (const conc of tiers){
                const calculatedVolume = totalDose / conc;
                if (calculatedVolume >= 1.0){
                  finalConcentration = conc;
                  dilutionApplied = conc !== initialConcentration;
                  break;
                }
                finalConcentration = conc;
                dilutionApplied = true;
              }
            }
        }

        // final metrics
        const volume = isInjectable ? totalDose / finalConcentration : 0;
        volumeDisplay = isInjectable ? volume.toFixed(2) : 'N/A';
        concentrationDisplay = isInjectable ? `${finalConcentration} ${drug.concentrationUnit}` : 'N/A';
        
        // Final Display formatting for standard drugs
        doseDisplay = (typeof totalDose === 'number') ? 
            (totalDoseUnit === 'mcg' ? totalDose.toFixed(0) : totalDose.toFixed(2)) :
            totalDose;
        // --- END STANDARD DRUG LOGIC ---
      }

      // caution logic
      let isCautionNeeded = false;
      if (drug.caution){
        if (drug.name === 'Succinylcholine' && patient.weight > 0 && patient.weight < 50) isCautionNeeded = true;
        else if (drug.name === 'Etomidate' && patient.weight > 0) isCautionNeeded = true;
        else if ((drug.name === 'Paracetamol (IV)' || drug.name === 'Midazolam' || drug.name === 'Lidocaine (Xylocard)') && patient.weight > 0 && patient.weight < 10) isCautionNeeded = true;
        else if ((drug.name === 'Diazepam' || drug.name === 'Lorazepam') && patient.weight > 0) isCautionNeeded = true;
        else if (drug.name === 'Magnesium Sulphate' && patient.weight > 0) isCautionNeeded = true;
        else if (drug.name === 'Phenylephrine' && patient.weight > 0) isCautionNeeded = true;
        else isCautionNeeded = true; // For any other drug with caution text
      }

      let cautionIconHtml = '';
      let cautionPopupHtml = '';
      if (isCautionNeeded){
        cautionIconHtml = `<span class="caution-icon" id="caution-icon-${index}" onclick="event.stopPropagation(); toggleCautionPopup(${index})">i</span>`;
        cautionPopupHtml = `<div id="caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${drug.caution}</div>`;
      }

      // dose info & limit warning
      let doseInfoHtml = `<div class="dose-info">Dose Range: ${drug.range}</div>`;
      if (doseAdjusted){
        doseInfoHtml = `<div class="dose-info dose-limit-applied">Dose reduced to ${dosePerKg} ${drug.unit} for <10 kg weight.</div>`;
      }
      let limitInfoHtml = '';
      if (limitApplied) {
        limitInfoHtml = `<span class="dose-limit-applied">${totalDose === drug.maxDose ? '(MAX Limit Applied)' : '(MIN Limit Applied)'}</span>`;
      }

      // custom dose warning
      let customDoseWarning = '';
      if (drug.isCustomDoseHigh){
        customDoseWarning = `
          <div class="dose-limit-applied" style="color: var(--reversal); font-weight:700; border:1px solid var(--reversal); display:block; padding:5px; border-radius:5px; margin-bottom:10px; background-color:var(--bg-card);">
            ⚠️ Custom Dose (${drug.defaultDose} ${drug.unit}) is **ABOVE** recommended range for the **current route**.
          </div>
        `;
      }

      // expanded / active classes
      const isExpandedClass = (allExpanded || index === activeEditIndex) ? 'expanded' : '';
      const isActiveEditClass = (index === activeEditIndex) ? 'active' : '';

      // Route Selector HTML
      let routeSelectorHTML = '';
      const routes = drug.routes || (drug.defaultRoute ? [drug.defaultRoute] : ['IV']);
      if (drug.imDose !== undefined && !routes.includes('IM')) routes.push('IM');
      if (drug.oralDose !== undefined && !routes.includes('Oral')) routes.push('Oral');

      if (routes.length > 1) {
        routeSelectorHTML = '<div class="route-selector">';
        routes.forEach(route => {
          const checked = drug.currentRoute === route ? 'checked' : '';
          const routeName = route === 'IM' ? 'Intramuscular (IM)' : route === 'Oral' ? 'Oral' : 'Intravenous (IV)';
          routeSelectorHTML += `
            <input type="radio" id="route-${index}-${route}" name="route-${index}" value="${route}" ${checked} 
                   onclick="event.stopPropagation(); selectRoute(${index}, '${route}')">
            <label for="route-${index}-${route}">${routeName}</label>
          `;
        });
        routeSelectorHTML += '</div>';
      }

      // Calculation/Volume Display (adjusted for Oral route)
      const volumeDetail = isInjectable && totalDose !== 'Not Recommended' ? 
          `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` :
          `<div class="volume-result" style="font-style:normal;">${totalDose !== 'Not Recommended' ? 'Concentration/Volume Not Applicable for Oral Dose' : ''}</div>`;
          
      // Edit Inputs (adjusted for Oral route)
      const concentrationEdit = isInjectable ?
        `<input type="number" step="0.1" placeholder="Concentration (${drug.concentrationUnit})" id="conc-${index}" value="${drug.concentration}" onchange="updateDrug(${index})">` :
        `<input type="number" step="0.1" placeholder="Concentration (${drug.concentrationUnit})" id="conc-${index}" value="${drug.concentration}" onchange="updateDrug(${index})" disabled title="Concentration edit is disabled for the selected route.">`;

      // assemble card HTML
      html += `
        <div class="drug-card ${drug.category} ${isExpandedClass} ${totalDose === 'Not Recommended' ? 'caution-active' : ''}" id="drug-card-${index}">
          ${cautionPopupHtml}
          <div class="drug-header" onclick="toggleDrugCard(${index})">
            <div class="drug-name">
              <span class="toggle-icon">▶</span>
              ${drug.name}
              <span style="font-size:0.65em; margin-left:8px; color:var(--text-secondary); font-weight:400;">(${drug.currentRoute} Dose)</span>
            </div>
            <div class="drug-category ${drug.category}">${drug.categoryLabel}</div>
            ${cautionIconHtml}
          </div>

          <div class="drug-details" id="drug-details-${index}">
            <div class="drug-info">
              ${routeSelectorHTML}
              ${ketorolacInfoBox}
              ${customDoseWarning}
              ${doseInfoHtml}
              <div class="calculation">
                <div class="calculation-result">${doseDisplay} ${drug.name !== 'Ketorolac' ? totalDoseUnit : ''} ${limitInfoHtml}</div>
                ${volumeDetail}
                ${(typeof totalDose === 'number' && totalDose > 0) ? `<div class="dose-info">Calculated: ${dosePerKg.toFixed(2)} ${drug.unit}</div>` : ''}
              </div>

              <button class="edit-btn" onclick="event.stopPropagation(); toggleEdit(${index})">Edit Dose/Dilution</button>
              <div class="edit-inputs ${isActiveEditClass}" id="edit-${index}">
                <input type="number" step="0.01" placeholder="Dose per kg (${drug.unit} - ${drug.currentRoute})" id="dose-${index}" value="${dosePerKg.toFixed(2)}" onchange="updateDrug(${index})">
                ${concentrationEdit}
              </div>

            </div>
          </div>
        </div>
      `;
    });

    drugResultsDiv.innerHTML = html;
    activeEditIndex = null;
    document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  /* -------------------------
     Toggle handlers for cards, all-expand, edit panel
     ------------------------- */
  function toggleDrugCard(index){
    const card = document.getElementById(`drug-card-${index}`);
    if (!card) return;
    card.classList.toggle('expanded');
  }

  function toggleAllDrugs(){
    allExpanded = !allExpanded;
    const cards = document.querySelectorAll('.drug-card');
    const button = document.getElementById('toggleAllBtn');
    cards.forEach(card=>{
      if (allExpanded) {
        card.classList.add('expanded');
        const editInputs = card.querySelector('.edit-inputs');
        if (editInputs && editInputs.classList.contains('active')) editInputs.classList.add('active');
      } else {
        card.classList.remove('expanded');
        const editInputs = card.querySelector('.edit-inputs');
        if (editInputs) editInputs.classList.remove('active');
      }
    });
    button.textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  function toggleEdit(index){
    const editDiv = document.getElementById(`edit-${index}`);
    if (!editDiv) return;
    editDiv.classList.toggle('active');
    if (editDiv.classList.contains('active')){
      document.getElementById(`drug-card-${index}`).classList.add('expanded');
    }
  }

  /* -------------------------
     Update drug from edit inputs
     ------------------------- */
  function updateDrug(index){
    const drug = drugs[index];
    const doseInput = document.getElementById(`dose-${index}`);
    const concInput = document.getElementById(`conc-${index}`);
    const newDose = parseFloat(doseInput.value);
    const newConc = parseFloat(concInput.value);

    // Parse max dose for the current route from the drug's range string
    const maxDose = parseMaxDoseFromRange(drug.range.split(drug.currentRoute)[0]);
    
    drug.isCustomDoseHigh = false;

    if (!isNaN(newDose) && newDose > 0){
      drug.defaultDose = newDose;
      if (maxDose !== null && newDose > maxDose) drug.isCustomDoseHigh = true;
    }
    
    // Only update concentration if injectable
    if (drug.currentRoute !== 'Oral' && !isNaN(newConc) && newConc > 0) drug.concentration = newConc;

    // keep this card open/active after rerender
    activeEditIndex = index;
    calculateDrugs();

    // Restore focus with a slight delay
    setTimeout(()=>{
      const updatedDoseInput = document.getElementById(`dose-${index}`);
      if (updatedDoseInput) updatedDoseInput.focus();
    },50);
  }

  /* -------------------------
     Caution popup logic
     ------------------------- */
  function toggleCautionPopup(index){
    const card = document.getElementById(`drug-card-${index}`);
    const popup = document.getElementById(`caution-popup-${index}`);

    // close other popups and remove their caution-active class
    document.querySelectorAll('.caution-popup').forEach(p=>{
      if (p.id !== (popup && popup.id)){
        p.style.display = 'none';
        const parentCard = p.closest('.drug-card');
        if (parentCard) parentCard.classList.remove('caution-active');
      }
    });

    if (!popup) return;
    if (popup.style.display === 'block'){
      popup.style.display = 'none';
      if (card) card.classList.remove('caution-active');
    } else {
      popup.style.display = 'block';
      if (card) card.classList.add('caution-active');
    }
  }

  // hide popups when clicking outside
  document.addEventListener('click', (e)=>{
    let clickedInsidePopup = false;
    let current = e.target;
    while(current){
      if (current.classList && (current.classList.contains('caution-popup') || current.classList.contains('caution-icon'))){
        clickedInsidePopup = true; break;
      }
      current = current.parentElement;
    }

    if (!clickedInsidePopup){
      document.querySelectorAll('.caution-popup').forEach(p=>p.style.display='none');
      document.querySelectorAll('.drug-card.caution-active').forEach(card=>card.classList.remove('caution-active'));
    }
  });

  /* -------------------------
     Top-level recalculation entrypoint
     ------------------------- */
  function calculateAll(){
    calculateEquipment();
    calculateFluids();
    calculateLocalAnesthetics();
    calculateDrugs();
  }

  /* -------------------------
     Dark mode toggle (persists in localStorage)
     ------------------------- */
  function toggleDarkMode(){
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    document.querySelector('.dark-mode-toggle').textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
  }

  /* -------------------------
     Initial load: restore dark mode and render
     ------------------------- */
  window.onload = function(){
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode){
      document.body.classList.add('dark-mode');
      document.querySelector('.dark-mode-toggle').textContent = '☀️ Light Mode';
    }
    calculateAll();
  };
  </script>
</body>
</html>
