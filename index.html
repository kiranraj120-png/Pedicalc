<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pediatric Anesthesia Calculator</title>

  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      /* New Modern Color Palette (Light Mode) */
      --primary-accent: #6366f1; /* Indigo 500 */
      --primary-accent-dark: #4338ca; /* Indigo 700 */
      --primary-accent-light: rgba(99, 102, 241, 0.2); /* Indigo 500 w/ alpha */

      --bg-primary: #f9fafb; /* Slate 50 */
      --bg-secondary: #ffffff; /* White */
      --bg-card: #ffffff; /* White */
      
      --text-primary: #111827; /* Slate 900 */
      --text-secondary: #4b5563; /* Slate 600 */
      --text-tertiary: #9ca3af; /* Slate 400 */
      
      --border-color: #e5e7eb; /* Slate 200 */
      
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-hover: var(--shadow-lg);

      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.3);

      /* Updated Drug Category Colors */
      --induction: #10b981; /* Emerald 500 */
      --muscle-relaxant: #f59e0b; /* Amber 500 */
      --analgesic: #3b82f6; /* Blue 500 */
      --adjunct: #8b5cf6; /* Violet 500 */
      --reversal: #ef4444; /* Red 500 */
      --emergency: #f97316; /* Orange 500 */
      --steroid: #6366f1; /* Indigo 500 (same as primary) */
      --antiemetic: #84cc16; /* Lime 500 */
      --local-anesthetic: #d946ef; /* Fuchsia 500 */
      --infusion: #06b6d4; /* Cyan 500 */
      --antibiotic: #78716c; /* Stone 500 */
      
      --caution-color: #f59e0b; /* Amber 500 */
      --reset-color: #ef4444; /* Red 500 */

      --radius-card: 12px;
      --radius-input: 8px;
      --radius-tab: 8px;
      
      --anim-bezier: cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.dark-mode {
      /* New Modern Color Palette (Dark Mode) */
      --primary-accent: #818cf8; /* Indigo 400 */
      --primary-accent-dark: #6366f1; /* Indigo 500 */
      --primary-accent-light: rgba(129, 140, 248, 0.2); /* Indigo 400 w/ alpha */

      --bg-primary: #111827; /* Slate 900 */
      --bg-secondary: #1f2937; /* Slate 800 */
      --bg-card: #1f2937; /* Slate 800 */
      
      --text-primary: #f9fafb; /* Slate 50 */
      --text-secondary: #9ca3af; /* Slate 400 */
      --text-tertiary: #6b7280; /* Slate 500 */
      
      --border-color: #374151; /* Slate 700 */

      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
      --shadow-hover: var(--shadow-lg);
      
      --glass-bg: rgba(31, 41, 55, 0.7); /* Slate 800 w/ alpha */
      --glass-border: rgba(255, 255, 255, 0.1);

      /* Drug colors can be the same, they pop nicely on dark */
      --caution-color: #fcd34d; /* Amber 300 */
      --reset-color: #f87171; /* Red 400 */
      --emergency: #fbbf24; /* Amber 400 */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      /* FIX: Remove tap highlight on all elements */
      -webkit-tap-highlight-color: transparent; 
    }

    html {
        scroll-behavior: smooth;
    }

    body {
      font-family: 'Poppins', sans-serif; /* New Font */
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 0.9rem;
      transition: background-color 0.4s var(--anim-bezier), color 0.4s var(--anim-bezier);
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    input, textarea {
      user-select: text !important;
      font-family: 'Poppins', sans-serif;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px 10px;
      /* Add page load animation */
      animation: containerFadeIn 0.5s ease-out;
    }

    @keyframes containerFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header {
      background: linear-gradient(135deg, var(--primary-accent), var(--primary-accent-dark));
      color: white;
      padding: 15px;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-md);
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
      transform: rotate(30deg);
      animation: shimmer 5s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translate(-30%, -30%) rotate(30deg); }
        100% { transform: translate(30%, 30%) rotate(30deg); }
    }

    h1 {
      font-size: 1.6em;
      font-weight: 700;
      z-index: 1;
    }

    .dark-mode-toggle {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: .75em;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .2);
      transition: all .25s var(--anim-bezier);
      outline: none;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center; /* Center content */
      gap: 8px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      
      /* FIX: Prevent jiggling by setting a min-width */
      min-width: 120px; 
      overflow: hidden;
    }

    .dark-mode-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .2);
    }

    .dark-mode-toggle:active {
      transform: translateY(0px);
    }
    
    .dark-mode-toggle i {
        /* Animation for icon */
        transition: transform 0.4s var(--anim-bezier);
    }
    
    body.dark-mode .dark-mode-toggle i {
        /* Rotate icon in dark mode */
        transform: rotate(180deg);
    }

    .tab-navigation {
      display: flex;
      overflow-x: auto;
      gap: 5px;
      margin-bottom: 15px;
      padding: 5px;
      scrollbar-width: none;
      -ms-overflow-style: none;
      position: sticky;
      top: 5px; /* Add small top sticky margin */
      z-index: 100;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .tab-navigation::-webkit-scrollbar {
      display: none;
    }

    .tab-button {
      flex: 1;
      min-width: 120px;
      background: transparent; /* Cleaner look */
      border: 1px solid transparent; /* No border by default */
      padding: 12px 15px;
      border-radius: var(--radius-tab);
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s var(--anim-bezier);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: var(--text-secondary);
    }

    .tab-button i {
      font-size: 1.2em;
    }

    .tab-button.active {
      background: var(--primary-accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--primary-accent-light);
    }

    .tab-button:not(.active):hover {
      background: var(--bg-card);
      color: var(--text-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s var(--anim-bezier);
      /* FIX: Ensure tab content has correct background in dark mode */
      background: var(--bg-primary); 
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-content.active {
      display: block;
    }

    .section, .patient-info, .memory-section {
      background: var(--bg-card);
      padding: 15px;
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-md);
      margin-bottom: 15px;
      transition: box-shadow .3s var(--anim-bezier), transform 0.3s var(--anim-bezier);
      border: 1px solid var(--border-color);
    }

    .section:hover, .patient-info:hover, .memory-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .section h2 {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h2 i {
      color: var(--primary-accent);
    }

    .disclaimer-container {
      margin-bottom: 15px;
    }

    .disclaimer-toggle {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      padding: 10px 15px;
      border-radius: var(--radius-card);
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s var(--anim-bezier);
      box-shadow: var(--shadow-md);
    }
    
    .disclaimer-toggle i:last-child {
        transition: transform 0.3s var(--anim-bezier);
    }

    .disclaimer-toggle:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-accent);
    }

    .disclaimer-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s var(--anim-bezier), padding 0.4s var(--anim-bezier);
      background: var(--bg-secondary);
      border-radius: 0 0 var(--radius-card) var(--radius-card);
      margin-top: -5px;
      border: 1px solid var(--border-color);
      border-top: none;
      visibility: hidden;
      padding-left: 15px;
      padding-right: 15px;
    }

    .disclaimer-content.expanded {
      max-height: 200px;
      padding: 15px;
      visibility: visible;
    }
    
    .disclaimer-content.expanded + .disclaimer-toggle i:last-child {
        transform: rotate(180deg);
    }
    
    #disclaimer-arrow {
        transition: transform 0.3s ease;
    }

    .warning {
      background: #fffbeb; /* Amber 50 */
      border-left: 5px solid #f59e0b; /* Amber 500 */
      padding: 12px;
      border-radius: 8px;
      font-size: 0.8em;
      color: #b45309; /* Amber 700 */
      font-weight: 500;
    }

    body.dark-mode .warning {
      background: #451a03; /* Amber 900 */
      color: #fcd34d; /* Amber 300 */
      border-left: 5px solid #f59e0b; /* Amber 500 */
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .age-input-group {
      display: flex;
      gap: 8px;
    }

    .input-field label {
      font-size: .8em;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 600;
      display: block;
    }

    .input-field input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-input);
      font-size: .9em;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color .3s var(--anim-bezier), box-shadow .3s var(--anim-bezier);
    }

    .input-field input:focus {
      outline: none;
      border-color: var(--primary-accent);
      box-shadow: 0 0 0 3px var(--primary-accent-light);
    }

    .info-box {
      background: var(--bg-secondary);
      border-left: 4px solid var(--primary-accent);
      padding: 12px 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-size: 0.85em;
      color: var(--text-secondary);
      animation: slideIn 0.5s var(--anim-bezier);
      border: 1px solid var(--border-color);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .info-box strong {
      color: var(--primary-accent);
      font-weight: 600;
    }

    .info-box.ketorolac-specific {
      border-left-color: var(--analgesic);
      margin-top: 5px;
      margin-bottom: 5px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.8em;
      padding: 8px 10px;
    }

    .drug-card {
      border-radius: var(--radius-card);
      padding: 12px;
      border-left: 6px solid;
      background: var(--bg-secondary);
      transition: all .35s var(--anim-bezier);
      position: relative;
      z-index: 1;
      will-change: transform, box-shadow, background-color;
      animation: cardAppear 0.5s var(--anim-bezier);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .drug-card.caution-active {
      z-index: 20;
      border-left-color: var(--caution-color) !important;
      box-shadow: 0 0 15px -3px var(--caution-color);
      border-color: var(--caution-color);
    }

    .drug-card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-3px);
      background: var(--bg-card);
    }

    /* Drug Category Borders */
    .drug-card.induction { border-left-color: var(--induction) }
    .drug-card.muscle-relaxant { border-left-color: var(--muscle-relaxant) }
    .drug-card.analgesic { border-left-color: var(--analgesic) }
    .drug-card.adjunct { border-left-color: var(--adjunct) }
    .drug-card.reversal { border-left-color: var(--reversal) }
    .drug-card.emergency { border-left-color: var(--emergency) }
    .drug-card.steroid { border-left-color: var(--steroid) }
    .drug-card.antiemetic { border-left-color: var(--antiemetic) }
    .drug-card.local-anesthetic { border-left-color: var(--local-anesthetic) }
    .drug-card.infusion { border-left-color: var(--infusion) }
    .drug-card.antibiotic { border-left-color: var(--antibiotic) }

    .drug-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      cursor: pointer;
      user-select: none;
      flex-direction: column;
      gap: 5px;
    }

    .drug-card.expanded .drug-header {
      padding-bottom: 8px;
    }

    .drug-name {
      font-weight: 700;
      font-size: 1.1em;
      color: var(--text-primary);
      display: flex;
      align-items: center;
    }

    .toggle-icon {
      font-size: 1em;
      margin-right: 8px; /* Increased margin */
      transform: rotate(0deg);
      transition: transform 350ms cubic-bezier(.175, .885, .32, 1.275);
      will-change: transform;
      color: var(--primary-accent);
    }

    .drug-card.expanded .toggle-icon {
      transform: rotate(90deg);
    }

    .drug-details {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      padding-top: 0;
      transform: translateY(-6px);
      transition: max-height 420ms cubic-bezier(.22, 1, .36, 1), opacity 260ms ease-in-out, transform 420ms cubic-bezier(.22, 1, .36, 1), padding-top 420ms cubic-bezier(.22, 1, .36, 1);
      will-change: max-height, opacity, transform, padding-top;
    }

    .drug-card.expanded .drug-details {
      max-height: 520px;
      opacity: 1;
      padding-top: 12px;
      transform: translateY(0);
    }

    .drug-category {
      font-size: 0.65em;
      padding: 4px 8px;
      border-radius: 20px;
      color: #fff; /* Default white text */
      font-weight: 700; /* Bolder */
      text-transform: uppercase;
      letter-spacing: .5px;
      background-color: var(--border-color);
    }

    /* Drug Category Backgrounds */
    .drug-category.induction { background-color: var(--induction); }
    .drug-category.muscle-relaxant { background-color: var(--muscle-relaxant); }
    .drug-category.analgesic { background-color: var(--analgesic); }
    .drug-category.adjunct { background-color: var(--adjunct); }
    .drug-category.reversal { background-color: var(--reversal); }
    .drug-category.emergency { background-color: var(--emergency); }
    .drug-category.steroid { background-color: var(--steroid); }
    .drug-category.antiemetic { background-color: var(--antiemetic); }
    .drug-category.local-anesthetic { background-color: var(--local-anesthetic); }
    .drug-category.infusion { background-color: var(--infusion); }
    .drug-category.antibiotic { background-color: var(--antibiotic); }
    
    /* Text color adjustments for light backgrounds */
    .drug-category.antiemetic, .drug-category.induction, body.dark-mode .drug-category.emergency {
        color: #000;
    }

    .dose-info {
      font-size: .75em;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 4px;
    }

    .caution-icon {
      display: inline-flex; /* Use flex for centering */
      align-items: center;
      justify-content: center;
      width: 18px; /* Slightly larger */
      height: 18px; /* Slightly larger */
      line-height: 18px;
      text-align: center;
      border-radius: 50%;
      background-color: var(--caution-color);
      color: #000;
      font-weight: bold;
      font-size: .7em; /* Larger icon font */
      cursor: pointer;
      margin-left: 8px;
      flex-shrink: 0;
      align-self: flex-start;
      transition: all 0.2s var(--anim-bezier);
    }
    
    .caution-icon:hover {
        transform: scale(1.2);
    }

    .caution-popup {
      display: none;
      position: absolute;
      z-index: 30;
      padding: 10px; /* More padding */
      background: var(--bg-card); /* Use card bg */
      color: var(--text-primary);
      border: 1px solid var(--caution-color);
      border-radius: 8px; /* Rounded */
      box-shadow: var(--shadow-hover);
      width: 220px;
      font-size: .75em; /* More readable */
      top: 12px;
      right: 12px;
      white-space: normal;
      animation: popIn 0.3s var(--anim-bezier);
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .dose-limit-applied {
      font-size: .7em;
      color: var(--reversal);
      font-weight: 600;
      display: block;
      margin-top: 2px;
    }

    .calculation {
      background: var(--bg-primary); /* Use primary bg for contrast */
      padding: 10px;
      border-radius: var(--radius-input);
      margin-top: 8px;
      border: 1px solid var(--border-color);
    }

    .calculation-result {
      font-weight: 800;
      font-size: 1.2em;
      color: var(--primary-accent); /* Use primary accent */
    }
    
    body.dark-mode .calculation-result {
        color: var(--primary-accent);
    }
    
    .calculation-result .dose-limit-applied {
        color: var(--reversal); /* Keep limit red */
    }

    .volume-result {
      font-size: .8em;
      color: var(--text-secondary);
      margin-top: 3px;
      font-weight: 500;
    }

    /* Base button style */
    .edit-btn, .memory-btn, .saved-item-btn, .infusion-rate-btn, .expand-all-btn {
        padding: 8px 16px;
        border-radius: 50px;
        font-size: .8em;
        font-weight: 600;
        cursor: pointer;
        transition: all .25s var(--anim-bezier);
        border: 2px solid transparent;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .edit-btn:hover, .memory-btn:hover, .saved-item-btn:hover, .infusion-rate-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }
    
    .edit-btn:active, .memory-btn:active, .saved-item-btn:active, .infusion-rate-btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow);
    }
    
    /* Primary button style (edit, memory) */
    .edit-btn, .memory-btn {
        background: transparent;
        border-color: var(--primary-accent);
        color: var(--primary-accent);
        margin-top: 8px;
    }
    
    .edit-btn:hover, .memory-btn:hover {
        background: var(--primary-accent);
        color: var(--bg-card); /* White/dark bg */
        box-shadow: 0 4px 10px var(--primary-accent-light);
    }
    
    /* Special for "Update" button inside edit pane */
    .edit-actions .edit-btn {
        margin-top: 0;
        background: var(--primary-accent);
        color: var(--bg-card);
    }
    .edit-actions .edit-btn:hover {
        background: var(--primary-accent-dark);
    }

    /* Reset/Warning button */
    .edit-btn.reset-btn, .memory-btn.warning {
        color: var(--reset-color);
        border-color: var(--reset-color);
        background: transparent;
    }
    
    .edit-btn.reset-btn:hover, .memory-btn.warning:hover {
        background: var(--reset-color);
        color: var(--bg-card);
        box-shadow: 0 4px 10px rgba(239, 68, 68, .3);
    }

    /* Secondary button */
    .memory-btn.secondary {
      background: transparent;
      color: var(--text-secondary);
      border-color: var(--border-color);
    }

    .memory-btn.secondary:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }
    
    /* Infusion Rate CTA */
    .infusion-rate-btn {
        background: var(--primary-accent);
        color: var(--bg-card);
        border: none;
        font-size: 1.1em;
        font-weight: 700;
        box-shadow: var(--shadow-md);
        text-align: center;
        margin-top: 10px;
        width: 100%;
    }
    .infusion-rate-btn:hover {
        background: var(--primary-accent-dark);
    }

    .edit-inputs {
      display: none;
      margin-top: 10px; /* More space */
      padding: 10px; /* More padding */
      background: var(--bg-primary); /* Contrast bg */
      border-radius: var(--radius-input);
      border: 1px dashed var(--border-color);
      flex-direction: column;
      gap: 10px;
    }

    .edit-inputs.active {
      display: flex;
      animation: slideDown 0.4s var(--anim-bezier);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        max-height: 150px; 
        transform: translateY(0);
      }
    }
    
    .edit-input-grid {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .edit-input-field {
        flex: 1;
    }

    .edit-input-field label {
        font-size: 0.7em;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .edit-input-field input {
        width: 100%;
        padding: 6px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 0.8em;
        background: var(--bg-secondary); /* White/darker bg */
        color: var(--text-primary);
    }
    
    .edit-input-field input:focus {
        outline: none;
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px var(--primary-accent-light);
    }
    
    .edit-actions {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }

    .route-selector, .indication-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--border-color);
      flex-wrap: wrap;
    }
    
    .indication-selector {
        flex-direction: column;
    }

    .route-selector label, .indication-selector label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.75em;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 6px 12px; /* More padding */
      border-radius: 50px;
      background: var(--bg-primary); /* Use primary bg */
      border: 1px solid var(--border-color);
      transition: all 0.2s var(--anim-bezier);
    }

    .route-selector input[type="radio"], .indication-selector input[type="radio"] {
      display: none;
    }
    
    /* Focus visible state for accessibility */
    .route-selector input[type="radio"]:focus-visible + label,
    .indication-selector input[type="radio"]:focus-visible + label {
        outline: 2px solid var(--primary-accent);
        outline-offset: 2px;
    }

    .route-selector input[type="radio"]:checked+label {
      background: var(--primary-accent);
      color: var(--bg-card);
      border-color: var(--primary-accent);
      box-shadow: 0 2px 4px var(--primary-accent-light);
    }

    .indication-selector input[type="radio"]:checked+label {
      background: var(--antibiotic);
      color: var(--bg-card);
      border-color: var(--antibiotic);
      box-shadow: 0 2px 4px rgba(120, 113, 108, 0.3);
    }

    .drugs-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .equipment-card {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: var(--radius-card);
      text-align: center;
      border-top: 4px solid var(--primary-accent);
      transition: all .3s var(--anim-bezier);
      animation: cardAppear 0.5s var(--anim-bezier);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .equipment-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .equipment-title {
      font-size: .85em;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .equipment-value {
      font-size: 1.4em;
      font-weight: 800;
      color: var(--primary-accent);
      line-height: 1.1;
    }

    .equipment-value.error {
      color: var(--reversal);
      font-size: .85em;
      font-weight: 600;
      line-height: 1.3;
    }

    .equipment-detail {
      font-size: .7em;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .expand-all-btn {
      margin-top: 5px;
      margin-bottom: 12px;
      display: block;
      width: 100%;
      max-width: 350px;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }

    .la-results-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .la-result-row {
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dotted var(--border-color);
    }

    .la-result-row:last-child {
      border-bottom: none;
    }

    .la-name {
      font-weight: 600;
      font-size: 0.95em;
      color: var(--text-primary);
    }

    .la-max-dose {
      font-weight: 800;
      font-size: 1.1em;
      color: var(--reversal); /* Keep this red for danger */
      text-align: right;
    }

    .la-detail {
      display: block;
      font-weight: 500;
      font-size: 0.7em;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    .infusion-details, .antibiotic-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .infusion-detail-row, .antibiotic-detail-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dotted var(--border-color);
    }

    .infusion-detail-row:last-child, .antibiotic-detail-row:last-child {
      border-bottom: none;
    }

    .infusion-label, .antibiotic-label {
      font-weight: 600;
      font-size: 0.85em;
      color: var(--text-primary);
    }

    .infusion-value, .antibiotic-value {
      font-weight: 600;
      font-size: 0.85em;
      color: var(--primary-accent);
      text-align: right;
    }
    
    .antibiotic-value {
        color: var(--antibiotic);
    }

    .infusion-note, .antibiotic-note {
      font-size: 0.75em;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 3px;
      grid-column: 1 / -1; /* Make note span full width */
    }

    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.8em;
      color: var(--text-secondary);
      padding: 20px 10px;
      border-top: 1px solid var(--border-color);
    }

    footer a {
      color: var(--primary-accent);
      text-decoration: none;
      font-weight: 600;
    }
    
    footer a:hover {
        text-decoration: underline;
    }

    .memory-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .memory-input {
      flex: 1;
      min-width: 150px;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-input);
      font-size: .9em;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color .3s var(--anim-bezier), box-shadow .3s var(--anim-bezier);
    }

    .memory-input:focus {
      outline: none;
      border-color: var(--primary-accent);
      box-shadow: 0 0 0 3px var(--primary-accent-light);
    }

    .saved-items-container {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-input);
      padding: 10px;
      background: var(--bg-primary);
    }

    .saved-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      margin-bottom: 5px;
      background: var(--bg-secondary);
      border-radius: var(--radius-input);
      transition: background .3s var(--anim-bezier);
      border: 1px solid var(--border-color);
    }

    .saved-item:hover {
      background: var(--bg-card);
      border-color: var(--primary-accent);
    }

    .saved-item:last-child {
      margin-bottom: 0;
    }

    .saved-item-name {
      font-weight: 600;
      font-size: .85em;
      color: var(--text-primary);
    }

    .saved-item-details {
      font-size: .7em;
      color: var(--text-secondary);
    }

    .saved-item-actions {
      display: flex;
      gap: 5px;
    }

    .saved-item-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: .8em;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .saved-item-btn:hover {
      background: var(--primary-accent);
      color: var(--bg-card);
      border-color: var(--primary-accent);
    }

    .saved-item-btn.delete:hover {
      background: var(--reversal);
      color: var(--bg-card);
      border-color: var(--reversal);
    }

    .custom-values-indicator {
      background: var(--primary-accent-light);
      border: 1px solid var(--primary-accent);
      color: var(--primary-accent-dark);
      padding: 12px 15px;
      border-radius: var(--radius-card);
      margin-bottom: 15px;
      font-size: .85em;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideIn 0.5s var(--anim-bezier);
      box-shadow: var(--shadow);
    }
    
    body.dark-mode .custom-values-indicator {
        color: var(--primary-accent);
    }

    .no-saved-items {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      padding: 20px;
      font-size: .85em;
    }

    .custom-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--primary-accent);
      margin-left: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        opacity: 0.7;
      }
      50% {
        transform: scale(1.1);
        opacity: 1;
      }
      100% {
        transform: scale(0.95);
        opacity: 0.7;
      }
    }

    .drug-name.has-custom::after {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--primary-accent);
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    @media(min-width:768px) {
      .container {
        padding: 20px 15px;
      }

      .drugs-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Slightly wider */
        gap: 15px;
      }

      .equipment-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      h1 {
        font-size: 2em;
      }

      .section h2 {
        font-size: 1.5em;
      }

      .drug-name {
        font-size: 1.2em;
      }

      .drug-header {
        flex-direction: row;
        align-items: center;
      }

      .tab-button {
        min-width: 150px;
        flex-direction: row;
        justify-content: center;
        font-size: 0.9em; /* Slightly larger tab text */
      }

      .tab-button i {
        font-size: 1em;
        margin-right: 8px;
      }
    }

    @media (max-width: 480px) {
      .tab-button {
        min-width: 100px;
        padding: 10px 8px;
        font-size: 0.7em;
      }

      .tab-button i {
        font-size: 1em;
      }

      .input-group {
        grid-template-columns: 1fr;
      }

      .memory-controls {
        flex-direction: column;
      }

      .memory-input {
        min-width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calculator"></i> Pediatric Anesthesia Calculator</h1>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i> <span>Dark Mode</span>
      </button>
    </header>

    <div class="disclaimer-container">
      <div class="disclaimer-toggle" onclick="toggleDisclaimer()">
        <span><i class="fas fa-exclamation-triangle" style="color: var(--caution-color);"></i> Disclaimer (Read this first)</span>
        <i class="fas fa-chevron-down" id="disclaimer-arrow"></i>
      </div>
      <div class="disclaimer-content" id="disclaimer-content">
        <div class="warning">
          The information provided by this calculator is strictly for estimation and reference purposes. You are required to exercise independent professional judgment and verify all calculations against approved institutional and regulatory standards. No warranties, express or implied, are made regarding the accuracy or completeness of the data. The developers and distributors disclaim all liability for damages arising from the use or inability to use this information.
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <div class="tab-button active" data-tab="patient-info">
        <i class="fas fa-user-injured"></i>
        <span>Patient Info</span>
      </div>
      <div class="tab-button" data-tab="airway-fluids">
        <i class="fas fa-lungs"></i>
        <span>Airway & Fluids</span>
      </div>
      <div class="tab-button" data-tab="local-anesthetics">
        <i class="fas fa-syringe"></i>
        <span>Local Anesthetics</span>
      </div>
      <div class="tab-button" data-tab="drug-calculations">
        <i class="fas fa-pills"></i>
        <span>Drugs</span>
      </div>
      <div class="tab-button" data-tab="infusions">
        <i class="fas fa-tint"></i>
        <span>Infusions</span>
      </div>
      <div class="tab-button" data-tab="antibiotics">
        <i class="fas fa-bacteria"></i>
        <span>Antibiotics</span>
      </div>
    </div>

    <!-- Patient Info Tab -->
    <div class="tab-content active" id="patient-info">
      <section class="patient-info">
        <h2><i class="fas fa-user-circle"></i> Patient Information</h2>
        <div class="input-group">
          <div class="input-field">
            <label for="age-years">Age</label>
            <div class="age-input-group">
              <input type="number" id="age-years" placeholder="Years (max 18)" step="1" min="0" max="18" oninput="clampAgeAndCalculate()">
              <input type="number" id="age-months" placeholder="Months (0-11)" step="1" min="0" max="11" oninput="clampAgeAndCalculate()">
            </div>
          </div>

          <div class="input-field">
            <label for="weight">Weight (kg)</label>
            <input type="number" id="weight" placeholder="Enter weight" step="0.1" min="0" oninput="calculateAll()">
          </div>

          <div class="input-field">
            <label for="currentHb">Current Hb (g/dL)</label>
            <input type="number" id="currentHb" placeholder="e.g., 12.0" step="0.1" min="0" oninput="calculateAll()">
          </div>

          <div class="input-field">
            <label for="targetHb">Target Hb (g/dL)</label>
            <input type="number" id="targetHb" placeholder="e.g., 8.0" step="0.1" min="0" oninput="calculateAll()">
          </div>
        </div>
      </section>

      <!-- Patient Memory Section -->
      <section class="memory-section">
        <h2><i class="fas fa-save"></i> Patient Memory</h2>
        <div class="info-box">
          <strong>Save Patient Profiles:</strong> Store patient details for quick recall. Data is saved locally in your browser.
        </div>
        
        <div class="input-field">
          <label for="patient-profile-name">Profile Name</label>
          <input type="text" id="patient-profile-name" placeholder="e.g., John Honai" class="memory-input">
        </div>
        
        <div class="memory-controls">
          <button class="memory-btn" onclick="savePatientProfile()">
            <i class="fas fa-save"></i> Save Current Patient
          </button>
          <button class="memory-btn warning" onclick="clearAllPatientProfiles()">
            <i class="fas fa-trash"></i> Clear All
          </button>
        </div>
        
        <div id="patient-profiles-list" class="saved-items-container">
          <!-- Patient profiles will be listed here -->
        </div>
      </section>
    </div>

    <!-- Airway & Fluids Tab -->
    <div class="tab-content" id="airway-fluids">
      <section class="section">
        <h2><i class="fas fa-wind"></i> Airway Equipment Sizing</h2>
        <div id="equipment-results" class="equipment-grid"></div>
      </section>

      <section class="section">
        <h2><i class="fas fa-tint"></i> Fluid & Blood Loss Requirements</h2>
        <div id="fluid-results" class="equipment-grid"></div>
      </section>
    </div>

    <!-- Local Anesthetics Tab -->
    <div class="tab-content" id="local-anesthetics">
      <section class="section">
        <h2><i class="fas fa-syringe"></i> Local Anesthetics - Maximum Doses</h2>
        <div class="info-box">
          <strong>Note:</strong> These are maximum recommended doses. Always use the lowest effective dose and consider patient factors.
        </div>
        <div id="local-anesthetics-results" class="drugs-grid"></div>
      </section>
    </div>

    <!-- Drug Calculations Tab -->
    <div class="tab-content" id="drug-calculations">
      <!-- Custom Drug Values Indicator -->
      <div id="custom-drugs-indicator" class="custom-values-indicator" style="display: none;">
        <span><i class="fas fa-info-circle"></i> Using Custom Drug Values: <span id="current-drug-set-name">Unknown</span> (<span id="modified-drugs-count">0</span> drugs modified)</span>
        <button class="memory-btn secondary" onclick="resetAllDrugsToDefault()" style="padding: 4px 8px; font-size: 0.7em;">
          <i class="fas fa-undo"></i> Reset to Default
        </button>
      </div>

      <section class="section">
        <h2><i class="fas fa-pills"></i> Drug Calculations</h2>
        <div class="info-box">
          <strong>Route Selection:</strong> Some drugs can be administered via different routes. Select the appropriate route for your clinical scenario.
        </div>
        <button class="expand-all-btn edit-btn" id="toggleAllBtn" onclick="toggleAllDrugs()">Expand All / Collapse All</button>
        <div id="drug-results" class="drugs-grid"></div>
      </section>

      <!-- Drug Settings Memory Section -->
      <section class="memory-section">
        <h2><i class="fas fa-cogs"></i> Drug Settings Memory</h2>
        <div class="info-box">
          <strong>Save Custom Drug Settings:</strong> Store your modified drug doses and concentrations as named sets for quick recall.
        </div>
        
        <div class="input-field">
          <label for="drug-set-name">Settings Name</label>
          <input type="text" id="drug-set-name" placeholder="e.g., My Custom Doses" class="memory-input">
        </div>
        
        <div class="memory-controls">
          <button class="memory-btn" onclick="saveDrugSet()">
            <i class="fas fa-save"></i> Save Current Settings
          </button>
          <button class="memory-btn warning" onclick="clearAllDrugSets()">
            <i class="fas fa-trash"></i> Clear All
          </button>
        </div>
        
        <div id="drug-sets-list" class="saved-items-container">
          <!-- Drug sets will be listed here -->
        </div>
      </section>
    </div>

    <!-- Infusions Tab -->
    <div class="tab-content" id="infusions">
      <section class="section">
        <h2><i class="fas fa-tint"></i> Infusion Calculations (!Experimental)</h2>
        <div class="info-box">
          <strong>Important:</strong> These are high-alert medications. Always verify calculations with a second clinician. Use central lines when possible for vasoactive drugs.
        </div>
        <button class="expand-all-btn edit-btn" id="toggleAllInfusionsBtn" onclick="toggleAllInfusions()">Expand All / Collapse All</button>
        <div id="infusion-results" class="drugs-grid"></div>
      </section>

      <section class="section">
        <h2><i class="fas fa-calculator"></i> Infusion Rate Calculator</h2>
        <div class="info-box">
          <strong>Advanced Infusion Calculations:</strong> For more complex infusion scenarios including custom concentrations, multiple drugs, and detailed rate calculations.
        </div>
        <a href="https://pedicalc-inf.pages.dev/" class="infusion-rate-btn" target="_self">
          <i class="fas fa-external-link-alt"></i> Open Infusion Rate Calculator
        </a>
      </section>
    </div>

    <!-- Antibiotics Tab -->
    <div class="tab-content" id="antibiotics">
      <section class="section">
        <h2><i class="fas fa-bacteria"></i> Antibiotics</h2>
        <div class="info-box">
          <strong>Note:</strong> Antibiotic dosing varies by indication, severity, and patient factors. Always verify with local guidelines and consider renal function.
        </div>
        <button class="expand-all-btn edit-btn" id="toggleAllAntibioticsBtn" onclick="toggleAllAntibiotics()">Expand All / Collapse All</button>
        <div id="antibiotics-results" class="drugs-grid"></div>
      </section>
    </div>

    <!-- Footer -->
    <footer>
      <a href="https://t.me/utopiccc">Ⓡ︎2025 Dr. Kiranraj</a>
    </footer>
  </div>

  <script>
  // Global state variables
  let allExpanded = false;
  let allInfusionsExpanded = false;
  let allAntibioticsExpanded = false;
  let activeEditIndex = null;
  let antibioticExpanded = [];

  const drugs = [
    { name:'Propofol', category:'induction', categoryLabel:'Induction Agent', defaultDose:2.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'2-3 mg/kg', defaultRoute:'IV' },
    { name:'Thiopentone', category:'induction', categoryLabel:'Induction Agent', defaultDose:5, unit:'mg/kg', concentration:25, concentrationUnit:'mg/mL', useParam:'weight', range:'4-6 mg/kg', defaultRoute:'IV' },
    { name:'Ketamine', category:'induction', categoryLabel:'Induction Agent', defaultDose:2, imDose:4, oralDose:6, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 4-6 mg/kg IM, 6-10 mg/kg Oral', defaultRoute:'IV' },
    { name:'Etomidate', category:'induction', categoryLabel:'Induction Agent', defaultDose:0.3, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2-0.3 mg/kg', caution:'Avoid in sepsis or adrenal suppression risk.', defaultRoute:'IV' },
    { name:'Vecuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.08-0.1 mg/kg', defaultRoute:'IV' },
    { name:'Rocuronium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.6, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.6-1.2 mg/kg', defaultRoute:'IV' },
    { name:'Atracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.5, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.4-0.5 mg/kg', defaultRoute:'IV' },
    { name:'Cisatracurium', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg', defaultRoute:'IV' },
    { name:'Succinylcholine', category:'muscle-relaxant', categoryLabel:'Muscle Relaxant', defaultDose:1.5, imDose:3, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg IV, 3-4 mg/kg IM', caution:'FDA Black Box Warning: Reserved for emergent use in children (<50kg) due to risk of hyperkalemia/cardiac arrest in undiagnosed myopathies.', defaultRoute:'IV' },
    { name:'Fentanyl', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:2, unit:'mcg/kg', concentration:50, concentrationUnit:'mcg/mL', useParam:'weight', range:'1-3 mcg/kg', defaultRoute:'IV' },
    { name:'Morphine', category:'analgesic', categoryLabel:'Opioid Analgesic', defaultDose:0.1, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg', defaultRoute:'IV' },
    { name:'Tramadol', category:'analgesic', categoryLabel:'Analgesic', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Paracetamol (IV)', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, caution:'Dose must be reduced to 7.5 mg/kg for patients <10 kg. Risk of hepatotoxicity in small infants/neonates.', defaultRoute:'IV' },
    { name:'Paracetamol (Oral)', category:'analgesic', categoryLabel:'Analgesic', defaultDose:15, unit:'mg/kg', concentration:24, concentrationUnit:'mg/mL', useParam:'weight', range:'10-15 mg/kg (max 1g)', maxDose:1000, defaultRoute:'Oral' },
    { name:'Ketorolac', category:'analgesic', categoryLabel:'NSAID Analgesic', defaultDose:0.5, oralDose:1.0, unit:'mg/kg', concentration:30, concentrationUnit:'mg/mL', useParam:'weight', range:'Dose varies significantly by Age/Weight/Route (See Info)', defaultRoute:'IV' },
    { name:'Midazolam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.5, unit:'mg/kg', concentration:1, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.2 mg/kg IV, 0.5-1 mg/kg Oral', caution:'Reduced dose or slow titration recommended for infants <10 kg due to prolonged effect/lower clearance.', defaultRoute:'IV' },
    { name:'Diazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.2, oralDose:0.3, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.3 mg/kg IV, 0.2-0.5 mg/kg Oral', caution:'Max 10mg. Slow IV. Not recommended for neonates.', defaultRoute:'IV' },
    { name:'Lorazepam', category:'adjunct', categoryLabel:'Sedative', defaultDose:0.1, oralDose:0.05, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.1 mg/kg IV, 0.05 mg/kg Oral', caution:'Max 4mg/dose. Slow IV.', defaultRoute:'IV' },
    { name:'Lidocaine (Xylocard)', category:'adjunct', categoryLabel:'Local Anesthetic', defaultDose:1.5, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'1-1.5 mg/kg IV', caution:'Strict total dose of 5 mg/kg. Higher risk of systemic toxicity in neonates/infants <10 kg.', defaultRoute:'IV' },
    { name:'Neostigmine', category:'reversal', categoryLabel:'Muscle Relaxant Reversal', defaultDose:0.05, unit:'mg/kg', concentration:0.5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.04-0.08 mg/kg (max 5mg)', maxDose:5, defaultRoute:'IV' },
    { name:'Glycopyrrolate', category:'reversal', categoryLabel:'Anticholinergic', defaultDose:0.01, unit:'mg/kg', concentration:0.2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.008-0.01 mg/kg', defaultRoute:'IV' },
    { name:'Sugammadex', category:'reversal', categoryLabel:'Rocuronium Reversal', defaultDose:2, unit:'mg/kg', concentration:20, concentrationUnit:'mg/mL', useParam:'weight', range:'2-4 mg/kg (routine reversal)', defaultRoute:'IV' },
    { name:'Naloxone', category:'reversal', categoryLabel:'Opioid Reversal', defaultDose:0.1, unit:'mg/kg', concentration:0.4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1mg/kg (titrate)',maxDose:2, defaultRoute:'IV' },
    { name:'Flumazenil', category:'reversal', categoryLabel:'Benzodiazepine Reversal', defaultDose:0.01, unit:'mg/kg', concentration:0.1, concentrationUnit:'mg/mL', useParam:'weight', range:'10 mcg/kg (titrate, max 200mcg)', maxDose:0.2, defaultRoute:'IV' },
    { name:'Adrenaline (Epinephrine) Arrest', category:'emergency', categoryLabel:'Cardiac Arrest', defaultDose:10, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'10 mcg/kg IV (1:10,000)', defaultRoute:'IV' },
    { name:'Adrenaline (Epinephrine) Anaphylaxis', category:'emergency', categoryLabel:'Anaphylaxis (IV)', defaultDose:1, unit:'mcg/kg', concentration:10, concentrationUnit:'mcg/mL', useParam:'weight', range:'1 mcg/kg (1:10,000)', defaultRoute:'IV' },
    { name:'Atropine', category:'emergency', categoryLabel:'Bradycardia', defaultDose:0.02, unit:'mg/kg', concentration:0.6, concentrationUnit:'mg/mL', useParam:'weight', range:'20 mcg/kg (min 100mcg, max 600mcg)', minDose:0.1, maxDose:0.6, defaultRoute:'IV' },
    { name:'Lignocaine (Anti-Arrhythmic)', category:'emergency', categoryLabel:'Anti-Arrhythmic', defaultDose:1, unit:'mg/kg', concentration:10, concentrationUnit:'mg/mL', useParam:'weight', range:'0.5-1 mg/kg', defaultRoute:'IV' },
    { name:'Magnesium Sulphate', category:'emergency', categoryLabel:'Asthma/Torsades', defaultDose:50, unit:'mg/kg', concentration:500, concentrationUnit:'mg/mL', useParam:'weight', range:'25-50 mg/kg', caution:'Infuse over 10-20 minutes.', defaultRoute:'IV' },
    { name:'Adenosine 1st Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.1, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1 mg/kg (max 6mg)', maxDose:6, defaultRoute:'IV' },
    { name:'Adenosine 2nd Dose', category:'emergency', categoryLabel:'SVT', defaultDose:0.2, unit:'mg/kg', concentration:3, concentrationUnit:'mg/mL', useParam:'weight', range:'0.2 mg/kg (max 12mg)', maxDose:12, defaultRoute:'IV' },
    { name:'Phenylephrine', category:'emergency', categoryLabel:'Vasopressor', defaultDose:10, unit:'mcg/kg', concentration:100, concentrationUnit:'mcg/mL', useParam:'weight', range:'5-20 mcg/kg', caution:'Total dose: 50-100 mcg. Use for acute hypotension.', defaultRoute:'IV' },
    { name:'Dexamethasone', category:'steroid', categoryLabel:'Steroid', defaultDose:0.15, unit:'mg/kg', concentration:4, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Hydrocortisone', category:'steroid', categoryLabel:'Steroid', defaultDose:1, unit:'mg/kg', concentration:50, concentrationUnit:'mg/mL', useParam:'weight', range:'1-2 mg/kg', defaultRoute:'IV' },
    { name:'Ondansetron', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.1, unit:'mg/kg', concentration:2, concentrationUnit:'mg/mL', useParam:'weight', range:'0.05-0.15 mg/kg (max 8mg)', maxDose:8, defaultRoute:'IV' },
    { name:'Metoclopramide', category:'antiemetic', categoryLabel:'Antiemetic', defaultDose:0.15, unit:'mg/kg', concentration:5, concentrationUnit:'mg/mL', useParam:'weight', range:'0.1-0.2 mg/kg (max 10mg)', maxDose:10, defaultRoute:'IV' }
  ];
  
  // Add custom value fields to all drugs
  drugs.forEach(drug => {
    drug.customDoseIV = null;
    drug.customDoseIM = null;
    drug.customDoseOral = null;
    drug.customConcentration = null;
  });

  const antibiotics = [
    { name: 'Ampicillin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 50, unit: 'mg/kg', concentration: 100, concentrationUnit: 'mg/mL', useParam: 'weight', range: '50-100 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Mild/Moderate Infection', dose: 50, frequency: 'Q6H' }, { name: 'Severe Infection/Meningitis', dose: 100, frequency: 'Q6H' }, { name: 'Surgical Prophylaxis', dose: 50, frequency: 'Single dose' } ], caution: 'High rate of rash. Not effective against beta-lactamase producing bacteria.', info: 'Common indications: Meningitis, severe sepsis, UTIs, intra-abdominal infections. Often used for Listeria in neonates.' },
    { name: 'Amoxicillin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 25, unit: 'mg/kg', concentration: 50, concentrationUnit: 'mg/mL', useParam: 'weight', range: '25-90 mg/kg', defaultRoute: 'Oral', routes: ['Oral'], indications: [ { name: 'Mild/Moderate Infection', dose: 25, frequency: 'Q8H' }, { name: 'Otitis Media/Sinusitis', dose: 45, frequency: 'Q12H' }, { name: 'Severe Infection', dose: 90, frequency: 'Q12H' } ], maxDose: 1000, caution: 'High incidence of rash, especially with concurrent viral infections.', info: 'Common indications: Otitis media, sinusitis, community-acquired pneumonia, streptococcal pharyngitis.' },
    { name: 'Amoxicillin/Clavulanate', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 25, unit: 'mg/kg', concentration: 50, concentrationUnit: 'mg/mL', useParam: 'weight', range: '25-90 mg/kg', defaultRoute: 'Oral', routes: ['Oral'], indications: [ { name: 'Standard Dose', dose: 25, frequency: 'Q8H' }, { name: 'Higher Dose (Recurrent Otitis)', dose: 45, frequency: 'Q12H' } ], maxDose: 875, caution: 'Diarrhea and GI upset are more common due to clavulanate.', info: 'Common indications: Recurrent or persistent otitis media, sinusitis, bite wounds. Used when beta-lactamase producing bacteria are suspected.' },
    { name: 'Cefazolin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 25, unit: 'mg/kg', concentration: 100, concentrationUnit: 'mg/mL', useParam: 'weight', range: '25-50 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Surgical Prophylaxis', dose: 25, frequency: 'Single dose' }, { name: 'Treatment', dose: 50, frequency: 'Q8H' } ], maxDose: 2000, caution: 'Cross-hypersensitivity with penicillins (approx. 5-10% risk).', info: 'Common indications: Surgical prophylaxis, skin and soft tissue infections caused by MSSA.' },
    { name: 'Cefotaxime', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 50, unit: 'mg/kg', concentration: 100, concentrationUnit: 'mg/mL', useParam: 'weight', range: '50-75 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Mild/Moderate Infection', dose: 50, frequency: 'Q8H' }, { name: 'Severe Infection/Meningitis', dose: 75, frequency: 'Q6H' }, { name: 'Surgical Prophylaxis', dose: 50, frequency: 'Single dose' } ], maxDose: 2000, caution: 'Excellent CNS penetration.', info: 'Common indications: Meningitis, serious Gram-negative infections, gonorrhea, sepsis in neonates.' },
    { name: 'Cefoxitin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 40, unit: 'mg/kg', concentration: 100, concentrationUnit: 'mg/mL', useParam: 'weight', range: '40-80 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Mild/Moderate Infection', dose: 40, frequency: 'Q6H' }, { name: 'Severe Infection', dose: 80, frequency: 'Q4H' }, { name: 'Surgical Prophylaxis', dose: 40, frequency: 'Single dose' } ], maxDose: 2000, caution: 'Good anaerobic coverage. Considered a "cephamycin".', info: 'Common indications: Intra-abdominal infections, pelvic inflammatory disease (PID), surgical prophylaxis for colorectal procedures.' },
    { name: 'Clindamycin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 10, unit: 'mg/kg', concentration: 150, concentrationUnit: 'mg/mL', useParam: 'weight', range: '10-40 mg/kg', defaultRoute: 'IV', routes: ['IV', 'Oral'], indications: [ { name: 'Mild/Moderate Infection', dose: 10, frequency: 'Q8H' }, { name: 'Severe Infection/MRSA', dose: 40, frequency: 'Q6H' }, { name: 'Surgical Prophylaxis', dose: 10, frequency: 'Single dose' } ], maxDose: 900, caution: 'High risk of causing C. difficile colitis. Not reliable for CNS infections.', info: 'Common indications: Anaerobic infections, MRSA skin/soft tissue infections, bone/joint infections.' },
    { name: 'Gentamicin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 7.5, unit: 'mg/kg', concentration: 10, concentrationUnit: 'mg/mL', useParam: 'weight', range: '5-7.5 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Standard Dose', dose: 7.5, frequency: 'Q24H' }, { name: 'Meningitis', dose: 5, frequency: 'Q8H' } ], maxDose: 300, caution: 'NEPHROTOXIC and OTOTOXIC. Therapeutic drug monitoring required.', info: 'Common indications: Severe Gram-negative infections, sepsis, synergistic therapy for endocarditis.' },
    { name: 'Metronidazole', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 7.5, unit: 'mg/kg', concentration: 5, concentrationUnit: 'mg/mL', useParam: 'weight', range: '7.5-10 mg/kg', defaultRoute: 'IV', routes: ['IV', 'Oral'], indications: [ { name: 'Anaerobic Infections', dose: 7.5, frequency: 'Q8H' }, { name: 'C. difficile Colitis', dose: 10, frequency: 'Q8H (Oral)' }, { name: 'Surgical Prophylaxis', dose: 7.5, frequency: 'Single dose' } ], maxDose: 500, caution: 'Causes disulfiram-like reaction with alcohol. Metallic taste common.', info: 'Common indications: Anaerobic infections (intra-abdominal, brain abscess), C. difficile colitis.' },
    { name: 'Vancomycin', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 15, unit: 'mg/kg', concentration: 5, concentrationUnit: 'mg/mL', useParam: 'weight', range: '15-20 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Standard Dose', dose: 15, frequency: 'Q6-8H' }, { name: 'Severe Infection/Meningitis', dose: 20, frequency: 'Q6-8H' } ], maxDose: 1000, caution: 'NEPHROTOXIC and OTOTOXIC. Requires therapeutic drug monitoring.', info: 'Common indications: MRSA infections, serious infections in penicillin-allergic patients.' },
    { name: 'Piperacillin/Tazobactam (Zosyn)', category: 'antibiotic', categoryLabel: 'Antibiotic', defaultDose: 100, unit: 'mg/kg', concentration: 40, concentrationUnit: 'mg/mL', useParam: 'weight', range: '80-100 mg/kg', defaultRoute: 'IV', routes: ['IV'], indications: [ { name: 'Standard Dose', dose: 80, frequency: 'Q8H' }, { name: 'Severe Infection', dose: 100, frequency: 'Q6H' }, { name: 'Surgical Prophylaxis', dose: 80, frequency: 'Single dose' } ], maxDose: 4000, caution: 'Broad-spectrum use can lead to C. diff and fungal superinfections. Contains significant sodium load.', info: 'Common indications: Broad-spectrum coverage for hospital-acquired pneumonia, intra-abdominal infections, febrile neutropenia.' }
  ];

  const infusionDrugs = [
    { name: 'Adrenaline (Epinephrine) Infusion', category: 'infusion', categoryLabel: 'Vasopressor Infusion', loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Not typically used as a loading dose for infusions' }, infusionDose: { min: 0.1, max: 1, unit: 'mcg/kg/min' }, commonDilution: '4 mg in 50 mL (80 mcg/mL)', preparation: 'Take 4 mL of Adrenaline (1 mg/mL) and add to 46 mL of compatible fluid to make 50 mL.', concentration: 80, concentrationUnit: 'mcg/mL', rateCalculation: function(dose, weight) { return (dose * weight * 60) / 80; }, caution: 'VESICANT - High risk of tissue necrosis if extravasation occurs. Use central line if possible. Have phentolamine ready for infiltration management.', notes: 'Standard preparation: 4 mg in 50 mL → 1 mL/h = (80 mcg/mL ÷ 60 min) ÷ weight = 1.33 mcg/kg/min for 1 kg patient' },
    { name: 'Noradrenaline (Norepinephrine) Infusion', category: 'infusion', categoryLabel: 'Vasopressor Infusion', loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Not typically used as a loading dose' }, infusionDose: { min: 0.05, max: 2, unit: 'mcg/kg/min' }, commonDilution: '4 mg in 50 mL (80 mcg/mL)', preparation: 'Take 2 mL of Noradrenaline (2 mg/mL) and add to 48 mL of compatible fluid to make 50 mL.', concentration: 80, concentrationUnit: 'mcg/mL', rateCalculation: function(dose, weight) { return (dose * weight * 60) / 80; }, caution: 'POTENT VESICANT - Must be administered through a central line if possible. If peripheral, use large proximal vein with frequent monitoring.', notes: 'Standard preparation: 4 mg in 50 mL → 1 mL/h = (80 mcg/mL ÷ 60 min) ÷ weight = 1.33 mcg/kg/min for 1 kg patient' },
    { name: 'Dexmedetomidine (Precedex) Infusion', category: 'infusion', categoryLabel: 'Sedative Infusion', loadingDose: { dose: 0.5, unit: 'mcg/kg', note: 'Optional: 0.5-1 mcg/kg over 10-20 minutes' }, infusionDose: { min: 0.2, max: 1, unit: 'mcg/kg/hr' }, commonDilution: '200 mcg in 50 mL (4 mcg/mL)', preparation: 'Take 2 mL of Dexmedetomidine (100 mcg/mL) and add to 48 mL of NS or D5W to make 50 mL.', concentration: 4, concentrationUnit: 'mcg/mL', rateCalculation: function(dose, weight) { return (dose * weight) / 4; }, caution: 'Causes bradycardia. Monitor hemodynamics closely. Withdrawal symptoms possible after prolonged use (>24 hours).', notes: 'Does not cause significant respiratory depression. Useful for procedural sedation and weaning from other sedatives.' },
    { name: 'Fentanyl Infusion', category: 'infusion', categoryLabel: 'Opioid Analgesic Infusion', loadingDose: { dose: 1, unit: 'mcg/kg', note: '1-2 mcg/kg bolus before starting infusion' }, infusionDose: { min: 1, max: 5, unit: 'mcg/kg/hr' }, commonDilution: '500 mcg in 50 mL (10 mcg/mL)', preparation: 'Take 10 mL of Fentanyl (50 mcg/mL) and add to 40 mL of compatible fluid to make 50 mL.', concentration: 10, concentrationUnit: 'mcg/mL', rateCalculation: function(dose, weight) { return (dose * weight) / 10; }, caution: 'Respiratory depression risk. Monitor respiratory status continuously. Have naloxone available. Chest wall rigidity possible with rapid bolus.', notes: 'For non-intubated patients, use lowest effective dose and monitor closely.' },
  {
      name: 'Dopamine Infusion',
      category: 'infusion',
      categoryLabel: 'Inotrope/Vasopressor',
      loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Loading dose not typically used.' },
      infusionDose: { min: 2, max: 20, unit: 'mcg/kg/min' },
      commonDilution: '200 mg in 50 mL (4000 mcg/mL)',
      preparation: 'Take 5 mL of Dopamine (40 mg/mL) and add to 45 mL of compatible fluid to make 50 mL.',
      concentration: 4000,
      concentrationUnit: 'mcg/mL',
      rateCalculation: function(dose, weight) { return (dose * weight * 60) / 4000; },
      caution: 'POTENT VESICANT - Must be administered through a central line. Can cause tachycardia and arrhythmias.',
      notes: 'Dose-dependent effects: 2-5 mcg/kg/min (dopaminergic/renal), 5-10 mcg/kg/min (inotropic/beta), >10 mcg/kg/min (vasopressor/alpha).'
    },
    {
      name: 'Dobutamine Infusion',
      category: 'infusion',
      categoryLabel: 'Inotrope Infusion',
      loadingDose: { dose: 0, unit: 'mcg/kg', note: 'Loading dose not typically used.' },
      infusionDose: { min: 2, max: 20, unit: 'mcg/kg/min' },
      commonDilution: '250 mg in 50 mL (5000 mcg/mL)',
      preparation: 'Take 20 mL of Dobutamine (12.5 mg/mL) and add to 30 mL of compatible fluid to make 50 mL.',
      concentration: 5000,
      concentrationUnit: 'mcg/mL',
      rateCalculation: function(dose, weight) { return (dose * weight * 60) / 5000; },
      caution: 'Can cause tachycardia, arrhythmias, and hypotension. Monitor HR and BP closely.',
      notes: 'Primarily a beta-1 agonist, increasing inotropy and chronotropy with less effect on SVR.'
    },
    {
      name: 'Vasopressin Infusion',
      category: 'infusion',
      categoryLabel: 'Vasopressor Infusion',
      loadingDose: { dose: 0, unit: 'units/kg', note: 'Loading dose not typically used for shock.' },
      infusionDose: { min: 0.01, max: 0.48, unit: 'units/kg/hr' },
      commonDilution: '5 units in 50 mL (0.1 units/mL)',
      preparation: 'Take 0.25 mL of Vasopressin (20 units/mL) and add to 49.75 mL of compatible fluid to make 50 mL.',
      concentration: 0.1,
      concentrationUnit: 'units/mL',
      rateCalculation: function(dose, weight) { return (dose * weight) / 0.1; },
      caution: 'POTENT VESICANT - Must use central line. Risk of peripheral and splanchnic ischemia. Monitor for limb perfusion and urine output.',
      notes: 'Dose range corresponds to 0.2 - 2 milliunits/kg/min. Used for catecholamine-resistant shock.'
    }
];

  const localAnesthetics = [
    { name: 'Lignocaine (Plain)', maxDose: 3, unit: 'mg/kg', caution: 'Without epinephrine' },
    { name: 'Lignocaine (With Epinephrine)', maxDose: 7, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
    { name: 'Bupivacaine (Plain)', maxDose: 2, unit: 'mg/kg', caution: 'Without epinephrine' },
    { name: 'Bupivacaine (With Epinephrine)', maxDose: 3, unit: 'mg/kg', caution: 'With epinephrine 1:200,000' },
    { name: 'Ropivacaine', maxDose: 3, unit: 'mg/kg', caution: 'Maximum recommended dose' }
  ];

  const dilutionTiers = {
    'Fentanyl': [50,10,5], 'Atropine': [0.6,0.1], 'Glycopyrrolate': [0.2,0.04],
    'Ondansetron': [2,1], 'Vecuronium': [1,0.5], 'Atracurium': [10,5,2.5],
    'Cisatracurium': [2,1,0.5], 'Adrenaline (Epinephrine) Anaphylaxis': [10,5]
  };

  // Initialization/Route assignment
  drugs.forEach(drug => {
    if (drug.name === 'Ketorolac') { drug.routes = ['IV', 'IM', 'Oral']; drug.defaultRoute = 'IV'; } 
    else { drug.routes = drug.defaultRoute ? [drug.defaultRoute] : ['IV']; if (drug.imDose !== undefined) drug.routes.push('IM'); if (drug.oralDose !== undefined) drug.routes.push('Oral'); }
    drug.currentRoute = drug.defaultRoute;
  });

  antibiotics.forEach(antibiotic => {
    antibiotic.routes = antibiotic.routes.filter(route => route !== 'IM');
    if (antibiotic.defaultRoute === 'IM') { antibiotic.defaultRoute = antibiotic.routes.includes('IV') ? 'IV' : antibiotic.routes[0]; }
    antibiotic.currentRoute = antibiotic.defaultRoute;
    antibiotic.currentIndication = antibiotic.indications ? antibiotic.indications[0].name : 'Standard';
  });
  
  // Store a copy of initial drug data
  const initialDrugs = JSON.parse(JSON.stringify(drugs.map(d => ({
      name: d.name, 
      defaultDose: d.defaultDose, // This is IV default
      imDose: d.imDose, 
      oralDose: d.oralDose,
      concentration: d.concentration
  }))));

  function getPatientData(){
    const years = parseFloat(document.getElementById('age-years').value) || 0;
    const months = parseFloat(document.getElementById('age-months').value) || 0;
    const totalAge = years + (months/12);
    return {
      age: totalAge, ageYears: years, ageMonths: months,
      weight: parseFloat(document.getElementById('weight').value) || 0,
      currentHb: parseFloat(document.getElementById('currentHb').value) || 0,
      targetHb: parseFloat(document.getElementById('targetHb').value) || 0
    };
  }

  function clampAgeAndCalculate(){
    const ageYearsInput = document.getElementById('age-years');
    const ageMonthsInput = document.getElementById('age-months');
    let years = parseFloat(ageYearsInput.value);
    let months = parseFloat(ageMonthsInput.value);

    if (!isNaN(years)){
      years = Math.min(18, Math.max(0, years));
      ageYearsInput.value = years;
    } else if (ageYearsInput.value) { ageYearsInput.value = ''; }

    if (!isNaN(months)){
      months = Math.min(11, Math.max(0, months));
      if (years === 18) months = 0;
      ageMonthsInput.value = months;
    } else if (ageMonthsInput.value) { ageMonthsInput.value = ''; }

    calculateAll();
  }

  /**
   * Gets the current effective dose for a given route, prioritizing custom values.
   */
  function getDoseByRoute(drug, route) {
    const initialDrug = initialDrugs.find(d => d.name === drug.name);
    if (!initialDrug) return 0;

    switch (route) {
        case 'IV':
            return drug.customDoseIV !== null ? drug.customDoseIV : initialDrug.defaultDose;
        case 'IM':
            // Use IM default if available, otherwise fall back to IV default
            const defaultIM = initialDrug.imDose !== undefined ? initialDrug.imDose : initialDrug.defaultDose;
            return drug.customDoseIM !== null ? drug.customDoseIM : defaultIM;
        case 'Oral':
            // Use Oral default if available, otherwise fall back to IV default
            const defaultOral = initialDrug.oralDose !== undefined ? initialDrug.oralDose : initialDrug.defaultDose;
            return drug.customDoseOral !== null ? drug.customDoseOral : defaultOral;
        default:
            return drug.customDoseIV !== null ? drug.customDoseIV : initialDrug.defaultDose;
    }
  }

  /**
   * Gets the current effective concentration, prioritizing custom values.
   */
  function getConcentration(drug) {
      const initialDrug = initialDrugs.find(d => d.name === drug.name);
      if (!initialDrug) return 0;
      return drug.customConcentration !== null ? drug.customConcentration : initialDrug.concentration;
  }

  /**
   * Checks if a drug has any custom values set that differ from the default.
   */
  function hasCustomValues(drug) {
    const initialDrug = initialDrugs.find(d => d.name === drug.name);
    if (!initialDrug) return false;

    // Check if custom values are set (not null)
    // The reset button will set them back to null, clearing the marker.
    const isIvDoseMod = drug.customDoseIV !== null;
    const isImDoseMod = drug.customDoseIM !== null;
    const isOralDoseMod = drug.customDoseOral !== null;
    const isConcMod = drug.customConcentration !== null;

    return isIvDoseMod || isImDoseMod || isOralDoseMod || isConcMod;
  }


  function countModifiedDrugs() {
    return drugs.filter(hasCustomValues).length;
  }

  /**
   * Selects a route for a drug and recalculates.
   */
  function selectRoute(index, route) {
    const drug = drugs[index];
    if (drug) {
      drug.currentRoute = route;
      activeEditIndex = index; // Keep edit pane open when switching routes
      calculateDrugs(); // Recalculate to show new route's values
    }
  }


  function selectAntibioticRoute(index, route) {
    const antibiotic = antibiotics[index];
    if (antibiotic) {
      antibiotic.currentRoute = route;
      if (antibiotic.indications && antibiotic.indications.length > 0) { antibiotic.currentIndication = antibiotic.indications[0].name; }
      calculateAntibiotics();
    }
  }

  function selectAntibioticIndication(index, indication) {
    const antibiotic = antibiotics[index];
    if (antibiotic) { antibiotic.currentIndication = indication; calculateAntibiotics(); }
  }

  function calculateKetorolacDoseAndInfo(patient, drug) {
    const age = patient.age;
    const weight = patient.weight;
    const route = drug.currentRoute;
    let dosePerKg = 0.5; let totalDose = 0; let maxDosePerDose = 0; let maxDailyDose = 0;
    let duration = ''; let doseInfo = ''; let specialNote = ''; let displayDoseString = 'N/A';

    if (age < 2.0) {
      if (route === 'IV' || route === 'IM') {
        dosePerKg = 0.5; totalDose = weight * dosePerKg; maxDosePerDose = 15;
        totalDose = Math.min(totalDose, maxDosePerDose);
        displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;
        doseInfo = `Recommended: 0.5 mg/kg/dose Q6-8H (Range: 0.25-0.5 mg/kg/dose). Max ${maxDosePerDose} mg/dose.`;
        duration = 'Limited to 48-72 hours.';
        if (route === 'IM' && age < 0.5) { doseInfo = `IM use described in patients ≥6 months of age. Recommended IV: 0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose.`; }
      } else {
        doseInfo = 'Oral use is not recommended in this age group (<2 years).'; displayDoseString = 'Not Recommended'; totalDose = 'Not Recommended';
      }
    } else if (age >= 2.0 && age < 17.0) {
      if (route === 'IM' || route === 'IV') {
        dosePerKg = 0.5; totalDose = weight * dosePerKg; maxDosePerDose = 30;
        totalDose = Math.min(totalDose, maxDosePerDose);
        displayDoseString = `${totalDose.toFixed(2)} mg Q6-8H`;
        doseInfo = `0.5 mg/kg/dose Q6-8H. Max ${maxDosePerDose} mg/dose. Max duration: 5 days.`; duration = 'Max duration: 5 days.';
      } else if (route === 'Oral') {
        dosePerKg = 1.0; totalDose = weight * dosePerKg; maxDosePerDose = 10; maxDailyDose = 40;
        totalDose = Math.min(totalDose, maxDosePerDose);
        displayDoseString = `${maxDosePerDose} mg Q4-6H (Max ${maxDailyDose} mg/day)`;
        doseInfo = `1 mg/kg/dose Q4-6H. Max ${maxDosePerDose} mg/dose. Max daily: ${maxDailyDose} mg/day.`;
        specialNote = 'Oral must **only** be used as a continuation of IV or IM therapy; do not use as initial therapy.';
        duration = 'Max combined duration: 5 days.';
      }
    } else if (age >= 17.0) {
      const isUnder50kg = weight < 50;
      if (route === 'IM') {
        totalDose = isUnder50kg ? 15 : 30; maxDosePerDose = isUnder50kg ? 30 : 60; maxDailyDose = isUnder50kg ? 60 : 120;
        dosePerKg = totalDose / weight;
        displayDoseString = isUnder50kg ? '15 mg Q6H (Max 30 mg single dose; Max daily: 60 mg)' : '30 mg Q6H (Max 60 mg single dose; Max daily: 120 mg)';
        doseInfo = `${totalDose} mg every 6 hours (OR ${maxDosePerDose} mg as a single dose). Max daily: ${maxDailyDose} mg/day.`;
        duration = 'Max combined duration (parenteral + oral): 5 days.';
      } else if (route === 'IV') {
        totalDose = isUnder50kg ? 15 : 30; maxDosePerDose = isUnder50kg ? 15 : 30; maxDailyDose = isUnder50kg ? 60 : 120;
        dosePerKg = totalDose / weight;
        displayDoseString = isUnder50kg ? '15 mg Q6H (Max 15 mg single dose; Max daily: 60 mg)' : '30 mg Q6H (Max 30 mg single dose; Max daily: 120 mg)';
        doseInfo = `${totalDose} mg every 6 hours (OR ${maxDosePerDose} mg as a single dose). Max daily: ${maxDailyDose} mg/day.`;
        duration = 'Max combined duration (parenteral + oral): 5 days.';
      } else if (route === 'Oral') {
        totalDose = 10; maxDosePerDose = 10; maxDailyDose = 40; dosePerKg = 10 / weight;
        displayDoseString = isUnder50kg ? 'Initial 10 mg, then 10 mg Q4-6H (Max 40 mg/day)' : 'Initial 20 mg, then 10 mg Q4-6H (Max 40 mg/day)';
        doseInfo = `Initial: ${isUnder50kg ? 10 : 20} mg, then 10 mg every 4 to 6 hours. Max daily: 40 mg/day.`;
        specialNote = 'The maximum combined duration of treatment (parenteral and oral) is 5 days. Oral is generally continuation therapy.';
        duration = 'Max combined duration: 5 days.';
      }
    } else { doseInfo = 'Enter Age and Weight for Ketorolac Dose.'; }
    
    // This is the *calculated* default dose for this route/age/weight
    let editableDosePerKg = (dosePerKg > 0) ? dosePerKg : 0;

    return { dosePerKg: editableDosePerKg, totalDose, displayDoseString, doseUnit: 'mg', doseInfo, specialNote, maxDosePerDose, maxDailyDose, duration };
  }

  function calculateAntibiotics() {
    const patient = getPatientData();
    const antibioticsDiv = document.getElementById('antibiotics-results');

    if (!patient.weight) {
      antibioticsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate antibiotic doses</p>';
      document.getElementById('toggleAllAntibioticsBtn').style.display = 'none';
      return;
    }
    document.getElementById('toggleAllAntibioticsBtn').style.display = 'block';

    let html = '';

    antibiotics.forEach((antibiotic, index) => {
      const weight = patient.weight;
      const currentIndication = antibiotic.indications.find(ind => ind.name === antibiotic.currentIndication) || { dose: antibiotic.defaultDose, frequency: 'Q6H' };
      const dosePerKg = currentIndication.dose;
      const frequency = currentIndication.frequency;
      let totalDose = weight * dosePerKg;
      let limitApplied = false;
      if (antibiotic.maxDose && totalDose > antibiotic.maxDose) { totalDose = antibiotic.maxDose; limitApplied = true; }
      
      let volumeDisplay = 'N/A';
      let concentrationDisplay = '';
      if (antibiotic.currentRoute === 'IV') {
        const volume = totalDose / antibiotic.concentration;
        volumeDisplay = volume.toFixed(2);
        concentrationDisplay = `${antibiotic.concentration} ${antibiotic.concentrationUnit}`;
      }
      
      let isCautionNeeded = antibiotic.caution ? true : false;
      let cautionIconHtml = isCautionNeeded ? `<span class="caution-icon" id="antibiotic-caution-icon-${index}" onclick="event.stopPropagation(); toggleAntibioticCautionPopup(${index})">i</span>` : '';
      let cautionPopupHtml = isCautionNeeded ? `<div id="antibiotic-caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${antibiotic.caution}</div>` : '';
      let infoBoxHtml = antibiotic.info ? `<div class="info-box ketorolac-specific" style="border-left-color: var(--antibiotic);">${antibiotic.info}</div>` : '';
      
      let routeSelectorHTML = antibiotic.routes.length > 1 ? '<div class="route-selector">' + antibiotic.routes.map(route => `<input type="radio" id="antibiotic-route-${index}-${route}" name="antibiotic-route-${index}" value="${route}" ${antibiotic.currentRoute === route ? 'checked' : ''} onclick="event.stopPropagation(); selectAntibioticRoute(${index}, '${route}')"><label for="antibiotic-route-${index}-${route}">${route === 'Oral' ? 'Oral' : 'Intravenous (IV)'}</label>`).join('') + '</div>' : '';
      
      let indicationSelectorHTML = antibiotic.indications.length > 1 ? '<div class="indication-selector">' + antibiotic.indications.map(indication => `<input type="radio" id="antibiotic-indication-${index}-${indication.name.replace(/\s+/g, '-')}" name="antibiotic-indication-${index}" value="${indication.name}" ${antibiotic.currentIndication === indication.name ? 'checked' : ''} onclick="event.stopPropagation(); selectAntibioticIndication(${index}, '${indication.name}')"><label for="antibiotic-indication-${index}-${indication.name.replace(/\s+/g, '-')}">${indication.name}</label>`).join('') + '</div>' : '';
      
      let limitInfoHtml = limitApplied ? `<span class="dose-limit-applied">(MAX Limit Applied)</span>` : '';
      
      const volumeDetail = (antibiotic.currentRoute === 'IV') ? 
        `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` :
        `<div class="volume-result" style="font-style:normal;">Concentration/Volume Not Applicable for Oral Dose</div>`;
      
      const isExpandedClass = (allAntibioticsExpanded || antibioticExpanded[index]) ? 'expanded' : '';
      
      html += `<div class="drug-card antibiotic ${isExpandedClass}" id="antibiotic-card-${index}">
          ${cautionPopupHtml}
          <div class="drug-header" onclick="toggleAntibioticCard(${index})">
            <div class="drug-name"><span class="toggle-icon">▶</span>${antibiotic.name}</div>
            <div class="drug-category antibiotic">${antibiotic.categoryLabel}</div>
            ${cautionIconHtml}
          </div>
          <div class="drug-details" id="antibiotic-details-${index}">
            <div class="antibiotic-details">
              ${routeSelectorHTML}${indicationSelectorHTML}${infoBoxHtml}
              <div class="antibiotic-detail-row"><div class="antibiotic-label">Dose Range:</div><div class="antibiotic-value">${antibiotic.range}</div></div>
              <div class="antibiotic-detail-row"><div class="antibiotic-label">Frequency:</div><div class="antibiotic-value">${frequency}</div></div>
              <div class="calculation">
                <div class="calculation-result" style="color: var(--antibiotic);">${totalDose.toFixed(2)} mg ${limitInfoHtml}</div>
                ${volumeDetail}
                <div class="dose-info">Calculated: ${dosePerKg} ${antibiotic.unit}</div>
              </div>
            </div>
          </div>
        </div>`;
    });

    antibioticsDiv.innerHTML = html;
    document.getElementById('toggleAllAntibioticsBtn').textContent = allAntibioticsExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  function calculateETTSize(age, weight){
    if (age === 0) return 'Enter Age (Years/Months)';
    if (age < 1){ if (weight === 0) return 'Enter Weight (kg)'; if (weight < 1.0) return '2.5'; if (weight <= 2.0) return '3.0'; return '3.5'; }
    if (age <= 18){ const calculatedSize = (age/4)+4; return (Math.round(calculatedSize * 2) / 2).toFixed(1); }
    return '7.5';
  }

  function calculateETTDepth(age, weight){
    const sizeStr = calculateETTSize(age, weight);
    if (sizeStr.includes('Enter') || sizeStr === 'N/A') return 'N/A';
    const size = parseFloat(sizeStr);
    if (age < 0.1 && weight > 0){ return (weight + 6).toFixed(1); }
    return (size * 3).toFixed(1);
  }

  function calculateCuffedETTSize(age, weight){
    const uncuffedSize = calculateETTSize(age, weight);
    if (uncuffedSize.includes('Enter') || uncuffedSize === 'N/A') return 'N/A';
    return (parseFloat(uncuffedSize) - 0.5).toFixed(1);
  }

  function calculateLaryngoscopeBlade(age){
    if (age < 1) return '0-1 (Miller)';
    if (age <= 2) return '1 (Miller)';
    if (age <= 6) return '2 (Mac)';
    return '3 (Mac)';
  }

  function calculateProSealLMASize(weight){
    if (weight === 0) return { size: 'N/A', cuffVolume: 'N/A' };
    if (weight < 5) return { size: '1', cuffVolume: 'Up to 4 mL' };
    if (weight < 10) return { size: '1.5', cuffVolume: 'Up to 7 mL' };
    if (weight < 20) return { size: '2', cuffVolume: 'Up to 10 mL' };
    if (weight < 30) return { size: '2.5', cuffVolume: 'Up to 14 mL' };
    if (weight < 50) return { size: '3', cuffVolume: 'Up to 20 mL' };
    if (weight < 70) return { size: '4', cuffVolume: 'Up to 30 mL' };
    return { size: '5', cuffVolume: 'Up to 40 mL' };
  }

  function calculateIGelSize(weight){
    if (weight < 5) return '1';
    if (weight < 10) return '1.5';
    if (weight < 25) return '2';
    if (weight < 35) return '2.5';
    if (weight < 60) return '3';
    if (weight < 90) return '4';
    return '5';
  }

  function calculateCentralLineSize(weight){
    if (weight === 0) return 'N/A';
    if (weight <= 5) return '3.0 Fr';
    if (weight <= 10) return '4.0 Fr';
    if (weight <= 40) return '5.0 Fr';
    return '7.0 Fr';
  }

  function calculateEquipment(){
    const patient = getPatientData();
    const uncuffedSize = calculateETTSize(patient.age, patient.weight);
    const cuffedSize = calculateCuffedETTSize(patient.age, patient.weight);
    const depth = calculateETTDepth(patient.age, patient.weight);
    const blade = calculateLaryngoscopeBlade(patient.age);
    const proSealLMA = calculateProSealLMASize(patient.weight);
    const igelSize = patient.weight === 0 ? 'N/A' : calculateIGelSize(patient.weight);
    const centralLineSize = calculateCentralLineSize(patient.weight);

    let uncuffedValueClass = 'equipment-value';
    if (uncuffedSize.includes('Enter')){ uncuffedValueClass += ' error'; }

    const equipmentHTML = `
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Uncuffed)</div>
        <div class="${uncuffedValueClass}">${uncuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">ETT Size (Cuffed)</div>
        <div class="equipment-value">${cuffedSize}</div>
        <div class="equipment-detail">Depth: ${depth} cm at lips</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Laryngoscope Blade</div>
        <div class="equipment-value">${blade}</div>
        <div class="equipment-detail">Based on age</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">ProSeal LMA Size</div>
        <div class="equipment-value">${proSealLMA.size}</div>
        <div class="equipment-detail">Cuff: ${proSealLMA.cuffVolume}</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">i-gel Size</div>
        <div class="equipment-value">${igelSize}</div>
        <div class="equipment-detail">Based on weight</div>
      </div>
      <div class="equipment-card">
        <div class="equipment-title">Central Line Catheter</div>
        <div class="equipment-value">${centralLineSize}</div>
        <div class="equipment-detail">French size based on weight</div>
      </div>
    `;
    document.getElementById('equipment-results').innerHTML = equipmentHTML;
  }

  function calculateMaintenanceFluid(weight){
    if (weight <= 10) return weight * 4;
    if (weight <= 20) return 40 + (weight - 10) * 2;
    return 60 + (weight - 20) * 1;
  }

  function calculateEBV(weight, age){
    if (weight === 0) return 0;
    if (age < 0.1) return weight * 90;
    if (age < 1) return weight * 85;
    if (age < 3) return weight * 80;
    if (age < 6) return weight * 75;
    if (age < 12) return weight * 70;
    return weight * 65;
  }

  function calculateMABL(EBV, initialHb, targetHb){
    if (initialHb <= targetHb || initialHb === 0 || EBV === 0) return 0;
    const MABL = EBV * (initialHb - targetHb) / initialHb;
    return Math.max(0, MABL);
  }

  function calculatePerioperativeBolus(weight) {
    if (weight === 0) return 'N/A';
    const lowRange = weight * 20;
    const highRange = weight * 40;
    return `${lowRange.toFixed(0)}-${highRange.toFixed(0)} mL`;
  }

  function calculatePostopMaintenance(weight) {
    if (weight === 0) return 'N/A';
    let maintenance = 0;
    if (weight <= 10) { maintenance = weight * 2; } 
    else if (weight <= 20) { maintenance = 20 + (weight - 10) * 1; } 
    else { maintenance = 30 + (weight - 20) * 0.5; }
    return `${maintenance.toFixed(0)} mL/hr`;
  }

  function calculateFluids(){
    const patient = getPatientData();
    const fluidResultsEl = document.getElementById('fluid-results');

    if (!patient.weight){
      fluidResultsEl.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate fluids and drug doses</p>';
      return;
    }

    const maintenance = calculateMaintenanceFluid(patient.weight);
    const bolus = patient.weight * 10;
    const EBV = calculateEBV(patient.weight, patient.age);
    const perioperativeBolus = calculatePerioperativeBolus(patient.weight);
    const postopMaintenance = calculatePostopMaintenance(patient.weight);

    let MABL_Result = "N/A";
    let MABL_Detail = "Requires Current & Target Hb";

    if (patient.currentHb > 0 && patient.targetHb > 0){
      const calculatedMABL = calculateMABL(EBV, patient.currentHb, patient.targetHb);
      MABL_Result = `${calculatedMABL.toFixed(0)} mL`;
      MABL_Detail = `Hb Drop: ${patient.currentHb.toFixed(1)} → ${patient.targetHb.toFixed(1)} g/dL`;
    } else {
      MABL_Result = `${(EBV * 0.15).toFixed(0)} - ${(EBV * 0.3).toFixed(0)} mL`;
      MABL_Detail = `Estimated Max (15-30% of EBV)`;
    }

    const fluidHTML = `
      <div class="equipment-card"><div class="equipment-title">Maintenance Fluid</div><div class="equipment-value">${maintenance.toFixed(0)} mL/hr</div><div class="equipment-detail">4-2-1 rule</div></div>
      <div class="equipment-card"><div class="equipment-title">Fluid Bolus</div><div class="equipment-value">${bolus.toFixed(0)} mL</div><div class="equipment-detail">10 mL/kg</div></div>
      <div class="equipment-card"><div class="equipment-title">Est. Blood Volume (EBV)</div><div class="equipment-value">${EBV.toFixed(0)} mL</div><div class="equipment-detail">Age-based mL/kg used</div></div>
      <div class="equipment-card"><div class="equipment-title">Max Allowable Blood Loss (MABL)</div><div class="equipment-value">${MABL_Result}</div><div class="equipment-detail">${MABL_Detail}</div></div>
      <div class="equipment-card"><div class="equipment-title">Perioperative Bolus</div><div class="equipment-value">${perioperativeBolus}</div><div class="equipment-detail">20-40 mL/kg (Alternative)</div></div>
      <div class="equipment-card"><div class="equipment-title">Postop Maintenance</div><div class="equipment-value">${postopMaintenance}</div><div class="equipment-detail">2-1-0.5 rule (12 hrs)</div></div>
    `;
    
    fluidResultsEl.innerHTML = `${fluidHTML}<div class="info-box" style="grid-column: 1/-1; margin-top: 10px;">
        <strong>Perioperative Fluid Note:</strong> For children with marginal to moderate hypovolemia (e.g., fasting for surgery), administer 20-40 mL/kg of isotonic fluids during surgery and in PACU. Postoperatively, use the 2-1-0.5 rule for the first 12 hours or until patient starts drinking. 
        <a href="https://www.openanesthesia.org/keywords/perioperative-fluid-administration-in-children/" target="_blank" style="color: var(--primary-accent);">Source</a>
      </div>`;
  }

  function calculateLocalAnesthetics() {
    const patient = getPatientData();
    const localAnestheticsDiv = document.getElementById('local-anesthetics-results');
    
    if (!patient.weight) {
      localAnestheticsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate maximum doses</p>';
      return;
    }
    
    let resultsListHtml = '';
    
    localAnesthetics.forEach((la) => {
      const maxDose = patient.weight * la.maxDose;
      const maxDoseDisplay = maxDose.toFixed(1);
      resultsListHtml += `<div class="la-result-row">
          <div class="la-name">${la.name}</div>
          <div class="la-max-dose">
            ${maxDoseDisplay} ${la.unit.split('/')[0]}
            <span class="la-detail">${la.maxDose} ${la.unit} | ${la.caution}</span>
          </div>
        </div>`;
    });

    const singleCardHtml = `
      <div class="drug-card local-anesthetic expanded" style="border-color: var(--local-anesthetic);">
        <div class="drug-header" style="cursor: default; padding-bottom: 0;">
          <div class="drug-name">Maximum Safe Doses</div>
          <div class="drug-category local-anesthetic">Local Anesthetics</div>
        </div>
        <div class="la-results-container">${resultsListHtml}</div>
        <div class="dose-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); font-style:normal;">
            Doses are based on patient weight of ${patient.weight.toFixed(1)} kg.
        </div>
      </div>
    `;
    
    localAnestheticsDiv.innerHTML = singleCardHtml;
  }

  function parseMaxDoseFromRange(rangeString){
    if (!rangeString) return null;
    const numbers = rangeString.match(/(\d+\.?\d*)/g);
    if (!numbers || numbers.length === 0) return null;
    const maxDose = numbers.reduce((max, cur) => {
      const num = parseFloat(cur);
      return (!isNaN(num) && num > max) ? num : max;
    }, 0);
    return maxDose > 0 ? maxDose : null;
  }

  function calculateDrugs(){
    const patient = getPatientData();
    const drugResultsDiv = document.getElementById('drug-results');

    if (!patient.weight){
      drugResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate drug doses</p>';
      document.getElementById('toggleAllBtn').style.display = 'none';
      return;
    }
    document.getElementById('toggleAllBtn').style.display = 'block';

    let html = '';

    drugs.forEach((drug, index) => {
      const paramValue = patient[drug.useParam];
      let dosePerKg;
      let concentration;
      let totalDose = 0;
      let limitApplied = false;
      let doseAdjusted = false;
      let concentrationDisplay = '';
      let volumeDisplay = 'N/A';
      let totalDoseUnit = drug.unit.includes('mcg') ? 'mcg' : 'mg';
      let isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
      let ketorolacInfoBox = '';
      let doseDisplay;

      if (drug.name === 'Ketorolac') {
        const ketorolacCalc = calculateKetorolacDoseAndInfo(patient, drug);
        let customDose = null;
        if(drug.currentRoute === 'IV') customDose = drug.customDoseIV;
        else if(drug.currentRoute === 'IM') customDose = drug.customDoseIM;
        else if(drug.currentRoute === 'Oral') customDose = drug.customDoseOral;

        // Use custom dose if set, otherwise use the calculated default
        dosePerKg = (customDose !== null) ? customDose : ketorolacCalc.dosePerKg;
        // Recalculate total dose if custom, otherwise use calculated display
        totalDose = (customDose !== null) ? (paramValue * customDose) : ketorolacCalc.totalDose;
        
        totalDoseUnit = ketorolacCalc.doseUnit;
        doseDisplay = (customDose !== null) ? `${totalDose.toFixed(2)} ${totalDoseUnit}` : ketorolacCalc.displayDoseString;
        
        ketorolacInfoBox = `<div class="info-box ketorolac-specific"><strong>Ketorolac Dosing for ${patient.weight.toFixed(1)} kg (${patient.ageYears} Y, ${patient.ageMonths} M):</strong><div>${ketorolacCalc.doseInfo}</div><div>${ketorolacCalc.duration}</div>${ketorolacCalc.specialNote ? `<div>**Note:** ${ketorolacCalc.specialNote}</div>` : ''}</div>`;
      
      } else {
        dosePerKg = getDoseByRoute(drug, drug.currentRoute);
        
        if (drug.name.includes('Paracetamol') && patient.weight > 0 && patient.weight < 10){
          const initialDrug = initialDrugs.find(d => d.name === drug.name);
          if (initialDrug && dosePerKg === initialDrug.defaultDose && initialDrug.defaultDose === 15){ 
            dosePerKg = 7.5; 
            doseAdjusted = true; 
          }
        }

        totalDose = paramValue * dosePerKg;

        if (drug.maxDose && totalDose > drug.maxDose){ totalDose = drug.maxDose; limitApplied = true; }
        if (drug.minDose && totalDose < drug.minDose){ totalDose = drug.minDose; limitApplied = true; }

        if (drug.unit.includes('mcg') && totalDose < 1) { doseDisplay = `${(totalDose * 1000).toFixed(0)} mcg`; } 
        else { doseDisplay = `${totalDose.toFixed(2)} ${totalDoseUnit}`; }
      }

      // Get current concentration (custom or default)
      concentration = getConcentration(drug);

      if (isInjectable && typeof totalDose === 'number' && totalDose > 0){
        let volume = totalDose / concentration;
        let currentConc = concentration;

        if (volume < 1 && dilutionTiers[drug.name]){
          const newConc = dilutionTiers[drug.name].find(conc => (totalDose / conc) >= 1);
          if (newConc){ volume = totalDose / newConc; currentConc = newConc; }
        }
        volumeDisplay = volume.toFixed(2);
        // Use 'concentration' (which is the effective one) for the display
        concentrationDisplay = `${currentConc} ${drug.concentrationUnit}${currentConc !== concentration ? ' (Diluted)' : ''}`;
      }

      let isCustomDoseHigh = drug.isCustomDoseHigh || false;
      const currentDoseForRangeCheck = getDoseByRoute(drug, drug.currentRoute);
      const rangeMax = parseMaxDoseFromRange(drug.range);
      if (rangeMax && currentDoseForRangeCheck > rangeMax) { isCustomDoseHigh = true; }

      const hasCustom = hasCustomValues(drug);
      const customIndicator = hasCustom ? ' has-custom' : '';
      let cautionActive = isCustomDoseHigh || drug.caution;
      let cautionIconHtml = cautionActive ? `<span class="caution-icon" id="caution-icon-${index}" onclick="event.stopPropagation(); toggleCautionPopup(${index})">i</span>` : '';
      let cautionPopupHtml = cautionActive ? `<div id="caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${isCustomDoseHigh ? `Custom dose (${currentDoseForRangeCheck} ${drug.unit}) exceeds recommended range (${drug.range}).` : drug.caution}</div>` : '';

      let routeSelectorHTML = '';
      if (drug.routes && drug.routes.length > 1) {
        routeSelectorHTML = '<div class="route-selector">' + drug.routes.map(route => {
          const checked = drug.currentRoute === route ? 'checked' : '';
          const routeName = (route === 'IV' ? 'Intravenous (IV)' : (route === 'IM' ? 'Intramuscular (IM)' : 'Oral'));
          return `<input type="radio" id="route-${index}-${route}" name="route-${index}" value="${route}" ${checked} onclick="event.stopPropagation(); selectRoute(${index}, '${route}')"><label for="route-${index}-${route}">${routeName}</label>`;
        }).join('') + '</div>';
      }

      let limitInfoHtml = limitApplied ? `<span class="dose-limit-applied">(MAX Limit Applied)</span>` : '';
      let adjustedInfoHtml = doseAdjusted ? `<span class="dose-limit-applied">(Adjusted for weight < 10 kg)</span>` : '';

      const isEditing = activeEditIndex === index;
      const isModified = hasCustomValues(drug); // Check if modified for reset button
      
      const editInputsHtml = `
        <div class="edit-inputs ${isEditing ? 'active' : ''}" id="edit-inputs-${index}">
          <div class="edit-input-grid">
            <div class="edit-input-field">
              <label for="dose-${index}">Dose (${drug.unit})</label>
              <input type="number" id="dose-${index}" value="${dosePerKg}" step="0.01" min="0">
            </div>
            ${isInjectable ? `<div class="edit-input-field">
                                <label for="conc-${index}">Concentration (${drug.concentrationUnit})</label>
                                <input type="number" id="conc-${index}" value="${concentration}" step="0.01" min="0">
                             </div>` : ''}
          </div>
          <div class="edit-actions">
            <button class="edit-btn" onclick="updateDrug(${index})">Update</button>
            ${isModified ? `<button class="edit-btn reset-btn" onclick="resetDrugToDefault(${index})">Reset</button>` : ''}
          </div>
        </div>`;

      const isExpandedClass = allExpanded || isEditing ? 'expanded' : '';
      
      // Assign dynamic text color to calculation result based on category
      let resultColorStyle = '';
      if(drug.category) {
          resultColorStyle = `style="color: var(--${drug.category});"`;
          if(drug.category === 'induction' || drug.category === 'antiemetic' || (drug.category === 'emergency' && document.body.classList.contains('dark-mode'))) {
              resultColorStyle = `style="color: var(--${drug.category}); text-shadow: 0 0 5px rgba(0,0,0,0.2);"`;
          }
      } else {
          resultColorStyle = `style="color: var(--primary-accent);"`;
      }


      html += `<div class="drug-card ${drug.category} ${isExpandedClass} ${cautionActive ? 'caution-active' : ''}" id="drug-card-${index}">
          ${cautionPopupHtml}
          <div class="drug-header" onclick="toggleDrugCard(${index})">
            <div class="drug-name${customIndicator}"><span class="toggle-icon">▶</span>${drug.name}</div>
            <div class="drug-category ${drug.category}">${drug.categoryLabel}</div>
            ${cautionIconHtml}
          </div>
          <div class="drug-details" id="drug-details-${index}">
            ${ketorolacInfoBox}${routeSelectorHTML}
            <div class="dose-info">Recommended: ${drug.range}</div>
            <div class="calculation">
              <div class="calculation-result" ${resultColorStyle}>${doseDisplay} ${limitInfoHtml} ${adjustedInfoHtml}</div>
              ${isInjectable ? `<div class="volume-result">Volume: ${volumeDisplay} mL (@ ${concentrationDisplay})</div>` : ''}
              ${drug.name !== 'Ketorolac' ? `<div class="dose-info">Calculated: ${dosePerKg} ${drug.unit}</div>` : ''}
            </div>
            <button class="edit-btn" onclick="toggleEdit(${index})">${isEditing ? 'Close Edit' : 'Edit Dose/Concentration'}</button>
            ${editInputsHtml}
          </div>
        </div>`;
    });

    drugResultsDiv.innerHTML = html;
    document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  function calculateInfusions() {
    const patient = getPatientData();
    const infusionResultsDiv = document.getElementById('infusion-results');

    if (!patient.weight) {
      infusionResultsDiv.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">Enter patient weight to calculate infusion rates</p>';
      document.getElementById('toggleAllInfusionsBtn').style.display = 'none';
      return;
    }
    document.getElementById('toggleAllInfusionsBtn').style.display = 'block';

    let html = '';

    infusionDrugs.forEach((infusion, index) => {
      const weight = patient.weight;
      const minRate = infusion.rateCalculation(infusion.infusionDose.min, weight);
      const maxRate = infusion.rateCalculation(infusion.infusionDose.max, weight);
      
      let isCautionNeeded = infusion.caution ? true : false;
      let cautionIconHtml = isCautionNeeded ? `<span class="caution-icon" id="infusion-caution-icon-${index}" onclick="event.stopPropagation(); toggleInfusionCautionPopup(${index})">i</span>` : '';
      let cautionPopupHtml = isCautionNeeded ? `<div id="infusion-caution-popup-${index}" class="caution-popup"><strong>CAUTION:</strong> ${infusion.caution}</div>` : '';
      
      let loadingDoseHtml = '';
      if (infusion.loadingDose && infusion.loadingDose.dose > 0) {
        loadingDoseHtml = `<div class="infusion-detail-row"><div class="infusion-label">Loading Dose:</div><div class="infusion-value">${infusion.loadingDose.dose} ${infusion.loadingDose.unit}</div></div><div class="infusion-note">${infusion.loadingDose.note}</div>`;
      }
      
      const isExpandedClass = allInfusionsExpanded ? 'expanded' : '';
      
      html += `<div class="drug-card infusion ${isExpandedClass}" id="infusion-card-${index}">
          ${cautionPopupHtml}
          <div class="drug-header" onclick="toggleInfusionCard(${index})">
            <div class="drug-name"><span class="toggle-icon">▶</span>${infusion.name}</div>
            <div class="drug-category infusion">${infusion.categoryLabel}</div>
            ${cautionIconHtml}
          </div>
          <div class="drug-details" id="infusion-details-${index}">
            <div class="infusion-details">
              <div class="infusion-detail-row"><div class="infusion-label">Infusion Range:</div><div class="infusion-value">${infusion.infusionDose.min}-${infusion.infusionDose.max} ${infusion.infusionDose.unit}</div></div>
              ${loadingDoseHtml}
              <div class="infusion-detail-row"><div class="infusion-label">Common Dilution:</div><div class="infusion-value">${infusion.commonDilution}</div></div>
              <div class="infusion-note">${infusion.preparation}</div>
              <div class="calculation">
                <div class="calculation-result" style="color: var(--infusion);">${minRate.toFixed(1)} - ${maxRate.toFixed(1)} mL/hr</div>
                <div class="volume-result">For ${weight.toFixed(1)} kg patient</div>
                <div class="dose-info">Rate for ${infusion.infusionDose.min}-${infusion.infusionDose.max} ${infusion.infusionDose.unit}</div>
              </div>
              ${infusion.notes ? `<div class="infusion-note" style="font-style: normal; border-top: 1px dashed var(--border-color); padding-top: 8px;">${infusion.notes}</div>` : ''}
            </div>
          </div>
        </div>`;
    });

    infusionResultsDiv.innerHTML = html;
    document.getElementById('toggleAllInfusionsBtn').textContent = allInfusionsExpanded ? 'Collapse All' : 'Expand All / Collapse All';
  }

  function toggleDrugCard(index) { requestAnimationFrame(() => { document.getElementById(`drug-card-${index}`).classList.toggle('expanded'); }); }
  function toggleInfusionCard(index) { requestAnimationFrame(() => { document.getElementById(`infusion-card-${index}`).classList.toggle('expanded'); }); }
  function toggleAntibioticCard(index) { 
    const card = document.getElementById(`antibiotic-card-${index}`);
    if (!card) return;
    requestAnimationFrame(() => { card.classList.toggle('expanded'); antibioticExpanded[index] = card.classList.contains('expanded'); });
  }

  function toggleAllDrugs() {
    allExpanded = !allExpanded;
    requestAnimationFrame(() => {
      drugs.forEach((_, index) => {
        const card = document.getElementById(`drug-card-${index}`);
        if (card) { card.classList.toggle('expanded', allExpanded); }
      });
      setTimeout(() => { document.getElementById('toggleAllBtn').textContent = allExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
    });
  }

  function toggleAllInfusions() {
    allInfusionsExpanded = !allInfusionsExpanded;
    requestAnimationFrame(() => {
      infusionDrugs.forEach((_, index) => {
        const card = document.getElementById(`infusion-card-${index}`);
        if (card) { card.classList.toggle('expanded', allInfusionsExpanded); }
      });
      setTimeout(() => { document.getElementById('toggleAllInfusionsBtn').textContent = allInfusionsExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
    });
  }

  function toggleAllAntibiotics() {
    allAntibioticsExpanded = !allAntibioticsExpanded;
    requestAnimationFrame(() => {
      antibioticExpanded.fill(allAntibioticsExpanded);
      calculateAntibiotics(); // This will re-render with the correct 'expanded' class
      setTimeout(() => { document.getElementById('toggleAllAntibioticsBtn').textContent = allAntibioticsExpanded ? 'Collapse All' : 'Expand All / Collapse All'; }, 300);
    });
  }

  function toggleEdit(index) {
    activeEditIndex = activeEditIndex === index ? null : index;
    calculateDrugs();
  }

  /**
   * Resets a single drug's custom values to default (null).
   */
  function resetDrugToDefault(index) {
      const drug = drugs[index];
      if (drug) {
          drug.customDoseIV = null;
          drug.customDoseIM = null;
          drug.customDoseOral = null;
          drug.customConcentration = null;
          drug.isCustomDoseHigh = false;

          // Re-run calculations
          saveLastUsedDrugValues();
          calculateDrugs();
          checkForCustomDrugValues();
      }
  }

  /**
   * Updates a drug's custom values based on input fields.
   */
  function updateDrug(index) {
    const drug = drugs[index];
    const initialDrug = initialDrugs.find(d => d.name === drug.name);
    if (!initialDrug) return;

    const newDoseInput = document.getElementById(`dose-${index}`);
    const newDose = parseFloat(newDoseInput.value);

    const isInjectable = drug.currentRoute === 'IV' || drug.currentRoute === 'IM';
    let newConc = null;
    let newConcInput = null;
    
    if (isInjectable) {
        newConcInput = document.getElementById(`conc-${index}`);
        if (newConcInput) { // Check if conc input exists
            newConc = parseFloat(newConcInput.value);
        }
    }

    if (!isNaN(newDose) && newDose > 0) {
        // Update Dose based on current route
        switch (drug.currentRoute) {
            case 'IV':
                const defaultIVDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : initialDrug.defaultDose;
                drug.customDoseIV = (newDose !== defaultIVDose) ? newDose : null;
                break;
            case 'IM':
                const defaultIMDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : (initialDrug.imDose !== undefined ? initialDrug.imDose : initialDrug.defaultDose);
                drug.customDoseIM = (newDose !== defaultIMDose) ? newDose : null;
                break;
            case 'Oral':
                const defaultOralDose = (drug.name === 'Ketorolac') ? calculateKetorolacDoseAndInfo(getPatientData(), drug).dosePerKg : (initialDrug.oralDose !== undefined ? initialDrug.oralDose : initialDrug.defaultDose);
                drug.customDoseOral = (newDose !== defaultOralDose) ? newDose : null;
                break;
        }
    }

    if (newConc !== null && !isNaN(newConc) && newConc > 0) {
        // Update Concentration
        const defaultConc = initialDrug.concentration;
        drug.customConcentration = (newConc !== defaultConc) ? newConc : null;
    } else if (newConcInput && newConcInput.value === '') {
        // Handle clearing the concentration field
        drug.customConcentration = null;
    }

    // Check for high dose
    drug.isCustomDoseHigh = false;
    const currentDose = getDoseByRoute(drug, drug.currentRoute);
    const rangeMax = parseMaxDoseFromRange(drug.range);
    if (rangeMax && currentDose > rangeMax) {
        drug.isCustomDoseHigh = true;
    }

    saveLastUsedDrugValues();
    calculateDrugs();
    checkForCustomDrugValues();
  }


  function toggleCautionPopup(index) {
    const popup = document.getElementById(`caution-popup-${index}`);
    if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
  }

  function toggleInfusionCautionPopup(index) {
    const popup = document.getElementById(`infusion-caution-popup-${index}`);
    if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
  }

  function toggleAntibioticCautionPopup(index) {
    const popup = document.getElementById(`antibiotic-caution-popup-${index}`);
    if (popup) { popup.style.display = popup.style.display === 'block' ? 'none' : 'block'; }
  }

  // Close popups when clicking anywhere else
  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('caution-icon')) {
      document.querySelectorAll('.caution-popup').forEach(popup => { popup.style.display = 'none'; });
    }
  });

  function calculateAll() {
    calculateEquipment();
    calculateFluids();
    calculateDrugs();
    calculateLocalAnesthetics();
    calculateInfusions();
    calculateAntibiotics();
  }

  function resetAllDrugsToDefault() {
    drugs.forEach(drug => {
      drug.customDoseIV = null;
      drug.customDoseIM = null;
      drug.customDoseOral = null;
      drug.customConcentration = null;
      drug.isCustomDoseHigh = false;
      drug.currentRoute = drug.defaultRoute; // Reset route as well
    });
    localStorage.removeItem('pediatricAnesthesiaLastUsedDrugValues');
    calculateDrugs();
    document.getElementById('custom-drugs-indicator').style.display = 'none';
  }

  // Patient Profiles
  function savePatientProfile() {
    const profileName = document.getElementById('patient-profile-name').value.trim();
    if (!profileName) { console.error('Please enter a profile name'); return; }
    
    const patientData = { name: profileName, ageYears: document.getElementById('age-years').value, ageMonths: document.getElementById('age-months').value, weight: document.getElementById('weight').value, currentHb: document.getElementById('currentHb').value, targetHb: document.getElementById('targetHb').value, timestamp: new Date().toISOString() };
    let savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
    const existingIndex = savedProfiles.findIndex(p => p.name === profileName);
    
    if (existingIndex !== -1) {
      // Simple confirm replacement
      console.log(`Profile "${profileName}" already exists. Overwriting.`);
      savedProfiles[existingIndex] = patientData;
    } else { savedProfiles.push(patientData); }
    
    localStorage.setItem('pediatricAnesthesiaPatientProfiles', JSON.stringify(savedProfiles));
    document.getElementById('patient-profile-name').value = '';
    loadPatientProfiles();
  }

  function loadPatientProfiles() {
    const savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
    const container = document.getElementById('patient-profiles-list');
    
    if (savedProfiles.length === 0) { container.innerHTML = '<div class="no-saved-items">No saved patient profiles</div>'; return; }
    
    savedProfiles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    container.innerHTML = savedProfiles.map(profile => `
      <div class="saved-item">
        <div>
          <div class="saved-item-name">${profile.name}</div>
          <div class="saved-item-details">
            ${profile.ageYears || 0}Y ${profile.ageMonths || 0}M | ${profile.weight || 0} kg | 
            Hb: ${profile.currentHb || 'N/A'} → ${profile.targetHb || 'N/A'}
          </div>
        </div>
        <div class="saved-item-actions">
          <button class="saved-item-btn" onclick="applyPatientProfile('${profile.name}')" title="Apply"><i class="fas fa-play"></i></button>
          <button class="saved-item-btn delete" onclick="deletePatientProfile('${profile.name}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `).join('');
  }

  function applyPatientProfile(profileName) {
    const profile = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]').find(p => p.name === profileName);
    if (profile) {
      document.getElementById('age-years').value = profile.ageYears || '';
      document.getElementById('age-months').value = profile.ageMonths || '';
      document.getElementById('weight').value = profile.weight || '';
      document.getElementById('currentHb').value = profile.currentHb || '';
      document.getElementById('targetHb').value = profile.targetHb || '';
      calculateAll();
    }
  }

  function deletePatientProfile(profileName) {
    console.log(`Deleting profile "${profileName}".`);
    let savedProfiles = JSON.parse(localStorage.getItem('pediatricAnesthesiaPatientProfiles') || '[]');
    savedProfiles = savedProfiles.filter(p => p.name !== profileName);
    localStorage.setItem('pediatricAnesthesiaPatientProfiles', JSON.stringify(savedProfiles));
    loadPatientProfiles();
  }

  function clearAllPatientProfiles() {
    console.log('Deleting ALL saved patient profiles.');
    localStorage.removeItem('pediatricAnesthesiaPatientProfiles');
    loadPatientProfiles();
  }

  // Drug Sets
  function saveDrugSet() {
    const setName = document.getElementById('drug-set-name').value.trim();
    if (!setName) { console.error('Please enter a drug set name'); return; }
    const modifiedCount = countModifiedDrugs();
    
    const drugSet = {
        name: setName,
        drugs: drugs.map(drug => ({
            name: drug.name,
            customDoseIV: drug.customDoseIV,
            customDoseIM: drug.customDoseIM,
            customDoseOral: drug.customDoseOral,
            customConcentration: drug.customConcentration,
            currentRoute: drug.currentRoute,
            isCustomDoseHigh: drug.isCustomDoseHigh
        })),
        modifiedCount,
        timestamp: new Date().toISOString()
    };
    
    let savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
    const existingIndex = savedSets.findIndex(s => s.name === setName);
    
    if (existingIndex !== -1) {
      console.log(`Drug set "${setName}" already exists. Overwriting.`);
      savedSets[existingIndex] = drugSet;
    } else { savedSets.push(drugSet); }
    
    localStorage.setItem('pediatricAnesthesiaDrugSets', JSON.stringify(savedSets));
    document.getElementById('drug-set-name').value = '';
    loadDrugSets();
  }

  function loadDrugSets() {
    const savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
    const container = document.getElementById('drug-sets-list');
    
    if (savedSets.length === 0) { container.innerHTML = '<div class="no-saved-items">No saved drug sets</div>'; return; }
    
    savedSets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    container.innerHTML = savedSets.map(set => `
      <div class="saved-item">
        <div>
          <div class="saved-item-name">${set.name}</div>
          <div class="saved-item-details">
            ${set.modifiedCount || 0} drugs modified | ${new Date(set.timestamp).toLocaleDateString()}
          </div>
        </div>
        <div class="saved-item-actions">
          <button class="saved-item-btn" onclick="applyDrugSet('${set.name}')" title="Apply"><i class="fas fa-play"></i></button>
          <button class="saved-item-btn delete" onclick="deleteDrugSet('${set.name}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `).join('');
  }

  function applyDrugSet(setName) {
    const set = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]').find(s => s.name === setName);
    if (set) {
      set.drugs.forEach(savedDrug => {
        const drug = drugs.find(d => d.name === savedDrug.name);
        if (!drug) return;

        if (savedDrug.customDoseIV !== undefined) {
            // New format
            drug.customDoseIV = savedDrug.customDoseIV;
            drug.customDoseIM = savedDrug.customDoseIM;
            drug.customDoseOral = savedDrug.customDoseOral;
            drug.customConcentration = savedDrug.customConcentration;
        } else {
            // Old format compatibility
            const initialDrug = initialDrugs.find(d => d.name === savedDrug.name);
            if (initialDrug) {
                drug.customDoseIV = (savedDrug.defaultDose !== initialDrug.defaultDose) ? savedDrug.defaultDose : null;
                drug.customConcentration = (savedDrug.concentration !== initialDrug.concentration) ? savedDrug.concentration : null;
                drug.customDoseIM = null;
                drug.customDoseOral = null;
            }
        }
        drug.currentRoute = savedDrug.currentRoute || drug.defaultRoute;
        drug.isCustomDoseHigh = savedDrug.isCustomDoseHigh;
      });
      
      saveLastUsedDrugValues(); // Save in the *new* format
      calculateDrugs();
      document.getElementById('custom-drugs-indicator').style.display = 'flex';
      document.getElementById('current-drug-set-name').textContent = setName;
      document.getElementById('modified-drugs-count').textContent = countModifiedDrugs();
    }
  }

  function deleteDrugSet(setName) {
    console.log(`Deleting drug set "${setName}".`);
    let savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
    savedSets = savedSets.filter(s => s.name !== setName);
    localStorage.setItem('pediatricAnesthesiaDrugSets', JSON.stringify(savedSets));
    loadDrugSets();
  }

  function clearAllDrugSets() {
    console.log('Deleting ALL saved drug sets.');
    localStorage.removeItem('pediatricAnesthesiaDrugSets');
    loadDrugSets();
  }

  function saveLastUsedDrugValues() {
    const drugValues = drugs.map(drug => ({
        name: drug.name,
        customDoseIV: drug.customDoseIV,
        customDoseIM: drug.customDoseIM,
        customDoseOral: drug.customDoseOral,
        customConcentration: drug.customConcentration,
        currentRoute: drug.currentRoute,
        isCustomDoseHigh: drug.isCustomDoseHigh
    }));
    localStorage.setItem('pediatricAnesthesiaLastUsedDrugValues', JSON.stringify({ drugs: drugValues, timestamp: new Date().toISOString() }));
  }

  function loadLastUsedDrugValues() {
    const savedData = localStorage.getItem('pediatricAnesthesiaLastUsedDrugValues');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        if (data.drugs && Array.isArray(data.drugs)) {
          data.drugs.forEach(savedDrug => {
            const drug = drugs.find(d => d.name === savedDrug.name);
            if (drug) {
                drug.customDoseIV = savedDrug.customDoseIV;
                drug.customDoseIM = savedDrug.customDoseIM;
                drug.customDoseOral = savedDrug.customDoseOral;
                drug.customConcentration = savedDrug.customConcentration;
                drug.currentRoute = savedDrug.currentRoute || drug.defaultRoute;
                drug.isCustomDoseHigh = savedDrug.isCustomDoseHigh;
            }
          });
          checkForCustomDrugValues();
        }
      } catch (e) {
        console.error('Error loading last used drug values:', e);
      }
    }
  }


  function checkForCustomDrugValues() {
    const modifiedCount = countModifiedDrugs();
    const indicator = document.getElementById('custom-drugs-indicator');
    
    if (modifiedCount > 0) {
      indicator.style.display = 'flex';
      document.getElementById('modified-drugs-count').textContent = modifiedCount;
      // Try to find a matching saved set name
      const savedSets = JSON.parse(localStorage.getItem('pediatricAnesthesiaDrugSets') || '[]');
      let currentSetName = 'Custom';
      const currentValues = JSON.stringify(drugs.map(d => d.customDoseIV + d.customDoseIM + d.customDoseOral + d.customConcentration));
      
      for(const set of savedSets) {
          const setValues = JSON.stringify(set.drugs.map(d => d.customDoseIV + d.customDoseIM + d.customDoseOral + d.customConcentration));
          if(currentValues === setValues) {
              currentSetName = set.name;
              break;
          }
      }
      document.getElementById('current-drug-set-name').textContent = currentSetName;

    } else {
      indicator.style.display = 'none';
    }
  }
  
  function toggleDisclaimer() {
    const content = document.getElementById('disclaimer-content');
    const arrow = document.getElementById('disclaimer-arrow');
    // Toggle class on content
    content.classList.toggle('expanded');
    // Toggle arrow direction
    arrow.classList.toggle('fa-chevron-down');
    arrow.classList.toggle('fa-chevron-up');
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
    updateDarkModeButton();
  }
  
  function updateDarkModeButton() {
    const isDark = document.body.classList.contains('dark-mode');
    const icon = document.querySelector('.dark-mode-toggle i');
    const text = document.querySelector('.dark-mode-toggle span');
    if (isDark) { 
        icon.className = 'fas fa-sun'; 
        text.textContent = 'Light Mode'; 
    } else { 
        icon.className = 'fas fa-moon'; 
        text.textContent = 'Dark Mode'; 
    }
  }

  // DOMContentLoaded: Setup listeners and initial state
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Deactivate all
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Activate clicked
        button.classList.add('active');
        const targetTab = document.getElementById(button.getAttribute('data-tab'));
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // Scroll tab into view if needed
        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      });
    });
    
    // Check for saved dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      document.body.classList.add('dark-mode');
    }
    updateDarkModeButton(); // Update button text/icon regardless
    
    // Load data and run initial calculations
    loadLastUsedDrugValues();
    calculateAll();
    loadPatientProfiles();
    loadDrugSets();
    checkForCustomDrugValues();
    antibioticExpanded = new Array(antibiotics.length).fill(false);
  });
  </script>
</body>
</html>
